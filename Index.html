<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Balanço de Estoque - Multiempresa v2.8.1</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* CSS da versão anterior (v2.8 - tema claro) mantido. Cole o CSS completo aqui. */
        /* ... (COLE O CSS DA VERSÃO ANTERIOR AQUI) ... */
        :root {
            --primary-color: #007bff; --primary-color-darker: #0069d9;
            --secondary-color: #6c757d; --secondary-color-darker: #5a6268;
            --success-color: #198754; --success-color-darker: #157347;
            --danger-color: #dc3545; --danger-color-darker: #bb2d3b;
            --warning-color: #ffc107; --warning-color-darker: #ffb300;
            --info-color: #0dcaf0; --info-color-darker: #0aa9c6;
            --background-color: #f8f9fa; --container-bg-color: #ffffff;
            --header-bg-color: #e9ecef; --input-bg-color: #ffffff;
            --input-border-color: #ced4da; --text-color: #212529; 
            --text-muted-color: #6c757d; --text-on-primary-color: #ffffff;
            --text-on-secondary-color: #ffffff; --text-on-success-color: #ffffff;
            --text-on-danger-color: #ffffff; --text-on-warning-color: #000000;
            --text-on-info-color: #000000; --border-color: #dee2e6; 
            --hover-row-background: #f0f2f5; --border-radius: 0.375rem; 
            --box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
            --box-shadow-lg: 0 0.5rem 1rem rgba(0,0,0,0.15);
        }
        body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;margin:0;padding:20px 0;background-color:var(--background-color);color:var(--text-color);display:flex;flex-direction:column;align-items:center;min-height:100vh;line-height:1.5;font-size:1rem}
        .container{width:95%;max-width:600px;background-color:var(--container-bg-color);padding:25px 30px;border-radius:var(--border-radius);box-shadow:var(--box-shadow);margin-top:20px;margin-bottom:20px;border:1px solid var(--border-color)}
        .content-container{max-width:1140px}
        h1,h2,h3{color:var(--text-color);text-align:center;margin-top:0;margin-bottom:1.5rem;font-weight:500}
        h1{font-size:2rem}h2{font-size:1.75rem}h3{font-size:1.5rem;margin-bottom:1rem}
        .screen{display:none}.screen.active{display:block;animation:fadeIn .5s}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        button,.btn{border:1px solid transparent;padding:.5rem 1rem;text-align:center;text-decoration:none;display:inline-block;font-size:1rem;font-weight:400;line-height:1.5;border-radius:var(--border-radius);cursor:pointer;transition:color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;margin:.25rem}
        button:hover,.btn:hover{text-decoration:none;transform:translateY(-1px);box-shadow:var(--box-shadow-lg)}
        button:active,.btn:active{transform:translateY(0);}
        button:focus-visible,.btn:focus-visible{outline:2px solid var(--primary-color);outline-offset:2px}
        .btn-primary{background-color:var(--primary-color);border-color:var(--primary-color);color:var(--text-on-primary-color)}.btn-primary:hover{background-color:var(--primary-color-darker);border-color:var(--primary-color-darker)}
        .btn-secondary{background-color:var(--secondary-color);border-color:var(--secondary-color);color:var(--text-on-secondary-color)}.btn-secondary:hover{background-color:var(--secondary-color-darker);border-color:var(--secondary-color-darker)}
        .btn-success{background-color:var(--success-color);border-color:var(--success-color);color:var(--text-on-success-color)}.btn-success:hover{background-color:var(--success-color-darker);border-color:var(--success-color-darker)}
        .btn-danger{background-color:var(--danger-color);border-color:var(--danger-color);color:var(--text-on-danger-color)}.btn-danger:hover{background-color:var(--danger-color-darker);border-color:var(--danger-color-darker)}
        .btn-warning{background-color:var(--warning-color);border-color:var(--warning-color);color:var(--text-on-warning-color)}.btn-warning:hover{background-color:var(--warning-color-darker);border-color:var(--warning-color-darker)}
        .btn-info{background-color:var(--info-color);border-color:var(--info-color);color:var(--text-on-info-color);}.btn-info:hover{background-color:var(--info-color-darker);border-color:var(--info-color-darker);}
        .dashboard-options{display:flex;flex-direction:column;align-items:stretch;gap:1rem;padding:1rem 0}
        .dashboard-options .btn{padding:.75rem 1rem;font-size:1.05rem;width:100%}
        .card{border:1px solid var(--border-color);border-radius:var(--border-radius);margin-bottom:1.5rem;box-shadow:var(--box-shadow);background-color:var(--container-bg-color)}
        .card-header{padding:.75rem 1.25rem;margin-bottom:0;background-color:var(--header-bg-color);border-bottom:1px solid var(--border-color);border-top-left-radius:calc(var(--border-radius) - 1px);border-top-right-radius:calc(var(--border-radius) - 1px)}
        .card-header>*{margin:0;font-size:1.25rem;font-weight:500;color:var(--text-color);text-align:left}
        .card-body{padding:1.25rem}
        table{width:100%;border-collapse:collapse;margin-bottom:1rem;color:var(--text-color); }
        th,td{border:1px solid var(--border-color);padding:.75rem;text-align:left;vertical-align:middle}
        th{background-color:var(--header-bg-color);font-weight:500;border-bottom-width:2px} 
        tbody tr:nth-child(odd){background-color:var(--container-bg-color); } 
        tbody tr:nth-child(even){background-color: #f2f2f2; } 
        tbody tr:hover{background-color:var(--hover-row-background); color:var(--text-color); }
        input[type=text],input[type=number],input[type=password],input[type=email],select,input[type=file]{width:100%;padding:.5rem .75rem;margin-bottom:1rem;border:1px solid var(--input-border-color);border-radius:var(--border-radius);box-sizing:border-box;font-size:1rem;line-height:1.5;background-color:var(--input-bg-color);color:var(--text-color);background-clip:padding-box;transition:border-color .15s ease-in-out,box-shadow .15s ease-in-out}
        input[type=text]::placeholder,input[type=number]::placeholder,input[type=password]::placeholder,input[type=email]::placeholder{color:var(--text-muted-color);opacity:1}
        input[type=text]:focus,input[type=number]:focus,input[type=password]:focus,input[type=email]:focus,select:focus{border-color:var(--primary-color);outline:0;box-shadow:0 0 0 .25rem rgba(13,110,253,.25)}
        input[type=file]{padding:.375rem .75rem}
        select{appearance:none;background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23212529' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");background-repeat:no-repeat;background-position:right .75rem center;background-size:16px 12px}
        .form-group{margin-bottom:1rem}
        .form-group label{display:block;margin-bottom:.5rem;font-weight:500;color:var(--text-color); }
        .filter-controls,.product-management-form-fields,.xlsx-import-section,.actions-bar,.sub-form-section{margin-bottom:1.5rem;padding:1rem;background-color:var(--container-bg-color);border:1px solid var(--border-color);border-radius:var(--border-radius)} 
        .product-management-form-fields .form-group{margin-bottom:0}
        .filter-controls>div{flex:1;min-width:200px}
        .filter-controls input,.filter-controls select{margin-bottom:0}
        .xlsx-import-section input[type=file]{width:auto;margin-right:.5rem}
        .actions-bar{text-align:center;padding:1rem 0; background-color: transparent; border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); }
        .actions-bar .btn{margin:0 .5rem}
        #productManagementTable td:last-child,#inventoryTable td:last-child,#adminEmpresasTable td:last-child, #colaboradoresTable td:last-child, #historicoContagensTable td:last-child, #adminCategoriasTable td:last-child {text-align:center} 
        #inventoryTable input[type=number]{max-width:80px;text-align:right;padding:.375rem .5rem;font-size:.9rem}
        .back-button{margin-bottom:1.5rem;display:inline-block}
        .modal-overlay { background-color: rgba(0,0,0,0.5); } 
        .modal-content { background-color: var(--container-bg-color); color: var(--text-color); }
        .modal-content h4 { color: var(--text-color); }
        .modal-content p { color: var(--text-muted-color); }
        .login-form{max-width:400px;margin:1.5rem auto; padding: 2rem; background-color: var(--container-bg-color); border-radius: var(--border-radius); box-shadow: var(--box-shadow);}
        .login-form .form-group{margin-bottom:1rem}
        .login-form button{width:100%;padding:.75rem;font-size:1.05em}
        #loginErrorMessage{color:var(--danger-color);margin-top:1rem;text-align:center;display:none}
        .sub-form-section h4{text-align:left;font-size:1.1rem;color:var(--text-color);margin-bottom:1rem;border-bottom:1px solid var(--border-color);padding-bottom:.5rem}
        .table-actions button,.table-actions .btn{margin:0 2px;padding:.25rem .5rem;font-size:.85rem}
        .generated-password-display { margin-top: 10px; padding: 10px; background-color: #e9ecef; border: 1px dashed var(--border-color); border-radius: var(--border-radius); word-break: break-all; color: var(--text-color); font-family: monospace; text-align: center;}
        .company-users-list { list-style-type: none; padding-left: 0; font-size: 0.9em; }
        .company-users-list li { padding: 8px 5px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .company-users-list li:last-child { border-bottom: none; }
        .company-users-list li .user-info { margin-right: 10px; flex-grow: 1; /* Para ocupar espaço */ }
        .company-users-list li .user-info .user-email { font-weight: bold; color: var(--primary-color); }
        .company-users-list li .user-info .user-details { font-style: italic; color: var(--text-muted-color); font-size: 0.9em; display: block; }
        .company-users-list li .user-actions { display: flex; gap: 5px; flex-shrink: 0; /* Para não encolher os botões */ }
        .password-change-form { max-width: 450px; margin: 1.5rem auto; }
        .form-inline-flex { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 1rem;}
        .form-inline-flex .form-group { flex: 1; margin-bottom: 0;}
        .form-inline-flex button { flex-shrink: 0; }
        #previewContagemTable { width: 100%; margin-top: 1rem; }
        #previewContagemTable th, #previewContagemTable td { font-size: 0.9rem; padding: 0.5rem; }
        .admin-context-selector { margin-bottom: 1.5rem; padding: 1rem; background-color: var(--header-bg-color); border-radius: var(--border-radius); }
        .admin-context-selector label { margin-right: 0.5rem; font-weight: 500;}
        .admin-context-selector select { display: inline-block; width: auto; min-width: 250px; margin-right: 10px; }
    </style>
</head>
<body>
    <div id="mainContainer" class="container"> 
        <div id="loadingIndicator" class="loader" style="display:none;"></div>

        <div id="screenLogin" class="screen active">
            <h1>Login no Sistema de Balanço</h1>
            <div class="login-form card card-body">
                <div class="form-group"><label for="loginEmail">Email:</label><input type="email" id="loginEmail" placeholder="seuemail@exemplo.com" autocomplete="email"></div>
                <div class="form-group"><label for="loginPassword">Senha:</label><input type="password" id="loginPassword" placeholder="Sua senha" autocomplete="current-password"></div>
                <button class="btn btn-primary" onclick="handleLogin()">Entrar</button>
                <div id="loginErrorMessage"></div>
            </div>
        </div>

        <div id="screenAdminMasterDashboard" class="screen">
            <h2>Painel Admin Master</h2>
            <p style="text-align: center;">Bem-vindo, <span id="adminMasterNameDisplay">Admin Master</span>!</p>
            <div class="dashboard-options">
                <button class="btn btn-primary" onclick="showAdminEmpresasScreen()">Gerenciar Empresas & Seus Logins</button>
                <button class="btn btn-primary" onclick="showAdminCategoriasScreen()">Gerenciar Categorias</button> 
                <button class="btn btn-primary" onclick="showProductManagementScreen_AdminGlobal()">Gerenciar Produtos</button>
                <button class="btn btn-primary" onclick="showInventoryCountScreen_AdminGlobal()">Contagem de Estoque</button>
                <button class="btn btn-secondary" onclick="handleLogout()">Logout</button>
            </div>
        </div>

        <div id="screenEmpresaDashboard" class="screen">
            <h2 id="empresaDashboardTitle">Painel da Empresa</h2>
            <p style="text-align: center;">Logado como: <span id="empresaUserName"></span></p>
            <div class="dashboard-options">
                <button class="btn btn-primary" onclick="showEmpresaColaboradoresScreen()">Gerenciar Colaboradores</button>
                <button class="btn btn-primary" onclick="showProductManagementScreen_Empresa()">Gerenciar Produtos da Empresa</button>
                <button class="btn btn-primary" onclick="showInventoryCountScreen_Empresa()">Iniciar Contagem da Empresa</button>
                <button class="btn btn-info" onclick="showHistoricoContagensScreen()">Ver Histórico de Contagens</button>
                <button class="btn btn-info" onclick="showChangePasswordScreen_Empresa()">Alterar Senha da Empresa</button> 
                <button class="btn btn-secondary" onclick="handleLogout()">Logout</button>
            </div>
        </div>
        
        <div id="screenAdminCategorias" class="screen">
            <button class="btn btn-secondary back-button" onclick="showAdminMasterDashboardScreen()">&larr; Painel Admin</button>
            <h2>Gerenciar Categorias de Produtos</h2>
            <div class="card">
                <div class="card-header"><h3>Adicionar Nova Categoria</h3></div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="adminCategoriaEmpresaSelect">Associar Categoria a (Opcional):</label>
                        <select id="adminCategoriaEmpresaSelect">
                            <option value="">-- Categoria Global --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="adminNomeCategoria">Nome da Nova Categoria:</label>
                        <input type="text" id="adminNomeCategoria" placeholder="Ex: Bolos, Salgados, Bebidas">
                    </div>
                    <button class="btn btn-success" onclick="handleAdminAddCategoria()">Adicionar Categoria</button>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><h3>Categorias Cadastradas</h3></div>
                <div class="card-body">
                    <table id="adminCategoriasTable">
                        <thead><tr><th>Nome da Categoria</th><th>Empresa (Global se vazio)</th><th>Criação</th><th>Ações</th></tr></thead>
                        <tbody id="adminCategoriasTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="screenAdminEmpresas" class="screen">
            <button class="btn btn-secondary back-button" onclick="showAdminMasterDashboardScreen()">&larr; Painel Admin</button>
            <h2>Gerenciar Empresas e Seus Logins Principais</h2>
            <div class="card"><div class="card-header"><h3>Adicionar Nova Empresa</h3></div><div class="card-body"><div class="form-group"><label for="adminNomeEmpresa">Nome da Empresa:</label><input type="text" id="adminNomeEmpresa" placeholder="Nome da nova empresa"></div><button class="btn btn-success" onclick="handleAdminAddEmpresa()">Adicionar Empresa</button></div></div>
            <div class="card"><div class="card-header"><h3>Empresas Cadastradas</h3></div><div class="card-body"><table id="adminEmpresasTable"><thead><tr><th>Nome</th><th>Criação</th><th style="width:200px;">Login da Empresa</th></tr></thead><tbody id="adminEmpresasTableBody"></tbody></table></div></div>
            <div id="adminDefineLoginEmpresaSection" class="card" style="display:none; margin-top: 2rem;"><div class="card-header"><h3 id="adminDefineLoginEmpresaTitle">Definir Login para Empresa</h3></div><div class="card-body"><input type="hidden" id="selectedEmpresaIdForLogin"><div class="form-group"><label for="adminEmpresaLoginEmail">Email para Login da Empresa (fictício):</label><input type="email" id="adminEmpresaLoginEmail" placeholder="login_empresa@sistema.com"></div><div class="form-group"><label for="adminEmpresaLoginFullName">Nome de Referência (Ex: Login Principal):</label><input type="text" id="adminEmpresaLoginFullName" placeholder="Referência do Login"></div><button class="btn btn-success" onclick="handleAdminCreateOrUpdateEmpresaLogin()">Salvar Login e Gerar Senha</button><div id="generatedEmpresaPasswordMessage" class="generated-password-display" style="display:none;"></div></div><button class="btn btn-secondary" onclick="closeAdminDefineLoginEmpresaSection()" style="margin: 0 1.25rem 1.25rem;">Cancelar</button></div>
        </div>
        
        <div id="screenEmpresaColaboradores" class="screen">
            <button class="btn btn-secondary back-button" onclick="showEmpresaDashboardScreen()">&larr; Painel da Empresa</button>
            <h2>Gerenciar Colaboradores (<span id="colaboradoresEmpresaNome"></span>)</h2>
            <div class="card"><div class="card-header"><h3>Adicionar Novo Colaborador</h3></div><div class="card-body"><div class="form-inline-flex"><div class="form-group"><label for="colaboradorNome">Nome do Colaborador:</label><input type="text" id="colaboradorNome" placeholder="Nome completo"></div><button class="btn btn-success" onclick="handleAddColaborador()">Adicionar</button></div></div></div>
            <div class="card"><div class="card-header"><h3>Colaboradores Cadastrados</h3></div><div class="card-body"><table id="colaboradoresTable"><thead><tr><th>Nome</th><th>Ativo</th><th>Criação</th><th>Ações</th></tr></thead><tbody id="colaboradoresTableBody"></tbody></table></div></div>
        </div>
        
        <div id="screenChangePassword" class="screen">
            <button class="btn btn-secondary back-button" id="changePasswordBackButton">&larr; Voltar ao Painel</button>
            <h2>Alterar Senha</h2>
            <div class="password-change-form card card-body">
                <p>Alterando senha para o login: <strong id="changingPasswordForUserDisplay"></strong></p>
                <div class="form-group" id="currentPasswordGroup" style="display:none;"><label for="currentPasswordInput">Senha Atual:</label><input type="password" id="currentPasswordInput"></div>
                <div class="form-group"><label for="newPasswordInput">Nova Senha (mín. 6 caracteres):</label><input type="password" id="newPasswordInput" placeholder="Digite a nova senha"></div>
                <div class="form-group"><label for="confirmNewPasswordInput">Confirmar Nova Senha:</label><input type="password" id="confirmNewPasswordInput" placeholder="Confirme a nova senha"></div>
                <button class="btn btn-primary" onclick="handleChangePassword()">Salvar Nova Senha</button>
                <div id="changePasswordMessage" style="margin-top:1rem; text-align:center;"></div>
            </div>
        </div>

        <div id="screenHistoricoContagens" class="screen">
            <button class="btn btn-secondary back-button" onclick="showEmpresaDashboardScreen()">&larr; Painel da Empresa</button>
            <h2>Histórico de Contagens (<span id="historicoEmpresaNome"></span>)</h2>
            <div class="card"><div class="card-header"><h3>Registros de Contagem</h3></div><div class="card-body" style="padding:0;"><table id="historicoContagensTable"><thead><tr><th>Data</th><th>Colaborador</th><th>Itens Contados</th><th>Ações</th></tr></thead><tbody id="historicoContagensTableBody"></tbody></table></div></div>
            <div id="modalDetalhesContagem" class="modal-overlay"><div class="modal-content" style="max-width: 600px; text-align:left;"><h4>Detalhes da Contagem</h4><div id="detalhesContagemConteudo"></div><div class="modal-actions" style="margin-top:1.5rem;"><button class="btn btn-secondary" onclick="closeModalDetalhesContagem()">Fechar</button></div></div></div>
        </div>

        <div id="screenProductManagement" class="screen">
            <button class="btn btn-secondary back-button" id="productManagementBackButton">&larr; Voltar</button>
            <h2 id="productManagementTitle">Gerenciar Produtos</h2>
            <div id="adminProdutoEmpresaSelectorContainer" class="admin-context-selector" style="display:none;">
                <label for="adminProdutoEmpresaSelect">Gerenciar Produtos Para Empresa:</label>
                <select id="adminProdutoEmpresaSelect"><option value="">-- Produtos Globais (Sem Empresa) --</option></select>
            </div>
            <p id="productManagementContext" style="text-align:center; font-size:0.9em; color:var(--text-muted-color); margin-bottom: 1rem;"></p>
            <div class="card"><div class="card-header"><h3>Adicionar Novo Produto</h3></div><div class="card-body">
                <div class="product-management-form-fields">
                    <div class="form-group"><label for="prodCodigo">Código:</label><input type="text" id="prodCodigo"></div>
                    <div class="form-group"><label for="prodNome">Produto:</label><input type="text" id="prodNome"></div>
                    <div class="form-group">
                        <label for="prodCategoriaSelect">Categoria:</label>
                        <select id="prodCategoriaSelect"><option value="">-- Sem Categoria --</option></select>
                    </div>
                    <button class="btn btn-success" onclick="handleAddProduct()">Adicionar</button>
                </div>
            </div></div>
            <div class="card"><div class="card-header"><h3>Importar Produtos via XLSX</h3></div><div class="card-body xlsx-import-section"><input type="file" id="xlsxFile" accept=".xlsx, .xls"><button class="btn btn-info" onclick="handleXLSXImport()">Importar</button><p>Colunas: 'codigo', 'produto', 'categoria'. Categoria vazia = Sem Categoria.</p></div></div>
            <div class="card"><div class="card-header"><h3>Produtos Cadastrados</h3></div><div class="card-body" style="padding:0;"><table id="productManagementTable"><thead><tr><th>Código</th><th>Produto</th><th>Categoria</th><th>Ação</th></tr></thead><tbody id="productManagementTableBody"></tbody></table></div></div>
        </div>

        <div id="screenInventoryCount" class="screen">
            <button class="btn btn-secondary back-button" id="inventoryCountBackButton">&larr; Voltar</button>
            <h2 id="inventoryCountTitle">Balanço de Estoque</h2>
            <div id="adminContagemEmpresaSelectorContainer" class="admin-context-selector" style="display:none;">
                <label for="adminContagemEmpresaSelect">Realizar Contagem Para Empresa:</label>
                <select id="adminContagemEmpresaSelect"><option value="">-- Contagem Global (Sem Empresa) --</option></select>
            </div>
            <p id="inventoryCountContext" style="text-align:center; font-size:0.9em; color:var(--text-muted-color); margin-bottom: 1rem;"></p>
            <div class="card card-body">
                <div class="form-group"> 
                    <label for="selectColaboradorContagem">Contagem realizada por:</label>
                    <select id="selectColaboradorContagem" style="margin-bottom: 1rem;"></select>
                </div>
                <div class="actions-bar" style="border:none; padding-bottom:0;">
                     <button class="btn btn-info" onclick="showPreviewContagem()">Ver Resumo</button> 
                     <button class="btn btn-success" onclick="gerarArquivoTXT()">Gerar TXT & Salvar Histórico</button>
                     <button class="btn btn-warning" onclick="clearAllQuantities()">Limpar Quantidades</button>
                </div>
            </div>
            <div class="filter-controls card card-body"><div><label for="pesquisaProduto">Produto:</label><input type="text" id="pesquisaProduto" placeholder="Nome..."></div><div><label for="pesquisaCodigo">Código:</label><input type="text" id="pesquisaCodigo" placeholder="Código..."></div><div><label for="filtroCategoria">Categoria:</label><select id="filtroCategoria"><option value="">Todas</option></select></div></div>
            <table><thead><tr><th>Código</th><th>Produto</th><th>Categoria</th><th>Quantidade</th></tr></thead><tbody id="inventoryTableBody"></tbody></table>
            
            <div id="modalPreviewContagem" class="modal-overlay"><div class="modal-content" style="max-width: 700px; text-align:left;"><h4>Resumo da Contagem Atual</h4><div id="previewContagemTableContainer" style="max-height: 400px; overflow-y:auto;"><table id="previewContagemTable"><thead><tr><th>Código</th><th>Produto</th><th>Categoria</th><th>Qtd. Digitada</th></tr></thead><tbody></tbody></table></div><div class="modal-actions" style="margin-top: 1.5rem;"><button class="btn btn-secondary" onclick="closeModalPreviewContagem()">Fechar</button></div></div></div>
        </div>
    </div>

    <script>
        // --- CONFIGURAÇÃO SUPABASE ---
        // ... (Mantida como antes)
        const SUPABASE_URL = 'https://daeocsintrbdfqclvteg.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhZW9jc2ludHJiZGZxY2x2dGVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM0ODMxNDEsImV4cCI6MjA1OTA1OTE0MX0.BJ61kSxTDiEFway590hoTvVH4yu0FxLnjecqQsYdwK4';
        const { createClient } = supabase;
        const _supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- VARIÁVEIS GLOBAIS ---
        // ... (Mantidas e adicionado adminSelectedEmpresaParaCategoria)
        let produtosCache = []; 
        let categoriasCache = []; 
        let empresasCache = []; 
        let colaboradoresCache = []; 
        let quantidadesDigitadas = {}; 
        const ADMIN_MASTER_EMAIL = "matheus@mtech.com";
        const ADMIN_MASTER_PASSWORD = "260195@@";
        let currentUser = null; 
        let adminSelectedEmpresaId = null; 
        let adminSelectedEmpresaParaCategoriaId = null; // Novo: para contexto de categoria

        // --- SELETORES DOM ---
        // ... (Mantidos e adicionados novos para categoria e seletores de empresa do admin)
        const mainContainer = document.getElementById('mainContainer');
        const screens = {
            login: document.getElementById('screenLogin'),
            adminMasterDashboard: document.getElementById('screenAdminMasterDashboard'),
            empresaDashboard: document.getElementById('screenEmpresaDashboard'),
            adminEmpresas: document.getElementById('screenAdminEmpresas'),
            adminCategorias: document.getElementById('screenAdminCategorias'), 
            empresaColaboradores: document.getElementById('screenEmpresaColaboradores'),
            changePassword: document.getElementById('screenChangePassword'), 
            historicoContagens: document.getElementById('screenHistoricoContagens'),
            productManagement: document.getElementById('screenProductManagement'),
            inventoryCount: document.getElementById('screenInventoryCount')
        };
        const loadingIndicator = document.getElementById('loadingIndicator');
        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');
        const loginErrorMessage = document.getElementById('loginErrorMessage');
        const adminMasterNameDisplay = document.getElementById('adminMasterNameDisplay');

        const adminNomeEmpresaInput = document.getElementById('adminNomeEmpresa');
        const adminEmpresasTableBody = document.getElementById('adminEmpresasTableBody');
        const adminDefineLoginEmpresaSection = document.getElementById('adminDefineLoginEmpresaSection');
        const adminDefineLoginEmpresaTitle = document.getElementById('adminDefineLoginEmpresaTitle');
        const selectedEmpresaIdForLogin = document.getElementById('selectedEmpresaIdForLogin');
        const adminEmpresaLoginEmailInput = document.getElementById('adminEmpresaLoginEmail');
        const adminEmpresaLoginFullNameInput = document.getElementById('adminEmpresaLoginFullName');
        const generatedEmpresaPasswordMessage = document.getElementById('generatedEmpresaPasswordMessage');

        const adminCategoriaEmpresaSelect = document.getElementById('adminCategoriaEmpresaSelect');
        const adminNomeCategoriaInput = document.getElementById('adminNomeCategoria');
        const adminCategoriasTableBody = document.getElementById('adminCategoriasTableBody');

        const colaboradoresEmpresaNomeSpan = document.getElementById('colaboradoresEmpresaNome');
        const colaboradorNomeInput = document.getElementById('colaboradorNome');
        const colaboradoresTableBody = document.getElementById('colaboradoresTableBody');
        
        const currentPasswordInput = document.getElementById('currentPasswordInput');
        const newPasswordInput = document.getElementById('newPasswordInput');
        const confirmNewPasswordInput = document.getElementById('confirmNewPasswordInput');
        const changePasswordMessage = document.getElementById('changePasswordMessage');
        const changePasswordBackButton = document.getElementById('changePasswordBackButton');
        const changingPasswordForUserDisplay = document.getElementById('changingPasswordForUserDisplay');
        const currentPasswordGroup = document.getElementById('currentPasswordGroup');

        const historicoEmpresaNomeSpan = document.getElementById('historicoEmpresaNome');
        const historicoContagensTableBody = document.getElementById('historicoContagensTableBody');
        const modalDetalhesContagem = document.getElementById('modalDetalhesContagem');
        const detalhesContagemConteudo = document.getElementById('detalhesContagemConteudo');

        const productManagementBackButton = document.getElementById('productManagementBackButton');
        const productManagementTitle = document.getElementById('productManagementTitle');
        const productManagementContext = document.getElementById('productManagementContext');
        const adminProdutoEmpresaSelectorContainer = document.getElementById('adminProdutoEmpresaSelectorContainer');
        const adminProdutoEmpresaSelect = document.getElementById('adminProdutoEmpresaSelect');
        const prodCodigoInput = document.getElementById('prodCodigo');
        const prodNomeInput = document.getElementById('prodNome');
        const prodCategoriaSelect = document.getElementById('prodCategoriaSelect'); 
        const productManagementTableBody = document.getElementById('productManagementTableBody');
        const xlsxFileInput = document.getElementById('xlsxFile');

        const inventoryCountBackButton = document.getElementById('inventoryCountBackButton');
        const inventoryCountTitle = document.getElementById('inventoryCountTitle');
        const inventoryCountContext = document.getElementById('inventoryCountContext');
        const adminContagemEmpresaSelectorContainer = document.getElementById('adminContagemEmpresaSelectorContainer');
        const adminContagemEmpresaSelect = document.getElementById('adminContagemEmpresaSelect');
        const selectColaboradorContagem = document.getElementById('selectColaboradorContagem');
        const pesquisaProdutoInput = document.getElementById('pesquisaProduto');
        const pesquisaCodigoInput = document.getElementById('pesquisaCodigo');
        const filtroCategoriaSelect = document.getElementById('filtroCategoria'); 
        const inventoryTableBody = document.getElementById('inventoryTableBody');
        const modalPreviewContagem = document.getElementById('modalPreviewContagem'); 
        const previewContagemTableContainer = document.getElementById('previewContagemTableContainer'); 

        const empresaDashboardTitle = document.getElementById('empresaDashboardTitle');
        const empresaUserNameSpan = document.getElementById('empresaUserName');

        // --- FUNÇÕES UTILITÁRIAS ---
        function showLoader() { if (loadingIndicator) loadingIndicator.style.display = 'block'; }
        function hideLoader() { if (loadingIndicator) loadingIndicator.style.display = 'none'; }
        function generateNumericPassword(length = 6) { /* ... (Mantida) ... */ 
             let password = '';
            for (let i = 0; i < length; i++) {
                password += Math.floor(Math.random() * 10).toString();
            }
            return password;
        }

        async function populateEmpresasSelect(selectElementId, includeSpecialOption = false, specialOptionValue = "", specialOptionText = "-- Selecione --") {
            const selectEmp = document.getElementById(selectElementId);
            if (!selectEmp) { console.error(`Select de empresa ${selectElementId} não encontrado.`); return; }
            
            const currentValue = selectEmp.value; // Salva valor atual
            selectEmp.innerHTML = ''; 
            if (includeSpecialOption) {
                const opt = document.createElement('option');
                opt.value = specialOptionValue; 
                opt.textContent = specialOptionText;
                selectEmp.appendChild(opt);
            }
            // Usa empresasCache se já populado, senão busca.
            if (empresasCache.length === 0) {
                try {
                    const { data, error } = await _supabaseClient.from('empresas').select('id, nome_empresa').order('nome_empresa');
                    if (error) throw error;
                    empresasCache = data || [];
                } catch (e) {
                    console.error("Erro ao buscar empresas para select:", e);
                    return; 
                }
            }
            empresasCache.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.id;
                option.textContent = emp.nome_empresa;
                selectEmp.appendChild(option);
            });
            // Tenta restaurar valor
            if (Array.from(selectEmp.options).some(opt => opt.value === currentValue)) {
                selectEmp.value = currentValue;
            } else if (includeSpecialOption) {
                selectEmp.value = specialOptionValue;
            }
        }

        function showScreen(screenId, screenConfig = {}) { /* ... (Adaptada para novos seletores de admin) ... */ 
            hideLoader();
            Object.values(screens).forEach(screen => screen && screen.classList.remove('active'));
            
            if (screens[screenId]) {
                screens[screenId].classList.add('active');
                if (['adminEmpresas', 'adminCategorias', 'productManagement', 'inventoryCount', 'empresaColaboradores', 'historicoContagens'].includes(screenId)) {
                    mainContainer.classList.add('content-container');
                } else {
                    mainContainer.classList.remove('content-container');
                }

                // Esconde seletores de contexto do admin por padrão
                if(adminProdutoEmpresaSelectorContainer) adminProdutoEmpresaSelectorContainer.style.display = 'none';
                if(adminContagemEmpresaSelectorContainer) adminContagemEmpresaSelectorContainer.style.display = 'none';


                if (screenId === 'productManagement') {
                    productManagementTitle.textContent = screenConfig.title || 'Gerenciar Produtos';
                    productManagementContext.textContent = screenConfig.context || '';
                    productManagementBackButton.onclick = screenConfig.backAction || (() => showScreen(currentUser?.role === 'admin_master' ? 'adminMasterDashboard' : 'empresaDashboard'));
                    if (currentUser?.role === 'admin_master' && screenConfig.showEmpresaSelector) {
                        adminProdutoEmpresaSelectorContainer.style.display = 'block';
                    }
                } else if (screenId === 'inventoryCount') {
                    inventoryCountTitle.textContent = screenConfig.title || 'Balanço de Estoque';
                    inventoryCountContext.textContent = screenConfig.context || '';
                    inventoryCountBackButton.onclick = screenConfig.backAction || (() => showScreen(currentUser?.role === 'admin_master' ? 'adminMasterDashboard' : 'empresaDashboard'));
                     if (currentUser?.role === 'admin_master' && screenConfig.showEmpresaSelector) {
                        adminContagemEmpresaSelectorContainer.style.display = 'block';
                    }
                } else if (screenId === 'empresaDashboard' && currentUser) {
                    empresaDashboardTitle.textContent = `Painel: ${currentUser.empresa_nome || 'Minha Empresa'}`;
                    empresaUserNameSpan.textContent = currentUser.full_name || currentUser.email;
                } else if (screenId === 'adminMasterDashboard' && currentUser && adminMasterNameDisplay) {
                     adminMasterNameDisplay.textContent = currentUser.full_name || currentUser.email;   
                } else if (screenId === 'changePassword' && currentUser) {
                    changingPasswordForUserDisplay.textContent = currentUser.email;
                    currentPasswordGroup.style.display = 'none'; 
                    changePasswordBackButton.onclick = screenConfig.backAction || (() => showScreen(currentUser?.role === 'admin_master' ? 'adminMasterDashboard' : 'empresaDashboard'));
                }
            } else {
                console.error("Tela não encontrada:", screenId);
                showScreen('login'); 
            }
            window.scrollTo(0,0); 
        }
        
        // --- LÓGICA DE LOGIN E LOGOUT ---
        async function handleLogin() { /* ... (Mantida) ... */ }
        async function handleLogout() { /* ... (Mantida, com adminSelectedEmpresaId = null) ... */ }

        // --- PAINÉIS ---
        function showAdminMasterDashboardScreen() { adminSelectedEmpresaId = null; adminSelectedEmpresaParaCategoriaId = null; showScreen('adminMasterDashboard'); }
        async function showEmpresaDashboardScreen() { adminSelectedEmpresaId = null; showScreen('empresaDashboard');}
        
        // --- ADMIN: GERENCIAR EMPRESAS E SEUS LOGINS ---
        async function showAdminEmpresasScreen() { /* ... (Mantida) ... */ }
        async function fetchAndRenderEmpresas() { /* ... (Mantida) ... */ }
        async function handleAdminAddEmpresa() { /* ... (Mantida, atualiza empresasCache) ... */ }
        function openAdminDefineLoginEmpresa(empresaId, nomeEmpresa) { /* ... (Mantida) ... */ }
        function closeAdminDefineLoginEmpresaSection() { /* ... (Mantida) ... */ }
        async function handleAdminCreateOrUpdateEmpresaLogin() { /* ... (Mantida) ... */ }

        // --- ADMIN: GERENCIAR CATEGORIAS (Modificada para contexto de empresa) ---
        async function showAdminCategoriasScreen() {
            if (!currentUser || currentUser.role !== 'admin_master') { handleLogout(); return; }
            showLoader();
            adminSelectedEmpresaParaCategoriaId = null; // Reseta contexto
            await populateEmpresasSelect('adminCategoriaEmpresaSelect', true, "-- Categoria Global --"); 
            adminCategoriaEmpresaSelect.value = ""; // Garante que "Global" esteja selecionado ou nada
            await fetchAndRenderCategorias(); // Mostra todas (globais e de empresas) inicialmente ou com base no select
            hideLoader(); // Esconde o loader ANTES de mostrar a tela
            showScreen('adminCategorias');

            // Listener para quando o admin troca a empresa no select de categorias
            adminCategoriaEmpresaSelect.onchange = async () => {
                adminSelectedEmpresaParaCategoriaId = adminCategoriaEmpresaSelect.value || null; // "" para global
                await fetchAndRenderCategorias(adminSelectedEmpresaParaCategoriaId); // Recarrega categorias para o contexto
            };
            // Dispara para carregar o contexto inicial (categorias globais)
            if (adminCategoriaEmpresaSelect.onchange) adminCategoriaEmpresaSelect.onchange();
        }

        async function fetchAndRenderCategorias(filterEmpresaId = undefined) { // undefined para buscar todas inicialmente
            if (!adminCategoriasTableBody) { console.error("Tabela de categorias não encontrada."); return; }
            adminCategoriasTableBody.innerHTML = '<tr><td colspan="4">Carregando...</td></tr>';
            try {
                let query = _supabaseClient.from('categorias').select(`id, nome_categoria, created_at, empresa_id, empresas ( nome_empresa )`).order('nome_categoria');
                if (filterEmpresaId === null) { // Explicitamente global
                    query = query.is('empresa_id', null);
                } else if (filterEmpresaId) { // Empresa específica
                    query = query.eq('empresa_id', filterEmpresaId);
                }
                // Se filterEmpresaId for undefined, busca todas.

                const { data, error } = await query;
                if (error) throw error;
                
                // Não vamos mais popular o categoriasCache global aqui, pois ele deve ser contextual.
                // O cache de categorias para dropdowns será populado dinamicamente.
                // categoriasCache = data || []; // Removido daqui

                adminCategoriasTableBody.innerHTML = "";
                const categoriasExibidas = data || [];
                if (categoriasExibidas.length > 0) {
                    categoriasExibidas.forEach(cat => {
                        const row = adminCategoriasTableBody.insertRow();
                        row.insertCell().textContent = cat.nome_categoria;
                        row.insertCell().textContent = cat.empresas ? cat.empresas.nome_empresa : (cat.empresa_id ? 'Empresa ID: ' + cat.empresa_id.substring(0,4) : "Global");
                        row.insertCell().textContent = new Date(cat.created_at).toLocaleDateString('pt-BR');
                        const actionsCell = row.insertCell();
                        const btnDelete = document.createElement('button');
                        btnDelete.textContent = 'Deletar';
                        btnDelete.className = 'btn btn-danger table-actions';
                        btnDelete.onclick = () => handleAdminDeleteCategoria(cat.id, cat.nome_categoria);
                        actionsCell.appendChild(btnDelete);
                    });
                } else {
                    adminCategoriasTableBody.innerHTML = '<tr><td colspan="4">Nenhuma categoria encontrada para este filtro.</td></tr>';
                }
            } catch (e) {
                console.error("Erro ao buscar categorias:", e);
                adminCategoriasTableBody.innerHTML = `<tr><td colspan="4" style="color:var(--danger-color)">Erro: ${e.message}</td></tr>`;
            }
        }

        async function handleAdminAddCategoria() {
            const nomeCategoria = adminNomeCategoriaInput.value.trim();
            // Pega do select que o admin usou para definir o contexto desta categoria
            const empresaIdCtx = adminCategoriaEmpresaSelect.value === "" ? null : adminCategoriaEmpresaSelect.value;

            if (!nomeCategoria) { alert("Digite o nome da categoria."); adminNomeCategoriaInput.focus(); return; }
            showLoader();
            try {
                let queryCheck = _supabaseClient.from('categorias').select('id').ilike('nome_categoria', nomeCategoria);
                if (empresaIdCtx) {
                    queryCheck = queryCheck.eq('empresa_id', empresaIdCtx);
                } else {
                    queryCheck = queryCheck.is('empresa_id', null);
                }
                const { data: existing } = await queryCheck.single();

                if (existing) { 
                    alert(`Erro: Categoria "${nomeCategoria}" já existe ${empresaIdCtx ? 'para esta empresa' : 'como global'}.`); 
                    hideLoader(); return; 
                }

                const { error } = await _supabaseClient.from('categorias').insert([{ 
                    nome_categoria: nomeCategoria,
                    empresa_id: empresaIdCtx 
                }]);
                if (error) throw error;
                alert("Categoria adicionada!");
                adminNomeCategoriaInput.value = "";
                // Reseta o select para o contexto atual para que a lista seja atualizada corretamente.
                await fetchAndRenderCategorias(empresaIdCtx); 
                // Atualiza o cache global de categorias para dropdowns de produto
                const { data: cats } = await _supabaseClient.from('categorias').select('*').order('nome_categoria');
                if (cats) categoriasCache = cats; 

            } catch (e) {
                console.error("Erro ao adicionar categoria:", e);
                alert("Falha: " + e.message);
            } finally {
                hideLoader();
            }
        }
        async function handleAdminDeleteCategoria(categoriaId, nomeCategoria) { /* ... (Mantida da v2.7, mas atualiza cache global) ... */ 
            if (!confirm(`Deletar categoria "${nomeCategoria}"?`)) return;
            showLoader();
            try {
                const { error } = await _supabaseClient.from('categorias').delete().eq('id', categoriaId);
                if (error) throw error;
                alert(`Categoria "${nomeCategoria}" deletada.`);
                const empresaIdCtx = adminCategoriaEmpresaSelect.value === "" ? null : adminCategoriaEmpresaSelect.value;
                await fetchAndRenderCategorias(empresaIdCtx);
                // Atualiza o cache global de categorias
                const { data: cats } = await _supabaseClient.from('categorias').select('*').order('nome_categoria');
                if (cats) categoriasCache = cats; 
            } catch (e) { console.error("Erro ao deletar categoria:", e); alert("Falha: " + e.message);
            } finally { hideLoader(); }
        }
        

        // --- EMPRESA LOGADA: GERENCIAR COLABORADORES ---
        // (Funções mantidas como na v2.7)
        async function showEmpresaColaboradoresScreen() { /* ... */ }
        async function fetchAndRenderColaboradores(empresaId) { /* ... */ }
        async function handleAddColaborador() { /* ... */ }
        async function handleDeleteColaborador(colaboradorId, empresaId) { /* ... */ }

        // --- USUÁRIO DA EMPRESA: ALTERAR PRÓPRIA SENHA ---
        // (Funções mantidas como na v2.7)
        function showChangePasswordScreen_Empresa() { /* ... */ }
        async function handleChangePassword() { /* ... */ }

        // --- HISTÓRICO DE CONTAGENS (EMPRESA LOGADA) ---
        // (Funções mantidas como na v2.7)
        async function showHistoricoContagensScreen() { /* ... */ }
        async function fetchAndRenderHistoricoContagens(empresaId) { /* ... */ }
        function showDetalhesContagem(dadosContagem) { /* ... */ }
        function closeModalDetalhesContagem() { /* ... */ }


        // --- GERENCIAMENTO DE PRODUTOS (Adaptado para Admin Selecionar Empresa e Categorias Dinâmicas) ---
        async function populateCategoriaSelect_ProdutoForm(empresaIdContexto = null) {
            if (!prodCategoriaSelect) { console.error("Select de categoria de produto não encontrado."); return; }
            const currentValue = prodCategoriaSelect.value;
            prodCategoriaSelect.innerHTML = '<option value="">-- Sem Categoria --</option>';
            
            let categoriasDisponiveis = [];
            // Adiciona categorias globais (onde empresa_id é null)
            categoriasDisponiveis.push(...categoriasCache.filter(c => c.empresa_id === null));
            // Se houver um contexto de empresa, adiciona as categorias específicas dessa empresa
            if (empresaIdContexto) {
                categoriasDisponiveis.push(...categoriasCache.filter(c => c.empresa_id === empresaIdContexto));
            }
            
            // Remove duplicatas por nome_categoria e ordena
            const nomesUnicos = [...new Set(categoriasDisponiveis.map(c => c.nome_categoria))].sort();
            nomesUnicos.forEach(nomeCat => {
                const option = document.createElement('option');
                option.value = nomeCat;
                option.textContent = nomeCat;
                prodCategoriaSelect.appendChild(option);
            });

            if (Array.from(prodCategoriaSelect.options).some(opt => opt.value === currentValue)) {
                prodCategoriaSelect.value = currentValue;
            }
        }

        async function showProductManagementScreen_AdminGlobal() { 
            if (!currentUser || currentUser.role !== 'admin_master') { handleLogout(); return; }
            showLoader();
            adminSelectedEmpresaId = null; 
            await populateEmpresasSelect('adminProdutoEmpresaSelect', true, "-- Produtos Globais (Sem Empresa) --", ""); // "" para valor de global
            adminProdutoEmpresaSelect.value = ""; 
            
            await fetchProductsFromSupabase(null); // Busca produtos globais (empresa_id = null)
            await populateCategoriaSelect_ProdutoForm(null); // Popula com categorias globais
            
            hideLoader(); 
            showScreen('productManagement', { 
                title: 'Produtos (Admin)', 
                context: 'Gerenciando produtos globais. Selecione uma empresa para ver seus produtos.', 
                backAction: showAdminMasterDashboardScreen,
                showEmpresaSelector: true 
            });

            adminProdutoEmpresaSelect.onchange = async () => {
                adminSelectedEmpresaId = adminProdutoEmpresaSelect.value || null; // "" vira null
                showLoader();
                await fetchProductsFromSupabase(adminSelectedEmpresaId); 
                await populateCategoriaSelect_ProdutoForm(adminSelectedEmpresaId); 
                productManagementContext.textContent = adminSelectedEmpresaId 
                    ? `Gerenciando produtos para: ${empresasCache.find(e=>e.id === adminSelectedEmpresaId)?.nome_empresa}` 
                    : 'Gerenciando produtos globais (sem empresa).';
                hideLoader();
            };
        }
        async function showProductManagementScreen_Empresa() { /* ... (Mantida da v2.7, mas chama populateCategoriaSelect_ProdutoForm) ... */ 
            if (!currentUser || !currentUser.empresa_id) { handleLogout(); return; }
            showLoader();
            adminSelectedEmpresaId = currentUser.empresa_id; // Define contexto para o usuário da empresa
            await fetchProductsFromSupabase(currentUser.empresa_id); 
            await populateCategoriaSelect_ProdutoForm(currentUser.empresa_id); 
            hideLoader();
            showScreen('productManagement', { 
                title: `Produtos: ${currentUser.empresa_nome}`, 
                context: 'Produtos pertencentes à sua empresa.', 
                backAction: showEmpresaDashboardScreen,
                showEmpresaSelector: false 
            });
        }
        async function fetchProductsFromSupabase(empresaIdFiltro = null) { // Renomeado para clareza
            showLoader();
            try {
                let query = _supabaseClient.from('produtos').select('*, empresas(nome_empresa)').order('produto'); 
                if (empresaIdFiltro) { 
                    query = query.eq('empresa_id', empresaIdFiltro);
                } else { // Se empresaIdFiltro é null, buscar apenas produtos globais (empresa_id IS NULL)
                    query = query.is('empresa_id', null);
                }
                // Exceção: se for admin e não houver empresaIdFiltro E adminSelectedEmpresaId for undefined (significando que ele não quer filtrar por empresa ainda, mas está na tela global)
                // Esta lógica precisa ser refinada se o admin global puder ver *todos* os produtos de todas as empresas numa única lista.
                // Por agora: ou é de uma empresa específica, ou são os globais (empresa_id IS NULL).

                const { data, error } = await query;
                if (error) throw error;
                produtosCache = data || []; 
            } catch (e) {
                console.error('Erro buscar produtos:', e); alert('Falha: ' + e.message); produtosCache = [];
            } finally {
                renderProductManagementTable(); 
                if (document.getElementById('filtroCategoria')) {
                    populateCategoryFilter('filtroCategoria'); 
                }
                hideLoader(); 
            }
        }
        function renderProductManagementTable() { /* ... (Mantida da v2.7) ... */ }
        async function handleAddProduct() { /* ... (Adaptada da v2.7 para usar adminSelectedEmpresaId ou currentUser.empresa_id) ... */
            const codigo = prodCodigoInput.value.trim(); 
            const nome = prodNomeInput.value.trim();
            const categoriaSelecionada = prodCategoriaSelect.value || null; 

            if (!codigo || !nome) { alert("Preencha Código e Produto."); return; }
            
            let empresaIdParaProduto = null;
            if (currentUser?.role === 'empresa_login_principal' && currentUser.empresa_id) {
                empresaIdParaProduto = currentUser.empresa_id;
            } else if (currentUser?.role === 'admin_master') {
                empresaIdParaProduto = adminSelectedEmpresaId; // Vem do select que o admin usou
                // Se adminSelectedEmpresaId for null, o produto é global.
                if (empresaIdParaProduto === null && !confirm("Admin: Adicionar este produto como GLOBAL (sem vínculo com empresa)?")) {
                    return; // Admin cancelou adição de produto global
                }
            } else { alert("Usuário não autorizado."); return; }

            showLoader();
            try {
                const { data, error } = await _supabaseClient.from('produtos')
                    .insert([{ codigo, produto: nome, categoria: categoriaSelecionada, empresa_id: empresaIdParaProduto }])
                    .select('*, empresas (nome_empresa)'); 
                if (error) throw error;
                
                // Atualiza o cache e re-renderiza
                await fetchProductsFromSupabase(empresaIdParaProduto); 
                
                prodCodigoInput.value = ""; prodNomeInput.value = ""; prodCategoriaSelect.value = "";
                prodCodigoInput.focus(); alert('Produto adicionado!');
            } catch (e) {
                console.error('Erro add produto:', e);
                if (e.message.includes('violates unique constraint')) { 
                    alert('Erro: Produto com este código já existe para este contexto/empresa.');
                } else if (e.message.includes('null value in column "empresa_id" violates not-null constraint')) {
                    alert('Erro: Produto precisa ser associado a uma empresa.');
                } else { alert('Falha: ' + e.message); }
            } finally { hideLoader(); }
        }
        async function handleRemoveProduct(idOuCodigo) { /* ... (Mantida da v2.7, mas usa fetchProducts para recarregar) ... */ }
        async function handleXLSXImport() { /* ... (Adaptada da v2.7 para usar adminSelectedEmpresaId ou currentUser.empresa_id) ... */ 
            if (!xlsxFileInput?.files?.length) { alert("Selecione um arquivo XLSX."); return; }
            const file = xlsxFileInput.files[0];
            showLoader();
            const reader = new FileReader(); 
            reader.onload = async function(event) { 
                try {
                    const wb = XLSX.read(new Uint8Array(event.target.result), { type: 'array' }); 
                    const ws = wb.Sheets[wb.SheetNames[0]]; 
                    const jsonData = XLSX.utils.sheet_to_json(ws, { raw: false, defval:null });
                    if (jsonData.length === 0) { alert("XLSX vazio."); hideLoader(); return; }
                    
                    let empresaIdParaImport = null;
                    if (currentUser?.role === 'empresa_login_principal') empresaIdParaImport = currentUser.empresa_id;
                    else if (currentUser?.role === 'admin_master') {
                        empresaIdParaImport = adminSelectedEmpresaId; // Pega do select do admin
                        if (!empresaIdParaImport && !confirm("Admin: Nenhuma empresa selecionada. Importar produtos como GLOBAIS?")) { 
                            hideLoader(); return; 
                        }
                    } else { alert("Usuário não autorizado."); hideLoader(); return; }

                    const productsToInsert = jsonData.map(item => {
                        const codigo = item.codigo || item.Código; 
                        const produtoNome = item.produto || item.Produto; 
                        let categoria = item.categoria || item.Categoria || null; 
                        if (categoria && typeof categoria === 'string' && categoria.trim() === "") categoria = null; 

                        if (codigo != null && produtoNome != null) {
                            return { codigo: String(codigo).trim(), produto: String(produtoNome).trim(), categoria: categoria ? String(categoria).trim() : null, empresa_id: empresaIdParaImport };
                        } return null;
                    }).filter(Boolean);

                    if (productsToInsert.length === 0) { alert("Nenhum produto válido no XLSX."); hideLoader(); return; }
                    
                    const { error } = await _supabaseClient.from('produtos').insert(productsToInsert);
                    if (error) {
                         if (error.message.includes('violates unique constraint')) { 
                            throw new Error('Um ou mais produtos no arquivo já existem com o mesmo código para este contexto/empresa.');
                        } else if (error.message.includes('null value in column "empresa_id" violates not-null constraint')) {
                            throw new Error('Os produtos importados precisam ser associados a uma empresa.');
                        }
                        throw error; 
                    }
                    
                    await fetchProductsFromSupabase(empresaIdParaImport); 
                    alert(`${productsToInsert.length} produto(s) importado(s)!`);
                    if (xlsxFileInput) xlsxFileInput.value = ""; 
                } catch (e) { console.error("Erro XLSX:", e); alert("Erro ao importar: " + e.message);
                } finally { hideLoader(); }
            };
            reader.readAsArrayBuffer(file); 
        }


        // --- CONTAGEM DE ESTOQUE (Adaptado para Admin Selecionar Empresa e Pré-visualização) ---
        async function showInventoryCountScreen_AdminGlobal() { 
            if (!currentUser || currentUser.role !== 'admin_master') { handleLogout(); return; }
            showLoader();
            adminSelectedEmpresaId = null; 
            await populateEmpresasSelect('adminContagemEmpresaSelect', true, "-- Contagem Global (Sem Empresa) --", "");
            adminContagemEmpresaSelect.value = ""; 
            
            produtosCache = []; colaboradoresCache = []; // Limpa caches antes de selecionar empresa
            renderInventoryTableBasedOnSelection(); 
            populateColaboradoresSelectForContagem(null, true); // True para popular com admin se global

            hideLoader();
            showScreen('inventoryCount', { 
                title: 'Contagem de Estoque (Admin)', 
                context: 'Selecione uma empresa para iniciar a contagem, ou faça uma contagem global.', 
                backAction: showAdminMasterDashboardScreen,
                showEmpresaSelector: true 
            });
            
            adminContagemEmpresaSelect.onchange = async () => {
                adminSelectedEmpresaId = adminContagemEmpresaSelect.value || null; // "" vira null
                showLoader();
                const empresaContextId = adminSelectedEmpresaId; // ID da empresa para buscar, ou null se for global
                await fetchProductsFromSupabase(empresaContextId); 
                await loadColaboradoresParaContagem(empresaContextId, !empresaContextId); // Se for global, popula com admin
                
                const contextText = empresaContextId 
                    ? `Contagem para: ${empresasCache.find(e=>e.id === empresaContextId)?.nome_empresa}` 
                    : 'Contagem global (produtos sem empresa).';
                if(inventoryCountContext) inventoryCountContext.textContent = contextText;
                
                renderInventoryTableBasedOnSelection(); 
                hideLoader();
            };
             if (adminContagemEmpresaSelect.onchange) adminContagemEmpresaSelect.onchange(); // Chama para estado inicial
        }
        async function showInventoryCountScreen_Empresa() { /* ... (Mantida da v2.7, mas chama loadColaboradoresParaContagem) ... */ 
             if (!currentUser || !currentUser.empresa_id) { handleLogout(); return; }
            showLoader();
            adminSelectedEmpresaId = currentUser.empresa_id; 
            await fetchProductsFromSupabase(currentUser.empresa_id);
            await loadColaboradoresParaContagem(currentUser.empresa_id, false); // False para não popular com admin
            hideLoader();
            showScreen('inventoryCount', { 
                title: `Balanço: ${currentUser.empresa_nome}`, 
                context: 'Contagem dos produtos da sua empresa.', 
                backAction: showEmpresaDashboardScreen,
                showEmpresaSelector: false 
            });
            renderInventoryTableBasedOnSelection();
        }
        
        function renderInventoryTableBasedOnSelection() { 
            populateCategoryFilter('filtroCategoria'); 
            filterInventoryProducts(); 
        }

        async function loadColaboradoresParaContagem(empresaId, isGlobalAdminContext = false) { 
            if (!selectColaboradorContagem) return;
            selectColaboradorContagem.innerHTML = '<option value="">-- Selecione o Colaborador --</option>';
            colaboradoresCache = [];

            if (isGlobalAdminContext && currentUser?.role === 'admin_master') { 
                const option = document.createElement('option');
                option.value = currentUser.email; 
                option.textContent = "Admin Master (Contagem Global)";
                selectColaboradorContagem.appendChild(option);
                selectColaboradorContagem.value = currentUser.email; 
                return;
            }
            if (!empresaId) return; 

            try {
                const { data, error } = await _supabaseClient
                    .from('colaboradores').select('id, nome_colaborador').eq('empresa_id', empresaId).eq('ativo', true).order('nome_colaborador');
                if (error) throw error;
                colaboradoresCache = data || [];
                colaboradoresCache.forEach(col => {
                    const option = document.createElement('option');
                    option.value = col.id; option.textContent = col.nome_colaborador;
                    selectColaboradorContagem.appendChild(option);
                });
            } catch (e) { console.error("Erro ao carregar colaboradores:", e); }
        }
        function saveQuantities() { localStorage.setItem('balancoQuantities_v2.8', JSON.stringify(quantidadesDigitadas)); } // v2.8
        function loadQuantities() {
            const stored = localStorage.getItem('balancoQuantities_v2.8'); 
            quantidadesDigitadas = stored ? JSON.parse(stored) : {};
        }
        function populateCategoryFilter(selectElementId = 'filtroCategoria') { /* ... (Mantida da v2.7) ... */ }
        function displayInventoryProducts(listaProdutos) { /* ... (Mantida da v2.7) ... */ }
        function filterInventoryProducts() { /* ... (Mantida da v2.7) ... */ }
        function clearAllQuantities() { /* ... (Mantida da v2.7, com chave contextual) ... */ 
            if (confirm("Limpar todas as quantidades desta contagem?")) {
                const currentContextEmpresaId = adminSelectedEmpresaId || currentUser?.empresa_id || null;
                const suffixKeyFragment = currentContextEmpresaId ? `_${currentContextEmpresaId}` : '_global';
                
                Object.keys(quantidadesDigitadas).forEach(key => {
                    if (key.endsWith(suffixKeyFragment)) {
                        delete quantidadesDigitadas[key];
                    }
                });
                saveQuantities(); 
                filterInventoryProducts(); 
                alert("Quantidades limpas para o contexto atual.");
            }
        }
        function showPreviewContagem() { /* ... (Mantida da v2.7) ... */ 
            if (!modalPreviewContagem || !previewContagemTableContainer) return;
            const tbody = previewContagemTableContainer.querySelector('table tbody');
            tbody.innerHTML = ""; 

            let foundData = false;
            const itemsParaPreview = [];
            const currentContextEmpresaId = adminSelectedEmpresaId || currentUser?.empresa_id || null;

            produtosCache.forEach(produto => { // Itera sobre o produtosCache atual (já filtrado para o contexto)
                const qtyKey = produto.codigo + (produto.empresa_id ? '_' + produto.empresa_id : '_global');
                // Garante que a chave da quantidade corresponda ao produto E ao contexto da empresa
                const correspondeAoContexto = (produto.empresa_id === currentContextEmpresaId) || (produto.empresa_id === null && currentContextEmpresaId === null)

                if (correspondeAoContexto) {
                    const quantidade = parseFloat(quantidadesDigitadas[qtyKey]);
                    if (!isNaN(quantidade) && quantidade > 0) {
                        itemsParaPreview.push({ ...produto, quantidadeDigitada: quantidade });
                        foundData = true;
                    }
                }
            });

            if (!foundData) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Nenhuma quantidade inserida ainda.</td></tr>';
            } else {
                itemsParaPreview.sort((a,b) => String(a.codigo).localeCompare(String(b.codigo))).forEach(item => {
                    const row = tbody.insertRow();
                    row.insertCell().textContent = item.codigo;
                    row.insertCell().textContent = item.produto;
                    row.insertCell().textContent = item.categoria || "--";
                    row.insertCell().textContent = item.quantidadeDigitada;
                });
            }
            modalPreviewContagem.classList.add('active');
        }
        function closeModalPreviewContagem() { /* ... (Mantida da v2.7) ... */ }
        async function gerarArquivoTXT() { /* ... (Adaptada da v2.7, para usar adminSelectedEmpresaId) ... */
            let conteudoArquivo = ""; let hasInvalidQuantity = false; let foundData = false; 
            const dadosContagemParaHistorico = [];
            const colaboradorSelecionadoIdOuEmail = selectColaboradorContagem.value;
            
            // Determina a empresaId para o histórico e para a chave de quantidade
            let empresaIdParaHistorico = null;
            let empresaNomeParaHistorico = "GLOBAL";

            if (currentUser?.role === 'empresa_login_principal' && currentUser.empresa_id) {
                empresaIdParaHistorico = currentUser.empresa_id;
                empresaNomeParaHistorico = currentUser.empresa_nome;
            } else if (currentUser?.role === 'admin_master' && adminSelectedEmpresaId) {
                empresaIdParaHistorico = adminSelectedEmpresaId;
                const empresaSelecionada = empresasCache.find(e => e.id === adminSelectedEmpresaId);
                if (empresaSelecionada) empresaNomeParaHistorico = empresaSelecionada.nome_empresa;
            }
            
            if (!colaboradorSelecionadoIdOuEmail) {
                 alert("Selecione o colaborador/responsável."); selectColaboradorContagem.focus(); return;
            }
            
            produtosCache.forEach(produto => {
                const qtyKey = produto.codigo + (produto.empresa_id ? '_' + produto.empresa_id : '_global');
                const quantidadeStr = quantidadesDigitadas[qtyKey];
                if (quantidadeStr && quantidadeStr.trim() !== "") { 
                    foundData = true; const numQuantidade = parseFloat(quantidadeStr);
                    if (!isNaN(numQuantidade) && numQuantidade >= 0) { 
                        if (numQuantidade > 0) {
                            conteudoArquivo += `${produto.codigo};${numQuantidade}\n`; 
                            dadosContagemParaHistorico.push({
                                codigo: produto.codigo, produto: produto.produto, categoria: produto.categoria,
                                quantidade: numQuantidade, empresa_id: produto.empresa_id 
                            });
                        }
                    } else {
                        alert(`Qtd inválida ("${quantidadeStr}") para ${produto.codigo}.`); hasInvalidQuantity = true; 
                    }
                }
            });
            if (hasInvalidQuantity) return; 
            if (!foundData || dadosContagemParaHistorico.length === 0) { alert("Nenhuma quantidade positiva inserida."); return; }

            showLoader();
            try {
                // Salva no histórico APENAS se for uma contagem de empresa (empresaIdParaHistorico não é null)
                // E se o colaboradorSelecionadoIdOuEmail for um UUID (colaborador) e não um email (admin)
                if (empresaIdParaHistorico && colaboradorSelecionadoIdOuEmail && !colaboradorSelecionadoIdOuEmail.includes('@')) {
                     const { error: histError } = await _supabaseClient.from('historico_contagens').insert({
                        empresa_id: empresaIdParaHistorico,
                        colaborador_id: colaboradorSelecionadoIdOuEmail, // Aqui deve ser o ID do colaborador
                        dados_contagem_json: dadosContagemParaHistorico 
                    });
                    if (histError) throw histError;
                    alert("Histórico da contagem salvo!");
                } else {
                     console.log("Contagem global do Admin ou colaborador não é UUID. TXT gerado, sem salvar no histórico de empresas.");
                }

                const dataAtual = new Date(); const dia = String(dataAtual.getDate()).padStart(2, '0');
                const mes = String(dataAtual.getMonth() + 1).padStart(2, '0'); const ano = dataAtual.getFullYear();
                const nomeContexto = empresaNomeParaHistorico.replace(/\s+/g, '_');
                const nomeArquivo = `balanco_${nomeContexto}_${dia}-${mes}-${ano}.txt`;
                const elementoLink = document.createElement('a');
                elementoLink.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(conteudoArquivo));
                elementoLink.setAttribute('download', nomeArquivo);
                elementoLink.style.display = 'none'; document.body.appendChild(elementoLink);
                elementoLink.click(); document.body.removeChild(elementoLink); 
                alert(`Arquivo "${nomeArquivo}" gerado!`);
            } catch (e) {
                console.error("Erro ao salvar histórico/gerar TXT:", e);
                alert("Erro: " + e.message);
            } finally { hideLoader(); }
        }
        
        // --- INICIALIZAÇÃO ---
        window.onload = async () => { /* ... (Mantida da v2.7, carrega empresas e categorias globais) ... */ }

    </script>
</body>
</html>