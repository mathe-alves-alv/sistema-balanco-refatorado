<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Balance System - v2.10.2 (User Role Fixes)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            /* Light Theme - Adjusted */
            --primary-color: #007bff;
            --primary-color-darker: #0069d9;
            --secondary-color: #6c757d;
            --secondary-color-darker: #5a6268;
            --success-color: #198754;
            --success-color-darker: #157347;
            --danger-color: #dc3545;
            --danger-color-darker: #bb2d3b;
            --warning-color: #ffc107;
            --warning-color-darker: #ffb300;
            --info-color: #0dcaf0;
            --info-color-darker: #0aa9c6;
            --background-color: #f4f6f9;
            --container-bg-color: #ffffff;
            --card-bg-color: #ffffff;
            --header-bg-color: #f8f9fa;
            --input-bg-color: #ffffff;
            --input-border-color: #ced4da;
            --text-color: #212529;
            --text-muted-color: #6c757d;
            --text-on-primary-color: #ffffff;
            --text-on-secondary-color: #ffffff;
            --text-on-success-color: #ffffff;
            --text-on-danger-color: #ffffff;
            --text-on-warning-color: #000000;
            --text-on-info-color: #000000;
            --border-color: #dee2e6;
            --hover-row-background: #e9ecef;
            --border-radius: 0.375rem;
            --box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            --box-shadow-lg: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;margin:0;padding:20px 0;background-color:var(--background-color);color:var(--text-color);display:flex;flex-direction:column;align-items:center;min-height:100vh;line-height:1.5;font-size:1rem}
        .container{width:95%;max-width:600px;background-color:var(--container-bg-color);padding:25px 30px;border-radius:var(--border-radius);box-shadow:var(--box-shadow);margin-top:20px;margin-bottom:20px;border:1px solid var(--border-color)}
        .content-container{max-width:1140px} /* Used for wider screens like tables */
        h1,h2,h3{color:var(--text-color);text-align:center;margin-top:0;margin-bottom:1.5rem;font-weight:500}
        h1{font-size:2rem}h2{font-size:1.75rem}h3{font-size:1.5rem;margin-bottom:1rem}
        .screen { display: none !important; opacity: 0 !important; visibility: hidden !important; min-height: 300px; }
        .screen.active { display: block !important; opacity: 1 !important; visibility: visible !important; animation: fadeInView .4s ease-out; }
        @keyframes fadeInView{ from{opacity:0; transform: translateY(10px);} to{opacity:1; transform: translateY(0);} }
        button,.btn{border:1px solid transparent;padding:.5rem 1rem;text-align:center;text-decoration:none;display:inline-block;font-size:1rem;font-weight:400;line-height:1.5;border-radius:var(--border-radius);cursor:pointer;transition:color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;margin:.25rem}
        button:hover,.btn:hover{text-decoration:none;transform:translateY(-1px);box-shadow:var(--box-shadow-lg)}
        button:active,.btn:active{transform:translateY(0);}
        button:focus-visible,.btn:focus-visible{outline:2px solid var(--primary-color);outline-offset:2px}
        button:disabled, .btn:disabled { background-color: #adb5bd; border-color: #adb5bd; color: #f8f9fa; cursor: not-allowed; transform: none; box-shadow: none;}
        .btn-primary{background-color:var(--primary-color);border-color:var(--primary-color);color:var(--text-on-primary-color)}.btn-primary:hover:not(:disabled){background-color:var(--primary-color-darker);border-color:var(--primary-color-darker)}
        .btn-secondary{background-color:var(--secondary-color);border-color:var(--secondary-color);color:var(--text-on-secondary-color)}.btn-secondary:hover:not(:disabled){background-color:var(--secondary-color-darker);border-color:var(--secondary-color-darker)}
        .btn-success{background-color:var(--success-color);border-color:var(--success-color);color:var(--text-on-success-color)}.btn-success:hover:not(:disabled){background-color:var(--success-color-darker);border-color:var(--success-color-darker)}
        .btn-danger{background-color:var(--danger-color);border-color:var(--danger-color);color:var(--text-on-danger-color)}.btn-danger:hover:not(:disabled){background-color:var(--danger-color-darker);border-color:var(--danger-color-darker)}
        .btn-warning{background-color:var(--warning-color);border-color:var(--warning-color);color:var(--text-on-warning-color)}.btn-warning:hover:not(:disabled){background-color:var(--warning-color-darker);border-color:var(--warning-color-darker)}
        .btn-info{background-color:var(--info-color);border-color:var(--info-color);color:var(--text-on-info-color);}.btn-info:hover:not(:disabled){background-color:var(--info-color-darker);border-color:var(--info-color-darker);}
        .dashboard-options{display:flex;flex-direction:column;align-items:stretch;gap:1rem;padding:1rem 0}
        .dashboard-options .btn{padding:.75rem 1rem;font-size:1.05rem;width:100%}
        .card{border:1px solid var(--border-color);border-radius:var(--border-radius);margin-bottom:1.5rem;box-shadow:var(--box-shadow);background-color:var(--card-bg-color)}
        .card-header{padding:.75rem 1.25rem;margin-bottom:0;background-color:var(--header-bg-color);border-bottom:1px solid var(--border-color);border-top-left-radius:calc(var(--border-radius) - 1px);border-top-right-radius:calc(var(--border-radius) - 1px)}
        .card-header>*{margin:0;font-size:1.25rem;font-weight:500;color:var(--text-color);text-align:left}
        .card-body{padding:1.25rem}
        table{width:100%;border-collapse:collapse;margin-bottom:1rem;color:var(--text-color); }
        th,td{border:1px solid var(--border-color);padding:.75rem;text-align:left;vertical-align:middle}
        th{background-color:var(--header-bg-color);font-weight:500;border-bottom-width:2px}
        tbody tr:nth-child(odd){background-color:var(--container-bg-color); }
        tbody tr:nth-child(even){background-color: #f1f3f5; }
        tbody tr:hover{background-color:var(--hover-row-background); }
        input[type=text],input[type=number],input[type=password],input[type=email],select,input[type=file]{width:100%;padding:.5rem .75rem;margin-bottom:1rem;border:1px solid var(--input-border-color);border-radius:var(--border-radius);box-sizing:border-box;font-size:1rem;line-height:1.5;background-color:var(--input-bg-color);color:var(--text-color);background-clip:padding-box;transition:border-color .15s ease-in-out,box-shadow .15s ease-in-out}
        input[type=text]::placeholder,input[type=number]::placeholder,input[type=password]::placeholder,input[type=email]::placeholder{color:var(--text-muted-color);opacity:1}
        input[type=text]:focus,input[type=number]:focus,input[type=password]:focus,input[type=email]:focus,select:focus{border-color:var(--primary-color);outline:0;box-shadow:0 0 0 .25rem rgba(13,110,253,.25)}
        input[type=file]{padding:.375rem .75rem}
        select{appearance:none;background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23212529' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");background-repeat:no-repeat;background-position:right .75rem center;background-size:16px 12px}
        .form-group{margin-bottom:1rem}
        .form-group label{display:block;margin-bottom:.5rem;font-weight:500;color:var(--text-color); }
        .filter-controls,.product-management-form-fields,.xlsx-import-section,.actions-bar,.sub-form-section{margin-bottom:1.5rem;padding:1rem;background-color:var(--card-bg-color);border:1px solid var(--border-color);border-radius:var(--border-radius)}
        .product-management-form-fields .form-group{margin-bottom:0}
        .filter-controls>div{flex:1;min-width:200px}
        .filter-controls input,.filter-controls select{margin-bottom:0}
        .xlsx-import-section input[type=file]{width:auto;margin-right:.5rem}
        .actions-bar{text-align:center;padding:1rem 0; background-color: transparent; border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); }
        .actions-bar .btn{margin:0 .25rem}
        #productManagementTable td:last-child,#inventoryTable td:last-child,#adminEmpresasTable td:last-child, #colaboradoresTable td:last-child, #historicoContagensTable td:last-child, #categoriasTable td:last-child, #adminEmpresaUsersTable td:last-child {text-align:center}
        #inventoryTable input[type=number]{max-width:80px;text-align:right;padding:.375rem .5rem;font-size:.9rem}
        .back-button{margin-bottom:1.5rem;display:inline-block}
        .modal-overlay { position: fixed !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; background-color: rgba(0,0,0,0.4) !important; display: flex !important; justify-content: center !important; align-items: center !important; z-index: 10000 !important; opacity: 0 !important; visibility: hidden !important; transition: opacity 0.2s ease, visibility 0.2s ease !important; }
        .modal-overlay.active { opacity: 1 !important; visibility: visible !important; }
        .modal-content { background-color: var(--container-bg-color); color: var(--text-color); padding: 20px 25px; border-radius: var(--border-radius); box-shadow: var(--box-shadow-lg); width: 90%; max-width: 500px; text-align: left; border: 1px solid var(--border-color); transform: translateY(-20px) scale(0.95); transition: transform 0.2s ease, opacity 0.2s ease; opacity: 0;}
        .modal-overlay.active .modal-content { transform: translateY(0) scale(1); opacity: 1;}
        .modal-content h4 { color: var(--text-color); margin-bottom: 1rem; font-size: 1.25rem; text-align: center;}
        .modal-content p { color: var(--text-muted-color); margin-bottom: 1rem; font-size: 0.95rem; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem; }
        .login-form{max-width:400px;margin:1.5rem auto; padding: 2rem; background-color: var(--container-bg-color); border-radius: var(--border-radius); box-shadow: var(--box-shadow);}
        .login-form .form-group{margin-bottom:1rem}
        .login-form button{width:100%;padding:.75rem;font-size:1.05em}
        #loginErrorMessage{color:var(--danger-color);margin-top:1rem;text-align:center;display:none}
        .sub-form-section h4{text-align:left;font-size:1.1rem;color:var(--text-color);margin-bottom:1rem;border-bottom:1px solid var(--border-color);padding-bottom:.5rem}
        .table-actions button,.table-actions .btn{margin:0 2px;padding:.25rem .5rem;font-size:.85rem}
        .generated-password-display { margin-top: 10px; padding: 10px; background-color: #e9ecef; border: 1px dashed var(--border-color); border-radius: var(--border-radius); word-break: break-all; color: var(--text-color); font-family: monospace; text-align: center;}
        .password-change-form { max-width: 450px; margin: 1.5rem auto; }
        .form-inline-flex { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 1rem;}
        .form-inline-flex .form-group { flex: 1; margin-bottom: 0;}
        .form-inline-flex button { flex-shrink: 0; }
        #previewContagemTable { width: 100%; margin-top: 1rem; }
        #previewContagemTable th, #previewContagemTable td { font-size: 0.9rem; padding: 0.5rem; }
        .admin-context-selector { margin-bottom: 1.5rem; padding: 1rem; background-color: var(--header-bg-color); border-radius: var(--border-radius); }
        .admin-context-selector label { margin-right: 0.5rem; font-weight: 500;}
        .admin-context-selector select { display: inline-block; width: auto; min-width: 250px; margin-right: 10px; }
        .loader { border: 5px solid #e9ecef; border-top: 5px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        #adminManageUsersEmpresaContent { margin-top: 1rem; } /* Renamed from adminManageLoginEmpresaContent */
        #adminManageUsersEmpresaContent p { margin-bottom: 0.5rem; }
        #adminManageUsersEmpresaContent .form-group { margin-top: 1rem; }
        #adminEmpresaUsersTable th, #adminEmpresaUsersTable td { font-size: 0.9em; padding: 0.5rem;}
    </style>
</head>
<body>
    <div id="mainContainer" class="container">
        <div id="loadingIndicator" class="loader" style="display:none;"></div>

        <div id="screenLogin" class="screen active">
            <h1>Login no Sistema de Balanço</h1>
            <div class="login-form card card-body">
                <div class="form-group"><label for="loginEmail">Email:</label><input type="email" id="loginEmail" placeholder="seuemail@exemplo.com" autocomplete="email"></div>
                <div class="form-group"><label for="loginPassword">Senha:</label><input type="password" id="loginPassword" placeholder="Sua senha" autocomplete="current-password"></div>
                <button class="btn btn-primary" id="loginButton">Entrar</button>
                <div id="loginErrorMessage"></div>
            </div>
        </div>

        <div id="screenAdminMasterDashboard" class="screen">
            <h2>Painel Admin Master</h2>
            <p style="text-align: center;">Bem-vindo, <span id="adminMasterNameDisplay">Admin Master</span>!</p>
            <div class="dashboard-options">
                <button class="btn btn-primary" id="btnAdminGerenciarEmpresas">Gerenciar Empresas & Seus Usuários</button>
                <button class="btn btn-primary" id="btnAdminGerenciarCategorias">Gerenciar Categorias (Admin)</button>
                <button class="btn btn-primary" id="btnAdminGerenciarProdutos">Gerenciar Produtos (Admin)</button>
                <button class="btn btn-primary" id="btnAdminContagemEstoque">Contagem de Estoque (Admin)</button>
                <button class="btn btn-info" id="btnAdminHistoricoContagens">Histórico de Contagens (Admin)</button>
                <button class="btn btn-secondary" id="btnLogoutAdmin">Logout</button>
            </div>
        </div>

        <div id="screenEmpresaDashboard" class="screen">
            <h2 id="empresaDashboardTitle">Painel da Empresa</h2>
            <p style="text-align: center;">Logado como: <span id="empresaUserName"></span> (<span id="empresaUserRoleDisplay"></span>)</p>
            <div class="dashboard-options">
                <button class="btn btn-primary" id="btnEmpresaGerenciarColaboradores" data-role-req="empresa_manager">Gerenciar Colaboradores</button>
                <button class="btn btn-primary" id="btnEmpresaGerenciarCategorias" data-role-req="empresa_manager">Gerenciar Categorias da Empresa</button>
                <button class="btn btn-primary" id="btnEmpresaGerenciarProdutos" data-role-req="empresa_manager">Gerenciar Produtos da Empresa</button>
                <button class="btn btn-primary" id="btnEmpresaContagemEstoque">Iniciar Contagem da Empresa</button>
                <button class="btn btn-info" id="btnEmpresaHistoricoContagens" data-role-req="empresa_manager">Ver Histórico de Contagens</button>
                <button class="btn btn-info" id="btnEmpresaAlterarSenha" data-role-req="empresa_manager">Alterar Senha Pessoal</button>
                <button class="btn btn-secondary" id="btnLogoutEmpresa">Logout</button>
            </div>
        </div>

        <div id="screenAdminCategorias" class="screen">
            <button class="btn btn-secondary back-button" id="btnCategoriasVoltar"> &larr; Voltar ao Painel</button>
            <h2 id="categoriasTitle">Gerenciar Categorias</h2>
            <div class="card">
                <div class="card-header"><h3>Adicionar Nova Categoria</h3></div>
                <div class="card-body">
                    <div class="form-group" id="adminCategoriaEmpresaSelectContainer">
                        <label for="adminCategoriaEmpresaSelect">Gerenciar Categorias Para Empresa:</label>
                        <select id="adminCategoriaEmpresaSelect">
                            <option value="">-- Selecione uma Empresa --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="nomeCategoriaInput">Nome da Nova Categoria:</label>
                        <input type="text" id="nomeCategoriaInput" placeholder="Ex: Bolos, Salgados, Bebidas">
                    </div>
                    <button class="btn btn-success" id="btnAddCategoria" disabled>Adicionar Categoria</button>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><h3>Categorias Cadastradas</h3></div>
                <div class="card-body">
                    <p id="categoriasContext" style="text-align:center; font-size:0.9em; color:var(--text-muted-color); margin-bottom: 1rem;"></p>
                    <table id="categoriasTable">
                        <thead><tr><th>Nome da Categoria</th><th id="thCategoriaEmpresaScope">Empresa</th><th>Criação</th><th>Ações</th></tr></thead>
                        <tbody id="categoriasTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="screenAdminEmpresas" class="screen">
             <button class="btn btn-secondary back-button" id="btnAdminEmpresasVoltar">&larr; Painel Admin</button>
            <h2>Gerenciar Empresas e Seus Usuários</h2>
            <div class="card"><div class="card-header"><h3>Adicionar Nova Empresa</h3></div><div class="card-body"><div class="form-group"><label for="adminNomeEmpresa">Nome da Empresa:</label><input type="text" id="adminNomeEmpresa" placeholder="Nome da nova empresa"></div><button class="btn btn-success" id="btnAdminAddEmpresa">Adicionar Empresa</button></div></div>
            <div class="card"><div class="card-header"><h3>Empresas Cadastradas</h3></div><div class="card-body"><table id="adminEmpresasTable"><thead><tr><th>Nome da Empresa</th><th>Criação</th><th style="min-width: 280px;">Ações da Empresa</th></tr></thead><tbody id="adminEmpresasTableBody"></tbody></table></div></div>

            <div id="adminManageUsersEmpresaSection" class="card" style="display:none; margin-top: 2rem;">
                <div class="card-header"><h3 id="adminManageUsersEmpresaTitle">Gerenciar Usuários para Empresa</h3></div>
                <div class="card-body">
                    <input type="hidden" id="selectedEmpresaIdForUserManage">
                    <input type="hidden" id="selectedEmpresaNameForUserManage">
                    <h4>Usuários Existentes</h4>
                    <div style="max-height: 300px; overflow-y: auto; margin-bottom: 1.5rem;">
                        <table id="adminEmpresaUsersTable" class="table table-sm">
                            <thead><tr><th>Email</th><th>Função</th><th>Ações</th></tr></thead>
                            <tbody id="adminEmpresaUsersTableBody"></tbody>
                        </table>
                    </div>
                    <hr>
                    <h4>Adicionar Novo Usuário para <strong id="addUserNameForEmpresaDisplay"></strong></h4>
                    <div class="form-group">
                        <label for="adminEmpresaNewUserEmail">Email do Novo Usuário:</label>
                        <input type="email" id="adminEmpresaNewUserEmail" placeholder="novo.usuario@email.com">
                    </div>
                    <div class="form-group">
                        <label for="adminEmpresaNewUserFullName">Nome de Referência do Usuário (Opcional):</label>
                        <input type="text" id="adminEmpresaNewUserFullName" placeholder="Ex: João Silva Contador">
                    </div>
                    <div class="form-group">
                        <label for="adminEmpresaNewUserRole">Função do Novo Usuário:</label>
                        <select id="adminEmpresaNewUserRole">
                            <option value="empresa_manager">Gerente da Empresa (Acesso Total)</option>
                            <option value="empresa_counter">Contador da Empresa (Apenas Contagem)</option>
                        </select>
                    </div>
                    <button class="btn btn-success" id="btnExecuteCreateNewEmpresaUser">Criar Novo Usuário e Gerar Senha</button>
                    <div id="manageUsersEmpresaMessage" class="generated-password-display" style="display:none; margin-top:1rem;"></div>
                </div>
                <button class="btn btn-secondary" id="btnCancelarManageUsersEmpresa" style="margin: 0 1.25rem 1.25rem;">Fechar Gerenciamento de Usuários</button>
            </div>
        </div>

        <div id="screenEmpresaColaboradores" class="screen">
            <button class="btn btn-secondary back-button" id="colaboradoresBackButton">&larr; Voltar</button>
            <h2>Gerenciar Colaboradores (<span id="colaboradoresEmpresaNome"></span>)</h2>
            <div class="card"><div class="card-header"><h3>Adicionar Novo Colaborador</h3></div><div class="card-body"><div class="form-inline-flex"><div class="form-group"><label for="colaboradorNome">Nome do Colaborador:</label><input type="text" id="colaboradorNome" placeholder="Nome completo"></div><button class="btn btn-success" id="btnAddColaborador">Adicionar</button></div></div></div>
            <div class="card"><div class="card-header"><h3>Colaboradores Cadastrados</h3></div><div class="card-body"><table id="colaboradoresTable"><thead><tr><th>Nome</th><th>Ativo</th><th>Criação</th><th style="min-width: 220px;">Ações</th></tr></thead><tbody id="colaboradoresTableBody"></tbody></table></div></div>
        </div>

        <div id="screenChangePassword" class="screen">
             <button class="btn btn-secondary back-button" id="changePasswordBackButton">&larr; Voltar ao Painel</button>
            <h2>Alterar Senha Pessoal</h2>
            <div class="password-change-form card card-body">
                <p>Alterando senha para o login: <strong id="changingPasswordForUserDisplay"></strong></p>
                <div class="form-group" id="currentPasswordGroup" style="display:none;"><label for="currentPasswordInput">Senha Atual:</label><input type="password" id="currentPasswordInput"></div>
                <div class="form-group"><label for="newPasswordInput">Nova Senha (mín. 6 caracteres):</label><input type="password" id="newPasswordInput" placeholder="Digite a nova senha"></div>
                <div class="form-group"><label for="confirmNewPasswordInput">Confirmar Nova Senha:</label><input type="password" id="confirmNewPasswordInput" placeholder="Confirme a nova senha"></div>
                <button class="btn btn-primary" id="btnSalvarNovaSenha">Salvar Nova Senha</button>
                <div id="changePasswordMessage" style="margin-top:1rem; text-align:center;"></div>
            </div>
        </div>

        <div id="screenHistoricoContagens" class="screen">
            <button class="btn btn-secondary back-button" id="historicoBackButton">&larr; Voltar ao Painel</button>
            <h2 id="historicoTitle">Histórico de Contagens (<span id="historicoEmpresaNomeSpan"></span>)</h2>
            <div id="adminHistoricoEmpresaSelectorContainer" class="admin-context-selector" style="display:none;">
                <label for="adminHistoricoEmpresaSelect">Ver Histórico Para Empresa:</label>
                <select id="adminHistoricoEmpresaSelect"><option value="">-- Selecione uma Empresa --</option></select>
            </div>
            <p id="historicoContext" style="text-align:center; font-size:0.9em; color:var(--text-muted-color); margin-bottom: 1rem;"></p>
            <div class="card"><div class="card-header"><h3>Registros de Contagem</h3></div><div class="card-body" style="padding:0;"><table id="historicoContagensTable"><thead><tr><th id="colEmpresaHistorico" style="display:none;">Empresa</th><th>Data</th><th>Colaborador</th><th>Itens Contados</th><th>Ações</th></tr></thead><tbody id="historicoContagensTableBody"></tbody></table></div></div>
        </div>

        <div id="screenProductManagement" class="screen">
            <button class="btn btn-secondary back-button" id="productManagementBackButton">&larr; Voltar</button>
            <h2 id="productManagementTitle">Gerenciar Produtos</h2>
            <div id="adminProdutoEmpresaSelectorContainer" class="admin-context-selector" style="display:none;">
                <label for="adminProdutoEmpresaSelect">Gerenciar Produtos Para Empresa:</label>
                <select id="adminProdutoEmpresaSelect"><option value="">-- Selecione uma Empresa --</option></select>
            </div>
            <p id="productManagementContext" style="text-align:center; font-size:0.9em; color:var(--text-muted-color); margin-bottom: 1rem;"></p>
            <div class="card"><div class="card-header"><h3>Adicionar Novo Produto</h3></div><div class="card-body">
                <div class="product-management-form-fields">
                    <div class="form-group"><label for="prodCodigo">Código:</label><input type="text" id="prodCodigo"></div>
                    <div class="form-group"><label for="prodNome">Produto:</label><input type="text" id="prodNome"></div>
                    <div class="form-group">
                        <label for="prodCategoriaSelect">Categoria:</label>
                        <select id="prodCategoriaSelect"><option value="">-- Selecione uma Categoria --</option></select>
                    </div>
                    <button class="btn btn-success" id="btnAddProduct" disabled>Adicionar Produto</button>
                </div>
            </div></div>
            <div class="card"><div class="card-header"><h3>Importar Produtos via XLSX</h3></div><div class="card-body xlsx-import-section"><input type="file" id="xlsxFile" accept=".xlsx, .xls"><button class="btn btn-info" id="btnImportXLSX" disabled>Importar</button><p>Colunas: 'codigo', 'produto', 'categoria'.</p></div></div>
            <div class="card"><div class="card-header"><h3>Produtos Cadastrados</h3></div><div class="card-body" style="padding:0;"><table id="productManagementTable"><thead><tr><th>Código</th><th>Produto</th><th>Categoria</th><th>Ação</th></tr></thead><tbody id="productManagementTableBody"></tbody></table></div></div>
        </div>

        <div id="screenInventoryCount" class="screen">
            <button class="btn btn-secondary back-button" id="inventoryCountBackButton">&larr; Voltar</button>
            <h2 id="inventoryCountTitle">Balanço de Estoque</h2>
            <div id="adminContagemEmpresaSelectorContainer" class="admin-context-selector" style="display:none;">
                <label for="adminContagemEmpresaSelect">Realizar Contagem Para Empresa:</label>
                <select id="adminContagemEmpresaSelect"><option value="">-- Selecione uma Empresa --</option></select>
            </div>
            <p id="inventoryCountContext" style="text-align:center; font-size:0.9em; color:var(--text-muted-color); margin-bottom: 1rem;"></p>
            <div class="card card-body">
                <div class="form-group">
                    <label for="selectColaboradorContagem">Contagem realizada por:</label>
                    <select id="selectColaboradorContagem" style="margin-bottom: 1rem;"></select>
                </div>
                <div class="actions-bar" style="border:none; padding-bottom:0;">
                    <button class="btn btn-info" id="btnShowPreviewContagem">Ver Resumo</button>
                    <button class="btn btn-primary" id="btnGerarPDF" disabled>Gerar PDF</button>
                    <button class="btn btn-success" id="btnGerarTXT" disabled>Gerar TXT & Salvar Histórico</button>
                    <button class="btn btn-warning" id="btnClearAllQuantities">Limpar Quantidades</button>
                </div>
            </div>
            <div class="filter-controls card card-body" style="display: flex; flex-wrap: wrap; gap: 1rem;">
                <div><label for="pesquisaProduto">Produto:</label><input type="text" id="pesquisaProduto" placeholder="Nome..."></div>
                <div><label for="pesquisaCodigo">Código:</label><input type="text" id="pesquisaCodigo" placeholder="Código..."></div>
                <div><label for="filtroCategoria">Categoria:</label><select id="filtroCategoria"><option value="">Todas</option></select></div>
            </div>
            <table><thead><tr><th>Código</th><th>Produto</th><th>Categoria</th><th>Quantidade</th></tr></thead><tbody id="inventoryTableBody"></tbody></table>
        </div>

        <div id="modalPreviewContagem" class="modal-overlay">
            <div class="modal-content" style="max-width: 700px; text-align:left;">
                <h4>Resumo da Contagem Atual</h4>
                <div id="previewContagemTableContainer" style="max-height: 400px; overflow-y:auto;">
                    <table id="previewContagemTable">
                        <thead><tr><th>Código</th><th>Produto</th><th>Categoria</th><th>Qtd. Digitada</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="modal-actions" style="margin-top: 1.5rem;">
                    <button class="btn btn-secondary" id="btnClosePreviewModal">Fechar</button>
                </div>
            </div>
        </div>
        <div id="modalDetalhesContagem" class="modal-overlay">
            <div class="modal-content" style="max-width: 600px; text-align:left;">
                <h4>Detalhes da Contagem</h4>
                <div id="detalhesContagemConteudo"></div>
                <div class="modal-actions" style="margin-top:1.5rem;">
                    <button class="btn btn-secondary" id="btnCloseDetalhesModal">Fechar</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Script version v2.10.2 (User Role Fixes)
        console.log("SCRIPT START - v2.10.2 (User Role Fixes)");
        const SUPABASE_URL = 'https://daeocsintrbdfqclvteg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhZW9jc2ludHJiZGZxY2x2dGVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM0ODMxNDEsImV4cCI6MjA1OTA1OTE0MX0.BJ61kSxTDiEFway590hoTvVH4yu0FxLnjecqQsYdwK4';
        const { createClient } = supabase;
        const _supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let produtosCache = [], categoriasCache = [], empresasCache = [], colaboradoresCache = [], quantidadesDigitadas = {};
        const ADMIN_MASTER_EMAIL = "matheus@mtech.com";
        let currentUser = null;
        let adminSelectedEmpresaContextId = null;

        let userProfilesCache = [];

        let mainContainer, screens = {}, loadingIndicator, loginEmailInput, loginPasswordInput, loginErrorMessage,
            adminMasterNameDisplay, adminNomeEmpresaInput, adminEmpresasTableBody,
            adminManageUsersEmpresaSection, adminManageUsersEmpresaTitle, selectedEmpresaIdForUserManage,
            selectedEmpresaNameForUserManage, adminEmpresaUsersTableBody, manageUsersEmpresaMessage,
            adminEmpresaNewUserEmailEl, adminEmpresaNewUserFullNameEl, adminEmpresaNewUserRoleEl, addUserNameForEmpresaDisplayEl,

            categoriasTitleEl, adminCategoriaEmpresaSelectContainerEl, adminCategoriaEmpresaSelectEl,
            nomeCategoriaInputEl, categoriasTableBodyEl, btnCategoriasVoltarEl, btnAddCategoriaEl, categoriasContextEl,
            thCategoriaEmpresaScopeEl,

            colaboradoresEmpresaNomeSpan, colaboradorNomeInput, colaboradoresTableBody,
            currentPasswordInput, newPasswordInput, confirmNewPasswordInput, changePasswordMessage,
            changePasswordBackButton, changingPasswordForUserDisplay, currentPasswordGroup,
            historicoEmpresaNomeSpan, historicoContagensTableBody, modalDetalhesContagem, detalhesContagemConteudo,
            productManagementBackButton, productManagementTitle, productManagementContext,
            adminProdutoEmpresaSelectorContainer, adminProdutoEmpresaSelect, prodCodigoInput, prodNomeInput,
            prodCategoriaSelect, productManagementTableBody, xlsxFileInput, btnAddProductEl, btnImportXLSXEl,
            inventoryCountBackButton, inventoryCountTitle, inventoryCountContext, adminContagemEmpresaSelectorContainer,
            adminContagemEmpresaSelect, selectColaboradorContagem, pesquisaProdutoInput, pesquisaCodigoInput,
            filtroCategoriaSelect, inventoryTableBody, modalPreviewContagem, previewContagemTableContainer,
            empresaDashboardTitle, empresaUserNameSpan, empresaUserRoleDisplaySpan,
            adminHistoricoEmpresaSelectorContainer, adminHistoricoEmpresaSelect, historicoBackButton, historicoTitle, historicoContext, colEmpresaHistorico,
            btnGerarTXT, btnGerarPDF;


        function initializeDOMSelectors() {
            console.log("initializeDOMSelectors v2.10.2 called");
            mainContainer = document.getElementById('mainContainer');
            screens = {
                login: document.getElementById('screenLogin'),
                adminMasterDashboard: document.getElementById('screenAdminMasterDashboard'),
                empresaDashboard: document.getElementById('screenEmpresaDashboard'),
                adminEmpresas: document.getElementById('screenAdminEmpresas'),
                adminCategorias: document.getElementById('screenAdminCategorias'),
                empresaColaboradores: document.getElementById('screenEmpresaColaboradores'),
                changePassword: document.getElementById('screenChangePassword'),
                historicoContagens: document.getElementById('screenHistoricoContagens'),
                productManagement: document.getElementById('screenProductManagement'),
                inventoryCount: document.getElementById('screenInventoryCount')
            };
            loadingIndicator = document.getElementById('loadingIndicator');
            loginEmailInput = document.getElementById('loginEmail');
            loginPasswordInput = document.getElementById('loginPassword');
            loginErrorMessage = document.getElementById('loginErrorMessage');

            function safeGetElementById(id, context = document) {
                const el = context.getElementById(id);
                if (!el) console.warn(`Element with ID '${id}' NOT found in initializeDOMSelectors.`);
                return el;
            }

            Object.keys(screens).forEach(key => {
                if (!screens[key]) console.warn(`Screen element screens.${key} (Reference ID: ${key}) NOT found in initial assignment.`);
            });

            adminMasterNameDisplay = safeGetElementById('adminMasterNameDisplay');
            adminNomeEmpresaInput = safeGetElementById('adminNomeEmpresa');
            adminEmpresasTableBody = safeGetElementById('adminEmpresasTableBody');

            adminManageUsersEmpresaSection = safeGetElementById('adminManageUsersEmpresaSection');
            adminManageUsersEmpresaTitle = safeGetElementById('adminManageUsersEmpresaTitle');
            selectedEmpresaIdForUserManage = safeGetElementById('selectedEmpresaIdForUserManage');
            selectedEmpresaNameForUserManage = safeGetElementById('selectedEmpresaNameForUserManage');
            adminEmpresaUsersTableBody = safeGetElementById('adminEmpresaUsersTableBody');
            manageUsersEmpresaMessage = safeGetElementById('manageUsersEmpresaMessage');
            adminEmpresaNewUserEmailEl = safeGetElementById('adminEmpresaNewUserEmail');
            adminEmpresaNewUserFullNameEl = safeGetElementById('adminEmpresaNewUserFullName');
            adminEmpresaNewUserRoleEl = safeGetElementById('adminEmpresaNewUserRole');
            addUserNameForEmpresaDisplayEl = safeGetElementById('addUserNameForEmpresaDisplay');


            categoriasTitleEl = safeGetElementById('categoriasTitle');
            adminCategoriaEmpresaSelectContainerEl = safeGetElementById('adminCategoriaEmpresaSelectContainer');
            adminCategoriaEmpresaSelectEl = safeGetElementById('adminCategoriaEmpresaSelect');
            nomeCategoriaInputEl = safeGetElementById('nomeCategoriaInput');
            categoriasTableBodyEl = safeGetElementById('categoriasTableBody');
            btnCategoriasVoltarEl = safeGetElementById('btnCategoriasVoltar');
            btnAddCategoriaEl = safeGetElementById('btnAddCategoria');
            categoriasContextEl = safeGetElementById('categoriasContext');
            thCategoriaEmpresaScopeEl = safeGetElementById('thCategoriaEmpresaScope');


            colaboradoresEmpresaNomeSpan = safeGetElementById('colaboradoresEmpresaNome');
            colaboradorNomeInput = safeGetElementById('colaboradorNome');
            colaboradoresTableBody = safeGetElementById('colaboradoresTableBody');
            currentPasswordInput = safeGetElementById('currentPasswordInput');
            newPasswordInput = safeGetElementById('newPasswordInput');
            confirmNewPasswordInput = safeGetElementById('confirmNewPasswordInput');
            changePasswordMessage = safeGetElementById('changePasswordMessage');
            changePasswordBackButton = safeGetElementById('changePasswordBackButton');
            changingPasswordForUserDisplay = safeGetElementById('changingPasswordForUserDisplay');
            currentPasswordGroup = safeGetElementById('currentPasswordGroup');
            historicoEmpresaNomeSpan = safeGetElementById('historicoEmpresaNomeSpan');
            historicoContagensTableBody = safeGetElementById('historicoContagensTableBody');
            modalDetalhesContagem = safeGetElementById('modalDetalhesContagem');
            detalhesContagemConteudo = safeGetElementById('detalhesContagemConteudo');
            adminHistoricoEmpresaSelectorContainer = safeGetElementById('adminHistoricoEmpresaSelectorContainer');
            adminHistoricoEmpresaSelect = safeGetElementById('adminHistoricoEmpresaSelect');
            historicoBackButton = safeGetElementById('historicoBackButton');
            historicoTitle = safeGetElementById('historicoTitle');
            historicoContext = safeGetElementById('historicoContext');
            colEmpresaHistorico = safeGetElementById('colEmpresaHistorico');
            productManagementBackButton = safeGetElementById('productManagementBackButton');
            productManagementTitle = safeGetElementById('productManagementTitle');
            productManagementContext = safeGetElementById('productManagementContext');
            adminProdutoEmpresaSelectorContainer = safeGetElementById('adminProdutoEmpresaSelectorContainer');
            adminProdutoEmpresaSelect = safeGetElementById('adminProdutoEmpresaSelect');
            prodCodigoInput = safeGetElementById('prodCodigo');
            prodNomeInput = safeGetElementById('prodNome');
            prodCategoriaSelect = safeGetElementById('prodCategoriaSelect');
            productManagementTableBody = safeGetElementById('productManagementTableBody');
            xlsxFileInput = safeGetElementById('xlsxFile');
            btnAddProductEl = safeGetElementById('btnAddProduct');
            btnImportXLSXEl = safeGetElementById('btnImportXLSX');

            inventoryCountBackButton = safeGetElementById('inventoryCountBackButton');
            inventoryCountTitle = safeGetElementById('inventoryCountTitle');
            inventoryCountContext = safeGetElementById('inventoryCountContext');
            adminContagemEmpresaSelectorContainer = safeGetElementById('adminContagemEmpresaSelectorContainer');
            adminContagemEmpresaSelect = safeGetElementById('adminContagemEmpresaSelect');
            selectColaboradorContagem = safeGetElementById('selectColaboradorContagem');
            pesquisaProdutoInput = safeGetElementById('pesquisaProduto');
            pesquisaCodigoInput = safeGetElementById('pesquisaCodigo');
            filtroCategoriaSelect = document.getElementById('filtroCategoria');
            inventoryTableBody = safeGetElementById('inventoryTableBody');
            modalPreviewContagem = safeGetElementById('modalPreviewContagem');
            previewContagemTableContainer = safeGetElementById('previewContagemTableContainer');
            empresaDashboardTitle = safeGetElementById('empresaDashboardTitle');
            empresaUserNameSpan = safeGetElementById('empresaUserName');
            empresaUserRoleDisplaySpan = safeGetElementById('empresaUserRoleDisplay');

            btnGerarTXT = safeGetElementById('btnGerarTXT');
            btnGerarPDF = safeGetElementById('btnGerarPDF');

            console.log("DOM Selectors initialization complete.");
        }

        function saveQuantities() { try { localStorage.setItem('balancoQuantities_v2.10.2', JSON.stringify(quantidadesDigitadas)); } catch (e) { console.error("Error saving quantities to localStorage:", e); }}
        function loadQuantities() { try { const stored = localStorage.getItem('balancoQuantities_v2.10.2'); quantidadesDigitadas = stored ? JSON.parse(stored) : {}; } catch (e) { console.error("Error loading quantities:", e); quantidadesDigitadas = {}; }}
        function showLoader() { if (loadingIndicator) loadingIndicator.style.display = 'block'; }
        function hideLoader() { if (loadingIndicator) loadingIndicator.style.display = 'none'; }
        function generateNumericPassword(length = 6) { let pw = ''; for (let i = 0; i < length; i++) { pw += Math.floor(Math.random() * 10); } return pw; }

        async function populateEmpresasSelect(selectElement, includeSpecialOption = false, specialOptionText = "-- Selecione uma Empresa --", specialOptionValue = "") {
            const selectEl = (typeof selectElement === 'string') ? document.getElementById(selectElement) : selectElement;

            if (!selectEl) { console.warn(`Company select element/ID '${selectElement}' not found.`); return; }
            const currentValue = selectEl.value;
            selectEl.innerHTML = '';
            if (includeSpecialOption) {
                const opt = document.createElement('option'); opt.value = specialOptionValue; opt.textContent = specialOptionText; selectEl.appendChild(opt);
            }
            if (empresasCache.length === 0) {
                try {
                    console.log("Populating global empresasCache from DB...");
                    const { data, error } = await _supabaseClient.from('empresas').select('id, nome_empresa').order('nome_empresa');
                    if (error) throw error;
                    empresasCache = data || [];
                    console.log("Global empresasCache populated:", empresasCache.length);
                } catch (e) { console.error("Error fetching companies for select:", e); if(selectEl) selectEl.innerHTML = '<option value="">Erro ao carregar</option>'; return; }
            }
            empresasCache.forEach(emp => { const option = document.createElement('option'); option.value = emp.id; option.textContent = emp.nome_empresa; selectEl.appendChild(option); });

            if (currentValue && Array.from(selectEl.options).some(opt => opt.value === currentValue)) {
                 selectEl.value = currentValue;
            } else if (adminSelectedEmpresaContextId && Array.from(selectEl.options).some(opt => opt.value === adminSelectedEmpresaContextId)) {
                 selectEl.value = adminSelectedEmpresaContextId;
            } else if (includeSpecialOption) {
                 selectEl.value = specialOptionValue;
            }
            if(selectEl.value && selectEl.value !== specialOptionValue) selectEl.dispatchEvent(new Event('change'));
        }


        function showScreen(screenId, screenConfig = {}) {
            hideLoader();
            const mainCont = document.getElementById('mainContainer');
            const targetScreenElement = screens[screenId];
            Object.values(screens).forEach(sE => { if (sE && sE.classList) sE.classList.remove('active');});
            if (targetScreenElement && targetScreenElement.classList) {
                targetScreenElement.classList.add('active');
                if (mainCont) { mainCont.classList.toggle('content-container', ['adminEmpresas', 'adminCategorias', 'productManagement', 'inventoryCount', 'empresaColaboradores', 'historicoContagens'].includes(screenId));}

                ['adminProdutoEmpresaSelectorContainer', 'adminContagemEmpresaSelectorContainer', 'adminHistoricoEmpresaSelectorContainer', 'adminCategoriaEmpresaSelectContainer', 'colEmpresaHistorico'].forEach(id => {
                    const el = document.getElementById(id); if(el) el.style.display = 'none';
                });

                const { title, context, showEmpresaSelector, showEmpresaColumnInTable, isEmpresaContext = false } = screenConfig;

                if (screenId === 'adminCategorias') {
                    if(categoriasTitleEl) categoriasTitleEl.textContent = title || 'Gerenciar Categorias';
                    if(categoriasContextEl) categoriasContextEl.textContent = context || '';
                    if(adminCategoriaEmpresaSelectContainerEl) adminCategoriaEmpresaSelectContainerEl.style.display = isEmpresaContext ? 'none' : 'block';
                    if(thCategoriaEmpresaScopeEl) thCategoriaEmpresaScopeEl.style.display = isEmpresaContext ? 'none': '';

                }
                else if (screenId === 'productManagement') {
                    if(document.getElementById('productManagementTitle')) document.getElementById('productManagementTitle').textContent = title || 'Gerenciar Produtos';
                    if(document.getElementById('productManagementContext') && context !== undefined) document.getElementById('productManagementContext').textContent = context;
                    else if (document.getElementById('productManagementContext')) document.getElementById('productManagementContext').textContent = '';
                    if (currentUser?.role === 'admin_master' && showEmpresaSelector && document.getElementById('adminProdutoEmpresaSelectorContainer')) document.getElementById('adminProdutoEmpresaSelectorContainer').style.display = 'block';
                } else if (screenId === 'inventoryCount') {
                    if(document.getElementById('inventoryCountTitle')) document.getElementById('inventoryCountTitle').textContent = title || 'Balanço de Estoque';
                    if(document.getElementById('inventoryCountContext') && context !== undefined) document.getElementById('inventoryCountContext').textContent = context;
                    else if (document.getElementById('inventoryCountContext')) document.getElementById('inventoryCountContext').textContent = '';
                    if (currentUser?.role === 'admin_master' && showEmpresaSelector && document.getElementById('adminContagemEmpresaSelectorContainer')) document.getElementById('adminContagemEmpresaSelectorContainer').style.display = 'block';
                    updateExportButtonStates();
                } else if (screenId === 'historicoContagens') {
                    if(document.getElementById('historicoTitle')) document.getElementById('historicoTitle').textContent = title || 'Histórico de Contagens';
                    if(document.getElementById('historicoEmpresaNomeSpan') && (currentUser?.role === 'empresa_manager' || currentUser?.role === 'empresa_counter' || currentUser?.role === 'empresa_login_principal')) document.getElementById('historicoEmpresaNomeSpan').textContent = currentUser.empresa_nome || '';
                    else if(document.getElementById('historicoEmpresaNomeSpan')) document.getElementById('historicoEmpresaNomeSpan').textContent = '';

                    if(document.getElementById('historicoContext') && context !== undefined) document.getElementById('historicoContext').textContent = context;
                    else if (document.getElementById('historicoContext')) document.getElementById('historicoContext').textContent = '';

                    if (currentUser?.role === 'admin_master' && showEmpresaSelector && document.getElementById('adminHistoricoEmpresaSelectorContainer')) document.getElementById('adminHistoricoEmpresaSelectorContainer').style.display = 'block';
                    if (document.getElementById('colEmpresaHistorico')) document.getElementById('colEmpresaHistorico').style.display = (currentUser?.role === 'admin_master' && showEmpresaColumnInTable) ? '' : 'none';
                } else if (screenId === 'empresaDashboard' && currentUser) {
                    if(empresaDashboardTitle) empresaDashboardTitle.textContent = `Painel: ${currentUser.empresa_nome || 'Minha Empresa'}`;
                    if(empresaUserNameSpan) empresaUserNameSpan.textContent = currentUser.full_name || currentUser.email;

                    if(empresaUserRoleDisplaySpan) {
                        let displayRole = currentUser.role;
                        if (currentUser.role === 'empresa_manager' || currentUser.role === 'empresa_login_principal') displayRole = 'Gerente';
                        else if (currentUser.role === 'empresa_counter') displayRole = 'Contador';
                        empresaUserRoleDisplaySpan.textContent = displayRole;
                    }

                    const dashboardButtons = document.querySelectorAll('#screenEmpresaDashboard .dashboard-options .btn');
                    dashboardButtons.forEach(btn => {
                        const roleReq = btn.dataset.roleReq; // e.g., 'empresa_manager'
                        let canAccess = false;
                        if (roleReq) {
                            canAccess = (currentUser.role === roleReq) || (roleReq === 'empresa_manager' && currentUser.role === 'empresa_login_principal');
                        } else { // Buttons without roleReq are generally visible
                            canAccess = true;
                        }
                        btn.style.display = canAccess ? 'block' : 'none';
                    });
                } else if (screenId === 'adminMasterDashboard' && currentUser && adminMasterNameDisplay) {
                     adminMasterNameDisplay.textContent = currentUser.full_name || currentUser.email;
                } else if (screenId === 'changePassword' && currentUser) {
                    if(changingPasswordForUserDisplay) changingPasswordForUserDisplay.textContent = currentUser.email;
                    const isChangingOwnPasswordAsManager = (currentUser?.role === 'empresa_manager' || currentUser?.role === 'empresa_login_principal');
                    if(currentPasswordGroup) currentPasswordGroup.style.display = isChangingOwnPasswordAsManager ? 'block' : 'none';
                }
            } else {
                console.error(`CRITICAL: Screen '${screenId}' not found. Fallback to login.`);
                const loginSc = document.getElementById('screenLogin'); if (loginSc) loginSc.classList.add('active'); else if(document.body) document.body.innerHTML="UI Error.";
            }
            window.scrollTo(0,0);
        }
        function isMobileDevice() { return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent); }
        function triggerDownload(filename, textContent) { const blob = new Blob([textContent],{type:'text/plain;charset=utf-8'}); const link=document.createElement("a"); link.href=URL.createObjectURL(blob); link.download=filename; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(link.href); console.log(`Download ${filename} triggered.`); }

        async function handleLogin() {
            console.log("handleLogin v2.10.2 called");
            if (!loginEmailInput || !loginPasswordInput || !loginErrorMessage) {
                console.error("handleLogin: Login form elements not found!");
                alert("Erro crítico no formulário de login. Tente recarregar."); hideLoader(); return;
            }
            const email = loginEmailInput.value.trim();
            const password = loginPasswordInput.value.trim();
            loginErrorMessage.textContent = ""; loginErrorMessage.style.display = "none";

            if (!email || !password) {
                loginErrorMessage.textContent = "Por favor, preencha email e senha.";
                loginErrorMessage.style.display = "block"; return;
            }
            showLoader();
            console.log("Attempting Supabase login for:", email);

            try {
                const { data: signInData, error: signInError } = await _supabaseClient.auth.signInWithPassword({ email, password });

                if (signInError) { console.error("Supabase signIn Error:", signInError); throw signInError; }
                if (!signInData || !signInData.user) { console.error("No user data from Supabase signIn."); throw new Error("Usuário não retornado. Verifique credenciais.");}

                console.log("Supabase signIn OK. User ID:", signInData.user.id, "Metadata:", signInData.user.user_metadata);
                currentUser = {
                    id: signInData.user.id,
                    email: signInData.user.email,
                    user_metadata: signInData.user.user_metadata,
                    full_name: signInData.user.user_metadata?.full_name || signInData.user.email,
                    role: null
                };

                if (currentUser.user_metadata?.user_role) {
                     currentUser.role = currentUser.user_metadata.user_role;
                     console.log("Role assigned from JWT user_metadata:", currentUser.role);
                }

                if (!currentUser.role || ['empresa_manager', 'empresa_counter', 'empresa_login_principal'].includes(currentUser.role) || !currentUser.empresa_id) { // Also fetch profile if empresa_id is missing
                     console.log("Fetching profile for user (or to get empresa_id/nome):", currentUser.id);
                     const { data: profile, error: profileError } = await _supabaseClient
                        .from('user_profiles')
                        .select('empresa_id, role, full_name, empresas (id, nome_empresa)')
                        .eq('id', signInData.user.id)
                        .single();
                    console.log("Profile fetch result - Data:", profile, "Error:", profileError);

                    if (profileError && profileError.code !== 'PGRST116') {
                        console.error("Error fetching profile:", profileError);
                        await _supabaseClient.auth.signOut();
                        currentUser = null;
                        throw profileError;
                    }

                    if (profile) {
                        currentUser.role = profile.role; // This is the source of truth from DB
                        currentUser.empresa_id = profile.empresa_id;
                        currentUser.empresa_nome = profile.empresas ? profile.empresas.nome_empresa : (profile.empresa_id ? 'Empresa Associada (Nome não carregado)' : 'N/A');
                        currentUser.full_name = profile.full_name || currentUser.full_name;
                        console.log("User profile fetched and merged:", currentUser);
                    } else if (currentUser.email === ADMIN_MASTER_EMAIL && !currentUser.role) {
                        currentUser.role = 'admin_master';
                        console.warn("Admin Master identified by email (profile/JWT role missing):", currentUser.id);
                    } else if (!currentUser.role) {
                        console.error("User profile not found and not admin_master by email; no role in JWT. User ID:", signInData.user.id);
                        await _supabaseClient.auth.signOut();
                        currentUser = null;
                        throw new Error("Perfil do usuário não encontrado ou função não definida.");
                    }
                }


                if (currentUser.role === 'admin_master') {
                    const { data: adminEmpresas, error: adminEmpresasError } = await _supabaseClient.from('empresas').select('id, nome_empresa').order('nome_empresa');
                    if (adminEmpresasError) console.error("Error fetching companies for admin selects on login:", adminEmpresasError);
                    else empresasCache = adminEmpresas || [];

                    await Promise.all([
                        populateEmpresasSelect(adminCategoriaEmpresaSelectEl, true, "-- Selecione uma Empresa --", ""),
                        populateEmpresasSelect(adminProdutoEmpresaSelect, true, "-- Selecione uma Empresa --", ""),
                        populateEmpresasSelect(adminContagemEmpresaSelect, true, "-- Selecione uma Empresa --", ""),
                        populateEmpresasSelect(adminHistoricoEmpresaSelect, true, "-- Selecione uma Empresa --", "")
                    ]);
                    await fetchAndRenderEmpresas();
                    showAdminMasterDashboardScreen();
                } else if ((currentUser.role === 'empresa_manager' || currentUser.role === 'empresa_login_principal') && currentUser.empresa_id) { // Treat empresa_login_principal as manager
                    await showEmpresaDashboardScreen();
                } else if (currentUser.role === 'empresa_counter' && currentUser.empresa_id) {
                    await showInventoryCountScreen_Empresa();
                }
                else {
                    console.warn("Login successful but role unclear or company data missing after profile check:", currentUser);
                    await _supabaseClient.auth.signOut();
                    currentUser = null;
                    throw new Error("Função do usuário não definida ou dados da empresa ausentes.");
                }

            } catch (e) {
                console.error("Catch in login:", e);
                currentUser = null;
                loginErrorMessage.textContent = e.message.includes("Invalid login credentials") ? "Email ou senha inválidos."
                                              : (e.message.includes("Email not confirmed") ? "Email não confirmado."
                                              : (e.message || "Erro desconhecido."));
                loginErrorMessage.style.display = "block";
            } finally {
                hideLoader();
            }
        }


        async function handleLogout() {
            console.log("handleLogout called"); showLoader();
            try {
                const { error } = await _supabaseClient.auth.signOut();
                if (error) { console.error("Error in Supabase logout:", error); }
                currentUser = null; adminSelectedEmpresaContextId = null;
                if(loginEmailInput) loginEmailInput.value = ""; if(loginPasswordInput) loginPasswordInput.value = "";
                produtosCache = []; categoriasCache = []; empresasCache = []; colaboradoresCache = []; userProfilesCache = [];
                quantidadesDigitadas = {}; localStorage.removeItem('balancoQuantities_v2.10.2');
                showScreen('login'); console.log("User logged out.");
            } catch (e) { console.error("Error logout:", e); } finally { hideLoader(); }
        }

        function showAdminMasterDashboardScreen() { adminSelectedEmpresaContextId = null; showScreen('adminMasterDashboard'); }
        async function showEmpresaDashboardScreen() { adminSelectedEmpresaContextId = currentUser?.empresa_id; showScreen('empresaDashboard');}

        async function showAdminEmpresasScreen() {
            if (!currentUser || currentUser?.role !== 'admin_master') { handleLogout(); return; }
            showLoader();
            try {
                if (adminManageUsersEmpresaSection) adminManageUsersEmpresaSection.style.display = 'none';
                await fetchAndRenderEmpresas();
                showScreen('adminEmpresas');
            } catch (e) { console.error("Error showAdminEmpresasScreen:", e); alert("Erro ao carregar tela de empresas."); hideLoader(); }
        }

        async function fetchAndRenderEmpresas() {
            if (!adminEmpresasTableBody) {console.error("adminEmpresasTableBody not found"); hideLoader(); return;}
            adminEmpresasTableBody.innerHTML = '<tr><td colspan="3">Carregando empresas...</td></tr>';
            showLoader();
            try {
                const { data: companiesData, error: companiesError } = await _supabaseClient
                    .from('empresas')
                    .select('id, nome_empresa, created_at')
                    .order('nome_empresa');
                if (companiesError) throw companiesError;
                empresasCache = companiesData || [];

                adminEmpresasTableBody.innerHTML = "";
                if (empresasCache.length > 0) {
                    empresasCache.forEach(empresa => {
                        const row = adminEmpresasTableBody.insertRow();
                        row.insertCell().textContent = empresa.nome_empresa;
                        row.insertCell().textContent = new Date(empresa.created_at).toLocaleDateString('pt-BR');
                        const actionsCell = row.insertCell();

                        const btnManageUsers = document.createElement('button');
                        btnManageUsers.textContent = 'Gerenciar Usuários';
                        btnManageUsers.className = 'btn btn-info table-actions';
                        btnManageUsers.onclick = () => handleShowManageUsersEmpresaSection(empresa.id, empresa.nome_empresa);
                        actionsCell.appendChild(btnManageUsers);

                        const btnManageColabs = document.createElement('button');
                        btnManageColabs.textContent = 'Colaboradores'; btnManageColabs.className = 'btn btn-secondary table-actions';
                        btnManageColabs.onclick = () => showEmpresaColaboradoresScreen(empresa.id, empresa.nome_empresa, true);
                        actionsCell.appendChild(btnManageColabs);
                    });
                } else { adminEmpresasTableBody.innerHTML = '<tr><td colspan="3">Nenhuma empresa cadastrada.</td></tr>'; }
            } catch (e) {
                console.error("Error listing companies:", e);
                if(adminEmpresasTableBody) adminEmpresasTableBody.innerHTML = `<tr><td colspan="3" style="color:var(--danger-color);">Erro ao carregar empresas: ${e.message}</td></tr>`;
            }
            finally { hideLoader(); }
        }


        async function handleAdminAddEmpresa() {
            if(!adminNomeEmpresaInput) return; const nomeEmpresa = adminNomeEmpresaInput.value.trim();
            if (!nomeEmpresa) { alert('Digite o nome da empresa.'); return; }
            showLoader();
            try {
                const { data: existing } = await _supabaseClient.from('empresas').select('id').ilike('nome_empresa', nomeEmpresa).single();
                if (existing) { alert('Empresa já existe.'); hideLoader(); return; }
                const { data: novaEmpresa, error } = await _supabaseClient.from('empresas').insert([{ nome_empresa: nomeEmpresa }]).select().single();
                if (error) throw error;

                alert('Empresa adicionada! Agora adicione usuários para ela em "Gerenciar Usuários".'); adminNomeEmpresaInput.value = '';
                await fetchAndRenderEmpresas();
                const { data: allEmpresas, error: refreshError } = await _supabaseClient.from('empresas').select('id, nome_empresa').order('nome_empresa');
                if (refreshError) console.error("Error refreshing global empresasCache after add:", refreshError);
                else empresasCache = allEmpresas || [];

            } catch (e) { console.error("Error add company:", e); alert('Falha: ' + e.message); } finally { hideLoader(); }
        }

        async function handleShowManageUsersEmpresaSection(empresaId, nomeEmpresa) {
            if (!adminManageUsersEmpresaSection || !adminManageUsersEmpresaTitle || !selectedEmpresaIdForUserManage || !adminEmpresaUsersTableBody || !manageUsersEmpresaMessage || !addUserNameForEmpresaDisplayEl) {
                console.error("UI elements for managing company users not found."); return;
            }
            showLoader();
            adminManageUsersEmpresaTitle.textContent = `Gerenciar Usuários para: ${nomeEmpresa}`;
            selectedEmpresaIdForUserManage.value = empresaId;
            if(selectedEmpresaNameForUserManage) selectedEmpresaNameForUserManage.value = nomeEmpresa;
            addUserNameForEmpresaDisplayEl.textContent = nomeEmpresa;
            adminEmpresaUsersTableBody.innerHTML = '<tr><td colspan="3">Verificando usuários existentes...</td></tr>';
            manageUsersEmpresaMessage.style.display = 'none'; manageUsersEmpresaMessage.textContent = '';
            adminManageUsersEmpresaSection.style.display = 'block';
            adminManageUsersEmpresaSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            try {
                console.log(`DEBUG: Fetching profiles for empresa_id: ${empresaId}`);
                const { data: existingProfiles, error: profileError } = await _supabaseClient
                    .from('user_profiles')
                    .select('id, email, full_name, role') // id here is the auth.users.id
                    .eq('empresa_id', empresaId)
                    .in('role', ['empresa_manager', 'empresa_counter', 'empresa_login_principal']); // Include old role

                if (profileError) {
                    console.error("DEBUG: Profile fetch error in handleShowManageUsersEmpresaSection:", profileError);
                    throw profileError;
                }
                console.log("DEBUG: Existing profiles data in handleShowManageUsersEmpresaSection:", existingProfiles);
                userProfilesCache = existingProfiles || []; // Update cache specifically for this view

                adminEmpresaUsersTableBody.innerHTML = "";
                if (userProfilesCache.length > 0) {
                    userProfilesCache.forEach(profile => {
                        const row = adminEmpresaUsersTableBody.insertRow();
                        row.insertCell().textContent = profile.email;

                        let roleDisplay = profile.role;
                        if (profile.role === 'empresa_manager' || profile.role === 'empresa_login_principal') {
                            roleDisplay = 'Gerente';
                        } else if (profile.role === 'empresa_counter') {
                            roleDisplay = 'Contador';
                        }
                        row.insertCell().textContent = roleDisplay;

                        const actionsCell = row.insertCell();
                        const btnResetPass = document.createElement('button');
                        btnResetPass.textContent = 'Resetar Senha';
                        btnResetPass.className = 'btn btn-warning table-actions';
                        btnResetPass.onclick = () => callResetPasswordEdgeFunction(profile.id, profile.email, nomeEmpresa);
                        actionsCell.appendChild(btnResetPass);
                    });
                } else {
                    adminEmpresaUsersTableBody.innerHTML = '<tr><td colspan="3">Nenhum usuário cadastrado para esta empresa.</td></tr>';
                }
                if(adminEmpresaNewUserEmailEl) adminEmpresaNewUserEmailEl.value = '';
                if(adminEmpresaNewUserFullNameEl) adminEmpresaNewUserFullNameEl.value = '';

            } catch(e) {
                console.error("Error in handleShowManageUsersEmpresaSection:", e);
                adminEmpresaUsersTableBody.innerHTML = `<tr><td colspan="3" style="color:var(--danger-color)">Erro ao verificar/gerenciar usuários: ${e.message}</td></tr>`;
            } finally {
                hideLoader();
            }
        }

        function closeAdminManageUsersEmpresaSection() {
            if(adminManageUsersEmpresaSection) adminManageUsersEmpresaSection.style.display = 'none';
        }

        async function handleAdminCreateEmpresaUser() {
            console.log("handleAdminCreateEmpresaUser called");
            const empresaId = document.getElementById('selectedEmpresaIdForUserManage').value;
            const empresaNome = document.getElementById('addUserNameForEmpresaDisplay').textContent || 'Empresa Desconhecida';

            if (!adminEmpresaNewUserEmailEl || !adminEmpresaNewUserFullNameEl || !adminEmpresaNewUserRoleEl || !manageUsersEmpresaMessage || !empresaId) {
                alert("Erro de interface ou ID da empresa faltando. Recarregue."); return;
            }

            const email = adminEmpresaNewUserEmailEl.value.trim();
            const fullName = adminEmpresaNewUserFullNameEl.value.trim() || email;
            const role = adminEmpresaNewUserRoleEl.value;

            if (!email) { alert("Email é obrigatório."); adminEmpresaNewUserEmailEl.focus(); return; }
            if (!role) { alert("Função é obrigatória."); adminEmpresaNewUserRoleEl.focus(); return; }

            const password = generateNumericPassword(6);
            showLoader();
            manageUsersEmpresaMessage.style.display = 'none'; manageUsersEmpresaMessage.textContent = '';

            try {
                const { data: authData, error: signUpError } = await _supabaseClient.auth.signUp({
                    email, password,
                    options: {
                        data: {
                            empresa_id: empresaId,
                            user_role: role, // This will be in raw_user_meta_data for the trigger
                            full_name: fullName
                        }
                    }
                });

                if (signUpError) {
                     if (signUpError.message.toLowerCase().includes("user already registered") || signUpError.message.toLowerCase().includes("already exists")) {
                         throw new Error(`Email ${email} já está registrado no Supabase Auth. Para definir uma nova senha para um login existente, use a opção "Resetar Senha".`);
                    }
                    throw signUpError;
                }

                if (authData.user) {
                    console.log("New user created in Auth:", authData.user.id, authData.user.email);
                    // Assuming the Supabase trigger 'on_auth_user_created' correctly populates 'user_profiles.role'
                    // from 'auth.users.raw_user_meta_data.user_role'.

                    let successMsg = `Novo usuário (${role}) para ${empresaNome} (${email}) criado com sucesso!`;
                    successMsg += `\nSenha Gerada: ${password}\nInforme ao responsável.`;
                    if (authData.user.email_confirmed_at === null && !authData.user.phone_confirmed_at) {
                         successMsg += `\nNota: Se a confirmação de email estiver ATIVA no Supabase, o usuário ${email} precisará confirmar o email.`;
                    }

                    manageUsersEmpresaMessage.innerHTML = successMsg.replace(/\n/g, '<br>');
                    manageUsersEmpresaMessage.style.display = 'block';
                    manageUsersEmpresaMessage.style.color = 'var(--success-color)';

                    // Crucial: Short delay to allow Supabase trigger to complete before refetching profiles
                    await new Promise(resolve => setTimeout(resolve, 1500)); // Delay of 1.5 seconds

                    await handleShowManageUsersEmpresaSection(empresaId, empresaNome);
                    adminEmpresaNewUserEmailEl.value = '';
                    adminEmpresaNewUserFullNameEl.value = '';
                } else {
                    console.warn("authData.user is null after signUp. authData:", authData);
                    throw new Error("Não foi possível obter dados do usuário após cadastro (authData.user nulo).");
                }
            } catch (e) {
                console.error("Final catch in handleAdminCreateEmpresaUser:", e);
                manageUsersEmpresaMessage.textContent = `Erro ao criar usuário: ${e.message}`;
                manageUsersEmpresaMessage.style.color = 'var(--danger-color)';
                manageUsersEmpresaMessage.style.display = 'block';
            } finally {
                hideLoader();
            }
        }

        async function callResetPasswordEdgeFunction(authUserId, userEmail, nomeEmpresaContext) {
            if (!authUserId || !userEmail) { alert("ID do usuário (Auth ID) ou email não fornecido para resetar senha."); return; }
            if (!confirm(`Tem certeza que deseja resetar a senha para o login ${userEmail} (associado à empresa ${nomeEmpresaContext})? Uma nova senha será gerada e exibida.`)) return;

            showLoader();
            const messageDisplay = document.getElementById('manageUsersEmpresaMessage');
            if(messageDisplay) { messageDisplay.style.display = 'none'; messageDisplay.textContent = ''; }

            try {
                console.log(`Invocando Edge Function 'reset-empresa-password' para auth.users.id: ${authUserId}`);
                const { data, error } = await _supabaseClient.functions.invoke('reset-empresa-password', {
                    body: JSON.stringify({ target_user_id: authUserId })
                });

                if (error) { throw new Error(error.message || "Falha ao chamar função de reset."); }
                if (data.error) { throw new Error(data.error); }

                console.log("Response from Edge Function:", data);
                let successMsg = data.message || `Senha para ${userEmail} resetada!`;
                if (data.newPassword) { successMsg += `\nNova Senha Gerada: ${data.newPassword}\nInforme ao responsável.`; }
                else { successMsg += `\nNova senha NÃO foi retornada pela função. Verifique a Edge Function.`}

                if(messageDisplay) {
                    messageDisplay.innerHTML = successMsg.replace(/\n/g, '<br>');
                    messageDisplay.style.display = 'block';
                    messageDisplay.style.color = data.newPassword ? 'var(--success-color)' : 'var(--warning-color)';
                } else { alert(successMsg.replace(/\n/g, '\n')); }
            } catch (e) {
                console.error("Erro ao resetar senha via Edge Function:", e);
                if(messageDisplay) {
                    messageDisplay.textContent = `Erro reset senha: ${e.message}`;
                    messageDisplay.style.color = 'var(--danger-color)';
                    messageDisplay.style.display = 'block';
                } else { alert(`Erro reset senha: ${e.message}`);}
            } finally {
                hideLoader();
            }
        }

        function updateExportButtonStates() {
            const hasQuantities = Object.values(quantidadesDigitadas).some(qty => parseFloat(qty) > 0);
            if (btnGerarTXT) btnGerarTXT.disabled = !hasQuantities;
            if (btnGerarPDF) btnGerarPDF.disabled = !hasQuantities;
        }

        async function gerarArquivoTXT() {
            console.log("gerarArquivoTXT v2.10.2 started");
            showLoader();
            const colaboradorSelect = document.getElementById('selectColaboradorContagem');
            if (!colaboradorSelect) { alert("Erro: Seletor de colaborador não encontrado."); hideLoader(); return; }
            const colaboradorId = colaboradorSelect.value;
            const colaboradorNome = colaboradorSelect.options[colaboradorSelect.selectedIndex]?.text || "N/A";
            if (!colaboradorId) { alert("Selecione o colaborador."); hideLoader(); return; }
            const produtosContados = produtosCache.filter(p => quantidadesDigitadas[p.id] && parseFloat(quantidadesDigitadas[p.id]) > 0);
            if (produtosContados.length === 0) { alert("Nenhum produto com quantidade > 0 para gerar o arquivo."); hideLoader(); return; }

            let conteudoTXT = "";
            produtosContados.forEach(produto => {
                const codigo = produto.codigo_produto || produto.id;
                const quantidade = parseFloat(quantidadesDigitadas[produto.id]);
                conteudoTXT += `${codigo};${quantidade}\n`;
            });

            const dataAtual = new Date();
            const nomeArquivo = `balanco_est_${dataAtual.getFullYear()}${String(dataAtual.getMonth() + 1).padStart(2, '0')}${String(dataAtual.getDate()).padStart(2, '0')}_${String(dataAtual.getHours()).padStart(2, '0')}${String(dataAtual.getMinutes()).padStart(2, '0')}.txt`;
            try {
                const empresaContextoId = (currentUser?.role === 'admin_master' && adminSelectedEmpresaContextId) ? adminSelectedEmpresaContextId : (currentUser.empresa_id || null);
                if (!empresaContextoId && currentUser?.role !== 'admin_master') {
                     console.error("gerarArquivoTXT: Empresa ID não encontrado para usuário da empresa.");
                     alert("Erro: ID da empresa não encontrado para salvar o histórico.");
                     hideLoader(); return;
                }

                const { error: histError } = await _supabaseClient.from('historico_contagens').insert({
                    empresa_id: empresaContextoId,
                    colaborador_id: colaboradorId.startsWith('admin_') || colaboradorId.startsWith('user_') ? null : colaboradorId,
                    colaborador_nome: colaboradorNome,
                    itens_contados: produtosContados.length,
                    dados_contagem: produtosContados.map(p => ({
                        produto_id: p.id, codigo: p.codigo_produto || p.id, nome: p.nome_produto,
                        categoria: categoriasCache.find(c => c.id === p.categoria_id)?.nome_categoria || "Sem Categoria",
                        quantidade: parseFloat(quantidadesDigitadas[p.id])
                    }))
                });
                if (histError) { console.error("Error saving history:", histError); alert(`Erro ao salvar histórico: ${histError.message}`); hideLoader(); return; }
                console.log("History saved.");

                triggerDownload(nomeArquivo, conteudoTXT);
                alert(`Arquivo "${nomeArquivo}" gerado, baixado e histórico salvo!`);
                clearAllQuantities();

            } catch (error) { console.error("Error gerarTXT:", error); alert(`Erro na contagem: ${error.message}`); } finally { hideLoader(); }
        }

        async function gerarPDFContagem() {
            console.log("gerarPDFContagem v2.10.2 started");
            showLoader();
            const { jsPDF } = window.jspdf;
            if (typeof jsPDF === 'undefined' || typeof window.jspdf.jsPDF.API === 'undefined' || typeof window.jspdf.jsPDF.API.autoTable === 'undefined') {
                 alert("Erro: Biblioteca jsPDF ou jsPDF-AutoTable não carregada corretamente.");
                 hideLoader(); return;
            }

            const colaboradorSelect = document.getElementById('selectColaboradorContagem');
            if (!colaboradorSelect) { alert("Erro: Seletor de colaborador não encontrado."); hideLoader(); return; }
            const colaboradorId = colaboradorSelect.value;
            const colaboradorNome = colaboradorSelect.options[colaboradorSelect.selectedIndex]?.text || "N/A";

            if (!colaboradorId) {
                alert("Selecione o colaborador que realizou a contagem.");
                hideLoader(); return;
            }

            const produtosContados = produtosCache.filter(p => quantidadesDigitadas[p.id] && parseFloat(quantidadesDigitadas[p.id]) > 0);

            if (produtosContados.length === 0) {
                alert("Nenhum produto com quantidade maior que zero para gerar PDF.");
                hideLoader(); return;
            }

            try {
                const pdf = new jsPDF();
                const dataAtual = new Date();
                const dataFormatada = dataAtual.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' }) + ' ' + dataAtual.toLocaleTimeString('pt-BR');

                let empresaNomeContext = "N/A (Contexto Geral/Admin)";
                if (currentUser?.role === 'admin_master' && adminSelectedEmpresaContextId) {
                    const selectedEmpresa = empresasCache.find(e => e.id === adminSelectedEmpresaContextId);
                    if(selectedEmpresa) empresaNomeContext = selectedEmpresa.nome_empresa;
                } else if ((currentUser?.role === 'empresa_manager' || currentUser?.role === 'empresa_counter' || currentUser?.role === 'empresa_login_principal') && currentUser.empresa_nome) {
                    empresaNomeContext = currentUser.empresa_nome;
                }

                pdf.setFontSize(18);
                pdf.text("Relatório de Contagem de Estoque", 14, 22);
                pdf.setFontSize(11);
                pdf.text(`Empresa: ${empresaNomeContext}`, 14, 30);
                pdf.text(`Data da Geração: ${dataFormatada}`, 14, 36);
                pdf.text(`Contagem Realizada por: ${colaboradorNome}`, 14, 42);

                const tableColumn = ["Código", "Produto", "Categoria", "Quantidade"];
                const tableRows = [];

                produtosContados.sort((a,b) => (a.nome_produto || "").localeCompare(b.nome_produto || "")).forEach(produto => {
                    let categoriaNome = 'Sem Categoria';
                    if (produto.categorias?.nome_categoria) {
                        categoriaNome = produto.categorias.nome_categoria;
                    } else if (produto.categoria_id) {
                        const foundCat = categoriasCache.find(c => c.id === produto.categoria_id);
                        categoriaNome = foundCat ? foundCat.nome_categoria : 'Inválida';
                    }
                    const produtoData = [
                        produto.codigo_produto || produto.id,
                        produto.nome_produto || "N/A",
                        categoriaNome,
                        quantidadesDigitadas[produto.id]
                    ];
                    tableRows.push(produtoData);
                });

                pdf.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: 50,
                    theme: 'striped',
                    headStyles: { fillColor: [22, 160, 133] },
                    styles: { fontSize: 9, cellPadding: 2 },
                    columnStyles: { 3: { halign: 'right' } }
                });

                const nomeArquivoPDF = `contagem_estoque_${dataAtual.getFullYear()}${String(dataAtual.getMonth() + 1).padStart(2, '0')}${String(dataAtual.getDate()).padStart(2, '0')}.pdf`;
                pdf.save(nomeArquivoPDF);
                alert(`PDF "${nomeArquivoPDF}" gerado com sucesso!`);

            } catch (error) {
                console.error("Erro ao gerar PDF da contagem:", error);
                alert("Falha ao gerar PDF: " + error.message);
            } finally {
                hideLoader();
            }
        }

        async function showCategoriasScreen_Admin() {
            if (!currentUser || currentUser.role !== 'admin_master') { handleLogout(); return; }
            console.log("showCategoriasScreen_Admin called");
            showLoader();
            try {
                adminSelectedEmpresaContextId = null;
                if(adminCategoriaEmpresaSelectEl) {
                    await populateEmpresasSelect(adminCategoriaEmpresaSelectEl, true, "-- Selecione uma Empresa --", "");
                    adminCategoriaEmpresaSelectEl.value = "";
                    if (!adminCategoriaEmpresaSelectEl.onchangeAttached_cat_admin) {
                        adminCategoriaEmpresaSelectEl.addEventListener('change', async () => {
                            adminSelectedEmpresaContextId = adminCategoriaEmpresaSelectEl.value === "" ? null : adminCategoriaEmpresaSelectEl.value;
                            const selectedEmpresa = empresasCache.find(e => e.id === adminSelectedEmpresaContextId);
                            if(categoriasContextEl) categoriasContextEl.textContent = selectedEmpresa ? `Gerenciando categorias para: ${selectedEmpresa.nome_empresa}` : "Nenhuma empresa selecionada";
                            if(btnAddCategoriaEl) btnAddCategoriaEl.disabled = !adminSelectedEmpresaContextId;
                            await fetchAndRenderCategorias();
                        });
                        adminCategoriaEmpresaSelectEl.onchangeAttached_cat_admin = true;
                    }
                    if(adminSelectedEmpresaContextId && Array.from(adminCategoriaEmpresaSelectEl.options).some(opt => opt.value === adminSelectedEmpresaContextId)){
                         adminCategoriaEmpresaSelectEl.value = adminSelectedEmpresaContextId;
                    }
                    adminCategoriaEmpresaSelectEl.dispatchEvent(new Event('change'));
                } else {
                     await fetchAndRenderCategorias();
                }
                showScreen('adminCategorias', { title: 'Gerenciar Categorias (Admin)', context: 'Selecione uma empresa para ver ou adicionar categorias.', isEmpresaContext: false });
            } catch (e) {
                console.error("Error in showCategoriasScreen_Admin:", e);
                alert("Erro ao carregar tela de categorias (Admin).");
            } finally {
                hideLoader();
            }
        }

        async function showCategoriasScreen_Empresa() {
            if (!currentUser || !(currentUser.role === 'empresa_manager' || currentUser.role === 'empresa_login_principal')) {
                alert("Acesso negado à gestão de categorias.");
                showEmpresaDashboardScreen();
                return;
            }
            console.log("showCategoriasScreen_Empresa called for company:", currentUser.empresa_nome);
            showLoader();
            try {
                adminSelectedEmpresaContextId = currentUser.empresa_id;
                if (categoriasContextEl) categoriasContextEl.textContent = `Gerenciando categorias para: ${currentUser.empresa_nome || 'sua empresa'}`;
                if(btnAddCategoriaEl) btnAddCategoriaEl.disabled = false;

                await fetchAndRenderCategorias();
                showScreen('adminCategorias', {
                    title: `Gerenciar Categorias (${currentUser.empresa_nome || 'Sua Empresa'})`,
                    context: `Adicione ou remova categorias para ${currentUser.empresa_nome || 'sua empresa'}.`,
                    isEmpresaContext: true
                });
            } catch (e) {
                console.error("Error in showCategoriasScreen_Empresa:", e);
                alert("Erro ao carregar tela de categorias da empresa.");
            } finally {
                hideLoader();
            }
        }


        async function fetchAndRenderCategorias() {
            if (!categoriasTableBodyEl) { console.error("categoriasTableBodyEl not found"); return; }
            categoriasTableBodyEl.innerHTML = '<tr><td colspan="4">Carregando categorias...</td></tr>';
            showLoader();

            let targetEmpresaIdForFetch = null;
            if (currentUser.role === 'admin_master') {
                targetEmpresaIdForFetch = adminSelectedEmpresaContextId;
                if (!targetEmpresaIdForFetch) {
                    categoriasTableBodyEl.innerHTML = '<tr><td colspan="4">Selecione uma empresa para visualizar as categorias.</td></tr>';
                    if(thCategoriaEmpresaScopeEl) thCategoriaEmpresaScopeEl.style.display = '';
                    hideLoader();
                    return;
                }
            } else if (currentUser.role === 'empresa_manager' || currentUser.role === 'empresa_counter' || currentUser.role === 'empresa_login_principal') {
                targetEmpresaIdForFetch = currentUser.empresa_id;
                if(thCategoriaEmpresaScopeEl) thCategoriaEmpresaScopeEl.style.display = 'none';
            } else {
                categoriasTableBodyEl.innerHTML = '<tr><td colspan="4">Permissão negada.</td></tr>';
                hideLoader(); return;
            }

            console.log(`fetchAndRenderCategorias - Role: ${currentUser?.role}, TargetEmpresaID: ${targetEmpresaIdForFetch}`);

            try {
                const { data, error } = await _supabaseClient.from('categorias')
                    .select('id, nome_categoria, created_at, empresa_id, empresas (nome_empresa)')
                    .eq('empresa_id', targetEmpresaIdForFetch)
                    .order('nome_categoria');

                if (error) throw error;

                categoriasCache = data || [];
                categoriasTableBodyEl.innerHTML = "";
                if (data && data.length > 0) {
                    data.forEach(cat => {
                        const row = categoriasTableBodyEl.insertRow();
                        row.insertCell().textContent = cat.nome_categoria;

                        const empresaCell = row.insertCell();
                        empresaCell.textContent = cat.empresas?.nome_empresa || `Empresa ID: ${cat.empresa_id}`;
                        if ((currentUser.role === 'empresa_manager' || currentUser.role === 'empresa_counter' || currentUser.role === 'empresa_login_principal') && thCategoriaEmpresaScopeEl && thCategoriaEmpresaScopeEl.style.display === 'none') {
                            // Cell hidden by CSS
                        }
                        row.insertCell().textContent = new Date(cat.created_at).toLocaleDateString('pt-BR');

                        const actionsCell = row.insertCell();
                        if (currentUser.role === 'admin_master' || currentUser.role === 'empresa_manager' || currentUser.role === 'empresa_login_principal') {
                            const btnDelete = document.createElement('button');
                            btnDelete.textContent = 'Excluir';
                            btnDelete.className = 'btn btn-danger table-actions';
                            btnDelete.onclick = () => handleDeleteCategoria(cat.id, cat.nome_categoria, cat.empresa_id);
                            actionsCell.appendChild(btnDelete);
                        } else {
                            actionsCell.textContent = 'N/A';
                        }
                    });
                } else {
                    categoriasTableBodyEl.innerHTML = '<tr><td colspan="4">Nenhuma categoria cadastrada para esta empresa.</td></tr>';
                }
            } catch (e) {
                console.error("Erro ao buscar/renderizar categorias:", e);
                categoriasTableBodyEl.innerHTML = `<tr><td colspan="4" style="color:var(--danger-color);">Erro ao carregar: ${e.message}</td></tr>`;
            } finally {
                hideLoader();
            }
        }

        async function handleAddCategoria() {
            if (!nomeCategoriaInputEl) {
                 alert("Erro: Campo de nome da categoria não encontrado."); return;
            }
            const nomeCategoria = nomeCategoriaInputEl.value.trim();
            let empresaIdParaNovaCategoria = null;

            if (currentUser.role === 'admin_master') {
                empresaIdParaNovaCategoria = adminSelectedEmpresaContextId;
                if (!empresaIdParaNovaCategoria) {
                    alert("Admin: Selecione uma empresa primeiro para adicionar a categoria.");
                    return;
                }
            } else if (currentUser.role === 'empresa_manager' || currentUser.role === 'empresa_login_principal') {
                empresaIdParaNovaCategoria = currentUser.empresa_id;
                 if (!empresaIdParaNovaCategoria) {
                    alert("Erro: ID da sua empresa não encontrado. Não é possível adicionar categoria.");
                    return;
                }
            } else {
                alert("Permissão negada para adicionar categoria."); return;
            }

            if (!nomeCategoria) { alert('Digite o nome da categoria.'); return; }
            showLoader();
            try {
                const { data: existing, error: checkError } = await _supabaseClient.from('categorias')
                    .select('id')
                    .eq('nome_categoria', nomeCategoria)
                    .eq('empresa_id', empresaIdParaNovaCategoria)
                    .maybeSingle();

                if (checkError) throw checkError;
                if (existing) {
                    alert(`Uma categoria com o nome "${nomeCategoria}" já existe para esta empresa.`);
                    hideLoader(); return;
                }

                const { data, error } = await _supabaseClient.from('categorias')
                    .insert([{ nome_categoria: nomeCategoria, empresa_id: empresaIdParaNovaCategoria }])
                    .select();

                if (error) throw error;
                alert('Categoria adicionada com sucesso!');
                nomeCategoriaInputEl.value = '';
                await fetchAndRenderCategorias();
            } catch (e) {
                console.error("Erro ao adicionar categoria:", e);
                alert('Falha ao adicionar categoria: ' + e.message);
            } finally {
                hideLoader();
            }
        }

        async function handleDeleteCategoria(categoriaId, nomeCategoria, catEmpresaId) {
            if (!confirm(`Tem certeza que deseja excluir a categoria "${nomeCategoria}"? Esta ação não pode ser desfeita.`)) return;

            let canDelete = false;
            if (currentUser.role === 'admin_master' && catEmpresaId === adminSelectedEmpresaContextId) {
                canDelete = true;
            } else if ((currentUser.role === 'empresa_manager' || currentUser.role === 'empresa_login_principal') && catEmpresaId === currentUser.empresa_id) {
                canDelete = true;
            }

            if (!canDelete) {
                 alert("Você não tem permissão para excluir esta categoria.");
                 return;
            }

            showLoader();
            try {
                const { count, error: productCheckError } = await _supabaseClient
                    .from('produtos')
                    .select('id', { count: 'exact', head: true })
                    .eq('categoria_id', categoriaId);

                if (productCheckError) throw productCheckError;

                if (count && count > 0) {
                     alert(`Não é possível excluir a categoria "${nomeCategoria}" pois ela está sendo utilizada por ${count} produto(s). Remova ou altere a categoria desses produtos primeiro.`);
                     hideLoader();
                     return;
                }

                const { error } = await _supabaseClient.from('categorias').delete().eq('id', categoriaId);
                if (error) throw error;
                alert(`Categoria "${nomeCategoria}" excluída com sucesso!`);
                await fetchAndRenderCategorias();
            } catch (e) {
                console.error("Erro ao excluir categoria:", e);
                alert('Falha ao excluir categoria: ' + e.message);
            } finally {
                hideLoader();
            }
        }


        async function showEmpresaColaboradoresScreen(empresaIdParaAdmin = null, nomeEmpresaParaAdmin = null, isAdminCalling = false) {
            let targetEmpresaId = null;
            let targetEmpresaNome = null;

            if (isAdminCalling && currentUser?.role === 'admin_master') {
                if (!empresaIdParaAdmin) {
                    alert("ID da empresa não fornecido para visualização de admin.");
                    showAdminEmpresasScreen();
                    return;
                }
                targetEmpresaId = empresaIdParaAdmin;
                targetEmpresaNome = nomeEmpresaParaAdmin || `Empresa ID: ${empresaIdParaAdmin}`;
            } else if (!isAdminCalling && (currentUser?.role === 'empresa_manager' || currentUser?.role === 'empresa_login_principal')) {
                targetEmpresaId = currentUser.empresa_id;
                targetEmpresaNome = currentUser.empresa_nome;
            } else {
                alert("Acesso negado à gestão de colaboradores.");
                if (currentUser?.role === 'admin_master') showAdminMasterDashboardScreen();
                else if (currentUser?.role === 'empresa_manager' || currentUser?.role === 'empresa_counter' || currentUser?.role === 'empresa_login_principal') showEmpresaDashboardScreen();
                else handleLogout();
                return;
            }

            console.log(`showEmpresaColaboradoresScreen for Company ID: ${targetEmpresaId}, Name: ${targetEmpresaNome}`);
            showLoader();
            try {
                if (colaboradoresEmpresaNomeSpan) colaboradoresEmpresaNomeSpan.textContent = targetEmpresaNome;
                else console.warn("colaboradoresEmpresaNomeSpan not found");


                if(colaboradorNomeInput) colaboradorNomeInput.dataset.empresaId = targetEmpresaId;

                await fetchAndRenderColaboradores(targetEmpresaId);
                showScreen('empresaColaboradores');


                const backBtn = document.getElementById('colaboradoresBackButton');
                if(backBtn) {
                    if(backBtn.currentListener) backBtn.removeEventListener('click', backBtn.currentListener);
                    if (isAdminCalling) {
                        backBtn.currentListener = showAdminEmpresasScreen;
                    } else {
                        backBtn.currentListener = showEmpresaDashboardScreen;
                    }
                    backBtn.addEventListener('click', backBtn.currentListener);
                }

            } catch (e) {
                console.error("Error in showEmpresaColaboradoresScreen:", e);
                alert("Erro ao carregar tela de colaboradores.");
            } finally {
                hideLoader();
            }
        }

        async function fetchAndRenderColaboradores(empresaId) {
            if (!colaboradoresTableBody) { console.error("colaboradoresTableBody not found"); return; }
            colaboradoresTableBody.innerHTML = '<tr><td colspan="4">Carregando colaboradores...</td></tr>';
            if (!empresaId) {
                 colaboradoresTableBody.innerHTML = '<tr><td colspan="4">ID da empresa não fornecido.</td></tr>';
                 return;
            }
            showLoader();
            try {
                const { data, error } = await _supabaseClient.from('colaboradores')
                    .select('id, nome_colaborador, created_at, ativo')
                    .eq('empresa_id', empresaId)
                    .order('nome_colaborador');

                if (error) throw error;

                colaboradoresCache = data || [];
                colaboradoresTableBody.innerHTML = "";
                if (data && data.length > 0) {
                    data.forEach(colab => {
                        const row = colaboradoresTableBody.insertRow();
                        row.insertCell().textContent = colab.nome_colaborador;
                        row.insertCell().textContent = colab.ativo ? 'Sim' : 'Não';
                        row.insertCell().textContent = new Date(colab.created_at).toLocaleDateString('pt-BR');

                        const actionsCell = row.insertCell();
                        const btnToggleAtivo = document.createElement('button');
                        btnToggleAtivo.textContent = colab.ativo ? 'Desativar' : 'Ativar';
                        btnToggleAtivo.className = `btn ${colab.ativo ? 'btn-warning' : 'btn-success'} table-actions`;
                        btnToggleAtivo.onclick = () => handleToggleAtivoColaborador(colab.id, !colab.ativo, empresaId);
                        actionsCell.appendChild(btnToggleAtivo);

                        const btnDelete = document.createElement('button');
                        btnDelete.textContent = 'Excluir';
                        btnDelete.className = 'btn btn-danger table-actions';
                        btnDelete.onclick = () => handleDeleteColaborador(colab.id, colab.nome_colaborador, empresaId);
                        actionsCell.appendChild(btnDelete);
                    });
                } else {
                    colaboradoresTableBody.innerHTML = '<tr><td colspan="4">Nenhum colaborador cadastrado para esta empresa.</td></tr>';
                }
            } catch (e) {
                console.error("Erro ao buscar/renderizar colaboradores:", e);
                colaboradoresTableBody.innerHTML = `<tr><td colspan="4" style="color:var(--danger-color);">Erro ao carregar: ${e.message}</td></tr>`;
            } finally {
                hideLoader();
            }
        }
        async function handleToggleAtivoColaborador(colaboradorId, novoEstadoAtivo, empresaId) {
            if (!confirm(`Tem certeza que deseja ${novoEstadoAtivo ? 'ATIVAR' : 'DESATIVAR'} este colaborador?`)) return;
            showLoader();
            try {
                const { error } = await _supabaseClient.from('colaboradores')
                    .update({ ativo: novoEstadoAtivo })
                    .eq('id', colaboradorId);
                if (error) throw error;
                alert(`Colaborador ${novoEstadoAtivo ? 'ativado' : 'desativado'} com sucesso!`);
                await fetchAndRenderColaboradores(empresaId);
            } catch (e) {
                console.error(`Erro ao ${novoEstadoAtivo ? 'ativar' : 'desativar'} colaborador:`, e);
                alert(`Falha: ${e.message}`);
            } finally {
                hideLoader();
            }
        }


        async function handleAddColaborador() {
            if (!colaboradorNomeInput) { alert("Erro: Campo de nome do colaborador não encontrado."); return; }
            const nomeColaborador = colaboradorNomeInput.value.trim();
            const empresaId = colaboradorNomeInput.dataset.empresaId;

            if (!empresaId) { alert("Erro: ID da empresa não definido para adicionar colaborador."); return;}
            if (!nomeColaborador) { alert('Digite o nome do colaborador.'); return; }

            showLoader();
            try {
                 const { data: existing, error: checkError } = await _supabaseClient
                    .from('colaboradores')
                    .select('id')
                    .eq('nome_colaborador', nomeColaborador)
                    .eq('empresa_id', empresaId)
                    .maybeSingle();

                if (checkError) throw checkError;
                if (existing) {
                    alert('Um colaborador com este nome já existe nesta empresa.');
                    hideLoader(); return;
                }

                const { error } = await _supabaseClient.from('colaboradores')
                    .insert([{ nome_colaborador: nomeColaborador, empresa_id: empresaId, ativo: true }]);
                if (error) throw error;
                alert('Colaborador adicionado com sucesso!');
                colaboradorNomeInput.value = '';
                await fetchAndRenderColaboradores(empresaId);
            } catch (e) {
                console.error("Erro ao adicionar colaborador:", e);
                alert('Falha ao adicionar colaborador: ' + e.message);
            } finally {
                hideLoader();
            }
        }

        async function handleDeleteColaborador(colaboradorId, nomeColaborador, empresaId) {
            if (!confirm(`Tem certeza que deseja excluir o colaborador "${nomeColaborador}"?`)) return;
            showLoader();
            try {

                const { error } = await _supabaseClient.from('colaboradores').delete().eq('id', colaboradorId);
                if (error) throw error;
                alert(`Colaborador "${nomeColaborador}" excluído com sucesso!`);
                await fetchAndRenderColaboradores(empresaId);
            } catch (e) {
                console.error("Erro ao excluir colaborador:", e);
                alert('Falha ao excluir colaborador: ' + e.message);
            } finally {
                hideLoader();
            }
        }

        function showChangePasswordScreen_Empresa() {
            if (!currentUser || !(currentUser.role === 'empresa_manager' || currentUser.role === 'empresa_login_principal')) {
                alert("Apenas Gerentes da Empresa podem alterar a própria senha por esta tela.");
                if(currentUser.role === 'admin_master') showAdminMasterDashboardScreen();
                else if (currentUser.role === 'empresa_counter') showInventoryCountScreen_Empresa();
                else showEmpresaDashboardScreen();
                return;
            }
            console.log("showChangePasswordScreen_Empresa called");
            if (changePasswordMessage) changePasswordMessage.textContent = '';
            if (currentPasswordInput) currentPasswordInput.value = '';
            if (newPasswordInput) newPasswordInput.value = '';
            if (confirmNewPasswordInput) confirmNewPasswordInput.value = '';
            showScreen('changePassword');
        }

        async function handleChangePassword() {
            if (!newPasswordInput || !confirmNewPasswordInput || !changePasswordMessage || !currentPasswordInput) {
                alert("Erro: Campos de senha não encontrados."); return;
            }
            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmNewPasswordInput.value;
            const currentPwd = currentPasswordInput.value;

            changePasswordMessage.textContent = '';
            changePasswordMessage.style.color = 'var(--danger-color)';

            if (newPassword.length < 6) {
                changePasswordMessage.textContent = "Nova senha deve ter pelo menos 6 caracteres."; return;
            }
            if (newPassword !== confirmPassword) {
                changePasswordMessage.textContent = "As novas senhas não coincidem."; return;
            }
            if (!(currentUser.role === 'empresa_manager' || currentUser.role === 'empresa_login_principal')) {
                alert("Operação não permitida para esta função de usuário."); return;
            }
            if (!currentPwd) {
                changePasswordMessage.textContent = "Senha atual é obrigatória."; return;
            }

            showLoader();
            try {
                const { data, error } = await _supabaseClient.auth.updateUser({ password: newPassword });
                if (error) {
                    if (error.message.includes("same as the existing password") || error.message.includes("New password should be different from the old password.")) {
                         changePasswordMessage.textContent = 'A nova senha deve ser diferente da senha atual.';
                    } else if (error.message.includes("Error changing user password") || error.message.includes("Current password is not correct")) {
                         changePasswordMessage.textContent = 'Erro ao alterar senha. Verifique sua senha atual ou tente logar novamente.';
                    } else {
                        throw error;
                    }
                } else {
                    console.log("Password changed successfully for:", currentUser.email, data);
                    changePasswordMessage.textContent = 'Senha alterada com sucesso!';
                    changePasswordMessage.style.color = 'var(--success-color)';
                    newPasswordInput.value = '';
                    confirmNewPasswordInput.value = '';
                    if(currentPasswordInput) currentPasswordInput.value = '';
                }
            } catch (e) {
                console.error("Error changing password:", e);
                changePasswordMessage.textContent = 'Falha ao alterar senha: ' + e.message;
            } finally {
                hideLoader();
            }
        }

        async function showHistoricoContagensScreen() { // Empresa Manager
            if (!currentUser || !(currentUser.role === 'empresa_manager' || currentUser.role === 'empresa_login_principal')) {
                alert("Acesso negado ao histórico de contagens.");
                showEmpresaDashboardScreen();
                return;
            }
            console.log("showHistoricoContagensScreen (Empresa Manager) called");
            showLoader();
            try {
                const empresaNome = currentUser.empresa_nome || 'Sua Empresa';
                await fetchAndRenderHistoricoContagens(currentUser.empresa_id, false);
                showScreen('historicoContagens', {
                    title: `Histórico de Contagens (${empresaNome})`,
                    context: `Visualizando contagens para ${empresaNome}.`,
                    showEmpresaSelector: false,
                    showEmpresaColumnInTable: false
                });
            } catch (e) {
                console.error("Error in showHistoricoContagensScreen (Empresa Manager):", e);
                alert("Erro ao carregar histórico.");
            } finally {
                hideLoader();
            }
        }

        async function showHistoricoContagensScreen_Admin() {
            if (!currentUser || currentUser?.role !== 'admin_master') { handleLogout(); return; }
            console.log("showHistoricoContagensScreen_Admin called");
            showLoader();
            try {
                const adminHistEmpSelect = document.getElementById('adminHistoricoEmpresaSelect');
                await populateEmpresasSelect(adminHistEmpSelect, true, "-- Selecione uma Empresa --", "");

                if (adminHistEmpSelect) {
                    adminHistEmpSelect.value = adminSelectedEmpresaContextId || "";
                    if (!adminHistEmpSelect.onchangeAttached_hist_admin) {
                        adminHistEmpSelect.addEventListener('change', async () => {
                            adminSelectedEmpresaContextId = adminHistEmpSelect.value === "" ? null : adminHistEmpSelect.value;
                            const selectedEmpresa = empresasCache.find(e => e.id === adminSelectedEmpresaContextId);
                            const contextText = selectedEmpresa ? `Empresa: ${selectedEmpresa.nome_empresa}` : "Nenhuma empresa selecionada";
                             if(document.getElementById('historicoContext')) document.getElementById('historicoContext').textContent = contextText;
                            await fetchAndRenderHistoricoContagens(adminSelectedEmpresaContextId, true);
                        });
                        adminHistEmpSelect.onchangeAttached_hist_admin = true;
                    }
                    adminHistEmpSelect.dispatchEvent(new Event('change'));
                } else {
                    await fetchAndRenderHistoricoContagens(null, true);
                }

                showScreen('historicoContagens', {
                    title: 'Histórico de Contagens (Admin)',
                    context: 'Selecione uma empresa para filtrar o histórico.',
                    showEmpresaSelector: true,
                    showEmpresaColumnInTable: true
                });

            } catch (e) {
                console.error("Error in showHistoricoContagensScreen_Admin:", e);
                alert("Erro ao carregar histórico de admin.");
            } finally {
                hideLoader();
            }
        }

        async function fetchAndRenderHistoricoContagens(empresaIdFiltro = null, isAdminView = false) {
            if (!historicoContagensTableBody) { console.error("historicoContagensTableBody not found."); return; }

            if (isAdminView && !empresaIdFiltro) {
                historicoContagensTableBody.innerHTML = `<tr><td colspan="5">Selecione uma empresa para ver o histórico.</td></tr>`;
                hideLoader(); return;
            }

            historicoContagensTableBody.innerHTML = `<tr><td colspan="${isAdminView ? 5 : 4}">Carregando histórico...</td></tr>`;
            showLoader();
            try {
                let query = _supabaseClient.from('historico_contagens')
                                         .select('id, created_at, colaborador_nome, itens_contados, dados_contagem, empresa_id, empresas (nome_empresa)')
                                         .order('created_at', { ascending: false });

                if (empresaIdFiltro) {
                    query = query.eq('empresa_id', empresaIdFiltro);
                } else if (!isAdminView && currentUser?.empresa_id) {
                    query = query.eq('empresa_id', currentUser.empresa_id);
                } else if (isAdminView && !empresaIdFiltro) {
                     historicoContagensTableBody.innerHTML = `<tr><td colspan="5">Selecione uma empresa.</td></tr>`;
                     hideLoader(); return;
                }


                const { data, error } = await query;
                if (error) throw error;

                historicoContagensTableBody.innerHTML = "";
                if (data && data.length > 0) {
                    data.forEach(reg => {
                        const row = historicoContagensTableBody.insertRow();
                        if (isAdminView && document.getElementById('colEmpresaHistorico').style.display !== 'none') {
                             row.insertCell().textContent = reg.empresas?.nome_empresa || (reg.empresa_id ? `ID: ${reg.empresa_id}`: 'N/A');
                        }
                        row.insertCell().textContent = new Date(reg.created_at).toLocaleString('pt-BR');
                        row.insertCell().textContent = reg.colaborador_nome || "N/A";
                        row.insertCell().textContent = reg.itens_contados;

                        const actionsCell = row.insertCell();
                        const btnDetalhes = document.createElement('button');
                        btnDetalhes.textContent = 'Detalhes';
                        btnDetalhes.className = 'btn btn-info table-actions';
                        btnDetalhes.onclick = () => showDetalhesContagem(reg.dados_contagem, reg);
                        actionsCell.appendChild(btnDetalhes);
                    });
                } else {
                    historicoContagensTableBody.innerHTML = `<tr><td colspan="${isAdminView ? 5 : 4}">Nenhum registro de contagem encontrado para a seleção.</td></tr>`;
                }
            } catch (e) {
                console.error("Error fetching/rendering history:", e);
                historicoContagensTableBody.innerHTML = `<tr><td colspan="${isAdminView ? 5 : 4}" style="color:var(--danger-color);">Erro: ${e.message}</td></tr>`;
            } finally {
                hideLoader();
            }
        }

        function showDetalhesContagem(dadosContagem, registroCompleto = null) {
            if (!modalDetalhesContagem || !detalhesContagemConteudo) { console.error("Details modal or content not found."); return;}

            let htmlConteudo = '';
            if (registroCompleto) {
                htmlConteudo += `<p><strong>Data:</strong> ${new Date(registroCompleto.created_at).toLocaleString('pt-BR')}</p>`;
                htmlConteudo += `<p><strong>Colaborador:</strong> ${registroCompleto.colaborador_nome || 'N/A'}</p>`;
                 if (registroCompleto.empresas) {
                      htmlConteudo += `<p><strong>Empresa:</strong> ${registroCompleto.empresas.nome_empresa}</p>`;
                 } else if (registroCompleto.empresa_id) {
                       htmlConteudo += `<p><strong>Empresa ID:</strong> ${registroCompleto.empresa_id}</p>`;
                 }
                  htmlConteudo += `<hr>`;
            }

            if (dadosContagem && dadosContagem.length > 0) {
                htmlConteudo += '<table style="width:100%; font-size:0.9em;"><thead><tr><th>Cód.</th><th>Produto</th><th>Categoria</th><th>Qtd.</th></tr></thead><tbody>';
                dadosContagem.sort((a,b) => (a.nome || "").localeCompare(b.nome || "")).forEach(item => {
                    htmlConteudo += `<tr>
                        <td>${item.codigo || item.produto_id}</td>
                        <td>${item.nome || 'N/A'}</td>
                        <td>${item.categoria || 'N/A'}</td>
                        <td style="text-align:right;">${item.quantidade}</td>
                    </tr>`;
                });
                htmlConteudo += '</tbody></table>';
            } else {
                htmlConteudo += '<p>Nenhum item detalhado nesta contagem.</p>';
            }
            detalhesContagemConteudo.innerHTML = htmlConteudo;
            modalDetalhesContagem.classList.add('active');
        }

        function closeModalDetalhesContagem() { if(modalDetalhesContagem) modalDetalhesContagem.classList.remove('active'); }
        function closeModalPreviewContagem() { if(modalPreviewContagem) modalPreviewContagem.classList.remove('active'); }

        async function populateCategoriaSelect_ProdutoForm(empresaIdParaCategorias) {
            if (!prodCategoriaSelect) { console.warn("Product category select (prodCategoriaSelect) not found."); return; }
            prodCategoriaSelect.innerHTML = '<option value="">-- Carregando Categorias... --</option>';

            if (!empresaIdParaCategorias) {
                prodCategoriaSelect.innerHTML = '<option value="">-- Selecione uma Empresa Primeiro --</option>';
                console.warn("populateCategoriaSelect_ProdutoForm: empresaIdParaCategorias não fornecido.");
                return;
            }

            const currentValue = prodCategoriaSelect.value;
            showLoader();
            try {
                const { data: companySpecificCategories, error } = await _supabaseClient.from('categorias')
                    .select('id, nome_categoria')
                    .eq('empresa_id', empresaIdParaCategorias)
                    .order('nome_categoria');

                if (error) throw error;
                prodCategoriaSelect.innerHTML = '<option value="">-- Sem Categoria --</option>';
                (companySpecificCategories || []).forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.nome_categoria;
                    prodCategoriaSelect.appendChild(option);
                });

                if (currentValue && Array.from(prodCategoriaSelect.options).some(opt => opt.value === currentValue)) {
                    prodCategoriaSelect.value = currentValue;
                } else {
                    prodCategoriaSelect.value = "";
                }

            } catch (e) {
                console.error("Error populating product category select:", e);
                prodCategoriaSelect.innerHTML = '<option value="">Erro ao carregar categorias</option>';
            } finally {
                hideLoader();
            }
        }

        async function showProductManagementScreen_AdminGlobal() {
            if (!currentUser || currentUser?.role !== 'admin_master') { handleLogout(); return; }
            console.log("showProductManagementScreen_AdminGlobal v2.10.2 called");
            showLoader();
            try {
                adminSelectedEmpresaContextId = null;
                if(adminProdutoEmpresaSelect) {
                    await populateEmpresasSelect(adminProdutoEmpresaSelect, true, "-- Selecione uma Empresa --", "");
                    adminProdutoEmpresaSelect.value = "";
                    if (!adminProdutoEmpresaSelect.onchangeAttached_prod_admin) {
                        adminProdutoEmpresaSelect.addEventListener('change', async () => {
                            adminSelectedEmpresaContextId = adminProdutoEmpresaSelect.value === "" ? null : adminProdutoEmpresaSelect.value;
                            const selectedEmpresa = empresasCache.find(e => e.id === adminSelectedEmpresaContextId);
                            const empresaNomeContext = selectedEmpresa ? selectedEmpresa.nome_empresa : "Nenhuma empresa selecionada";
                            if(document.getElementById('productManagementContext')) document.getElementById('productManagementContext').textContent = `Gerenciando para: ${empresaNomeContext}`;

                            if(btnAddProductEl) btnAddProductEl.disabled = !adminSelectedEmpresaContextId;
                            if(btnImportXLSXEl) btnImportXLSXEl.disabled = !adminSelectedEmpresaContextId;

                            if (adminSelectedEmpresaContextId) {
                                await populateCategoriaSelect_ProdutoForm(adminSelectedEmpresaContextId);
                                await fetchProductsFromSupabase(adminSelectedEmpresaContextId);
                            } else {
                                if(prodCategoriaSelect) prodCategoriaSelect.innerHTML = '<option value="">-- Selecione uma Empresa Primeiro --</option>';
                                produtosCache = [];
                            }
                            renderProductManagementTable();
                        });
                        adminProdutoEmpresaSelect.onchangeAttached_prod_admin = true;
                    }
                    adminProdutoEmpresaSelect.dispatchEvent(new Event('change'));
                } else {
                    produtosCache = []; renderProductManagementTable();
                    if(prodCategoriaSelect) prodCategoriaSelect.innerHTML = '<option value="">-- Selecione uma Empresa --</option>';
                }
                showScreen('productManagement', { title: 'Gerenciar Produtos (Admin)', context: 'Selecione uma empresa para ver ou adicionar produtos.', showEmpresaSelector: true });

            } catch (e) { console.error("Error showProductManagementScreen_AdminGlobal:", e); alert("Erro tela de produtos admin."); }
            finally { hideLoader(); }
        }

        async function showProductManagementScreen_Empresa() {
            if (!currentUser || !(currentUser.role === 'empresa_manager' || currentUser.role === 'empresa_login_principal') || !currentUser.empresa_id) {
                 alert("Acesso negado à gestão de produtos.");
                 showEmpresaDashboardScreen();
                 return;
            }
            console.log("showProductManagementScreen_Empresa called");
            showLoader();
            try {
                adminSelectedEmpresaContextId = currentUser.empresa_id;
                if(btnAddProductEl) btnAddProductEl.disabled = false;
                if(btnImportXLSXEl) btnImportXLSXEl.disabled = false;

                await populateCategoriaSelect_ProdutoForm(adminSelectedEmpresaContextId);
                await fetchProductsFromSupabase(adminSelectedEmpresaContextId);
                renderProductManagementTable();
                showScreen('productManagement', {
                    title: `Gerenciar Produtos (${currentUser.empresa_nome || 'Sua Empresa'})`,
                    context: `Gerenciando produtos para ${currentUser.empresa_nome || 'sua empresa'}.`,
                    showEmpresaSelector: false
                });

            } catch (e) {
                console.error("Error in showProductManagementScreen_Empresa:", e);
                alert("Erro ao carregar tela de gestão de produtos da empresa.");
            } finally {
                hideLoader();
            }
        }

        async function fetchProductsFromSupabase(empresaIdFiltro) {
            showLoader();
             if (!empresaIdFiltro) {
                console.warn("fetchProductsFromSupabase: empresaIdFiltro é nulo/vazio.");
                produtosCache = [];
                hideLoader();
                return;
            }
            try {
                const { data, error } = await _supabaseClient.from('produtos')
                    .select('*, categorias(id, nome_categoria)')
                    .eq('empresa_id', empresaIdFiltro)
                    .order('nome_produto');

                if (error) throw error;
                produtosCache = data || [];
                console.log(`Products loaded for company ID ${empresaIdFiltro}:`, produtosCache.length);
            } catch (e) {
                console.error("Error fetching products:", e);
                produtosCache = [];
                alert(`Erro ao carregar produtos: ${e.message}`);
            } finally {
                hideLoader();
            }
        }

        function renderProductManagementTable() {
            if (!productManagementTableBody) { console.error("productManagementTableBody not found"); return; }
            productManagementTableBody.innerHTML = "";

            if (produtosCache.length === 0) {
                productManagementTableBody.innerHTML = `<tr><td colspan="4">Nenhum produto cadastrado para a empresa selecionada.</td></tr>`;
                return;
            }

            produtosCache.forEach(produto => {
                const row = productManagementTableBody.insertRow();
                row.insertCell().textContent = produto.codigo_produto;
                row.insertCell().textContent = produto.nome_produto;
                row.insertCell().textContent = produto.categorias ? produto.categorias.nome_categoria : (produto.categoria_id ? 'Categoria Inválida' : 'Sem Categoria');

                const actionsCell = row.insertCell();
                const btnRemove = document.createElement('button');
                btnRemove.textContent = 'Remover';
                btnRemove.className = 'btn btn-danger table-actions';
                btnRemove.onclick = () => handleRemoveProduct(produto.id, produto.nome_produto, produto.empresa_id);
                actionsCell.appendChild(btnRemove);
            });
        }

        async function handleAddProduct() {
            if (!prodCodigoInput || !prodNomeInput || !prodCategoriaSelect) {
                alert("Erro: Campos do formulário de produto não encontrados."); return;
            }
            const codigo = prodCodigoInput.value.trim();
            const nome = prodNomeInput.value.trim();
            const categoriaId = prodCategoriaSelect.value === "" ? null : prodCategoriaSelect.value;

            let empresaParaProdutoId = null;
            if (currentUser?.role === 'admin_master') {
                empresaParaProdutoId = adminSelectedEmpresaContextId;
                if (!empresaParaProdutoId) {
                    alert("Admin: Selecione uma empresa primeiro para adicionar o produto.");
                    return;
                }
            } else if (currentUser?.role === 'empresa_manager' || currentUser?.role === 'empresa_login_principal') {
                empresaParaProdutoId = currentUser.empresa_id;
                 if (!empresaParaProdutoId) {
                    alert("Erro: ID da sua empresa não encontrado."); return;
                }
            } else {
                alert("Permissão negada."); return;
            }


            if (!codigo) { alert("Código do produto é obrigatório."); prodCodigoInput.focus(); return; }
            if (!nome) { alert("Nome do produto é obrigatório."); prodNomeInput.focus(); return; }

            showLoader();
            try {
                const { data: existing, error: checkError } = await _supabaseClient.from('produtos')
                    .select('id')
                    .eq('codigo_produto', codigo)
                    .eq('empresa_id', empresaParaProdutoId)
                    .maybeSingle();

                if (checkError) throw checkError;
                if (existing) {
                    alert(`Um produto com o código "${codigo}" já existe para esta empresa.`);
                    hideLoader(); return;
                }

                const { data, error } = await _supabaseClient.from('produtos').insert([
                    {
                        codigo_produto: codigo,
                        nome_produto: nome,
                        categoria_id: categoriaId,
                        empresa_id: empresaParaProdutoId
                    }
                ]).select().single();

                if (error) throw error;
                alert(`Produto "${nome}" adicionado com sucesso!`);
                prodCodigoInput.value = '';
                prodNomeInput.value = '';
                prodCategoriaSelect.value = '';

                await fetchProductsFromSupabase(empresaParaProdutoId);
                renderProductManagementTable();

            } catch (e) {
                console.error("Error adding product:", e);
                alert('Falha ao adicionar produto: ' + e.message);
            } finally {
                hideLoader();
            }
        }

        async function handleRemoveProduct(produtoId, nomeProduto, produtoEmpresaId) {
            if (!confirm(`Tem certeza que deseja remover o produto "${nomeProduto}"? Esta ação não pode ser desfeita.`)) return;

            let canDelete = false;
            if (currentUser?.role === 'admin_master' && produtoEmpresaId === adminSelectedEmpresaContextId) {
                canDelete = true;
            } else if ((currentUser?.role === 'empresa_manager' || currentUser?.role === 'empresa_login_principal') && produtoEmpresaId === currentUser.empresa_id) {
                canDelete = true;
            }
            if(!canDelete){
                 alert("Você não tem permissão para remover este produto."); return;
            }

            showLoader();
            try {
                const { error } = await _supabaseClient.from('produtos').delete().eq('id', produtoId);
                if (error) throw error;
                alert(`Produto "${nomeProduto}" removido com sucesso!`);

                await fetchProductsFromSupabase(produtoEmpresaId);
                renderProductManagementTable();

            } catch (e) {
                console.error("Error removing product:", e);
                alert('Falha ao remover produto: ' + e.message);
            } finally {
                hideLoader();
            }
        }

        async function handleXLSXImport() {
            if (!xlsxFileInput || !xlsxFileInput.files || xlsxFileInput.files.length === 0) {
                alert("Por favor, selecione um arquivo XLSX."); return;
            }

            let empresaParaImportacaoId = null;
            if (currentUser?.role === 'admin_master') {
                empresaParaImportacaoId = adminSelectedEmpresaContextId;
                if (!empresaParaImportacaoId) {
                    alert("Admin: Por favor, selecione uma empresa primeiro na tela de 'Gerenciar Produtos' antes de importar.");
                    return;
                }
            } else if (currentUser?.role === 'empresa_manager' || currentUser?.role === 'empresa_login_principal') {
                empresaParaImportacaoId = currentUser.empresa_id;
                if (!empresaParaImportacaoId) {
                    alert("Erro: ID da sua empresa não encontrado. Não é possível importar."); return;
                }
            } else {
                alert("Permissão negada para importar."); return;
            }


            const file = xlsxFileInput.files[0];
            const reader = new FileReader();

            reader.onload = async (e) => {
                showLoader();
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false, defval: "" });

                    if (!jsonData || jsonData.length < 1) {
                        alert("Planilha vazia ou formato inesperado. Verifique o arquivo XLSX.");
                        hideLoader(); return;
                    }

                    const headerRow = jsonData[0];
                    if (!Array.isArray(headerRow)) {
                        alert("Formato de cabeçalho inesperado. A primeira linha não é uma lista de células.");
                        hideLoader(); return;
                    }

                    const header = headerRow.map((h) => {
                        if (h === null || typeof h === 'undefined') return "";
                        return String(h).toLowerCase().trim();
                    });

                    const codigoIndex = header.indexOf('codigo');
                    const produtoIndex = header.indexOf('produto');
                    const categoriaIndex = header.indexOf('categoria');

                    if (codigoIndex === -1 || produtoIndex === -1) {
                        alert("Cabeçalho inválido. Colunas 'codigo' e 'produto' são obrigatórias. 'categoria' é opcional.");
                        hideLoader(); return;
                    }

                    const {data: companyCategories, error: catErr} = await _supabaseClient.from('categorias')
                        .select('id, nome_categoria')
                        .eq('empresa_id', empresaParaImportacaoId);

                    if(catErr) {
                        throw new Error("Erro ao carregar categorias da empresa para importação.");
                    }

                    const categoriaMap = new Map();
                    (companyCategories || []).forEach(cat => {
                        if (cat.nome_categoria) {
                            categoriaMap.set(String(cat.nome_categoria).toLowerCase().trim(), cat.id);
                        }
                    });

                    const produtosParaInserir = [];
                    let produtosIgnoradosCount = 0;
                    let categoriasCriadasNestaSessao = new Map();

                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (!row || !Array.isArray(row) || row.every(cell => cell === "" || cell === null || typeof cell === 'undefined') ) {
                            continue;
                        }

                        const codigoValue = row[codigoIndex];
                        const nomeProdutoValue = row[produtoIndex];
                        const categoriaValue = (categoriaIndex !== -1 && typeof row[categoriaIndex] !== 'undefined') ? row[categoriaIndex] : "";

                        const codigo = (codigoValue !== null && typeof codigoValue !== 'undefined') ? String(codigoValue).trim() : null;
                        const nomeProduto = (nomeProdutoValue !== null && typeof nomeProdutoValue !== 'undefined') ? String(nomeProdutoValue).trim() : null;
                        let nomeCategoriaXLSX = (categoriaValue !== null && typeof categoriaValue !== 'undefined') ? String(categoriaValue).trim() : null;
                        if (nomeCategoriaXLSX === "") nomeCategoriaXLSX = null;

                        if (!codigo || !nomeProduto) {
                            produtosIgnoradosCount++;
                            continue;
                        }

                        let categoriaIdParaProduto = null;
                        if (nomeCategoriaXLSX) {
                            const nomeCategoriaLower = nomeCategoriaXLSX.toLowerCase();
                            categoriaIdParaProduto = categoriaMap.get(nomeCategoriaLower);

                            if (!categoriaIdParaProduto) {
                                if (categoriasCriadasNestaSessao.has(nomeCategoriaLower)) {
                                    categoriaIdParaProduto = categoriasCriadasNestaSessao.get(nomeCategoriaLower);
                                } else {
                                    const { data: novaCategoria, error: createCatErr } = await _supabaseClient
                                        .from('categorias')
                                        .insert({ nome_categoria: nomeCategoriaXLSX, empresa_id: empresaParaImportacaoId })
                                        .select('id')
                                        .single();
                                    if (createCatErr) {
                                        console.error(`Erro ao criar nova categoria "${nomeCategoriaXLSX}" para empresa ${empresaParaImportacaoId}:`, createCatErr);
                                    } else if (novaCategoria) {
                                        categoriaIdParaProduto = novaCategoria.id;
                                        categoriaMap.set(nomeCategoriaLower, categoriaIdParaProduto);
                                        categoriasCriadasNestaSessao.set(nomeCategoriaLower, categoriaIdParaProduto);
                                    }
                                }
                            }
                        }

                        const { count: existingProdCount, error: checkProdError} = await _supabaseClient.from('produtos')
                            .select('id', { count: 'exact', head: true })
                            .eq('codigo_produto', codigo)
                            .eq('empresa_id', empresaParaImportacaoId);

                        if(checkProdError) throw checkProdError;

                        if(existingProdCount && existingProdCount > 0) {
                            produtosIgnoradosCount++;
                            continue;
                        }

                        const produtoParaInserir = {
                            codigo_produto: String(codigo),
                            nome_produto: String(nomeProduto),
                            categoria_id: categoriaIdParaProduto,
                            empresa_id: empresaParaImportacaoId
                        };
                        produtosParaInserir.push(produtoParaInserir);
                    }

                    if (produtosParaInserir.length > 0) {
                        const { data: insertedData, error: insertError } = await _supabaseClient
                            .from('produtos')
                            .insert(produtosParaInserir)
                            .select();
                        if (insertError) {
                            let detailedMessage = insertError.message;
                            if (insertError.details) detailedMessage += `\nDetalhes: ${insertError.details}`;
                            if (insertError.hint) detailedMessage += `\nHint: ${insertError.hint}`;
                            alert("Falha ao importar produtos (durante inserção): " + detailedMessage);
                            throw insertError;
                        }
                        const successfulInserts = insertedData ? insertedData.length : 0;
                        alert(`${successfulInserts} produtos importados com sucesso! ${produtosIgnoradosCount > 0 ? `${produtosIgnoradosCount} produtos foram ignorados (já existentes, dados inválidos ou linhas em branco).` : ''}`);
                    } else {
                        alert(`Nenhum produto novo para importar. ${produtosIgnoradosCount > 0 ? `${produtosIgnoradosCount} produtos foram ignorados (já existentes, dados inválidos ou linhas em branco).` : ''}`);
                    }

                    await fetchProductsFromSupabase(empresaParaImportacaoId);
                    renderProductManagementTable();
                    if (prodCategoriaSelect && empresaParaImportacaoId) {
                        await populateCategoriaSelect_ProdutoForm(empresaParaImportacaoId);
                    }
                } catch (e) {
                    console.error("Erro detalhado ao importar XLSX:", e, e.stack);
                    alert("Falha ao importar XLSX: " + e.message + (e.stack ? `\nDetalhes: ${e.stack.substring(0, 400)}` : ''));
                } finally {
                    if(xlsxFileInput) xlsxFileInput.value = '';
                    hideLoader();
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function showInventoryCountScreen_AdminGlobal() {
            if (!currentUser || currentUser?.role !== 'admin_master') { handleLogout(); return; }
            console.log("showInventoryCountScreen_AdminGlobal called");
            showLoader();
            try {
                adminSelectedEmpresaContextId = null;
                const adminCountEmpSelect = document.getElementById('adminContagemEmpresaSelect');
                await populateEmpresasSelect(adminCountEmpSelect, true, "-- Selecione uma Empresa --", "");

                if (adminCountEmpSelect) {
                    adminCountEmpSelect.value = "";
                    if (!adminCountEmpSelect.onchangeAttached_count_admin) {
                        adminCountEmpSelect.addEventListener('change', async () => {
                            adminSelectedEmpresaContextId = adminCountEmpSelect.value === "" ? null : adminCountEmpSelect.value;
                            const selectedEmpresa = empresasCache.find(e => e.id === adminSelectedEmpresaContextId);
                            const empresaNomeContext = selectedEmpresa ? selectedEmpresa.nome_empresa : "Nenhuma empresa selecionada";
                            if(document.getElementById('inventoryCountContext')) document.getElementById('inventoryCountContext').textContent = `Realizando contagem para: ${empresaNomeContext}`;

                            if(adminSelectedEmpresaContextId){
                                await loadColaboradoresParaContagem(adminSelectedEmpresaContextId, true);
                                await loadProductsForInventory(adminSelectedEmpresaContextId);
                            } else {
                                if(selectColaboradorContagem) selectColaboradorContagem.innerHTML = '<option value="">-- Selecione Empresa Primeiro --</option>';
                                produtosCache = [];
                                categoriasCache = [];
                            }
                            await populateCategoryFilter();
                            displayInventoryProducts(produtosCache);
                        });
                        adminCountEmpSelect.onchangeAttached_count_admin = true;
                    }
                    adminCountEmpSelect.dispatchEvent(new Event('change'));
                } else {
                     produtosCache = []; categoriasCache = []; displayInventoryProducts(produtosCache);
                     if(selectColaboradorContagem) selectColaboradorContagem.innerHTML = '<option value="">-- Selecione Empresa Primeiro --</option>';
                     updateExportButtonStates();
                }
                showScreen('inventoryCount', { title: 'Balanço de Estoque (Admin)', context: 'Selecione uma empresa para realizar a contagem.', showEmpresaSelector: true });
            } catch (e) {
                console.error("Error in showInventoryCountScreen_AdminGlobal:", e);
                alert("Erro ao carregar tela de contagem admin.");
            } finally {
                hideLoader();
            }
        }

        async function showInventoryCountScreen_Empresa() {
            if (!currentUser || !(currentUser.role === 'empresa_manager' || currentUser.role === 'empresa_counter' || currentUser.role === 'empresa_login_principal') || !currentUser.empresa_id) {
                 alert("Acesso negado à contagem de estoque.");
                 if(currentUser?.role === 'empresa_manager' || currentUser?.role === 'empresa_login_principal') showEmpresaDashboardScreen();
                 else handleLogout();
                 return;
            }
            console.log("showInventoryCountScreen_Empresa called for role:", currentUser.role);
            showLoader();
            try {
                adminSelectedEmpresaContextId = currentUser.empresa_id;
                const empresaNomeContext = currentUser.empresa_nome || 'Sua Empresa';
                if(document.getElementById('inventoryCountContext')) document.getElementById('inventoryCountContext').textContent = `Realizando contagem para: ${empresaNomeContext}`;

                await loadColaboradoresParaContagem(adminSelectedEmpresaContextId, false);
                await loadProductsForInventory(adminSelectedEmpresaContextId);
                await populateCategoryFilter();
                displayInventoryProducts(produtosCache);

                showScreen('inventoryCount', { title: `Balanço de Estoque (${empresaNomeContext})`, context: `Contagem para ${empresaNomeContext}`, showEmpresaSelector: false });
            } catch (e) {
                console.error("Error in showInventoryCountScreen_Empresa:", e);
                alert("Erro ao carregar tela de contagem da empresa.");
            } finally {
                hideLoader();
            }
        }

        async function loadProductsForInventory(empresaIdContexto) {
            showLoader();
             if (!empresaIdContexto) {
                console.warn("loadProductsForInventory: empresaIdContexto é nulo/vazio.");
                produtosCache = []; categoriasCache = [];
                hideLoader(); return;
            }
            try {
                const { data: productsData, error: productsError } = await _supabaseClient.from('produtos')
                    .select('*, categorias(id, nome_categoria)')
                    .eq('empresa_id', empresaIdContexto)
                    .order('nome_produto');
                if (productsError) throw productsError;
                produtosCache = productsData || [];
                console.log(`Products loaded for inventory (CID: ${empresaIdContexto}): ${produtosCache.length}`);

                const { data: categoriesData, error: categoriesError } = await _supabaseClient.from('categorias')
                    .select('id, nome_categoria, empresa_id')
                    .eq('empresa_id', empresaIdContexto)
                    .order('nome_categoria');
                if (categoriesError) {
                    console.warn("Could not load categories for inventory context:", categoriesError);
                    categoriasCache = [];
                } else {
                    categoriasCache = categoriesData || [];
                    console.log(`Categories loaded for inventory (CID: ${empresaIdContexto}): ${categoriasCache.length}`);
                }
            } catch (e) {
                console.error("Error fetching products/categories for count:", e);
                produtosCache = []; categoriasCache = [];
                alert(`Erro ao carregar produtos/categorias para contagem: ${e.message}`);
            } finally {
                hideLoader();
            }
        }

        async function loadColaboradoresParaContagem(empresaId, isAdminAlsoCounter = false) {
            if (!selectColaboradorContagem) { console.warn("Seletor de colaborador para contagem não encontrado."); return; }
            selectColaboradorContagem.innerHTML = '<option value="">-- Selecione Colaborador --</option>';

            if (!empresaId) {
                 selectColaboradorContagem.innerHTML = '<option value="">-- Selecione Empresa Primeiro --</option>';
                 return;
            }
            showLoader();
            try {
                let colaboradoresParaSelect = [];
                if (empresaId) {
                    const { data, error } = await _supabaseClient.from('colaboradores')
                        .select('id, nome_colaborador')
                        .eq('empresa_id', empresaId)
                        .eq('ativo', true)
                        .order('nome_colaborador');
                    if (error) throw error;
                    colaboradoresParaSelect = data || [];

                    if (currentUser?.role === 'admin_master' && isAdminAlsoCounter) {
                         colaboradoresParaSelect.unshift({id: `admin_${currentUser.id}`, nome_colaborador: `${currentUser.full_name || currentUser.email} (Admin)`});
                    } else if ((currentUser?.role === 'empresa_manager' || currentUser?.role === 'empresa_counter' || currentUser?.role === 'empresa_login_principal') && !isAdminAlsoCounter) {
                        const loggedInUserName = currentUser.full_name || currentUser.email;
                        if (!colaboradoresParaSelect.some(c => c.nome_colaborador === loggedInUserName && c.id !== `user_${currentUser.id}`)) {
                             colaboradoresParaSelect.unshift({id: `user_${currentUser.id}`, nome_colaborador: `${loggedInUserName} (Usuário Logado)`});
                        }
                    }
                }

                if (colaboradoresParaSelect.length > 0) {
                    colaboradoresParaSelect.forEach(colab => {
                        const option = document.createElement('option');
                        option.value = colab.id;
                        option.textContent = colab.nome_colaborador;
                        selectColaboradorContagem.appendChild(option);
                    });
                    if ((currentUser?.role === 'empresa_manager' || currentUser?.role === 'empresa_counter' || currentUser?.role === 'empresa_login_principal') && !isAdminAlsoCounter) {
                        const loggedInUserOption = Array.from(selectColaboradorContagem.options).find(opt => opt.value === `user_${currentUser.id}`);
                        if (loggedInUserOption) loggedInUserOption.selected = true;
                    } else if (currentUser?.role === 'admin_master' && isAdminAlsoCounter) {
                         const adminOption = Array.from(selectColaboradorContagem.options).find(opt => opt.value === `admin_${currentUser.id}`);
                        if (adminOption) adminOption.selected = true;
                    }
                } else {
                    selectColaboradorContagem.innerHTML = '<option value="">Nenhum colaborador ativo encontrado para esta empresa</option>';
                }
            } catch (e) {
                console.error("Error loading collaborators for count:", e);
                selectColaboradorContagem.innerHTML = '<option value="">Erro ao carregar</option>';
            } finally {
                hideLoader();
            }
        }

        async function populateCategoryFilter(selectElementId = 'filtroCategoria') {
            const filterSelect = document.getElementById(selectElementId);
            if (!filterSelect) { console.warn(`Category filter select '${selectElementId}' not found.`); return; }

            const currentFilterValue = filterSelect.value;
            filterSelect.innerHTML = '<option value="">Todas as Categorias</option>';

            let relevantEmpresaId = null;
            if (currentUser.role === 'admin_master') {
                relevantEmpresaId = adminSelectedEmpresaContextId;
            } else if (currentUser.role === 'empresa_manager' || currentUser.role === 'empresa_counter' || currentUser.role === 'empresa_login_principal') {
                relevantEmpresaId = currentUser.empresa_id;
            }

            if (!relevantEmpresaId) {
                filterSelect.innerHTML = '<option value="">-- Selecione Empresa Primeiro --</option>';
                return;
            }
            const uniqueCategories = new Map();
            (categoriasCache || []).filter(c => c.empresa_id === relevantEmpresaId).forEach(cat => {
                if (cat.id && cat.nome_categoria) {
                    if (!uniqueCategories.has(cat.id)) {
                        uniqueCategories.set(cat.id, cat.nome_categoria);
                    }
                }
            });
            if (produtosCache.filter(p => p.empresa_id === relevantEmpresaId).some(p => !p.categoria_id)) {
                 if (!uniqueCategories.has("NO_CATEGORY_ID_FILTER_VAL")) {
                    uniqueCategories.set("NO_CATEGORY_ID_FILTER_VAL", "Sem Categoria");
                }
            }

            const sortedCategories = Array.from(uniqueCategories.entries())
                .map(([id, name]) => ({ id, name }))
                .sort((a, b) => a.name.localeCompare(b.name));

            sortedCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id === "NO_CATEGORY_ID_FILTER_VAL" ? "SEM_CATEGORIA_FILTER" : cat.id;
                option.textContent = cat.name;
                filterSelect.appendChild(option);
            });

            if (Array.from(filterSelect.options).some(opt => opt.value === currentFilterValue)) {
                 filterSelect.value = currentFilterValue;
            } else {
                 filterSelect.value = "";
            }
        }


        function displayInventoryProducts(listaProdutos) {
            if (!inventoryTableBody) { console.error("inventoryTableBody not found"); return; }
            inventoryTableBody.innerHTML = "";
            loadQuantities();

            if (!listaProdutos || listaProdutos.length === 0) {
                inventoryTableBody.innerHTML = `<tr><td colspan="4">Nenhum produto para exibir. ${currentUser.role === 'admin_master' && !adminSelectedEmpresaContextId ? 'Selecione uma empresa para carregar produtos.' : 'Verifique os filtros ou cadastre produtos para esta empresa.'}</td></tr>`;
                updateExportButtonStates();
                return;
            }

            listaProdutos.forEach(produto => {
                const row = inventoryTableBody.insertRow();
                row.insertCell().textContent = produto.codigo_produto;
                row.insertCell().textContent = produto.nome_produto;
                let categoriaNome = 'Sem Categoria';
                if (produto.categorias?.nome_categoria) {
                    categoriaNome = produto.categorias.nome_categoria;
                } else if (produto.categoria_id) {
                    const foundCat = categoriasCache.find(c => c.id === produto.categoria_id);
                    categoriaNome = foundCat ? foundCat.nome_categoria : 'Categoria Inválida';
                }
                row.insertCell().textContent = categoriaNome;


                const qtdCell = row.insertCell();
                const qtdInput = document.createElement('input');
                qtdInput.type = 'number';
                qtdInput.min = '0';
                qtdInput.dataset.produtoId = produto.id;
                qtdInput.value = quantidadesDigitadas[produto.id] || '';
                const handleQtyChange = (e) => {
                    const val = e.target.value;
                    if (val === '' || parseFloat(val) < 0) {
                        delete quantidadesDigitadas[produto.id];
                        if(parseFloat(val) < 0) e.target.value = '';
                    } else {
                        quantidadesDigitadas[produto.id] = parseFloat(val);
                    }
                    saveQuantities();
                    updateExportButtonStates();
                };
                qtdInput.addEventListener('change', handleQtyChange);
                qtdInput.addEventListener('input', updateExportButtonStates);
                 qtdInput.addEventListener('focus', (e) => e.target.select());
                qtdCell.appendChild(qtdInput);
            });
            updateExportButtonStates();
        }

        function filterInventoryProducts() {
            const termoProduto = pesquisaProdutoInput.value.toLowerCase();
            const termoCodigo = pesquisaCodigoInput.value.toLowerCase();
            const categoriaIdFiltro = filtroCategoriaSelect.value;

            const produtosFiltrados = produtosCache.filter(produto => {
                const matchProduto = !termoProduto || produto.nome_produto.toLowerCase().includes(termoProduto);
                const matchCodigo = !termoCodigo || produto.codigo_produto.toLowerCase().includes(termoCodigo);

                let matchCategoria = true;
                if (categoriaIdFiltro) {
                     if (categoriaIdFiltro === "SEM_CATEGORIA_FILTER") {
                        matchCategoria = !produto.categoria_id;
                    } else {
                        matchCategoria = produto.categoria_id === categoriaIdFiltro;
                    }
                }
                return matchProduto && matchCodigo && matchCategoria;
            });
            displayInventoryProducts(produtosFiltrados);
        }

        function clearAllQuantities() {
            if (confirm("Tem certeza que deseja limpar todas as quantidades digitadas nesta tela?")) {
                quantidadesDigitadas = {};
                saveQuantities();

                const inputs = inventoryTableBody.querySelectorAll('input[type=number]');
                inputs.forEach(input => input.value = '');
                console.log("Quantities cleared.");
                updateExportButtonStates();
            }
        }

        function showPreviewContagem() {
            if (!modalPreviewContagem || !previewContagemTableContainer) {
                console.error("Preview modal or table container not found."); return;
            }
            const tableBody = previewContagemTableContainer.querySelector('#previewContagemTable tbody');
            if (!tableBody) { console.error("Preview table body not found."); return; }

            tableBody.innerHTML = '';
            const produtosContados = produtosCache.filter(p => quantidadesDigitadas[p.id] && parseFloat(quantidadesDigitadas[p.id]) > 0);

            if (produtosContados.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4">Nenhum item com quantidade maior que zero para exibir.</td></tr>';
            } else {
                produtosContados.sort((a,b) => (a.nome_produto || "").localeCompare(b.nome_produto || "")).forEach(produto => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = produto.codigo_produto;
                    row.insertCell().textContent = produto.nome_produto;
                    let categoriaNome = 'Sem Categoria';
                    if (produto.categorias?.nome_categoria) {
                        categoriaNome = produto.categorias.nome_categoria;
                    } else if (produto.categoria_id) {
                        const foundCat = categoriasCache.find(c => c.id === produto.categoria_id);
                        categoriaNome = foundCat ? foundCat.nome_categoria : 'Categoria Inválida';
                    }
                    row.insertCell().textContent = categoriaNome;
                    const qtdCell = row.insertCell();
                    qtdCell.style.textAlign = 'right';
                    qtdCell.textContent = quantidadesDigitadas[produto.id];
                });
            }
            modalPreviewContagem.classList.add('active');
        }


        window.onload = async () => {
            console.log("window.onload v2.10.2 (User Role Fixes) started");
            initializeDOMSelectors();
            showLoader();
            if (typeof loadQuantities === "function") loadQuantities();
            else console.error("CRITICAL: loadQuantities is not defined!");


            document.getElementById('loginButton')?.addEventListener('click', handleLogin);
            document.getElementById('loginPassword')?.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); handleLogin(); }});
            document.getElementById('btnLogoutAdmin')?.addEventListener('click', handleLogout);
            document.getElementById('btnLogoutEmpresa')?.addEventListener('click', handleLogout);


            document.getElementById('btnAdminGerenciarEmpresas')?.addEventListener('click', showAdminEmpresasScreen);
            document.getElementById('btnAdminGerenciarCategorias')?.addEventListener('click', showCategoriasScreen_Admin);
            document.getElementById('btnAdminGerenciarProdutos')?.addEventListener('click', showProductManagementScreen_AdminGlobal);
            document.getElementById('btnAdminContagemEstoque')?.addEventListener('click', showInventoryCountScreen_AdminGlobal);
            document.getElementById('btnAdminHistoricoContagens')?.addEventListener('click', showHistoricoContagensScreen_Admin);


            document.getElementById('btnEmpresaGerenciarColaboradores')?.addEventListener('click', () => showEmpresaColaboradoresScreen(null, null, false));
            document.getElementById('btnEmpresaGerenciarCategorias')?.addEventListener('click', showCategoriasScreen_Empresa);
            document.getElementById('btnEmpresaGerenciarProdutos')?.addEventListener('click', showProductManagementScreen_Empresa);
            document.getElementById('btnEmpresaContagemEstoque')?.addEventListener('click', showInventoryCountScreen_Empresa);
            document.getElementById('btnEmpresaHistoricoContagens')?.addEventListener('click', showHistoricoContagensScreen);
            document.getElementById('btnEmpresaAlterarSenha')?.addEventListener('click', showChangePasswordScreen_Empresa);


            btnCategoriasVoltarEl?.addEventListener('click', () => {
                if (currentUser?.role === 'admin_master') showAdminMasterDashboardScreen();
                else if (currentUser?.role === 'empresa_manager' || currentUser?.role === 'empresa_login_principal') showEmpresaDashboardScreen();
                else showScreen('login');
            });
            btnAddCategoriaEl?.addEventListener('click', handleAddCategoria);

            document.getElementById('btnAdminEmpresasVoltar')?.addEventListener('click', showAdminMasterDashboardScreen);
            document.getElementById('btnAdminAddEmpresa')?.addEventListener('click', handleAdminAddEmpresa);
            document.getElementById('btnCancelarManageUsersEmpresa')?.addEventListener('click', closeAdminManageUsersEmpresaSection);
            document.getElementById('btnExecuteCreateNewEmpresaUser')?.addEventListener('click', handleAdminCreateEmpresaUser);


            document.getElementById('btnAddColaborador')?.addEventListener('click', handleAddColaborador);
            document.getElementById('btnSalvarNovaSenha')?.addEventListener('click', handleChangePassword);
            btnAddProductEl?.addEventListener('click', handleAddProduct);
            btnImportXLSXEl?.addEventListener('click', handleXLSXImport);
            document.getElementById('btnShowPreviewContagem')?.addEventListener('click', showPreviewContagem);
            btnGerarTXT?.addEventListener('click', gerarArquivoTXT);
            btnGerarPDF?.addEventListener('click', gerarPDFContagem);
            document.getElementById('btnClearAllQuantities')?.addEventListener('click', clearAllQuantities);
            document.getElementById('btnClosePreviewModal')?.addEventListener('click', closeModalPreviewContagem);
            document.getElementById('btnCloseDetalhesModal')?.addEventListener('click', closeModalDetalhesContagem);

            const changePassBackBtn = document.getElementById('changePasswordBackButton');
            if(changePassBackBtn) {
                changePassBackBtn.addEventListener('click', () => {
                    if (currentUser?.role === 'admin_master') showAdminMasterDashboardScreen();
                    else if (currentUser?.role === 'empresa_manager' || currentUser?.role === 'empresa_login_principal') showEmpresaDashboardScreen();
                    else showScreen('login');
                });
            }
            const prodMgmtBackBtn = document.getElementById('productManagementBackButton');
            if(prodMgmtBackBtn) {
                prodMgmtBackBtn.addEventListener('click', () => {
                    if (currentUser?.role === 'admin_master') showAdminMasterDashboardScreen();
                    else if (currentUser?.role === 'empresa_manager' || currentUser?.role === 'empresa_login_principal') showEmpresaDashboardScreen();
                    else showScreen('login');
                });
            }
            const invCountBackBtn = document.getElementById('inventoryCountBackButton');
            if(invCountBackBtn) {
                invCountBackBtn.addEventListener('click', () => {
                    if (currentUser?.role === 'admin_master') showAdminMasterDashboardScreen();
                    else if (currentUser?.role === 'empresa_manager' || currentUser?.role === 'empresa_login_principal') showEmpresaDashboardScreen();
                    else if (currentUser?.role === 'empresa_counter') handleLogout();
                    else showScreen('login');
                });
            }
            const histBackBtn = document.getElementById('historicoBackButton');
              if(histBackBtn) {
                histBackBtn.addEventListener('click', () => {
                    if (currentUser?.role === 'admin_master') showAdminMasterDashboardScreen();
                    else if (currentUser?.role === 'empresa_manager' || currentUser?.role === 'empresa_login_principal') showEmpresaDashboardScreen();
                    else showScreen('login');
                });
            }

            console.log("Main event listeners added.");

            try {
                console.log("Loading global caches (companies) in onload...");

                const { data: empresasData, error: empresasError } = await _supabaseClient.from('empresas').select('id, nome_empresa').order('nome_empresa');
                if (empresasError) console.error("Error pre-loading companies cache (onload):", empresasError);
                else empresasCache = empresasData || [];
                console.log("Company cache pre-loaded in onload:", empresasCache.length);

            } catch(e) {
                console.error("Critical error loading initial company data (onload):", e);
            }

            const localPesquisaProdutoInput = document.getElementById('pesquisaProduto');
            const localPesquisaCodigoInput = document.getElementById('pesquisaCodigo');
            const localFiltroCategoriaSelect = document.getElementById('filtroCategoria');
            if (localPesquisaProdutoInput) localPesquisaProdutoInput.addEventListener("input", filterInventoryProducts);
            if (localPesquisaCodigoInput) localPesquisaCodigoInput.addEventListener("input", filterInventoryProducts);
            if (localFiltroCategoriaSelect) localFiltroCategoriaSelect.addEventListener("change", filterInventoryProducts);

            try {
                console.log("Attempting to get Supabase session in onload...");
                const { data: { session }, error: sessionError } = await _supabaseClient.auth.getSession();
                if (sessionError) { console.error("Error getting initial Supabase session (onload):", sessionError); throw sessionError; }

                if (session?.user) {
                    console.log("Supabase session found for user ID (onload):", session.user.id);
                    currentUser = {
                        id: session.user.id,
                        email: session.user.email,
                        user_metadata: session.user.user_metadata,
                        full_name: session.user.user_metadata?.full_name || session.user.email,
                        role: null
                    };

                    if (currentUser.user_metadata?.user_role) {
                        currentUser.role = currentUser.user_metadata.user_role;
                        console.log("Session: Role assigned from JWT user_metadata:", currentUser.role);
                    }

                    if (!currentUser.role || ['empresa_manager', 'empresa_counter', 'empresa_login_principal'].includes(currentUser.role) || !currentUser.empresa_id) {
                        const { data: profile, error: profileError } = await _supabaseClient
                            .from('user_profiles')
                            .select('empresa_id, role, full_name, empresas (id, nome_empresa)')
                            .eq('id', session.user.id)
                            .single();

                        if (profileError && profileError.code !== 'PGRST116') {
                            console.error("Error fetching profile for active session (onload):", profileError);
                            throw profileError;
                        }
                        if (profile) {
                            currentUser.role = profile.role;
                            currentUser.empresa_id = profile.empresa_id;
                            currentUser.empresa_nome = profile.empresas ? profile.empresas.nome_empresa : 'Empresa Associada';
                            currentUser.full_name = profile.full_name || currentUser.full_name;
                            console.log("Session: User profile fetched and merged (onload):", currentUser);
                        } else if (session.user.email === ADMIN_MASTER_EMAIL && !currentUser.role) {
                            currentUser.role = 'admin_master';
                            console.warn("Session: Admin Master (via email, profile/JWT role not found) (onload):", currentUser);
                        } else if (!currentUser.role) {
                             console.warn("Active session, but profile not found or role unclear (onload). Signing out.", session.user.id);
                             await _supabaseClient.auth.signOut();
                             currentUser = null;
                             showScreen('login');
                             hideLoader();
                             return;
                        }
                    }


                    if (currentUser.role === 'admin_master') {
                        const { data: adminEmpresas, error: adminEmpresasError } = await _supabaseClient.from('empresas').select('id, nome_empresa').order('nome_empresa');
                        if (adminEmpresasError) console.error("Error fetching companies for admin selects on session restore (onload):", adminEmpresasError);
                        else empresasCache = adminEmpresas || [];

                        await Promise.all([
                            populateEmpresasSelect(adminCategoriaEmpresaSelectEl, true, "-- Selecione uma Empresa --", ""),
                            populateEmpresasSelect(adminProdutoEmpresaSelect, true, "-- Selecione uma Empresa --", ""),
                            populateEmpresasSelect(adminContagemEmpresaSelect, true, "-- Selecione uma Empresa --", ""),
                            populateEmpresasSelect(adminHistoricoEmpresaSelect, true, "-- Selecione uma Empresa --", "")
                        ]);
                         await fetchAndRenderEmpresas();
                        showAdminMasterDashboardScreen();
                    } else if ((currentUser.role === 'empresa_manager' || currentUser.role === 'empresa_login_principal') && currentUser.empresa_id) {
                        await showEmpresaDashboardScreen();
                    } else if (currentUser.role === 'empresa_counter' && currentUser.empresa_id) {
                        await showInventoryCountScreen_Empresa();
                    }
                    else {
                        console.warn("Session active but user role is not admin_master or properly configured empresa user (onload). Signing out. User:", currentUser);
                        await _supabaseClient.auth.signOut();
                        currentUser = null;
                        showScreen('login');
                    }

                } else {
                    console.log("No active Supabase session found (onload).");
                    showScreen('login');
                }
            } catch (e) {
                console.error("Critical error in initialization when trying to restore session/profile (onload):", e);
                await _supabaseClient.auth.signOut().catch(err => { console.warn("Error in fallback signOut (onload):", err); });
                currentUser = null;
                showScreen('login');
            } finally {
                console.log("window.onload finished.");
                hideLoader();
            }
        };
        console.log("SCRIPT END - v2.10.2 (User Role Fixes)");
    </script>
</body>
</html>