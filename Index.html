<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Balanço de Estoque - v2.9.9</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            /* Tema Claro - Ajustado (v2.9.9 HEAD) */
            --primary-color: #007bff; 
            --primary-color-darker: #0069d9;
            --secondary-color: #6c757d; 
            --secondary-color-darker: #5a6268;
            --success-color: #198754; 
            --success-color-darker: #157347;
            --danger-color: #dc3545; 
            --danger-color-darker: #bb2d3b;
            --warning-color: #ffc107; 
            --warning-color-darker: #ffb300;
            --info-color: #0dcaf0; 
            --info-color-darker: #0aa9c6;

            --background-color: #f4f6f9;         
            --container-bg-color: #ffffff;       
            --card-bg-color: #ffffff;            
            --header-bg-color: #f8f9fa;          
            --input-bg-color: #ffffff;           
            --input-border-color: #ced4da;       
            
            --text-color: #212529;              
            --text-muted-color: #6c757d;        
            --text-on-primary-color: #ffffff;
            --text-on-secondary-color: #ffffff;
            --text-on-success-color: #ffffff;
            --text-on-danger-color: #ffffff;
            --text-on-warning-color: #000000;    
            --text-on-info-color: #000000;       
            
            --border-color: #dee2e6;            
            --hover-row-background: #e9ecef;     
            --border-radius: 0.375rem; 
            --box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            --box-shadow-lg: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;margin:0;padding:20px 0;background-color:var(--background-color);color:var(--text-color);display:flex;flex-direction:column;align-items:center;min-height:100vh;line-height:1.5;font-size:1rem}
        .container{width:95%;max-width:600px;background-color:var(--container-bg-color);padding:25px 30px;border-radius:var(--border-radius);box-shadow:var(--box-shadow);margin-top:20px;margin-bottom:20px;border:1px solid var(--border-color)}
        .content-container{max-width:1140px}
        h1,h2,h3{color:var(--text-color);text-align:center;margin-top:0;margin-bottom:1.5rem;font-weight:500}
        h1{font-size:2rem}h2{font-size:1.75rem}h3{font-size:1.5rem;margin-bottom:1rem}
        
        /* CSS PARA TELAS - COM !important PARA FORÇAR VISIBILIDADE (v2.9.9 HEAD) */
        .screen { 
            display: none !important; 
            opacity: 0 !important;
            visibility: hidden !important;
            min-height: 300px; /* Garante alguma altura para debug */
        } 
        .screen.active { 
            display: block !important; 
            opacity: 1 !important;
            visibility: visible !important;
            animation: fadeInView .4s ease-out; 
        }
        @keyframes fadeInView{ from{opacity:0; transform: translateY(10px);} to{opacity:1; transform: translateY(0);} }
        
        button,.btn{border:1px solid transparent;padding:.5rem 1rem;text-align:center;text-decoration:none;display:inline-block;font-size:1rem;font-weight:400;line-height:1.5;border-radius:var(--border-radius);cursor:pointer;transition:color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;margin:.25rem}
        button:hover,.btn:hover{text-decoration:none;transform:translateY(-1px);box-shadow:var(--box-shadow-lg)}
        button:active,.btn:active{transform:translateY(0);}
        button:focus-visible,.btn:focus-visible{outline:2px solid var(--primary-color);outline-offset:2px}
        .btn-primary{background-color:var(--primary-color);border-color:var(--primary-color);color:var(--text-on-primary-color)}.btn-primary:hover{background-color:var(--primary-color-darker);border-color:var(--primary-color-darker)}
        .btn-secondary{background-color:var(--secondary-color);border-color:var(--secondary-color);color:var(--text-on-secondary-color)}.btn-secondary:hover{background-color:var(--secondary-color-darker);border-color:var(--secondary-color-darker)}
        .btn-success{background-color:var(--success-color);border-color:var(--success-color);color:var(--text-on-success-color)}.btn-success:hover{background-color:var(--success-color-darker);border-color:var(--success-color-darker)}
        .btn-danger{background-color:var(--danger-color);border-color:var(--danger-color);color:var(--text-on-danger-color)}.btn-danger:hover{background-color:var(--danger-color-darker);border-color:var(--danger-color-darker)}
        .btn-warning{background-color:var(--warning-color);border-color:var(--warning-color);color:var(--text-on-warning-color)}.btn-warning:hover{background-color:var(--warning-color-darker);border-color:var(--warning-color-darker)}
        .btn-info{background-color:var(--info-color);border-color:var(--info-color);color:var(--text-on-info-color);}.btn-info:hover{background-color:var(--info-color-darker);border-color:var(--info-color-darker);}
        
        .dashboard-options{display:flex;flex-direction:column;align-items:stretch;gap:1rem;padding:1rem 0}
        .dashboard-options .btn{padding:.75rem 1rem;font-size:1.05rem;width:100%}
        
        .card{border:1px solid var(--border-color);border-radius:var(--border-radius);margin-bottom:1.5rem;box-shadow:var(--box-shadow);background-color:var(--card-bg-color)}
        .card-header{padding:.75rem 1.25rem;margin-bottom:0;background-color:var(--header-bg-color);border-bottom:1px solid var(--border-color);border-top-left-radius:calc(var(--border-radius) - 1px);border-top-right-radius:calc(var(--border-radius) - 1px)}
        .card-header>*{margin:0;font-size:1.25rem;font-weight:500;color:var(--text-color);text-align:left}
        .card-body{padding:1.25rem}
        
        table{width:100%;border-collapse:collapse;margin-bottom:1rem;color:var(--text-color); }
        th,td{border:1px solid var(--border-color);padding:.75rem;text-align:left;vertical-align:middle}
        th{background-color:var(--header-bg-color);font-weight:500;border-bottom-width:2px} 
        tbody tr:nth-child(odd){background-color:var(--container-bg-color); } 
        tbody tr:nth-child(even){background-color: #f1f3f5; } 
        tbody tr:hover{background-color:var(--hover-row-background); }

        input[type=text],input[type=number],input[type=password],input[type=email],select,input[type=file]{width:100%;padding:.5rem .75rem;margin-bottom:1rem;border:1px solid var(--input-border-color);border-radius:var(--border-radius);box-sizing:border-box;font-size:1rem;line-height:1.5;background-color:var(--input-bg-color);color:var(--text-color);background-clip:padding-box;transition:border-color .15s ease-in-out,box-shadow .15s ease-in-out}
        input[type=text]::placeholder,input[type=number]::placeholder,input[type=password]::placeholder,input[type=email]::placeholder{color:var(--text-muted-color);opacity:1}
        input[type=text]:focus,input[type=number]:focus,input[type=password]:focus,input[type=email]:focus,select:focus{border-color:var(--primary-color);outline:0;box-shadow:0 0 0 .25rem rgba(13,110,253,.25)}
        input[type=file]{padding:.375rem .75rem}
        select{appearance:none;background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23212529' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");background-repeat:no-repeat;background-position:right .75rem center;background-size:16px 12px}
        
        .form-group{margin-bottom:1rem}
        .form-group label{display:block;margin-bottom:.5rem;font-weight:500;color:var(--text-color); }
        
        .filter-controls,.product-management-form-fields,.xlsx-import-section,.actions-bar,.sub-form-section{margin-bottom:1.5rem;padding:1rem;background-color:var(--card-bg-color);border:1px solid var(--border-color);border-radius:var(--border-radius)} 
        .product-management-form-fields .form-group{margin-bottom:0}
        .filter-controls>div{flex:1;min-width:200px}
        .filter-controls input,.filter-controls select{margin-bottom:0}
        .xlsx-import-section input[type=file]{width:auto;margin-right:.5rem}
        .actions-bar{text-align:center;padding:1rem 0; background-color: transparent; border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); }
        .actions-bar .btn{margin:0 .5rem}
        
        #productManagementTable td:last-child,#inventoryTable td:last-child,#adminEmpresasTable td:last-child, #colaboradoresTable td:last-child, #historicoContagensTable td:last-child, #adminCategoriasTable td:last-child {text-align:center} 
        #inventoryTable input[type=number]{max-width:80px;text-align:right;padding:.375rem .5rem;font-size:.9rem}
        .back-button{margin-bottom:1.5rem;display:inline-block}
        
        .modal-overlay { 
            position: fixed !important; 
            top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important;
            background-color: rgba(0,0,0,0.4) !important; 
            display: flex !important; justify-content: center !important; align-items: center !important;
            z-index: 10000 !important; 
            opacity: 0 !important; 
            visibility: hidden !important; 
            transition: opacity 0.2s ease, visibility 0.2s ease !important; 
        }
        .modal-overlay.active { 
            opacity: 1 !important; 
            visibility: visible !important; 
        }
        .modal-content { 
            background-color: var(--container-bg-color); color: var(--text-color); 
            padding: 20px 25px; border-radius: var(--border-radius); 
            box-shadow: var(--box-shadow-lg); width: 90%; max-width: 500px; 
            text-align: left; 
            border: 1px solid var(--border-color);
            transform: translateY(-20px) scale(0.95); 
            transition: transform 0.2s ease, opacity 0.2s ease; 
            opacity: 0;
        }
        .modal-overlay.active .modal-content { transform: translateY(0) scale(1); opacity: 1;}
        .modal-content h4 { color: var(--text-color); margin-bottom: 1rem; font-size: 1.25rem; text-align: center;}
        .modal-content p { color: var(--text-muted-color); margin-bottom: 1rem; font-size: 0.95rem; } 
        .modal-actions { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem; }
        
        .login-form{max-width:400px;margin:1.5rem auto; padding: 2rem; background-color: var(--container-bg-color); border-radius: var(--border-radius); box-shadow: var(--box-shadow);}
        .login-form .form-group{margin-bottom:1rem}
        .login-form button{width:100%;padding:.75rem;font-size:1.05em}
        #loginErrorMessage{color:var(--danger-color);margin-top:1rem;text-align:center;display:none}
        .sub-form-section h4{text-align:left;font-size:1.1rem;color:var(--text-color);margin-bottom:1rem;border-bottom:1px solid var(--border-color);padding-bottom:.5rem}
        .table-actions button,.table-actions .btn{margin:0 2px;padding:.25rem .5rem;font-size:.85rem}
        .generated-password-display { margin-top: 10px; padding: 10px; background-color: #e9ecef; border: 1px dashed var(--border-color); border-radius: var(--border-radius); word-break: break-all; color: var(--text-color); font-family: monospace; text-align: center;}
        .company-users-list { list-style-type: none; padding-left: 0; font-size: 0.9em; }
        .company-users-list li { padding: 8px 5px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .company-users-list li:last-child { border-bottom: none; }
        .company-users-list li .user-info { margin-right: 10px; flex-grow: 1; }
        .company-users-list li .user-info .user-email { font-weight: bold; color: var(--primary-color); }
        .company-users-list li .user-info .user-details { font-style: italic; color: var(--text-muted-color); font-size: 0.9em; display: block; }
        .company-users-list li .user-actions { display: flex; gap: 5px; flex-shrink: 0; }
        .password-change-form { max-width: 450px; margin: 1.5rem auto; }
        .form-inline-flex { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 1rem;}
        .form-inline-flex .form-group { flex: 1; margin-bottom: 0;}
        .form-inline-flex button { flex-shrink: 0; }
        #previewContagemTable { width: 100%; margin-top: 1rem; }
        #previewContagemTable th, #previewContagemTable td { font-size: 0.9rem; padding: 0.5rem; }
        .admin-context-selector { margin-bottom: 1.5rem; padding: 1rem; background-color: var(--header-bg-color); border-radius: var(--border-radius); }
        .admin-context-selector label { margin-right: 0.5rem; font-weight: 500;}
        .admin-context-selector select { display: inline-block; width: auto; min-width: 250px; margin-right: 10px; }
        .loader { 
            border: 5px solid #e9ecef; 
            border-top: 5px solid var(--primary-color);
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: 20px auto;
            display: none; 
        }
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    </style>
</head>
<body>
    <div id="mainContainer" class="container"> 
        <div id="loadingIndicator" class="loader" style="display:none;"></div>

        <div id="screenLogin" class="screen active">
            <h1>Login no Sistema de Balanço</h1>
            <div class="login-form card card-body">
                <div class="form-group"><label for="loginEmail">Email:</label><input type="email" id="loginEmail" placeholder="seuemail@exemplo.com" autocomplete="email"></div>
                <div class="form-group"><label for="loginPassword">Senha:</label><input type="password" id="loginPassword" placeholder="Sua senha" autocomplete="current-password"></div>
                <button class="btn btn-primary" id="loginButton">Entrar</button> 
                <div id="loginErrorMessage"></div>
            </div>
        </div>

        <div id="screenAdminMasterDashboard" class="screen">
            <h2>Painel Admin Master</h2>
            <p style="text-align: center;">Bem-vindo, <span id="adminMasterNameDisplay">Admin Master</span>!</p>
            <div class="dashboard-options">
                <button class="btn btn-primary" id="btnAdminGerenciarEmpresas">Gerenciar Empresas & Seus Logins</button>
                <button class="btn btn-primary" id="btnAdminGerenciarCategorias">Gerenciar Categorias</button> 
                <button class="btn btn-primary" id="btnAdminGerenciarProdutos">Gerenciar Produtos</button>
                <button class="btn btn-primary" id="btnAdminContagemEstoque">Contagem de Estoque</button>
                <button class="btn btn-info" id="btnAdminHistoricoContagens">Histórico de Contagens (Admin)</button>
                <button class="btn btn-secondary" id="btnLogoutAdmin">Logout</button>
            </div>
        </div>

        <div id="screenEmpresaDashboard" class="screen">
            <h2 id="empresaDashboardTitle">Painel da Empresa</h2>
            <p style="text-align: center;">Logado como: <span id="empresaUserName"></span></p>
            <div class="dashboard-options">
                <button class="btn btn-primary" id="btnEmpresaGerenciarColaboradores">Gerenciar Colaboradores</button>
                <button class="btn btn-primary" id="btnEmpresaGerenciarProdutos">Gerenciar Produtos da Empresa</button>
                <button class="btn btn-primary" id="btnEmpresaContagemEstoque">Iniciar Contagem da Empresa</button>
                <button class="btn btn-info" id="btnEmpresaHistoricoContagens">Ver Histórico de Contagens</button>
                <button class="btn btn-info" id="btnEmpresaAlterarSenha">Alterar Senha da Empresa</button> 
                <button class="btn btn-secondary" id="btnLogoutEmpresa">Logout</button>
            </div>
        </div>
        
        <div id="screenAdminCategorias" class="screen">
            <button class="btn btn-secondary back-button" id="btnAdminCategoriasVoltar"> &larr; Painel Admin</button>
            <h2>Gerenciar Categorias de Produtos</h2>
            <div class="card">
                <div class="card-header"><h3>Adicionar Nova Categoria</h3></div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="adminCategoriaEmpresaSelect">Associar Categoria a:</label>
                        <select id="adminCategoriaEmpresaSelect">
                            <option value="">-- Categoria Global (para todas empresas) --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="adminNomeCategoria">Nome da Nova Categoria:</label>
                        <input type="text" id="adminNomeCategoria" placeholder="Ex: Bolos, Salgados, Bebidas">
                    </div>
                    <button class="btn btn-success" id="btnAdminAddCategoria">Adicionar Categoria</button>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><h3>Categorias Cadastradas</h3></div>
                <div class="card-body">
                    <table id="adminCategoriasTable">
                        <thead><tr><th>Nome da Categoria</th><th>Escopo (Empresa / Global)</th><th>Criação</th><th>Ações</th></tr></thead>
                        <tbody id="adminCategoriasTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="screenAdminEmpresas" class="screen">
             <button class="btn btn-secondary back-button" id="btnAdminEmpresasVoltar">&larr; Painel Admin</button>
            <h2>Gerenciar Empresas e Seus Logins Principais</h2>
            <div class="card"><div class="card-header"><h3>Adicionar Nova Empresa</h3></div><div class="card-body"><div class="form-group"><label for="adminNomeEmpresa">Nome da Empresa:</label><input type="text" id="adminNomeEmpresa" placeholder="Nome da nova empresa"></div><button class="btn btn-success" id="btnAdminAddEmpresa">Adicionar Empresa</button></div></div>
            <div class="card"><div class="card-header"><h3>Empresas Cadastradas</h3></div><div class="card-body"><table id="adminEmpresasTable"><thead><tr><th>Nome</th><th>Criação</th><th style="min-width: 280px;">Ações da Empresa</th></tr></thead><tbody id="adminEmpresasTableBody"></tbody></table></div></div>
            <div id="adminDefineLoginEmpresaSection" class="card" style="display:none; margin-top: 2rem;"><div class="card-header"><h3 id="adminDefineLoginEmpresaTitle">Definir Login para Empresa</h3></div><div class="card-body"><input type="hidden" id="selectedEmpresaIdForLogin"><div class="form-group"><label for="adminEmpresaLoginEmail">Email para Login da Empresa (fictício):</label><input type="email" id="adminEmpresaLoginEmail" placeholder="login_empresa@sistema.com"></div><div class="form-group"><label for="adminEmpresaLoginFullName">Nome de Referência (Ex: Login Principal):</label><input type="text" id="adminEmpresaLoginFullName" placeholder="Referência do Login"></div><button class="btn btn-success" id="btnSalvarLoginEmpresa">Salvar Login e Gerar Senha</button><div id="generatedEmpresaPasswordMessage" class="generated-password-display" style="display:none;"></div></div><button class="btn btn-secondary" id="btnCancelarDefineLoginEmpresa" style="margin: 0 1.25rem 1.25rem;">Cancelar</button></div>
        </div>
        
        <div id="screenEmpresaColaboradores" class="screen">
            <button class="btn btn-secondary back-button" id="colaboradoresBackButton">&larr; Voltar</button> 
            <h2>Gerenciar Colaboradores (<span id="colaboradoresEmpresaNome"></span>)</h2>
            <div class="card"><div class="card-header"><h3>Adicionar Novo Colaborador</h3></div><div class="card-body"><div class="form-inline-flex"><div class="form-group"><label for="colaboradorNome">Nome do Colaborador:</label><input type="text" id="colaboradorNome" placeholder="Nome completo"></div><button class="btn btn-success" id="btnAddColaborador">Adicionar</button></div></div></div>
            <div class="card"><div class="card-header"><h3>Colaboradores Cadastrados</h3></div><div class="card-body"><table id="colaboradoresTable"><thead><tr><th>Nome</th><th>Ativo</th><th>Criação</th><th style="min-width: 220px;">Ações</th></tr></thead><tbody id="colaboradoresTableBody"></tbody></table></div></div>
        </div>
        
        <div id="screenChangePassword" class="screen">
             <button class="btn btn-secondary back-button" id="changePasswordBackButton">&larr; Voltar ao Painel</button>
            <h2>Alterar Senha</h2>
            <div class="password-change-form card card-body">
                <p>Alterando senha para o login: <strong id="changingPasswordForUserDisplay"></strong></p>
                <div class="form-group" id="currentPasswordGroup" style="display:none;"><label for="currentPasswordInput">Senha Atual:</label><input type="password" id="currentPasswordInput"></div>
                <div class="form-group"><label for="newPasswordInput">Nova Senha (mín. 6 caracteres):</label><input type="password" id="newPasswordInput" placeholder="Digite a nova senha"></div>
                <div class="form-group"><label for="confirmNewPasswordInput">Confirmar Nova Senha:</label><input type="password" id="confirmNewPasswordInput" placeholder="Confirme a nova senha"></div>
                <button class="btn btn-primary" id="btnSalvarNovaSenha">Salvar Nova Senha</button>
                <div id="changePasswordMessage" style="margin-top:1rem; text-align:center;"></div>
            </div>
        </div>

        <div id="screenHistoricoContagens" class="screen">
            <button class="btn btn-secondary back-button" id="historicoBackButton">&larr; Voltar ao Painel</button> 
            <h2 id="historicoTitle">Histórico de Contagens (<span id="historicoEmpresaNomeSpan"></span>)</h2> 
            <div id="adminHistoricoEmpresaSelectorContainer" class="admin-context-selector" style="display:none;">
                <label for="adminHistoricoEmpresaSelect">Ver Histórico Para Empresa:</label>
                <select id="adminHistoricoEmpresaSelect"><option value="ALL_EMPRESAS">-- Todas as Empresas --</option></select>
            </div>
            <p id="historicoContext" style="text-align:center; font-size:0.9em; color:var(--text-muted-color); margin-bottom: 1rem;"></p>
            <div class="card"><div class="card-header"><h3>Registros de Contagem</h3></div><div class="card-body" style="padding:0;"><table id="historicoContagensTable"><thead><tr><th id="colEmpresaHistorico" style="display:none;">Empresa</th><th>Data</th><th>Colaborador</th><th>Itens Contados</th><th>Ações</th></tr></thead><tbody id="historicoContagensTableBody"></tbody></table></div></div>
        </div>

        <div id="screenProductManagement" class="screen">
            <button class="btn btn-secondary back-button" id="productManagementBackButton">&larr; Voltar</button>
            <h2 id="productManagementTitle">Gerenciar Produtos</h2>
            <div id="adminProdutoEmpresaSelectorContainer" class="admin-context-selector" style="display:none;">
                <label for="adminProdutoEmpresaSelect">Gerenciar Produtos Para Empresa:</label>
                <select id="adminProdutoEmpresaSelect"><option value="">-- Produtos Globais (Sem Empresa) --</option></select>
            </div>
            <p id="productManagementContext" style="text-align:center; font-size:0.9em; color:var(--text-muted-color); margin-bottom: 1rem;"></p>
            <div class="card"><div class="card-header"><h3>Adicionar Novo Produto</h3></div><div class="card-body">
                <div class="product-management-form-fields">
                    <div class="form-group"><label for="prodCodigo">Código:</label><input type="text" id="prodCodigo"></div>
                    <div class="form-group"><label for="prodNome">Produto:</label><input type="text" id="prodNome"></div>
                    <div class="form-group">
                        <label for="prodCategoriaSelect">Categoria:</label>
                        <select id="prodCategoriaSelect"><option value="">-- Sem Categoria --</option></select>
                    </div>
                    <button class="btn btn-success" id="btnAddProduct">Adicionar</button>
                </div>
            </div></div>
            <div class="card"><div class="card-header"><h3>Importar Produtos via XLSX</h3></div><div class="card-body xlsx-import-section"><input type="file" id="xlsxFile" accept=".xlsx, .xls"><button class="btn btn-info" id="btnImportXLSX">Importar</button><p>Colunas: 'codigo', 'produto', 'categoria'. Categoria vazia = Sem Categoria.</p></div></div>
            <div class="card"><div class="card-header"><h3>Produtos Cadastrados</h3></div><div class="card-body" style="padding:0;"><table id="productManagementTable"><thead><tr><th>Código</th><th>Produto</th><th>Categoria</th><th>Ação</th></tr></thead><tbody id="productManagementTableBody"></tbody></table></div></div>
        </div>

        <div id="screenInventoryCount" class="screen">
            <button class="btn btn-secondary back-button" id="inventoryCountBackButton">&larr; Voltar</button>
            <h2 id="inventoryCountTitle">Balanço de Estoque</h2>
            <div id="adminContagemEmpresaSelectorContainer" class="admin-context-selector" style="display:none;">
                <label for="adminContagemEmpresaSelect">Realizar Contagem Para Empresa:</label>
                <select id="adminContagemEmpresaSelect"><option value="">-- Contagem Global (Produtos Sem Empresa) --</option></select>
            </div>
            <p id="inventoryCountContext" style="text-align:center; font-size:0.9em; color:var(--text-muted-color); margin-bottom: 1rem;"></p>
            <div class="card card-body">
                <div class="form-group"> 
                    <label for="selectColaboradorContagem">Contagem realizada por:</label>
                    <select id="selectColaboradorContagem" style="margin-bottom: 1rem;"></select>
                </div>
                <div class="actions-bar" style="border:none; padding-bottom:0;">
                     <button class="btn btn-info" id="btnShowPreviewContagem">Ver Resumo</button> 
                     <button class="btn btn-success" id="btnGerarTXT">Gerar TXT & Salvar Histórico</button>
                     <button class="btn btn-warning" id="btnClearAllQuantities">Limpar Quantidades</button>
                </div>
            </div>
            <div class="filter-controls card card-body"><div><label for="pesquisaProduto">Produto:</label><input type="text" id="pesquisaProduto" placeholder="Nome..."></div><div><label for="pesquisaCodigo">Código:</label><input type="text" id="pesquisaCodigo" placeholder="Código..."></div><div><label for="filtroCategoria">Categoria:</label><select id="filtroCategoria"><option value="">Todas</option></select></div></div>
            <table><thead><tr><th>Código</th><th>Produto</th><th>Categoria</th><th>Quantidade</th></tr></thead><tbody id="inventoryTableBody"></tbody></table>
        </div>

        <div id="modalPreviewContagem" class="modal-overlay">
            <div class="modal-content" style="max-width: 700px; text-align:left;">
                <h4>Resumo da Contagem Atual</h4>
                <div id="previewContagemTableContainer" style="max-height: 400px; overflow-y:auto;">
                    <table id="previewContagemTable">
                        <thead><tr><th>Código</th><th>Produto</th><th>Categoria</th><th>Qtd. Digitada</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="modal-actions" style="margin-top: 1.5rem;">
                    <button class="btn btn-secondary" id="btnClosePreviewModal">Fechar</button>
                </div>
            </div>
        </div>
        <div id="modalDetalhesContagem" class="modal-overlay">
            <div class="modal-content" style="max-width: 600px; text-align:left;">
                <h4>Detalhes da Contagem</h4>
                <div id="detalhesContagemConteudo"></div>
                <div class="modal-actions" style="margin-top:1.5rem;">
                    <button class="btn btn-secondary" id="btnCloseDetalhesModal">Fechar</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        console.log("SCRIPT START - v2.9.7");
        // --- CONFIGURAÇÃO SUPABASE ---
        const SUPABASE_URL = 'https://daeocsintrbdfqclvteg.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhZW9jc2ludHJiZGZxY2x2dGVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM0ODMxNDEsImV4cCI6MjA1OTA1OTE0MX0.BJ61kSxTDiEFway590hoTvVH4yu0FxLnjecqQsYdwK4';
        const { createClient } = supabase;
        const _supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- VARIÁVEIS GLOBAIS ---
        let produtosCache = []; 
        let categoriasCache = []; 
        let empresasCache = []; 
        let colaboradoresCache = []; 
        let quantidadesDigitadas = {}; 
        const ADMIN_MASTER_EMAIL = "matheus@mtech.com";
        const ADMIN_MASTER_PASSWORD = "260195@@";
        let currentUser = null; 
        let adminSelectedEmpresaId = null; 
        let adminSelectedEmpresaParaCategoriaId = null;

        // --- SELETORES DOM (serão inicializados no window.onload) ---
        let mainContainer, screens = {}, loadingIndicator, loginEmailInput, loginPasswordInput, loginErrorMessage,
            adminMasterNameDisplay, adminNomeEmpresaInput, adminEmpresasTableBody, adminDefineLoginEmpresaSection,
            adminDefineLoginEmpresaTitle, selectedEmpresaIdForLogin, adminEmpresaLoginEmailInput,
            adminEmpresaLoginFullNameInput, generatedEmpresaPasswordMessage, adminCategoriaEmpresaSelect,
            adminNomeCategoriaInput, adminCategoriasTableBody, colaboradoresEmpresaNomeSpan, colaboradorNomeInput,
            colaboradoresTableBody, currentPasswordInput, newPasswordInput, confirmNewPasswordInput,
            changePasswordMessage, changePasswordBackButton, changingPasswordForUserDisplay, currentPasswordGroup,
            historicoEmpresaNomeSpan, historicoContagensTableBody, modalDetalhesContagem, detalhesContagemConteudo,
            productManagementBackButton, productManagementTitle, productManagementContext,
            adminProdutoEmpresaSelectorContainer, adminProdutoEmpresaSelect, prodCodigoInput, prodNomeInput,
            prodCategoriaSelect, productManagementTableBody, xlsxFileInput, inventoryCountBackButton,
            inventoryCountTitle, inventoryCountContext, adminContagemEmpresaSelectorContainer,
            adminContagemEmpresaSelect, selectColaboradorContagem, pesquisaProdutoInput, pesquisaCodigoInput,
            filtroCategoriaSelect, inventoryTableBody, modalPreviewContagem, previewContagemTableContainer,
            empresaDashboardTitle, empresaUserNameSpan,
            adminHistoricoEmpresaSelectorContainer, adminHistoricoEmpresaSelect, historicoBackButton, historicoTitle, historicoContext, colEmpresaHistorico; 

        function initializeDOMSelectors() {
            console.log("initializeDOMSelectors v2.9.7 chamado");
            mainContainer = document.getElementById('mainContainer');
            screens = {
                login: document.getElementById('screenLogin'),
                adminMasterDashboard: document.getElementById('screenAdminMasterDashboard'),
                empresaDashboard: document.getElementById('screenEmpresaDashboard'),
                adminEmpresas: document.getElementById('screenAdminEmpresas'),
                adminCategorias: document.getElementById('screenAdminCategorias'), 
                empresaColaboradores: document.getElementById('screenEmpresaColaboradores'),
                changePassword: document.getElementById('screenChangePassword'), 
                historicoContagens: document.getElementById('screenHistoricoContagens'),
                productManagement: document.getElementById('screenProductManagement'),
                inventoryCount: document.getElementById('screenInventoryCount')
            };
            loadingIndicator = document.getElementById('loadingIndicator');
            loginEmailInput = document.getElementById('loginEmail');
            loginPasswordInput = document.getElementById('loginPassword');
            loginErrorMessage = document.getElementById('loginErrorMessage');
            
            function safeGetElementById(id, context = document) {
                const el = context.getElementById(id);
                if (!el) console.warn(`Elemento com ID '${id}' NÃO encontrado.`);
                return el;
            }

            Object.keys(screens).forEach(key => {
                if (!screens[key]) console.warn(`Elemento de tela screens.${key} (ID: ${key}) NÃO encontrado na atribuição inicial.`);
            });
            
            adminMasterNameDisplay = safeGetElementById('adminMasterNameDisplay');
            adminNomeEmpresaInput = safeGetElementById('adminNomeEmpresa');
            adminEmpresasTableBody = safeGetElementById('adminEmpresasTableBody');
            adminDefineLoginEmpresaSection = safeGetElementById('adminDefineLoginEmpresaSection');
            adminDefineLoginEmpresaTitle = safeGetElementById('adminDefineLoginEmpresaTitle');
            selectedEmpresaIdForLogin = safeGetElementById('selectedEmpresaIdForLogin');
            adminEmpresaLoginEmailInput = safeGetElementById('adminEmpresaLoginEmail');
            adminEmpresaLoginFullNameInput = safeGetElementById('adminEmpresaLoginFullName');
            generatedEmpresaPasswordMessage = safeGetElementById('generatedEmpresaPasswordMessage');
            adminCategoriaEmpresaSelect = safeGetElementById('adminCategoriaEmpresaSelect');
            adminNomeCategoriaInput = safeGetElementById('adminNomeCategoria');
            adminCategoriasTableBody = safeGetElementById('adminCategoriasTableBody');
            colaboradoresEmpresaNomeSpan = safeGetElementById('colaboradoresEmpresaNome');
            colaboradorNomeInput = safeGetElementById('colaboradorNome');
            colaboradoresTableBody = safeGetElementById('colaboradoresTableBody');
            currentPasswordInput = safeGetElementById('currentPasswordInput');
            newPasswordInput = safeGetElementById('newPasswordInput');
            confirmNewPasswordInput = safeGetElementById('confirmNewPasswordInput');
            changePasswordMessage = safeGetElementById('changePasswordMessage');
            changePasswordBackButton = safeGetElementById('changePasswordBackButton');
            changingPasswordForUserDisplay = safeGetElementById('changingPasswordForUserDisplay');
            currentPasswordGroup = safeGetElementById('currentPasswordGroup');
            historicoEmpresaNomeSpan = safeGetElementById('historicoEmpresaNomeSpan'); 
            historicoContagensTableBody = safeGetElementById('historicoContagensTableBody');
            modalDetalhesContagem = safeGetElementById('modalDetalhesContagem');
            detalhesContagemConteudo = safeGetElementById('detalhesContagemConteudo');
            adminHistoricoEmpresaSelectorContainer = safeGetElementById('adminHistoricoEmpresaSelectorContainer');
            adminHistoricoEmpresaSelect = safeGetElementById('adminHistoricoEmpresaSelect');
            historicoBackButton = safeGetElementById('historicoBackButton'); 
            historicoTitle = safeGetElementById('historicoTitle'); 
            historicoContext = safeGetElementById('historicoContext'); 
            colEmpresaHistorico = safeGetElementById('colEmpresaHistorico'); 
            productManagementBackButton = safeGetElementById('productManagementBackButton');
            productManagementTitle = safeGetElementById('productManagementTitle');
            productManagementContext = safeGetElementById('productManagementContext');
            adminProdutoEmpresaSelectorContainer = safeGetElementById('adminProdutoEmpresaSelectorContainer');
            adminProdutoEmpresaSelect = safeGetElementById('adminProdutoEmpresaSelect');
            prodCodigoInput = safeGetElementById('prodCodigo');
            prodNomeInput = safeGetElementById('prodNome');
            prodCategoriaSelect = safeGetElementById('prodCategoriaSelect'); 
            productManagementTableBody = safeGetElementById('productManagementTableBody');
            xlsxFileInput = safeGetElementById('xlsxFile');
            inventoryCountBackButton = safeGetElementById('inventoryCountBackButton');
            inventoryCountTitle = safeGetElementById('inventoryCountTitle');
            inventoryCountContext = safeGetElementById('inventoryCountContext');
            adminContagemEmpresaSelectorContainer = safeGetElementById('adminContagemEmpresaSelectorContainer');
            adminContagemEmpresaSelect = safeGetElementById('adminContagemEmpresaSelect');
            selectColaboradorContagem = safeGetElementById('selectColaboradorContagem');
            pesquisaProdutoInput = safeGetElementById('pesquisaProduto');
            pesquisaCodigoInput = safeGetElementById('pesquisaCodigo');
            filtroCategoriaSelect = document.getElementById('filtroCategoria'); 
            inventoryTableBody = safeGetElementById('inventoryTableBody');
            modalPreviewContagem = safeGetElementById('modalPreviewContagem'); 
            previewContagemTableContainer = safeGetElementById('previewContagemTableContainer'); 
            empresaDashboardTitle = safeGetElementById('empresaDashboardTitle');
            empresaUserNameSpan = safeGetElementById('empresaUserName');
            console.log("DOM Selectors initialization complete. loginEmailInput:", loginEmailInput ? 'found' : 'NOT FOUND');
        }

        // --- Funções saveQuantities e loadQuantities ---
        function saveQuantities() { 
            try {
                localStorage.setItem('balancoQuantities_v2.9.7', JSON.stringify(quantidadesDigitadas)); 
            } catch (e) {
                console.error("Erro ao salvar quantidades no localStorage:", e);
            }
        }
        function loadQuantities() {
            try {
                const stored = localStorage.getItem('balancoQuantities_v2.9.7'); 
                quantidadesDigitadas = stored ? JSON.parse(stored) : {};
                console.log("Quantidades carregadas do localStorage (v2.9.7):", quantidadesDigitadas);
            } catch (e) {
                console.error("Erro ao carregar quantidades do localStorage:", e);
                quantidadesDigitadas = {};
            }
        }

        // --- FUNÇÕES UTILITÁRIAS ---
        function showLoader() { if (loadingIndicator) loadingIndicator.style.display = 'block'; }
        function hideLoader() { if (loadingIndicator) loadingIndicator.style.display = 'none'; }
        function generateNumericPassword(length = 6) { 
            let password = '';
            for (let i = 0; i < length; i++) {
                password += Math.floor(Math.random() * 10).toString();
            }
            return password;
        }
        async function populateEmpresasSelect(selectElementId, includeSpecialOption = false, specialOptionText = "-- Selecione --", specialOptionValue = "") { 
            const selectEmp = document.getElementById(selectElementId);
            if (!selectEmp) { console.warn(`Select de empresa ${selectElementId} não encontrado.`); return; }
            const currentValue = selectEmp.value; 
            selectEmp.innerHTML = ''; 
            if (includeSpecialOption) {
                const opt = document.createElement('option');
                opt.value = specialOptionValue; 
                opt.textContent = specialOptionText;
                selectEmp.appendChild(opt);
            }
            if (empresasCache.length === 0 && typeof _supabaseClient !== 'undefined') { 
                try {
                    const { data, error } = await _supabaseClient.from('empresas').select('id, nome_empresa').order('nome_empresa');
                    if (error) throw error;
                    empresasCache = data || [];
                } catch (e) { console.error("Erro ao buscar empresas para select:", e); 
                    if(selectEmp) selectEmp.innerHTML = '<option value="">Erro ao carregar</option>'; return;  
                }
            }
            empresasCache.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.id; option.textContent = emp.nome_empresa;
                selectEmp.appendChild(option);
            });
            if (Array.from(selectEmp.options).some(opt => opt.value === currentValue)) {
                selectEmp.value = currentValue;
            } else if (includeSpecialOption) {
                selectEmp.value = specialOptionValue;
            }
        }

        function showScreen(screenId, screenConfig = {}) {
            console.log(`SHOW SCREEN v2.9.7: Tentando mostrar '${screenId}'`, screenConfig);
            hideLoader(); 
            const mainCont = document.getElementById('mainContainer'); 
            const targetScreenElement = screens[screenId]; 

            Object.values(screens).forEach(screenElement => {
                if (screenElement && typeof screenElement.classList !== 'undefined') { 
                    screenElement.classList.remove('active');
                }
            });
            
            if (targetScreenElement && typeof targetScreenElement.classList !== 'undefined') {
                targetScreenElement.classList.add('active');
                console.log(`Screen '${screenId}' ativada. Classes: ${targetScreenElement.className}`);
                if (mainCont) { 
                    if (['adminEmpresas', 'adminCategorias', 'productManagement', 'inventoryCount', 'empresaColaboradores', 'historicoContagens'].includes(screenId)) {
                        mainCont.classList.add('content-container');
                    } else {
                        mainCont.classList.remove('content-container');
                    }
                }

                const adminProdSelCont = document.getElementById('adminProdutoEmpresaSelectorContainer');
                const adminContSelCont = document.getElementById('adminContagemEmpresaSelectorContainer');
                const adminHistSelCont = document.getElementById('adminHistoricoEmpresaSelectorContainer'); 
                const colEmpHist = document.getElementById('colEmpresaHistorico'); 

                if(adminProdSelCont) adminProdSelCont.style.display = 'none';
                if(adminContSelCont) adminContSelCont.style.display = 'none';
                if(adminHistSelCont) adminHistSelCont.style.display = 'none'; 
                if(colEmpHist) colEmpHist.style.display = 'none'; 

                const prodMgmtTitleEl = document.getElementById('productManagementTitle');
                const prodMgmtContextEl = document.getElementById('productManagementContext');
                const prodMgmtBackBtnEl = document.getElementById('productManagementBackButton');
                const invCountTitleEl = document.getElementById('inventoryCountTitle');
                const invCountContextEl = document.getElementById('inventoryCountContext');
                const invCountBackBtnEl = document.getElementById('inventoryCountBackButton');
                const empDashTitleEl = document.getElementById('empresaDashboardTitle');
                const empUserNameDispEl = document.getElementById('empresaUserName');
                const adminMasterNameDispEl = document.getElementById('adminMasterNameDisplay');
                const chgPassUserDispEl = document.getElementById('changingPasswordForUserDisplay');
                const currPassGrpEl = document.getElementById('currentPasswordGroup');
                const chgPassBackBtnEl = document.getElementById('changePasswordBackButton');
                const histTitleEl = document.getElementById('historicoTitle'); 
                const histContextEl = document.getElementById('historicoContext'); 
                const histBackBtnEl = document.getElementById('historicoBackButton'); 


                if (screenId === 'productManagement') {
                    if(prodMgmtTitleEl) prodMgmtTitleEl.textContent = screenConfig.title || 'Gerenciar Produtos';
                    if(prodMgmtContextEl) prodMgmtContextEl.textContent = screenConfig.context || '';
                    // O event listener para productManagementBackButton é adicionado no window.onload
                    if (currentUser?.role === 'admin_master' && screenConfig.showEmpresaSelector && adminProdSelCont) {
                        adminProdSelCont.style.display = 'block';
                    }
                } else if (screenId === 'inventoryCount') {
                    if(invCountTitleEl) invCountTitleEl.textContent = screenConfig.title || 'Balanço de Estoque';
                    if(invCountContextEl) invCountContextEl.textContent = screenConfig.context || '';
                    // O event listener para inventoryCountBackButton é adicionado no window.onload
                    if (currentUser?.role === 'admin_master' && screenConfig.showEmpresaSelector && adminContSelCont) {
                        adminContSelCont.style.display = 'block';
                    }
                } else if (screenId === 'historicoContagens') { 
                    if(histTitleEl) histTitleEl.textContent = screenConfig.title || 'Histórico de Contagens';
                    if(histContextEl) histContextEl.textContent = screenConfig.context || '';
                    // O event listener para historicoBackButton é adicionado no window.onload
                    if (currentUser?.role === 'admin_master' && screenConfig.showEmpresaSelector && adminHistSelCont) {
                        adminHistSelCont.style.display = 'block';
                    }
                    if (currentUser?.role === 'admin_master' && screenConfig.showEmpresaColumnInTable && colEmpHist) {
                        colEmpHist.style.display = ''; 
                    } else if (colEmpHist) { 
                        colEmpHist.style.display = 'none';
                    }

                } else if (screenId === 'empresaDashboard' && currentUser) {
                    if(empDashTitleEl) empDashTitleEl.textContent = `Painel: ${currentUser.empresa_nome || 'Minha Empresa'}`;
                    if(empUserNameDispEl) empUserNameDispEl.textContent = currentUser.full_name || currentUser.email;
                } else if (screenId === 'adminMasterDashboard' && currentUser && adminMasterNameDispEl) {
                     adminMasterNameDispEl.textContent = currentUser.full_name || currentUser.email;   
                } else if (screenId === 'changePassword' && currentUser) {
                    if(chgPassUserDispEl) chgPassUserDispEl.textContent = currentUser.email;
                    if(currPassGrpEl) currPassGrpEl.style.display = 'none'; 
                    // O event listener para changePasswordBackButton é adicionado no window.onload
                }
            } else {
                console.error(`CRITICAL: Elemento de tela para ID LÓGICO '${screenId}' não foi encontrado. Tentando fallback para 'login'.`);
                const loginScreenElement = document.getElementById('screenLogin');
                if (loginScreenElement) {
                     Object.values(screens).forEach(s => { if (s && s.classList) s.classList.remove('active');});
                     loginScreenElement.classList.add('active'); 
                } else {
                    console.error("CRITICAL: Tela de login ('screenLogin') também não encontrada no DOM!");
                    if(document.body) document.body.innerHTML = "<p style='color:red; text-align:center; margin-top:50px;'>Erro crítico na UI. Recarregue.</p>";
                }
            }
            window.scrollTo(0,0); 
            console.log(`FIM de showScreen para '${screenId}'. Classe da tela alvo:`, targetScreenElement ? targetScreenElement.className : 'NÃO ENCONTRADA');
            if (screenId === 'adminMasterDashboard' && screens.login) {
                console.log("Classe da tela de login após mostrar adminMasterDashboard:", screens.login.className);
            }
        }
        
        // --- LÓGICA DE LOGIN E LOGOUT ---
        async function handleLogin() {
            console.log("handleLogin v2.9.7 chamado");
            if (!loginEmailInput || !loginPasswordInput || !loginErrorMessage) {
                console.error("handleLogin: Elementos do formulário de login não encontrados!");
                alert("Erro crítico no formulário de login. Tente recarregar.");
                hideLoader(); 
                return;
            }
            const email = loginEmailInput.value.trim();
            const password = loginPasswordInput.value.trim();
            loginErrorMessage.textContent = ""; loginErrorMessage.style.display = "none";

            if (!email || !password) {
                loginErrorMessage.textContent = "Por favor, preencha email e senha.";
                loginErrorMessage.style.display = "block"; return;
            }
            showLoader();
            console.log("Tentando login para:", email);

            if (email.toLowerCase() === ADMIN_MASTER_EMAIL.toLowerCase() && password === ADMIN_MASTER_PASSWORD) {
                console.log("Admin Master OK.");
                currentUser = { email: ADMIN_MASTER_EMAIL, role: 'admin_master', full_name: 'Admin Master (Você)' };
                showAdminMasterDashboardScreen();
            } else {
                console.log("Tentando login Supabase para:", email);
                try {
                    const { data: signInData, error: signInError } = await _supabaseClient.auth.signInWithPassword({ email, password });
                    if (signInError) { console.error("Supabase signIn Error:", signInError); throw signInError; }
                    if (!signInData || !signInData.user) { console.error("No user data from Supabase signIn."); throw new Error("Usuário não retornado. Verifique credenciais e se a conta está ativa (confirmação de email desabilitada no Supabase para emails fictícios?).");  }
                    console.log("Supabase signIn OK. User ID:", signInData.user.id);

                    const { data: profile, error: profileError } = await _supabaseClient
                        .from('user_profiles').select('empresa_id, role, full_name, empresas (id, nome_empresa)')
                        .eq('id', signInData.user.id).single();
                    if (profileError && profileError.code !== 'PGRST116') { console.error("Erro ao buscar perfil:", profileError); throw profileError; }
                    console.log("Perfil buscado:", profile);

                    if (profile && profile.role === 'empresa_login_principal' && profile.empresa_id && profile.empresas) {
                        currentUser = { 
                            id: signInData.user.id, email: signInData.user.email, role: profile.role, 
                            empresa_id: profile.empresa_id,
                            empresa_nome: profile.empresas.nome_empresa || 'Empresa Associada',
                            full_name: profile.full_name || signInData.user.email
                        };
                        console.log("Usuário de Empresa OK:", currentUser);
                        await showEmpresaDashboardScreen();
                    } else {
                        console.warn("Perfil inválido ou não é empresa_login_principal:", email, profile);
                        await _supabaseClient.auth.signOut(); 
                        throw new Error("Conta de empresa inválida/não configurada.");
                    }
                } catch (e) {
                    console.error("Catch em login Supabase:", e);
                    loginErrorMessage.textContent = e.message.includes("Invalid login credentials") ? "Email ou senha inválidos." : (e.message.includes("Email not confirmed") ? "Email não confirmado. Verifique as configurações do Supabase ou seu email." : (e.message || "Erro desconhecido.")); 
                    loginErrorMessage.style.display = "block";
                }
            }
            hideLoader();
        }
        async function handleLogout() { 
            console.log("handleLogout v2.9.7 chamado");
            showLoader();
            try {
                if (currentUser && currentUser.role !== 'admin_master') { 
                    const { error } = await _supabaseClient.auth.signOut();
                    if (error) { console.error("Erro no logout do Supabase:", error); }
                }
                currentUser = null; adminSelectedEmpresaId = null; adminSelectedEmpresaParaCategoriaId = null;
                if(loginEmailInput) loginEmailInput.value = ""; 
                if(loginPasswordInput) loginPasswordInput.value = "";
                produtosCache = []; categoriasCache = []; empresasCache = []; colaboradoresCache = [];
                quantidadesDigitadas = {}; 
                localStorage.removeItem('balancoQuantities_v2.9.7'); 
                showScreen('login');
                console.log("Usuário deslogado com sucesso.");
            } catch (e) {
                console.error("Erro durante o logout:", e);
            } finally {
                hideLoader();
            }
        }
        function showAdminMasterDashboardScreen() { 
            console.log("showAdminMasterDashboardScreen v2.9.7 chamada");
            adminSelectedEmpresaId = null; 
            adminSelectedEmpresaParaCategoriaId = null; 
            showScreen('adminMasterDashboard'); 
        }
        async function showEmpresaDashboardScreen() { 
            console.log("showEmpresaDashboardScreen v2.9.7 chamada");
            adminSelectedEmpresaId = currentUser?.empresa_id; 
            showScreen('empresaDashboard');
        }
        
        async function showAdminEmpresasScreen() { 
            if (!currentUser || currentUser.role !== 'admin_master') { handleLogout(); return; }
            console.log("showAdminEmpresasScreen v2.9.7 chamada");
            showLoader();
            try {
                const section = document.getElementById('adminDefineLoginEmpresaSection');
                if(section) section.style.display = 'none';
                await fetchAndRenderEmpresas(); 
                showScreen('adminEmpresas'); 
            } catch (e) {
                console.error("Erro em showAdminEmpresasScreen:", e);
                alert("Erro ao carregar tela de empresas.");
            } finally {
                hideLoader();
            }
        }
        async function fetchAndRenderEmpresas() { 
            console.log("fetchAndRenderEmpresas v2.9.7 chamada");
            const tableBody = document.getElementById('adminEmpresasTableBody'); 
            if (!tableBody) {console.error("adminEmpresasTableBody não encontrado"); hideLoader(); return;}
            tableBody.innerHTML = '<tr><td colspan="3">Carregando...</td></tr>';
            try {
                const { data, error } = await _supabaseClient.from('empresas').select('id, nome_empresa, created_at').order('nome_empresa'); 
                if (error) throw error;
                empresasCache = data || []; 
                tableBody.innerHTML = ""; 
                if (empresasCache.length > 0) {
                    empresasCache.forEach(empresa => {
                        const row = tableBody.insertRow();
                        row.insertCell().textContent = empresa.nome_empresa;
                        row.insertCell().textContent = new Date(empresa.created_at).toLocaleDateString('pt-BR');
                        const actionsCell = row.insertCell();
                        
                        const btnDefineLogin = document.createElement('button');
                        btnDefineLogin.textContent = 'Definir/Ver Login'; 
                        btnDefineLogin.className = 'btn btn-info table-actions';
                        btnDefineLogin.onclick = () => openAdminDefineLoginEmpresa(empresa.id, empresa.nome_empresa);
                        actionsCell.appendChild(btnDefineLogin);
                        
                        const btnManageColabs = document.createElement('button');
                        btnManageColabs.textContent = 'Colaboradores';
                        btnManageColabs.className = 'btn btn-secondary table-actions';
                        btnManageColabs.onclick = () => showEmpresaColaboradoresScreen(empresa.id, empresa.nome_empresa, true); 
                        actionsCell.appendChild(btnManageColabs);
                    });
                } else {
                    tableBody.innerHTML = '<tr><td colspan="3">Nenhuma empresa.</td></tr>';
                }
            } catch (e) {
                console.error("Erro ao listar empresas:", e);
                if(tableBody) tableBody.innerHTML = `<tr><td colspan="3" style="color:var(--danger-color);">Erro: ${e.message}</td></tr>`;
            }
        }
        async function handleAdminAddEmpresa() { 
            console.log("handleAdminAddEmpresa v2.9.7 chamada");
            const nomeEmpresaEl = document.getElementById('adminNomeEmpresa');
            if(!nomeEmpresaEl) {console.error("adminNomeEmpresaEl não encontrado"); return;}
            const nomeEmpresa = nomeEmpresaEl.value.trim();
            if (!nomeEmpresa) { alert('Digite o nome da empresa.'); return; }
            showLoader();
            try {
                const { data: existing } = await _supabaseClient.from('empresas').select('id').ilike('nome_empresa', nomeEmpresa).single();
                if (existing) { alert('Empresa já existe.'); hideLoader(); return; }
                const { data: novaEmpresa, error } = await _supabaseClient.from('empresas').insert([{ nome_empresa: nomeEmpresa }]).select().single();
                if (error) throw error;
                if (novaEmpresa && empresasCache) empresasCache.push(novaEmpresa); 
                alert('Empresa adicionada!'); nomeEmpresaEl.value = ''; 
                await fetchAndRenderEmpresas(); 
            } catch (e) { console.error("Erro ao adicionar empresa:", e); alert('Falha: ' + e.message); } finally { hideLoader(); }
        }
        function openAdminDefineLoginEmpresa(empresaId, nomeEmpresa) { 
            console.log("openAdminDefineLoginEmpresa chamada para:", nomeEmpresa);
            const section = document.getElementById('adminDefineLoginEmpresaSection');
            const title = document.getElementById('adminDefineLoginEmpresaTitle');
            const idInput = document.getElementById('selectedEmpresaIdForLogin');
            const emailInput = document.getElementById('adminEmpresaLoginEmail');
            const fullNameInput = document.getElementById('adminEmpresaLoginFullName');
            const passMsg = document.getElementById('generatedEmpresaPasswordMessage');

            if(!section || !title || !idInput || !emailInput || !fullNameInput || !passMsg) {
                console.error("Elementos da UI para definir login de empresa não foram encontrados."); return;
            }
            title.textContent = `Definir Login Principal para: ${nomeEmpresa}`;
            idInput.value = empresaId; 
            emailInput.value = `${nomeEmpresa.toLowerCase().replace(/\s+/g, '.')}@login.sistema`; 
            fullNameInput.value = `Login Principal ${nomeEmpresa}`; 
            passMsg.style.display = 'none'; passMsg.textContent = ''; passMsg.style.color = 'var(--text-color)'; 
            section.style.display = 'block'; emailInput.focus();
        }
        function closeAdminDefineLoginEmpresaSection() { 
            console.log("closeAdminDefineLoginEmpresaSection chamada");
            const section = document.getElementById('adminDefineLoginEmpresaSection');
            if(section) section.style.display = 'none';
        }
        async function handleAdminCreateOrUpdateEmpresaLogin() { 
            console.log("handleAdminCreateOrUpdateEmpresaLogin v2.9.7 chamada");
            const empresaId = document.getElementById('selectedEmpresaIdForLogin').value;
            const titleEl = document.getElementById('adminDefineLoginEmpresaTitle');
            const empresaNome = titleEl ? titleEl.textContent.replace('Definir Login Principal para: ', '').trim() : 'Empresa Desconhecida'; 
            const emailEl = document.getElementById('adminEmpresaLoginEmail');
            const fullNameEl = document.getElementById('adminEmpresaLoginFullName');
            const passMsgEl = document.getElementById('generatedEmpresaPasswordMessage');

            if(!emailEl || !fullNameEl || !passMsgEl) { console.error("Inputs de login da empresa não encontrados"); return; }

            const email = emailEl.value.trim();
            const fullName = fullNameEl.value.trim(); 

            if (!empresaId || !email ) { alert("Preencha o email."); return; }
            const password = generateNumericPassword(6);  
            showLoader();
            passMsgEl.style.display = 'none'; passMsgEl.textContent = ''; passMsgEl.style.color = 'var(--text-color)'; 

            try {
                await _supabaseClient.auth.signOut().catch(()=>{ console.warn("Tentativa de signOut antes de signUp falhou ou não havia sessão.")}); 

                const { data: authData, error: signUpError } = await _supabaseClient.auth.signUp({
                    email, password,
                    options: { data: { empresa_id: empresaId, empresa_nome: empresaNome, role: 'empresa_login_principal', full_name: fullName || `Login ${empresaNome}` } }
                });
                if (signUpError) {
                    if (signUpError.message.includes("User already registered")) {
                         throw new Error(`Email ${email} já está registrado. Use outro ou delete o usuário existente no Supabase Auth.`);
                    } throw signUpError;
                }

                if (authData.user) { 
                    const { error: profileError } = await _supabaseClient.from('user_profiles').insert({
                        id: authData.user.id, email: email, empresa_id: empresaId, role: 'empresa_login_principal', full_name: fullName || `Login ${empresaNome}`
                    });
                    if (profileError) {
                        console.error("Login Auth criado, erro no perfil:", profileError);
                        throw new Error(`Login ${email} criado na Auth, mas falha ao salvar perfil: ${profileError.message}. Delete o usuário ${email} no Supabase Auth e tente de novo.`);
                    }
                } else if (!authData.user && authData.session === null ) { 
                     console.log("Usuário criado, mas pode precisar de confirmação de email se habilitado no Supabase.");
                } else if (!authData.user) {
                     throw new Error("Login da empresa não foi criado no Supabase Auth.");
                }
                
                let successMsg = `Login para ${empresaNome} (${email}) criado!\nSenha Gerada: ${password}\nInforme ao responsável.`;
                successMsg += `\nLembre-se: Se a confirmação de email estiver ATIVA no Supabase, o usuário precisará confirmar o email.`;
                
                passMsgEl.textContent = successMsg;
                passMsgEl.style.display = 'block';
            } catch (e) {
                console.error("Erro definir login empresa:", e); 
                passMsgEl.textContent = `Erro: ${e.message}`;
                passMsgEl.style.color = 'var(--danger-color)';
                passMsgEl.style.display = 'block';
            } finally { hideLoader(); }
        }
        
        async function showAdminCategoriasScreen() { 
            if (!currentUser || currentUser.role !== 'admin_master') { handleLogout(); return; }
            console.log("showAdminCategoriasScreen v2.9.7 chamada");
            showLoader();
            try {
                adminSelectedEmpresaParaCategoriaId = ""; 
                await populateEmpresasSelect('adminCategoriaEmpresaSelect', true, "-- Categoria Global --", ""); 
                const localAdminCategoriaEmpresaSelect = document.getElementById('adminCategoriaEmpresaSelect');
                
                if(localAdminCategoriaEmpresaSelect) {
                    localAdminCategoriaEmpresaSelect.value = ""; 
                    if(!localAdminCategoriaEmpresaSelect.onchangeAttached) { 
                        localAdminCategoriaEmpresaSelect.addEventListener('change', async () => {
                            adminSelectedEmpresaParaCategoriaId = localAdminCategoriaEmpresaSelect.value === "" ? null : localAdminCategoriaEmpresaSelect.value; 
                            console.log("Admin selecionou empresa para categoria:", adminSelectedEmpresaParaCategoriaId);
                            await fetchAndRenderCategorias(); 
                        });
                        localAdminCategoriaEmpresaSelect.onchangeAttached = true;
                    }
                    const event = new Event('change'); 
                    localAdminCategoriaEmpresaSelect.dispatchEvent(event);
                } else {
                     await fetchAndRenderCategorias(); 
                }
                showScreen('adminCategorias');
            } catch (e) {
                console.error("Erro em showAdminCategoriasScreen:", e);
                alert("Erro ao carregar tela de categorias.");
            } finally {
                hideLoader(); 
            }
        }
        async function fetchAndRenderCategorias() { 
            console.log("fetchAndRenderCategorias v2.9.7 chamada com filtro empresa ID:", adminSelectedEmpresaParaCategoriaId);
            const tableBody = document.getElementById('adminCategoriasTableBody');
            if (!tableBody) { console.error("Elemento adminCategoriasTableBody não encontrado."); return; }
            tableBody.innerHTML = '<tr><td colspan="4">Carregando...</td></tr>';
            try {
                let query = _supabaseClient.from('categorias').select(`id, nome_categoria, created_at, empresa_id, empresas ( nome_empresa )`).order('nome_categoria');
                if (adminSelectedEmpresaParaCategoriaId === null) { 
                    query = query.is('empresa_id', null);
                } else if (adminSelectedEmpresaParaCategoriaId) { 
                    query = query.eq('empresa_id', adminSelectedEmpresaParaCategoriaId);
                }
                
                const { data, error } = await query;
                if (error) throw error;
                
                const categoriasExibidas = data || [];
                tableBody.innerHTML = "";
                if (categoriasExibidas.length > 0) {
                    categoriasExibidas.forEach(cat => {
                        const row = tableBody.insertRow();
                        row.insertCell().textContent = cat.nome_categoria;
                        row.insertCell().textContent = cat.empresas ? cat.empresas.nome_empresa : (cat.empresa_id ? `Associada (ID: ${cat.empresa_id.substring(0,4)}...)` : "Global");
                        row.insertCell().textContent = new Date(cat.created_at).toLocaleDateString('pt-BR');
                        const actionsCell = row.insertCell();
                        const btnDelete = document.createElement('button');
                        btnDelete.textContent = 'Deletar'; btnDelete.className = 'btn btn-danger table-actions';
                        btnDelete.onclick = () => handleAdminDeleteCategoria(cat.id, cat.nome_categoria);
                        actionsCell.appendChild(btnDelete);
                    });
                } else {
                    tableBody.innerHTML = '<tr><td colspan="4">Nenhuma categoria para este filtro.</td></tr>';
                }
            } catch (e) {
                console.error("Erro ao buscar categorias:", e);
                if(tableBody) tableBody.innerHTML = `<tr><td colspan="4" style="color:var(--danger-color)">Erro: ${e.message}</td></tr>`;
            }
        }
        async function handleAdminAddCategoria() { 
            console.log("handleAdminAddCategoria v2.9.7 chamada");
            const nomeCategoriaInputEl = document.getElementById('adminNomeCategoria');
            const empresaSelectEl = document.getElementById('adminCategoriaEmpresaSelect');
            if(!nomeCategoriaInputEl || !empresaSelectEl) { console.error("Inputs de categoria não encontrados"); return; }

            const nomeCategoria = nomeCategoriaInputEl.value.trim();
            const empresaIdCtx = empresaSelectEl.value === "" ? null : empresaSelectEl.value;

            if (!nomeCategoria) { alert("Digite o nome da categoria."); nomeCategoriaInputEl.focus(); return; }
            console.log(`Tentando adicionar categoria "${nomeCategoria}" para empresa_id: ${empresaIdCtx}`);
            showLoader();
            try {
                let queryCheck = _supabaseClient.from('categorias').select('id', { count: 'exact' }).eq('nome_categoria', nomeCategoria); 
                if (empresaIdCtx) {
                    queryCheck = queryCheck.eq('empresa_id', empresaIdCtx);
                } else {
                    queryCheck = queryCheck.is('empresa_id', null);
                }
                const { count, error: checkError } = await queryCheck;

                if (checkError && checkError.code !== 'PGRST116') { 
                    console.error("Erro ao verificar categoria existente:", checkError);
                    throw checkError;
                }
                
                if (count !== null && count > 0) { 
                    alert(`Erro: Categoria "${nomeCategoria}" já existe ${empresaIdCtx ? 'para esta empresa' : 'como global'}.`); 
                    hideLoader(); return; 
                }

                const { error: insertError } = await _supabaseClient.from('categorias').insert([{ nome_categoria: nomeCategoria, empresa_id: empresaIdCtx }]);
                if (insertError) throw insertError;
                alert("Categoria adicionada!");
                nomeCategoriaInputEl.value = "";
                await fetchAndRenderCategorias(); 
                
                const { data: cats } = await _supabaseClient.from('categorias').select('*').order('nome_categoria');
                if (cats) categoriasCache = cats; 

            } catch (e) {
                console.error("Erro ao adicionar categoria:", e);
                alert("Falha: " + e.message);
            } finally {
                hideLoader();
            }
        }
        async function handleAdminDeleteCategoria(categoriaId, nomeCategoria) { 
            if (!confirm(`Deletar categoria "${nomeCategoria}"?`)) return;
            console.log("handleAdminDeleteCategoria v2.9.7 chamada para ID:", categoriaId);
            showLoader();
            try {
                const { error } = await _supabaseClient.from('categorias').delete().eq('id', categoriaId);
                if (error) throw error;
                alert(`Categoria "${nomeCategoria}" deletada.`);
                await fetchAndRenderCategorias();
                const { data: cats } = await _supabaseClient.from('categorias').select('*').order('nome_categoria');
                if (cats) categoriasCache = cats; 
            } catch (e) { console.error("Erro ao deletar categoria:", e); alert("Falha: " + e.message);
            } finally { hideLoader(); }
        }
        
        async function showEmpresaColaboradoresScreen(empresaIdParaAdmin = null, nomeEmpresaParaAdmin = null, isAdminCalling = false) {
            console.log("showEmpresaColaboradoresScreen v2.9.7 chamada. Admin:", isAdminCalling, "Empresa ID (Admin):", empresaIdParaAdmin);
            let targetEmpresaId = empresaIdParaAdmin;
            let targetEmpresaNome = nomeEmpresaParaAdmin;
            let backAction = showAdminMasterDashboardScreen; 

            if (!isAdminCalling) { 
                if (!currentUser || currentUser.role !== 'empresa_login_principal' || !currentUser.empresa_id) {
                    handleLogout(); return;
                }
                targetEmpresaId = currentUser.empresa_id;
                targetEmpresaNome = currentUser.empresa_nome;
                backAction = showEmpresaDashboardScreen;
            } else { 
                 if (!currentUser || currentUser.role !== 'admin_master') { handleLogout(); return; }
                 adminSelectedEmpresaId = targetEmpresaId; 
                 backAction = showAdminEmpresasScreen; 
            }
            
            if (!targetEmpresaId) {
                alert("ID da empresa não especificado para gerenciar colaboradores.");
                showScreen(isAdminCalling ? 'adminEmpresas' : 'empresaDashboard');
                return;
            }
            const colabEmpNomeEl = document.getElementById('colaboradoresEmpresaNome');
            const colabNomeInputEl = document.getElementById('colaboradorNome');
            const backBtnEl = document.getElementById('colaboradoresBackButton');

            if(colabEmpNomeEl) colabEmpNomeEl.textContent = targetEmpresaNome || "Empresa";
            if(colabNomeInputEl) colabNomeInputEl.value = ""; 
            // O event listener para colaboradoresBackButton é adicionado no window.onload

            await fetchAndRenderColaboradores(targetEmpresaId);
            showScreen('empresaColaboradores');
        }
        async function fetchAndRenderColaboradores(empresaId) { 
            console.log("fetchAndRenderColaboradores v2.9.7 para empresaId:", empresaId);
            const tableBody = document.getElementById('colaboradoresTableBody');
            if (!tableBody) { console.error("colaboradoresTableBody não encontrado"); return; }
            tableBody.innerHTML = '<tr><td colspan="4">Carregando...</td></tr>';
            try {
                const { data, error } = await _supabaseClient
                    .from('colaboradores').select('*').eq('empresa_id', empresaId).eq('ativo', true).order('nome_colaborador');
                if (error) throw error;
                colaboradoresCache = data || [];
                tableBody.innerHTML = "";
                if (colaboradoresCache.length > 0) {
                    colaboradoresCache.forEach(col => {
                        const row = tableBody.insertRow();
                        row.insertCell().textContent = col.nome_colaborador;
                        row.insertCell().textContent = col.ativo ? 'Sim' : 'Não';
                        row.insertCell().textContent = new Date(col.created_at).toLocaleDateString('pt-BR');
                        const actionsCell = row.insertCell();
                        const btnDeleteColab = document.createElement('button');
                        btnDeleteColab.textContent = 'Desativar'; 
                        btnDeleteColab.className = 'btn btn-danger table-actions';
                        btnDeleteColab.onclick = () => handleDeleteColaborador(col.id, empresaId);
                        actionsCell.appendChild(btnDeleteColab);
                    });
                } else {
                    tableBody.innerHTML = '<tr><td colspan="4">Nenhum colaborador.</td></tr>';
                }
            } catch (e) { 
                console.error("Erro ao buscar colaboradores:", e);
                if(tableBody) tableBody.innerHTML = '<tr><td colspan="4" style="color:var(--danger-color)">Erro.</td></tr>'; 
            }
        }
        async function handleAddColaborador() { 
            console.log("handleAddColaborador v2.9.7 chamada");
            const nomeColabEl = document.getElementById('colaboradorNome');
            if(!nomeColabEl) { console.error("colaboradorNomeEl não encontrado"); return; }
            const nome = nomeColabEl.value.trim();
            
            let empresaIdParaColaborador = null;
            if (currentUser.role === 'admin_master' && adminSelectedEmpresaId) {
                empresaIdParaColaborador = adminSelectedEmpresaId;
            } else if (currentUser.role === 'empresa_login_principal' && currentUser.empresa_id) {
                empresaIdParaColaborador = currentUser.empresa_id;
            }

            if (!empresaIdParaColaborador) {
                alert("Contexto da empresa não definido para adicionar colaborador."); return;
            }
            if (!nome) { alert("Digite o nome do colaborador."); nomeColabEl.focus(); return; }
            
            showLoader();
            try {
                const { error } = await _supabaseClient
                    .from('colaboradores').insert({ nome_colaborador: nome, empresa_id: empresaIdParaColaborador });
                if (error) throw error;
                alert("Colaborador adicionado!");
                nomeColabEl.value = "";
                await fetchAndRenderColaboradores(empresaIdParaColaborador);
            } catch (e) { console.error("Erro ao adicionar colaborador:", e); alert("Falha: " + e.message); } 
            finally { hideLoader(); }
        }
        async function handleDeleteColaborador(colaboradorId, empresaId) { /* ... (Mantida) ... */ }

        function showChangePasswordScreen_Empresa() { /* ... (Mantida) ... */ }
        async function handleChangePassword() { /* ... (Mantida) ... */ }

        async function showHistoricoContagensScreen() { /* ... (Mantida) ... */ }
        async function showHistoricoContagensScreen_Admin() { /* ... (Mantida) ... */ }
        async function fetchAndRenderHistoricoContagens(empresaIdFiltro = null, isAdminView = false) { /* ... (Mantida) ... */ }
        function showDetalhesContagem(dadosContagem) { /* ... (Mantida) ... */ }
        function closeModalDetalhesContagem() { /* ... (Mantida) ... */ }
        function closeModalPreviewContagem() { /* ... (Mantida) ... */ }

        async function populateCategoriaSelect_ProdutoForm(empresaIdContexto = null) { /* ... (Mantida) ... */ }
        async function showProductManagementScreen_AdminGlobal() { /* ... (Mantida) ... */ }
        async function showProductManagementScreen_Empresa() { /* ... (Mantida) ... */ }
        async function fetchProductsFromSupabase(empresaIdFiltro = null) { /* ... (Mantida) ... */ }
        function renderProductManagementTable() { /* ... (Mantida) ... */ }
        async function handleAddProduct() { /* ... (Mantida) ... */ }
        async function handleRemoveProduct(idOuCodigo) { /* ... (Mantida) ... */ }
        async function handleXLSXImport() { /* ... (Mantida) ... */ }

        async function showInventoryCountScreen_AdminGlobal() { /* ... (Mantida) ... */ }
        async function showInventoryCountScreen_Empresa() { /* ... (Mantida) ... */ }
        function renderInventoryTableBasedOnSelection() { /* ... (Mantida) ... */ }
        async function loadColaboradoresParaContagem(empresaId, isGlobalAdminContext = false) { /* ... (Mantida) ... */ }
        
        function populateCategoryFilter(selectElementId = 'filtroCategoria') { /* ... (Mantida) ... */ }
        function displayInventoryProducts(listaProdutos) { /* ... (Mantida) ... */ }
        function filterInventoryProducts() { /* ... (Mantida) ... */ }
        function clearAllQuantities() { /* ... (Mantida) ... */ }
        function showPreviewContagem() { /* ... (Mantida) ... */ }
        async function gerarArquivoTXT() { /* ... (Mantida) ... */ }
        
        // --- INICIALIZAÇÃO ---
        window.onload = async () => { 
            console.log("window.onload v2.9.7 (DOM Ready) iniciado");
            initializeDOMSelectors(); 
            showLoader(); 
            console.log("Chamando loadQuantities() de window.onload...");
            if (typeof loadQuantities === "function") {
                loadQuantities(); 
            } else {
                console.error("CRITICAL: loadQuantities não está definida!");
            }
            
            // Adiciona listeners de evento aos botões principais
            document.getElementById('loginButton')?.addEventListener('click', handleLogin);
            document.getElementById('loginPassword')?.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') { event.preventDefault(); handleLogin(); }
            });

            // Painel Admin Master
            document.getElementById('btnAdminGerenciarEmpresas')?.addEventListener('click', showAdminEmpresasScreen);
            document.getElementById('btnAdminGerenciarCategorias')?.addEventListener('click', showAdminCategoriasScreen);
            document.getElementById('btnAdminGerenciarProdutos')?.addEventListener('click', showProductManagementScreen_AdminGlobal);
            document.getElementById('btnAdminContagemEstoque')?.addEventListener('click', showInventoryCountScreen_AdminGlobal);
            document.getElementById('btnAdminHistoricoContagens')?.addEventListener('click', showHistoricoContagensScreen_Admin);
            document.getElementById('btnLogoutAdmin')?.addEventListener('click', handleLogout);

            // Painel Empresa
            document.getElementById('btnEmpresaGerenciarColaboradores')?.addEventListener('click', showEmpresaColaboradoresScreen);
            document.getElementById('btnEmpresaGerenciarProdutos')?.addEventListener('click', showProductManagementScreen_Empresa);
            document.getElementById('btnEmpresaContagemEstoque')?.addEventListener('click', showInventoryCountScreen_Empresa);
            document.getElementById('btnEmpresaHistoricoContagens')?.addEventListener('click', showHistoricoContagensScreen);
            document.getElementById('btnEmpresaAlterarSenha')?.addEventListener('click', showChangePasswordScreen_Empresa);
            document.getElementById('btnLogoutEmpresa')?.addEventListener('click', handleLogout);
            
            // Botões de Voltar e Ações dentro das telas (os que são fixos)
            document.getElementById('btnAdminCategoriasVoltar')?.addEventListener('click', showAdminMasterDashboardScreen);
            document.getElementById('btnAdminAddCategoria')?.addEventListener('click', handleAdminAddCategoria);
            document.getElementById('btnAdminEmpresasVoltar')?.addEventListener('click', showAdminMasterDashboardScreen);
            document.getElementById('btnAdminAddEmpresa')?.addEventListener('click', handleAdminAddEmpresa);
            document.getElementById('btnSalvarLoginEmpresa')?.addEventListener('click', handleAdminCreateOrUpdateEmpresaLogin);
            document.getElementById('btnCancelarDefineLoginEmpresa')?.addEventListener('click', closeAdminDefineLoginEmpresaSection);
            document.getElementById('colaboradoresBackButton')?.addEventListener('click', () => { 
                if(currentUser?.role === 'admin_master') showAdminEmpresasScreen(); else showEmpresaDashboardScreen();
            });
            document.getElementById('btnAddColaborador')?.addEventListener('click', handleAddColaborador);
            document.getElementById('btnSalvarNovaSenha')?.addEventListener('click', handleChangePassword);
            document.getElementById('btnAddProduct')?.addEventListener('click', handleAddProduct);
            document.getElementById('btnImportXLSX')?.addEventListener('click', handleXLSXImport);
            document.getElementById('btnShowPreviewContagem')?.addEventListener('click', showPreviewContagem);
            document.getElementById('btnGerarTXT')?.addEventListener('click', gerarArquivoTXT);
            document.getElementById('btnClearAllQuantities')?.addEventListener('click', clearAllQuantities);
            document.getElementById('btnClosePreviewModal')?.addEventListener('click', closeModalPreviewContagem);
            document.getElementById('btnCloseDetalhesModal')?.addEventListener('click', closeModalDetalhesContagem);
            document.getElementById('productManagementBackButton')?.addEventListener('click', () => showScreen(currentUser?.role === 'admin_master' ? 'adminMasterDashboard' : 'empresaDashboard'));
            document.getElementById('inventoryCountBackButton')?.addEventListener('click', () => showScreen(currentUser?.role === 'admin_master' ? 'adminMasterDashboard' : 'empresaDashboard'));
            document.getElementById('historicoBackButton')?.addEventListener('click', () => showScreen(currentUser?.role === 'admin_master' ? 'adminMasterDashboard' : 'empresaDashboard'));
            document.getElementById('changePasswordBackButton')?.addEventListener('click', () => showScreen(currentUser?.role === 'empresa_login_principal' ? 'empresaDashboard' : (currentUser?.role === 'admin_master' ? 'adminMasterDashboard' : 'login')));


            console.log("Event listeners principais adicionados.");
            
            try {
                console.log("Carregando caches globais (empresas, categorias) no onload...");
                const empresasPromise = _supabaseClient.from('empresas').select('id, nome_empresa').order('nome_empresa');
                const categoriasPromise = _supabaseClient.from('categorias').select('*').order('nome_categoria');
                
                const [empresasRes, categoriasRes] = await Promise.all([empresasPromise, categoriasPromise]);

                if (empresasRes.error) console.error("Erro ao carregar empresas no cache (onload):", empresasRes.error);
                else empresasCache = empresasRes.data || [];

                if (categoriasRes.error) {
                     console.error("Erro ao carregar categorias no cache (onload):", categoriasRes.error);
                } else {
                    categoriasCache = categoriasRes.data || [];
                }
                console.log("Caches globais (empresas, categorias) carregados no onload.");

            } catch(e) {
                console.error("Erro crítico ao carregar dados iniciais (empresas/categorias) no onload:", e);
            }
            
            const localPesquisaProdutoInput = document.getElementById('pesquisaProduto');
            const localPesquisaCodigoInput = document.getElementById('pesquisaCodigo');
            const localFiltroCategoriaSelect = document.getElementById('filtroCategoria'); 
            if (localPesquisaProdutoInput) localPesquisaProdutoInput.addEventListener("input", filterInventoryProducts);
            if (localPesquisaCodigoInput) localPesquisaCodigoInput.addEventListener("input", filterInventoryProducts);
            if (localFiltroCategoriaSelect) localFiltroCategoriaSelect.addEventListener("change", filterInventoryProducts);
            
            try { 
                console.log("Tentando obter sessão Supabase no onload...");
                const { data: { session }, error: sessionError } = await _supabaseClient.auth.getSession();
                if (sessionError) { console.error("Erro ao obter sessão inicial Supabase (onload):", sessionError); throw sessionError; }

                if (session?.user) {
                    console.log("Sessão Supabase encontrada para user ID (onload):", session.user.id);
                    const user = session.user;
                    const { data: profile, error: profileError } = await _supabaseClient
                        .from('user_profiles')
                        .select('empresa_id, role, full_name, empresas ( nome_empresa )')
                        .eq('id', user.id)
                        .single();
                    
                    if (profileError && profileError.code === 'PGRST116') { 
                        console.warn("Sessão ativa, mas perfil não encontrado (onload). Deslogando.", user.id);
                        await _supabaseClient.auth.signOut(); showScreen('login');
                    } else if (profileError) { 
                        console.error("Erro ao buscar perfil para sessão ativa (onload):", profileError);
                        throw profileError; 
                    } else if (profile && profile.role === 'empresa_login_principal' && profile.empresa_id && profile.empresas) {
                        currentUser = { 
                            id: user.id, email: user.email, role: profile.role, 
                            empresa_id: profile.empresa_id,
                            empresa_nome: profile.empresas.nome_empresa || 'Empresa Associada',
                            full_name: profile.full_name || user.email
                        };
                        console.log("Sessão restaurada para Usuário de Empresa (onload):", currentUser);
                        await showEmpresaDashboardScreen();
                    } else { 
                        console.warn("Sessão Supabase ativa, mas perfil inválido ou não é 'empresa_login_principal' (onload). Deslogando. Perfil:", profile);
                        await _supabaseClient.auth.signOut(); showScreen('login'); 
                    }
                } else { 
                    console.log("Nenhuma sessão Supabase ativa encontrada (onload).");
                    showScreen('login'); 
                }
            } catch (e) {
                console.error("Erro crítico na inicialização ao tentar restaurar sessão/perfil (onload):", e);
                await _supabaseClient.auth.signOut().catch(err => { console.warn("Erro no signOut de fallback (onload):", err); }); 
                currentUser = null; 
                showScreen('login');
            } finally {
                console.log("window.onload finalizado.");
                hideLoader(); 
            }
        };
        console.log("SCRIPT END - v2.9.9");
    </script>
</body>
</html>