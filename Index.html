<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Balanço de Estoque - v2.8.7</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* CSS da versão anterior (v2.8.6 - tema claro) mantido. */
        :root {
            --primary-color: #007bff; --primary-color-darker: #0069d9;
            --secondary-color: #6c757d; --secondary-color-darker: #5a6268;
            --success-color: #198754; --success-color-darker: #157347;
            --danger-color: #dc3545; --danger-color-darker: #bb2d3b;
            --warning-color: #ffc107; --warning-color-darker: #ffb300;
            --info-color: #0dcaf0; --info-color-darker: #0aa9c6;
            --background-color: #f4f6f9; --container-bg-color: #ffffff;
            --card-bg-color: #ffffff; --header-bg-color: #f8f9fa;
            --input-bg-color: #ffffff; --input-border-color: #ced4da; 
            --text-color: #212529; --text-muted-color: #6c757d;
            --text-on-primary-color: #ffffff; --text-on-secondary-color: #ffffff;
            --text-on-success-color: #ffffff; --text-on-danger-color: #ffffff;
            --text-on-warning-color: #000000; --text-on-info-color: #000000;
            --border-color: #dee2e6; --hover-row-background: #e9ecef;
            --border-radius: 0.375rem; --box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
            --box-shadow-lg: 0 0.5rem 1rem rgba(0,0,0,0.15);
        }
        body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;margin:0;padding:20px 0;background-color:var(--background-color);color:var(--text-color);display:flex;flex-direction:column;align-items:center;min-height:100vh;line-height:1.5;font-size:1rem}
        .container{width:95%;max-width:600px;background-color:var(--container-bg-color);padding:25px 30px;border-radius:var(--border-radius);box-shadow:var(--box-shadow);margin-top:20px;margin-bottom:20px;border:1px solid var(--border-color)}
        .content-container{max-width:1140px}
        h1,h2,h3{color:var(--text-color);text-align:center;margin-top:0;margin-bottom:1.5rem;font-weight:500}
        h1{font-size:2rem}h2{font-size:1.75rem}h3{font-size:1.5rem;margin-bottom:1rem}
        .screen { display: none; } 
        .screen.active { display: block; animation: fadeIn .5s; }
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        button,.btn{border:1px solid transparent;padding:.5rem 1rem;text-align:center;text-decoration:none;display:inline-block;font-size:1rem;font-weight:400;line-height:1.5;border-radius:var(--border-radius);cursor:pointer;transition:color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;margin:.25rem}
        button:hover,.btn:hover{text-decoration:none;transform:translateY(-1px);box-shadow:var(--box-shadow-lg)}
        button:active,.btn:active{transform:translateY(0);}
        button:focus-visible,.btn:focus-visible{outline:2px solid var(--primary-color);outline-offset:2px}
        .btn-primary{background-color:var(--primary-color);border-color:var(--primary-color);color:var(--text-on-primary-color)}.btn-primary:hover{background-color:var(--primary-color-darker);border-color:var(--primary-color-darker)}
        .btn-secondary{background-color:var(--secondary-color);border-color:var(--secondary-color);color:var(--text-on-secondary-color)}.btn-secondary:hover{background-color:var(--secondary-color-darker);border-color:var(--secondary-color-darker)}
        .btn-success{background-color:var(--success-color);border-color:var(--success-color);color:var(--text-on-success-color)}.btn-success:hover{background-color:var(--success-color-darker);border-color:var(--success-color-darker)}
        .btn-danger{background-color:var(--danger-color);border-color:var(--danger-color);color:var(--text-on-danger-color)}.btn-danger:hover{background-color:var(--danger-color-darker);border-color:var(--danger-color-darker)}
        .btn-warning{background-color:var(--warning-color);border-color:var(--warning-color);color:var(--text-on-warning-color)}.btn-warning:hover{background-color:var(--warning-color-darker);border-color:var(--warning-color-darker)}
        .btn-info{background-color:var(--info-color);border-color:var(--info-color);color:var(--text-on-info-color);}.btn-info:hover{background-color:var(--info-color-darker);border-color:var(--info-color-darker);}
        .dashboard-options{display:flex;flex-direction:column;align-items:stretch;gap:1rem;padding:1rem 0}
        .dashboard-options .btn{padding:.75rem 1rem;font-size:1.05rem;width:100%}
        .card{border:1px solid var(--border-color);border-radius:var(--border-radius);margin-bottom:1.5rem;box-shadow:var(--box-shadow);background-color:var(--card-bg-color)}
        .card-header{padding:.75rem 1.25rem;margin-bottom:0;background-color:var(--header-bg-color);border-bottom:1px solid var(--border-color);border-top-left-radius:calc(var(--border-radius) - 1px);border-top-right-radius:calc(var(--border-radius) - 1px)}
        .card-header>*{margin:0;font-size:1.25rem;font-weight:500;color:var(--text-color);text-align:left}
        .card-body{padding:1.25rem}
        table{width:100%;border-collapse:collapse;margin-bottom:1rem;color:var(--text-color); }
        th,td{border:1px solid var(--border-color);padding:.75rem;text-align:left;vertical-align:middle}
        th{background-color:var(--header-bg-color);font-weight:500;border-bottom-width:2px} 
        tbody tr:nth-child(odd){background-color:var(--container-bg-color); } 
        tbody tr:nth-child(even){background-color: #f1f3f5; } 
        tbody tr:hover{background-color:var(--hover-row-background); }
        input[type=text],input[type=number],input[type=password],input[type=email],select,input[type=file]{width:100%;padding:.5rem .75rem;margin-bottom:1rem;border:1px solid var(--input-border-color);border-radius:var(--border-radius);box-sizing:border-box;font-size:1rem;line-height:1.5;background-color:var(--input-bg-color);color:var(--text-color);background-clip:padding-box;transition:border-color .15s ease-in-out,box-shadow .15s ease-in-out}
        input[type=text]::placeholder,input[type=number]::placeholder,input[type=password]::placeholder,input[type=email]::placeholder{color:var(--text-muted-color);opacity:1}
        input[type=text]:focus,input[type=number]:focus,input[type=password]:focus,input[type=email]:focus,select:focus{border-color:var(--primary-color);outline:0;box-shadow:0 0 0 .25rem rgba(13,110,253,.25)}
        input[type=file]{padding:.375rem .75rem}
        select{appearance:none;background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23212529' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");background-repeat:no-repeat;background-position:right .75rem center;background-size:16px 12px}
        .form-group{margin-bottom:1rem}
        .form-group label{display:block;margin-bottom:.5rem;font-weight:500;color:var(--text-color); }
        .filter-controls,.product-management-form-fields,.xlsx-import-section,.actions-bar,.sub-form-section{margin-bottom:1.5rem;padding:1rem;background-color:var(--card-bg-color);border:1px solid var(--border-color);border-radius:var(--border-radius)} 
        .product-management-form-fields .form-group{margin-bottom:0}
        .filter-controls>div{flex:1;min-width:200px}
        .filter-controls input,.filter-controls select{margin-bottom:0}
        .xlsx-import-section input[type=file]{width:auto;margin-right:.5rem}
        .actions-bar{text-align:center;padding:1rem 0; background-color: transparent; border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); }
        .actions-bar .btn{margin:0 .5rem}
        #productManagementTable td:last-child,#inventoryTable td:last-child,#adminEmpresasTable td:last-child, #colaboradoresTable td:last-child, #historicoContagensTable td:last-child, #adminCategoriasTable td:last-child {text-align:center} 
        #inventoryTable input[type=number]{max-width:80px;text-align:right;padding:.375rem .5rem;font-size:.9rem}
        .back-button{margin-bottom:1.5rem;display:inline-block}
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.4); 
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; opacity: 0; visibility: hidden; 
            transition: opacity 0.2s ease, visibility 0.2s ease; 
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { 
            background-color: var(--container-bg-color); color: var(--text-color); 
            padding: 20px 25px; border-radius: var(--border-radius); 
            box-shadow: var(--box-shadow-lg); width: 90%; max-width: 500px; 
            text-align: left; 
            border: 1px solid var(--border-color);
            transform: translateY(-20px) scale(0.95); 
            transition: transform 0.2s ease, opacity 0.2s ease; 
            opacity: 0;
        }
        .modal-overlay.active .modal-content { transform: translateY(0) scale(1); opacity: 1;}
        .modal-content h4 { color: var(--text-color); margin-bottom: 1rem; font-size: 1.25rem; text-align: center;}
        .modal-content p { color: var(--text-muted-color); margin-bottom: 1rem; font-size: 0.95rem; } 
        .modal-actions { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem; }
        .login-form{max-width:400px;margin:1.5rem auto; padding: 2rem; background-color: var(--container-bg-color); border-radius: var(--border-radius); box-shadow: var(--box-shadow);}
        .login-form .form-group{margin-bottom:1rem}
        .login-form button{width:100%;padding:.75rem;font-size:1.05em}
        #loginErrorMessage{color:var(--danger-color);margin-top:1rem;text-align:center;display:none}
        .sub-form-section h4{text-align:left;font-size:1.1rem;color:var(--text-color);margin-bottom:1rem;border-bottom:1px solid var(--border-color);padding-bottom:.5rem}
        .table-actions button,.table-actions .btn{margin:0 2px;padding:.25rem .5rem;font-size:.85rem}
        .generated-password-display { margin-top: 10px; padding: 10px; background-color: #e9ecef; border: 1px dashed var(--border-color); border-radius: var(--border-radius); word-break: break-all; color: var(--text-color); font-family: monospace; text-align: center;}
        .company-users-list { list-style-type: none; padding-left: 0; font-size: 0.9em; }
        .company-users-list li { padding: 8px 5px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .company-users-list li:last-child { border-bottom: none; }
        .company-users-list li .user-info { margin-right: 10px; flex-grow: 1; }
        .company-users-list li .user-info .user-email { font-weight: bold; color: var(--primary-color); }
        .company-users-list li .user-info .user-details { font-style: italic; color: var(--text-muted-color); font-size: 0.9em; display: block; }
        .company-users-list li .user-actions { display: flex; gap: 5px; flex-shrink: 0; }
        .password-change-form { max-width: 450px; margin: 1.5rem auto; }
        .form-inline-flex { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 1rem;}
        .form-inline-flex .form-group { flex: 1; margin-bottom: 0;}
        .form-inline-flex button { flex-shrink: 0; }
        #previewContagemTable { width: 100%; margin-top: 1rem; }
        #previewContagemTable th, #previewContagemTable td { font-size: 0.9rem; padding: 0.5rem; }
        .admin-context-selector { margin-bottom: 1.5rem; padding: 1rem; background-color: var(--header-bg-color); border-radius: var(--border-radius); }
        .admin-context-selector label { margin-right: 0.5rem; font-weight: 500;}
        .admin-context-selector select { display: inline-block; width: auto; min-width: 250px; margin-right: 10px; }
        .loader { 
            border: 5px solid #e9ecef; 
            border-top: 5px solid var(--primary-color);
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: 20px auto;
            display: none; 
        }
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    </style>
</head>
<body>
    <div id="mainContainer" class="container"> 
        <div id="loadingIndicator" class="loader" style="display:none;"></div>

        <div id="screenLogin" class="screen active">
            <h1>Login no Sistema de Balanço</h1>
            <div class="login-form card card-body">
                <div class="form-group"><label for="loginEmail">Email:</label><input type="email" id="loginEmail" placeholder="seuemail@exemplo.com" autocomplete="email"></div>
                <div class="form-group"><label for="loginPassword">Senha:</label><input type="password" id="loginPassword" placeholder="Sua senha" autocomplete="current-password"></div>
                <button class="btn btn-primary" id="loginButton">Entrar</button> 
                <div id="loginErrorMessage"></div>
            </div>
        </div>

        <div id="screenAdminMasterDashboard" class="screen">
            <h2>Painel Admin Master</h2>
            <p style="text-align: center;">Bem-vindo, <span id="adminMasterNameDisplay">Admin Master</span>!</p>
            <div class="dashboard-options">
                <button class="btn btn-primary" onclick="showAdminEmpresasScreen()">Gerenciar Empresas & Seus Logins</button>
                <button class="btn btn-primary" onclick="showAdminCategoriasScreen()">Gerenciar Categorias</button> 
                <button class="btn btn-primary" onclick="showProductManagementScreen_AdminGlobal()">Gerenciar Produtos</button>
                <button class="btn btn-primary" onclick="showInventoryCountScreen_AdminGlobal()">Contagem de Estoque</button>
                <button class="btn btn-secondary" onclick="handleLogout()">Logout</button>
            </div>
        </div>

        <div id="screenEmpresaDashboard" class="screen">
            <h2 id="empresaDashboardTitle">Painel da Empresa</h2>
            <p style="text-align: center;">Logado como: <span id="empresaUserName"></span></p>
            <div class="dashboard-options">
                <button class="btn btn-primary" onclick="showEmpresaColaboradoresScreen()">Gerenciar Colaboradores</button>
                <button class="btn btn-primary" onclick="showProductManagementScreen_Empresa()">Gerenciar Produtos da Empresa</button>
                <button class="btn btn-primary" onclick="showInventoryCountScreen_Empresa()">Iniciar Contagem da Empresa</button>
                <button class="btn btn-info" onclick="showHistoricoContagensScreen()">Ver Histórico de Contagens</button>
                <button class="btn btn-info" onclick="showChangePasswordScreen_Empresa()">Alterar Senha da Empresa</button> 
                <button class="btn btn-secondary" onclick="handleLogout()">Logout</button>
            </div>
        </div>
        
        <div id="screenAdminCategorias" class="screen">
            <button class="btn btn-secondary back-button" onclick="showAdminMasterDashboardScreen()">&larr; Painel Admin</button>
            <h2>Gerenciar Categorias de Produtos</h2>
            <div class="card">
                <div class="card-header"><h3>Adicionar Nova Categoria</h3></div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="adminCategoriaEmpresaSelect">Associar Categoria a:</label>
                        <select id="adminCategoriaEmpresaSelect">
                            <option value="">-- Categoria Global (para todas empresas) --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="adminNomeCategoria">Nome da Nova Categoria:</label>
                        <input type="text" id="adminNomeCategoria" placeholder="Ex: Bolos, Salgados, Bebidas">
                    </div>
                    <button class="btn btn-success" onclick="handleAdminAddCategoria()">Adicionar Categoria</button>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><h3>Categorias Cadastradas</h3></div>
                <div class="card-body">
                    <table id="adminCategoriasTable">
                        <thead><tr><th>Nome da Categoria</th><th>Escopo (Empresa / Global)</th><th>Criação</th><th>Ações</th></tr></thead>
                        <tbody id="adminCategoriasTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="screenAdminEmpresas" class="screen">
             <button class="btn btn-secondary back-button" onclick="showAdminMasterDashboardScreen()">&larr; Painel Admin</button>
            <h2>Gerenciar Empresas e Seus Logins Principais</h2>
            <div class="card"><div class="card-header"><h3>Adicionar Nova Empresa</h3></div><div class="card-body"><div class="form-group"><label for="adminNomeEmpresa">Nome da Empresa:</label><input type="text" id="adminNomeEmpresa" placeholder="Nome da nova empresa"></div><button class="btn btn-success" onclick="handleAdminAddEmpresa()">Adicionar Empresa</button></div></div>
            <div class="card"><div class="card-header"><h3>Empresas Cadastradas</h3></div><div class="card-body"><table id="adminEmpresasTable"><thead><tr><th>Nome</th><th>Criação</th><th style="width:200px;">Login da Empresa</th></tr></thead><tbody id="adminEmpresasTableBody"></tbody></table></div></div>
            <div id="adminDefineLoginEmpresaSection" class="card" style="display:none; margin-top: 2rem;"><div class="card-header"><h3 id="adminDefineLoginEmpresaTitle">Definir Login para Empresa</h3></div><div class="card-body"><input type="hidden" id="selectedEmpresaIdForLogin"><div class="form-group"><label for="adminEmpresaLoginEmail">Email para Login da Empresa (fictício):</label><input type="email" id="adminEmpresaLoginEmail" placeholder="login_empresa@sistema.com"></div><div class="form-group"><label for="adminEmpresaLoginFullName">Nome de Referência (Ex: Login Principal):</label><input type="text" id="adminEmpresaLoginFullName" placeholder="Referência do Login"></div><button class="btn btn-success" onclick="handleAdminCreateOrUpdateEmpresaLogin()">Salvar Login e Gerar Senha</button><div id="generatedEmpresaPasswordMessage" class="generated-password-display" style="display:none;"></div></div><button class="btn btn-secondary" onclick="closeAdminDefineLoginEmpresaSection()" style="margin: 0 1.25rem 1.25rem;">Cancelar</button></div>
        </div>
        
        <div id="screenEmpresaColaboradores" class="screen">
            <button class="btn btn-secondary back-button" onclick="showEmpresaDashboardScreen()">&larr; Painel da Empresa</button>
            <h2>Gerenciar Colaboradores (<span id="colaboradoresEmpresaNome"></span>)</h2>
            <div class="card"><div class="card-header"><h3>Adicionar Novo Colaborador</h3></div><div class="card-body"><div class="form-inline-flex"><div class="form-group"><label for="colaboradorNome">Nome do Colaborador:</label><input type="text" id="colaboradorNome" placeholder="Nome completo"></div><button class="btn btn-success" onclick="handleAddColaborador()">Adicionar</button></div></div></div>
            <div class="card"><div class="card-header"><h3>Colaboradores Cadastrados</h3></div><div class="card-body"><table id="colaboradoresTable"><thead><tr><th>Nome</th><th>Ativo</th><th>Criação</th><th>Ações</th></tr></thead><tbody id="colaboradoresTableBody"></tbody></table></div></div>
        </div>
        
        <div id="screenChangePassword" class="screen">
             <button class="btn btn-secondary back-button" id="changePasswordBackButton">&larr; Voltar ao Painel</button>
            <h2>Alterar Senha</h2>
            <div class="password-change-form card card-body">
                <p>Alterando senha para o login: <strong id="changingPasswordForUserDisplay"></strong></p>
                <div class="form-group" id="currentPasswordGroup" style="display:none;"><label for="currentPasswordInput">Senha Atual:</label><input type="password" id="currentPasswordInput"></div>
                <div class="form-group"><label for="newPasswordInput">Nova Senha (mín. 6 caracteres):</label><input type="password" id="newPasswordInput" placeholder="Digite a nova senha"></div>
                <div class="form-group"><label for="confirmNewPasswordInput">Confirmar Nova Senha:</label><input type="password" id="confirmNewPasswordInput" placeholder="Confirme a nova senha"></div>
                <button class="btn btn-primary" onclick="handleChangePassword()">Salvar Nova Senha</button>
                <div id="changePasswordMessage" style="margin-top:1rem; text-align:center;"></div>
            </div>
        </div>

        <div id="screenHistoricoContagens" class="screen">
            <button class="btn btn-secondary back-button" onclick="showEmpresaDashboardScreen()">&larr; Painel da Empresa</button>
            <h2>Histórico de Contagens (<span id="historicoEmpresaNome"></span>)</h2>
            <div class="card"><div class="card-header"><h3>Registros de Contagem</h3></div><div class="card-body" style="padding:0;"><table id="historicoContagensTable"><thead><tr><th>Data</th><th>Colaborador</th><th>Itens Contados</th><th>Ações</th></tr></thead><tbody id="historicoContagensTableBody"></tbody></table></div></div>
            <div id="modalDetalhesContagem" class="modal-overlay"><div class="modal-content" style="max-width: 600px; text-align:left;"><h4>Detalhes da Contagem</h4><div id="detalhesContagemConteudo"></div><div class="modal-actions" style="margin-top:1.5rem;"><button class="btn btn-secondary" onclick="closeModalDetalhesContagem()">Fechar</button></div></div></div>
        </div>

        <div id="screenProductManagement" class="screen">
            <button class="btn btn-secondary back-button" id="productManagementBackButton">&larr; Voltar</button>
            <h2 id="productManagementTitle">Gerenciar Produtos</h2>
            <div id="adminProdutoEmpresaSelectorContainer" class="admin-context-selector" style="display:none;">
                <label for="adminProdutoEmpresaSelect">Gerenciar Produtos Para Empresa:</label>
                <select id="adminProdutoEmpresaSelect"><option value="">-- Produtos Globais (Sem Empresa) --</option></select>
            </div>
            <p id="productManagementContext" style="text-align:center; font-size:0.9em; color:var(--text-muted-color); margin-bottom: 1rem;"></p>
            <div class="card"><div class="card-header"><h3>Adicionar Novo Produto</h3></div><div class="card-body">
                <div class="product-management-form-fields">
                    <div class="form-group"><label for="prodCodigo">Código:</label><input type="text" id="prodCodigo"></div>
                    <div class="form-group"><label for="prodNome">Produto:</label><input type="text" id="prodNome"></div>
                    <div class="form-group">
                        <label for="prodCategoriaSelect">Categoria:</label>
                        <select id="prodCategoriaSelect"><option value="">-- Sem Categoria --</option></select>
                    </div>
                    <button class="btn btn-success" onclick="handleAddProduct()">Adicionar</button>
                </div>
            </div></div>
            <div class="card"><div class="card-header"><h3>Importar Produtos via XLSX</h3></div><div class="card-body xlsx-import-section"><input type="file" id="xlsxFile" accept=".xlsx, .xls"><button class="btn btn-info" onclick="handleXLSXImport()">Importar</button><p>Colunas: 'codigo', 'produto', 'categoria'. Categoria vazia = Sem Categoria.</p></div></div>
            <div class="card"><div class="card-header"><h3>Produtos Cadastrados</h3></div><div class="card-body" style="padding:0;"><table id="productManagementTable"><thead><tr><th>Código</th><th>Produto</th><th>Categoria</th><th>Ação</th></tr></thead><tbody id="productManagementTableBody"></tbody></table></div></div>
        </div>

        <div id="screenInventoryCount" class="screen">
            <button class="btn btn-secondary back-button" id="inventoryCountBackButton">&larr; Voltar</button>
            <h2 id="inventoryCountTitle">Balanço de Estoque</h2>
            <div id="adminContagemEmpresaSelectorContainer" class="admin-context-selector" style="display:none;">
                <label for="adminContagemEmpresaSelect">Realizar Contagem Para Empresa:</label>
                <select id="adminContagemEmpresaSelect"><option value="">-- Contagem Global (Produtos Sem Empresa) --</option></select>
            </div>
            <p id="inventoryCountContext" style="text-align:center; font-size:0.9em; color:var(--text-muted-color); margin-bottom: 1rem;"></p>
            <div class="card card-body">
                <div class="form-group"> 
                    <label for="selectColaboradorContagem">Contagem realizada por:</label>
                    <select id="selectColaboradorContagem" style="margin-bottom: 1rem;"></select>
                </div>
                <div class="actions-bar" style="border:none; padding-bottom:0;">
                     <button class="btn btn-info" onclick="showPreviewContagem()">Ver Resumo</button> 
                     <button class="btn btn-success" onclick="gerarArquivoTXT()">Gerar TXT & Salvar Histórico</button>
                     <button class="btn btn-warning" onclick="clearAllQuantities()">Limpar Quantidades</button>
                </div>
            </div>
            <div class="filter-controls card card-body"><div><label for="pesquisaProduto">Produto:</label><input type="text" id="pesquisaProduto" placeholder="Nome..."></div><div><label for="pesquisaCodigo">Código:</label><input type="text" id="pesquisaCodigo" placeholder="Código..."></div><div><label for="filtroCategoria">Categoria:</label><select id="filtroCategoria"><option value="">Todas</option></select></div></div>
            <table><thead><tr><th>Código</th><th>Produto</th><th>Categoria</th><th>Quantidade</th></tr></thead><tbody id="inventoryTableBody"></tbody></table>
            
            <div id="modalPreviewContagem" class="modal-overlay"><div class="modal-content" style="max-width: 700px; text-align:left;"><h4>Resumo da Contagem Atual</h4><div id="previewContagemTableContainer" style="max-height: 400px; overflow-y:auto;"><table id="previewContagemTable"><thead><tr><th>Código</th><th>Produto</th><th>Categoria</th><th>Qtd. Digitada</th></tr></thead><tbody></tbody></table></div><div class="modal-actions" style="margin-top: 1.5rem;"><button class="btn btn-secondary" onclick="closeModalPreviewContagem()">Fechar</button></div></div></div>
        </div>
        <div id="modalDetalhesContagem" class="modal-overlay"><div class="modal-content" style="max-width: 600px; text-align:left;"><h4>Detalhes da Contagem</h4><div id="detalhesContagemConteudo"></div><div class="modal-actions" style="margin-top:1.5rem;"><button class="btn btn-secondary" onclick="closeModalDetalhesContagem()">Fechar</button></div></div></div>

    </div>

    <script>
        // --- CONFIGURAÇÃO SUPABASE ---
        const SUPABASE_URL = 'https://daeocsintrbdfqclvteg.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhZW9jc2ludHJiZGZxY2x2dGVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM0ODMxNDEsImV4cCI6MjA1OTA1OTE0MX0.BJ61kSxTDiEFway590hoTvVH4yu0FxLnjecqQsYdwK4';
        const { createClient } = supabase;
        const _supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- VARIÁVEIS GLOBAIS ---
        let produtosCache = []; 
        let categoriasCache = []; 
        let empresasCache = []; 
        let colaboradoresCache = []; 
        let quantidadesDigitadas = {}; 
        const ADMIN_MASTER_EMAIL = "matheus@mtech.com";
        const ADMIN_MASTER_PASSWORD = "260195@@";
        let currentUser = null; 
        let adminSelectedEmpresaId = null; 
        let adminSelectedEmpresaParaCategoriaId = null;

        // --- SELETORES DOM (serão inicializados no window.onload) ---
        let mainContainer, screens = {}, loadingIndicator, loginEmailInput, loginPasswordInput, loginErrorMessage,
            adminMasterNameDisplay, adminNomeEmpresaInput, adminEmpresasTableBody, adminDefineLoginEmpresaSection,
            adminDefineLoginEmpresaTitle, selectedEmpresaIdForLogin, adminEmpresaLoginEmailInput,
            adminEmpresaLoginFullNameInput, generatedEmpresaPasswordMessage, adminCategoriaEmpresaSelect,
            adminNomeCategoriaInput, adminCategoriasTableBody, colaboradoresEmpresaNomeSpan, colaboradorNomeInput,
            colaboradoresTableBody, currentPasswordInput, newPasswordInput, confirmNewPasswordInput,
            changePasswordMessage, changePasswordBackButton, changingPasswordForUserDisplay, currentPasswordGroup,
            historicoEmpresaNomeSpan, historicoContagensTableBody, modalDetalhesContagem, detalhesContagemConteudo,
            productManagementBackButton, productManagementTitle, productManagementContext,
            adminProdutoEmpresaSelectorContainer, adminProdutoEmpresaSelect, prodCodigoInput, prodNomeInput,
            prodCategoriaSelect, productManagementTableBody, xlsxFileInput, inventoryCountBackButton,
            inventoryCountTitle, inventoryCountContext, adminContagemEmpresaSelectorContainer,
            adminContagemEmpresaSelect, selectColaboradorContagem, pesquisaProdutoInput, pesquisaCodigoInput,
            filtroCategoriaSelect, inventoryTableBody, modalPreviewContagem, previewContagemTableContainer,
            empresaDashboardTitle, empresaUserNameSpan;

        function initializeDOMSelectors() {
            console.log("initializeDOMSelectors chamado");
            mainContainer = document.getElementById('mainContainer');
            screens = {
                login: document.getElementById('screenLogin'),
                adminMasterDashboard: document.getElementById('screenAdminMasterDashboard'),
                empresaDashboard: document.getElementById('screenEmpresaDashboard'),
                adminEmpresas: document.getElementById('screenAdminEmpresas'),
                adminCategorias: document.getElementById('screenAdminCategorias'), 
                empresaColaboradores: document.getElementById('screenEmpresaColaboradores'),
                changePassword: document.getElementById('screenChangePassword'), 
                historicoContagens: document.getElementById('screenHistoricoContagens'),
                productManagement: document.getElementById('screenProductManagement'),
                inventoryCount: document.getElementById('screenInventoryCount')
            };
            loadingIndicator = document.getElementById('loadingIndicator');
            loginEmailInput = document.getElementById('loginEmail');
            loginPasswordInput = document.getElementById('loginPassword');
            loginErrorMessage = document.getElementById('loginErrorMessage');
            adminMasterNameDisplay = document.getElementById('adminMasterNameDisplay');
            adminNomeEmpresaInput = document.getElementById('adminNomeEmpresa');
            adminEmpresasTableBody = document.getElementById('adminEmpresasTableBody');
            adminDefineLoginEmpresaSection = document.getElementById('adminDefineLoginEmpresaSection');
            adminDefineLoginEmpresaTitle = document.getElementById('adminDefineLoginEmpresaTitle');
            selectedEmpresaIdForLogin = document.getElementById('selectedEmpresaIdForLogin');
            adminEmpresaLoginEmailInput = document.getElementById('adminEmpresaLoginEmail');
            adminEmpresaLoginFullNameInput = document.getElementById('adminEmpresaLoginFullName');
            generatedEmpresaPasswordMessage = document.getElementById('generatedEmpresaPasswordMessage');
            adminCategoriaEmpresaSelect = document.getElementById('adminCategoriaEmpresaSelect');
            adminNomeCategoriaInput = document.getElementById('adminNomeCategoria');
            adminCategoriasTableBody = document.getElementById('adminCategoriasTableBody');
            colaboradoresEmpresaNomeSpan = document.getElementById('colaboradoresEmpresaNome');
            colaboradorNomeInput = document.getElementById('colaboradorNome');
            colaboradoresTableBody = document.getElementById('colaboradoresTableBody');
            currentPasswordInput = document.getElementById('currentPasswordInput');
            newPasswordInput = document.getElementById('newPasswordInput');
            confirmNewPasswordInput = document.getElementById('confirmNewPasswordInput');
            changePasswordMessage = document.getElementById('changePasswordMessage');
            changePasswordBackButton = document.getElementById('changePasswordBackButton');
            changingPasswordForUserDisplay = document.getElementById('changingPasswordForUserDisplay');
            currentPasswordGroup = document.getElementById('currentPasswordGroup');
            historicoEmpresaNomeSpan = document.getElementById('historicoEmpresaNome');
            historicoContagensTableBody = document.getElementById('historicoContagensTableBody');
            modalDetalhesContagem = document.getElementById('modalDetalhesContagem');
            detalhesContagemConteudo = document.getElementById('detalhesContagemConteudo');
            productManagementBackButton = document.getElementById('productManagementBackButton');
            productManagementTitle = document.getElementById('productManagementTitle');
            productManagementContext = document.getElementById('productManagementContext');
            adminProdutoEmpresaSelectorContainer = document.getElementById('adminProdutoEmpresaSelectorContainer');
            adminProdutoEmpresaSelect = document.getElementById('adminProdutoEmpresaSelect');
            prodCodigoInput = document.getElementById('prodCodigo');
            prodNomeInput = document.getElementById('prodNome');
            prodCategoriaSelect = document.getElementById('prodCategoriaSelect'); 
            productManagementTableBody = document.getElementById('productManagementTableBody');
            xlsxFileInput = document.getElementById('xlsxFile');
            inventoryCountBackButton = document.getElementById('inventoryCountBackButton');
            inventoryCountTitle = document.getElementById('inventoryCountTitle');
            inventoryCountContext = document.getElementById('inventoryCountContext');
            adminContagemEmpresaSelectorContainer = document.getElementById('adminContagemEmpresaSelectorContainer');
            adminContagemEmpresaSelect = document.getElementById('adminContagemEmpresaSelect');
            selectColaboradorContagem = document.getElementById('selectColaboradorContagem');
            pesquisaProdutoInput = document.getElementById('pesquisaProduto');
            pesquisaCodigoInput = document.getElementById('pesquisaCodigo');
            filtroCategoriaSelect = document.getElementById('filtroCategoria'); 
            inventoryTableBody = document.getElementById('inventoryTableBody');
            modalPreviewContagem = document.getElementById('modalPreviewContagem'); 
            previewContagemTableContainer = document.getElementById('previewContagemTableContainer'); 
            empresaDashboardTitle = document.getElementById('empresaDashboardTitle');
            empresaUserNameSpan = document.getElementById('empresaUserName');
            console.log("DOM Selectors initialized. loginEmailInput:", loginEmailInput ? 'found' : 'NOT FOUND');
        }


        // --- FUNÇÕES UTILITÁRIAS ---
        function showLoader() { 
            if (loadingIndicator) loadingIndicator.style.display = 'block'; 
            else console.warn("loadingIndicator não encontrado em showLoader");
        }
        function hideLoader() { 
            if (loadingIndicator) loadingIndicator.style.display = 'none'; 
            else console.warn("loadingIndicator não encontrado em hideLoader");
        }
        function generateNumericPassword(length = 6) { 
             let password = '';
            for (let i = 0; i < length; i++) {
                password += Math.floor(Math.random() * 10).toString();
            }
            return password;
        }
        async function populateEmpresasSelect(selectElementId, includeSpecialOption = false, specialOptionText = "-- Selecione --", specialOptionValue = "") { 
            const selectEmp = document.getElementById(selectElementId);
            if (!selectEmp) { console.warn(`Select de empresa ${selectElementId} não encontrado.`); return; }
            const currentValue = selectEmp.value; 
            selectEmp.innerHTML = ''; 
            if (includeSpecialOption) {
                const opt = document.createElement('option');
                opt.value = specialOptionValue; 
                opt.textContent = specialOptionText;
                selectEmp.appendChild(opt);
            }
            if (empresasCache.length === 0 && typeof _supabaseClient !== 'undefined') { 
                console.log("Cache de empresas vazio, buscando do Supabase para o select:", selectElementId);
                try {
                    const { data, error } = await _supabaseClient.from('empresas').select('id, nome_empresa').order('nome_empresa');
                    if (error) throw error;
                    empresasCache = data || [];
                } catch (e) { console.error("Erro ao buscar empresas para select:", e); 
                    if(selectEmp) selectEmp.innerHTML = '<option value="">Erro ao carregar</option>'; return;  
                }
            }
            empresasCache.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.id; option.textContent = emp.nome_empresa;
                selectEmp.appendChild(option);
            });
            if (Array.from(selectEmp.options).some(opt => opt.value === currentValue)) {
                selectEmp.value = currentValue;
            } else if (includeSpecialOption) {
                selectEmp.value = specialOptionValue;
            }
        }

        function showScreen(screenId, screenConfig = {}) {
            console.log(`SHOW SCREEN: Tentando mostrar '${screenId}'`, screenConfig);
            hideLoader(); 
            const mainCont = document.getElementById('mainContainer'); 
            const targetScreenElement = screens[screenId]; 

            Object.values(screens).forEach(screenElement => {
                if (screenElement && typeof screenElement.classList !== 'undefined') { 
                    screenElement.classList.remove('active');
                }
            });
            
            if (targetScreenElement && typeof targetScreenElement.classList !== 'undefined') {
                targetScreenElement.classList.add('active');
                console.log(`Screen '${screenId}' ativada.`);
                if (mainCont) { 
                    if (['adminEmpresas', 'adminCategorias', 'productManagement', 'inventoryCount', 'empresaColaboradores', 'historicoContagens'].includes(screenId)) {
                        mainCont.classList.add('content-container');
                    } else {
                        mainCont.classList.remove('content-container');
                    }
                }

                const adminProdSelCont = document.getElementById('adminProdutoEmpresaSelectorContainer');
                const adminContSelCont = document.getElementById('adminContagemEmpresaSelectorContainer');
                if(adminProdSelCont) adminProdSelCont.style.display = 'none';
                if(adminContSelCont) adminContSelCont.style.display = 'none';

                const prodMgmtTitleEl = document.getElementById('productManagementTitle');
                const prodMgmtContextEl = document.getElementById('productManagementContext');
                const prodMgmtBackBtnEl = document.getElementById('productManagementBackButton');
                const invCountTitleEl = document.getElementById('inventoryCountTitle');
                const invCountContextEl = document.getElementById('inventoryCountContext');
                const invCountBackBtnEl = document.getElementById('inventoryCountBackButton');
                const empDashTitleEl = document.getElementById('empresaDashboardTitle');
                const empUserNameDispEl = document.getElementById('empresaUserName');
                const adminMasterNameDispEl = document.getElementById('adminMasterNameDisplay');
                const chgPassUserDispEl = document.getElementById('changingPasswordForUserDisplay');
                const currPassGrpEl = document.getElementById('currentPasswordGroup');
                const chgPassBackBtnEl = document.getElementById('changePasswordBackButton');

                if (screenId === 'productManagement') {
                    if(prodMgmtTitleEl) prodMgmtTitleEl.textContent = screenConfig.title || 'Gerenciar Produtos';
                    if(prodMgmtContextEl) prodMgmtContextEl.textContent = screenConfig.context || '';
                    if(prodMgmtBackBtnEl) prodMgmtBackBtnEl.onclick = screenConfig.backAction || (() => showScreen(currentUser?.role === 'admin_master' ? 'adminMasterDashboard' : 'empresaDashboard'));
                    if (currentUser?.role === 'admin_master' && screenConfig.showEmpresaSelector && adminProdSelCont) {
                        adminProdSelCont.style.display = 'block';
                    }
                } else if (screenId === 'inventoryCount') {
                    if(invCountTitleEl) invCountTitleEl.textContent = screenConfig.title || 'Balanço de Estoque';
                    if(invCountContextEl) invCountContextEl.textContent = screenConfig.context || '';
                    if(invCountBackBtnEl) invCountBackBtnEl.onclick = screenConfig.backAction || (() => showScreen(currentUser?.role === 'admin_master' ? 'adminMasterDashboard' : 'empresaDashboard'));
                    if (currentUser?.role === 'admin_master' && screenConfig.showEmpresaSelector && adminContSelCont) {
                        adminContSelCont.style.display = 'block';
                    }
                } else if (screenId === 'empresaDashboard' && currentUser) {
                    if(empDashTitleEl) empDashTitleEl.textContent = `Painel: ${currentUser.empresa_nome || 'Minha Empresa'}`;
                    if(empUserNameDispEl) empUserNameDispEl.textContent = currentUser.full_name || currentUser.email;
                } else if (screenId === 'adminMasterDashboard' && currentUser && adminMasterNameDispEl) {
                     adminMasterNameDispEl.textContent = currentUser.full_name || currentUser.email;   
                } else if (screenId === 'changePassword' && currentUser) {
                    if(chgPassUserDispEl) chgPassUserDispEl.textContent = currentUser.email;
                    if(currPassGrpEl) currPassGrpEl.style.display = 'none'; 
                    if(chgPassBackBtnEl) chgPassBackBtnEl.onclick = screenConfig.backAction || (() => showScreen(currentUser?.role === 'empresa_login_principal' ? 'empresaDashboard' : (currentUser?.role === 'admin_master' ? 'adminMasterDashboard' : 'login') ));
                }
            } else {
                console.error(`CRITICAL: Elemento de tela para ID LÓGICO '${screenId}' não foi encontrado no objeto 'screens' ou é inválido. Tentando fallback para 'login'.`);
                const loginScreenElement = document.getElementById('screenLogin'); // Tenta pegar diretamente
                if (loginScreenElement && typeof loginScreenElement.classList !== 'undefined') {
                     Object.values(screens).forEach(s => { if (s && s.classList) s.classList.remove('active');});
                     loginScreenElement.classList.add('active'); 
                } else {
                    console.error("CRITICAL: Tela de login ('screenLogin') também não encontrada no DOM! Falha total na UI.");
                    if(document.body) document.body.innerHTML = "<p style='color:red; text-align:center; margin-top:50px;'>Erro crítico na UI. Recarregue.</p>";
                }
            }
            window.scrollTo(0,0); 
        }
        
        async function handleLogin() {
            console.log("handleLogin chamado");
            if (!loginEmailInput || !loginPasswordInput || !loginErrorMessage) {
                console.error("handleLogin: Elementos do formulário de login não encontrados. Verifique os IDs no HTML e na função initializeDOMSelectors.");
                alert("Erro crítico no formulário de login. Tente recarregar a página.");
                return;
            }
            const email = loginEmailInput.value.trim();
            const password = loginPasswordInput.value.trim();
            loginErrorMessage.textContent = ""; loginErrorMessage.style.display = "none";

            if (!email || !password) {
                loginErrorMessage.textContent = "Por favor, preencha email e senha.";
                loginErrorMessage.style.display = "block"; return;
            }
            showLoader();
            console.log("Tentando login para:", email);

            if (email.toLowerCase() === ADMIN_MASTER_EMAIL.toLowerCase() && password === ADMIN_MASTER_PASSWORD) {
                console.log("Admin Master OK.");
                currentUser = { email: ADMIN_MASTER_EMAIL, role: 'admin_master', full_name: 'Admin Master (Você)' };
                showAdminMasterDashboardScreen();
            } else {
                console.log("Tentando login Supabase para:", email);
                try {
                    const { data: signInData, error: signInError } = await _supabaseClient.auth.signInWithPassword({ email, password });
                    if (signInError) { console.error("Supabase signIn Error:", signInError); throw signInError; }
                    if (!signInData || !signInData.user) { console.error("No user data or user object from Supabase signIn."); throw new Error("Usuário não retornado. Verifique credenciais e se a conta está ativa (confirmação de email desabilitada no Supabase para emails fictícios?).");  }
                    console.log("Supabase signIn OK. User ID:", signInData.user.id);

                    const { data: profile, error: profileError } = await _supabaseClient
                        .from('user_profiles').select('empresa_id, role, full_name, empresas (id, nome_empresa)')
                        .eq('id', signInData.user.id).single();
                    if (profileError && profileError.code !== 'PGRST116') { console.error("Erro ao buscar perfil:", profileError); throw profileError; }
                    console.log("Perfil buscado:", profile);

                    if (profile && profile.role === 'empresa_login_principal' && profile.empresa_id && profile.empresas) {
                        currentUser = { 
                            id: signInData.user.id, email: signInData.user.email, role: profile.role, 
                            empresa_id: profile.empresa_id,
                            empresa_nome: profile.empresas.nome_empresa || 'Empresa Associada',
                            full_name: profile.full_name || signInData.user.email
                        };
                        console.log("Usuário de Empresa OK:", currentUser);
                        await showEmpresaDashboardScreen();
                    } else {
                        console.warn("Perfil inválido ou não é empresa_login_principal:", email, profile);
                        await _supabaseClient.auth.signOut(); 
                        throw new Error("Conta de empresa inválida/não configurada.");
                    }
                } catch (e) {
                    console.error("Catch em login Supabase:", e);
                    loginErrorMessage.textContent = e.message.includes("Invalid login credentials") ? "Email ou senha inválidos." : (e.message.includes("Email not confirmed") ? "Email não confirmado. Verifique as configurações do Supabase ou seu email." : (e.message || "Erro desconhecido.")); 
                    loginErrorMessage.style.display = "block";
                }
            }
            hideLoader();
        }
        async function handleLogout() { 
            showLoader();
            if (currentUser && currentUser.role !== 'admin_master') { 
                const { error } = await _supabaseClient.auth.signOut();
                if (error) { console.error("Erro no logout do Supabase:", error); }
            }
            currentUser = null; adminSelectedEmpresaId = null; adminSelectedEmpresaParaCategoriaId = null;
            if(loginEmailInput) loginEmailInput.value = ""; 
            if(loginPasswordInput) loginPasswordInput.value = "";
            produtosCache = []; categoriasCache = []; empresasCache = []; colaboradoresCache = [];
            quantidadesDigitadas = {}; 
            localStorage.removeItem('balancoQuantities_v2.8.7'); 
            showScreen('login');
            hideLoader();
            console.log("Usuário deslogado.");
        }
        function showAdminMasterDashboardScreen() { adminSelectedEmpresaId = null; adminSelectedEmpresaParaCategoriaId = null; showScreen('adminMasterDashboard'); }
        async function showEmpresaDashboardScreen() { adminSelectedEmpresaId = currentUser?.empresa_id; showScreen('empresaDashboard');}
        
        async function showAdminEmpresasScreen() { 
            if (!currentUser || currentUser.role !== 'admin_master') { handleLogout(); return; }
            showLoader();
            const section = document.getElementById('adminDefineLoginEmpresaSection');
            if(section) section.style.display = 'none';
            await fetchAndRenderEmpresas(); 
            showScreen('adminEmpresas'); 
        }
        async function fetchAndRenderEmpresas() { 
            const tableBody = document.getElementById('adminEmpresasTableBody'); 
            if (!tableBody) {console.error("adminEmpresasTableBody não encontrado"); return;}
            tableBody.innerHTML = '<tr><td colspan="3">Carregando...</td></tr>';
            try {
                const { data, error } = await _supabaseClient.from('empresas').select('*').order('nome_empresa');
                if (error) throw error;
                empresasCache = data || []; 
                tableBody.innerHTML = ""; 
                if (empresasCache.length > 0) {
                    empresasCache.forEach(empresa => {
                        const row = tableBody.insertRow();
                        row.insertCell().textContent = empresa.nome_empresa;
                        row.insertCell().textContent = new Date(empresa.created_at).toLocaleDateString('pt-BR');
                        const actionsCell = row.insertCell();
                        const btnDefineLogin = document.createElement('button');
                        btnDefineLogin.textContent = 'Definir/Ver Login'; 
                        btnDefineLogin.className = 'btn btn-info table-actions';
                        btnDefineLogin.onclick = () => openAdminDefineLoginEmpresa(empresa.id, empresa.nome_empresa);
                        actionsCell.appendChild(btnDefineLogin);
                    });
                } else {
                    tableBody.innerHTML = '<tr><td colspan="3">Nenhuma empresa.</td></tr>';
                }
            } catch (e) {
                tableBody.innerHTML = `<tr><td colspan="3" style="color:var(--danger-color);">Erro: ${e.message}</td></tr>`;
            }
        }
        async function handleAdminAddEmpresa() { 
            const nomeEmpresaEl = document.getElementById('adminNomeEmpresa');
            if(!nomeEmpresaEl) return;
            const nomeEmpresa = nomeEmpresaEl.value.trim();
            if (!nomeEmpresa) { alert('Digite o nome da empresa.'); return; }
            showLoader();
            try {
                const { data: existing } = await _supabaseClient.from('empresas').select('id').ilike('nome_empresa', nomeEmpresa).single();
                if (existing) { alert('Empresa já existe.'); hideLoader(); return; }
                const { data: novaEmpresa, error } = await _supabaseClient.from('empresas').insert([{ nome_empresa: nomeEmpresa }]).select().single();
                if (error) throw error;
                if (novaEmpresa && empresasCache) empresasCache.push(novaEmpresa); 
                alert('Empresa adicionada!'); nomeEmpresaEl.value = ''; 
                await fetchAndRenderEmpresas(); 
            } catch (e) { alert('Falha: ' + e.message); } finally { hideLoader(); }
        }
        function openAdminDefineLoginEmpresa(empresaId, nomeEmpresa) { 
            const section = document.getElementById('adminDefineLoginEmpresaSection');
            const title = document.getElementById('adminDefineLoginEmpresaTitle');
            const idInput = document.getElementById('selectedEmpresaIdForLogin');
            const emailInput = document.getElementById('adminEmpresaLoginEmail');
            const fullNameInput = document.getElementById('adminEmpresaLoginFullName');
            const passMsg = document.getElementById('generatedEmpresaPasswordMessage');

            if(!section || !title || !idInput || !emailInput || !fullNameInput || !passMsg) {
                console.error("Elementos da UI para definir login de empresa não foram encontrados."); return;
            }
            title.textContent = `Definir Login Principal para: ${nomeEmpresa}`;
            idInput.value = empresaId; 
            emailInput.value = `${nomeEmpresa.toLowerCase().replace(/\s+/g, '.')}@login.sistema`; 
            fullNameInput.value = `Login Principal ${nomeEmpresa}`; 
            passMsg.style.display = 'none'; passMsg.textContent = ''; passMsg.style.color = 'var(--text-color)'; 
            section.style.display = 'block'; emailInput.focus();
        }
        function closeAdminDefineLoginEmpresaSection() { 
            const section = document.getElementById('adminDefineLoginEmpresaSection');
            if(section) section.style.display = 'none';
        }
        async function handleAdminCreateOrUpdateEmpresaLogin() { 
            const empresaId = document.getElementById('selectedEmpresaIdForLogin').value;
            const titleEl = document.getElementById('adminDefineLoginEmpresaTitle');
            const empresaNome = titleEl ? titleEl.textContent.replace('Definir Login Principal para: ', '').trim() : 'Empresa Desconhecida'; 
            const emailEl = document.getElementById('adminEmpresaLoginEmail');
            const fullNameEl = document.getElementById('adminEmpresaLoginFullName');
            const passMsgEl = document.getElementById('generatedEmpresaPasswordMessage');

            if(!emailEl || !fullNameEl || !passMsgEl) { console.error("Inputs de login da empresa não encontrados"); return; }

            const email = emailEl.value.trim();
            const fullName = fullNameEl.value.trim(); 

            if (!empresaId || !email ) { alert("Preencha o email."); return; }
            const password = generateNumericPassword(6);  
            showLoader();
            passMsgEl.style.display = 'none'; passMsgEl.textContent = ''; passMsgEl.style.color = 'var(--text-color)'; 

            try {
                await _supabaseClient.auth.signOut().catch(()=>{}); 

                const { data: authData, error: signUpError } = await _supabaseClient.auth.signUp({
                    email, password,
                    options: { data: { empresa_id: empresaId, empresa_nome: empresaNome, role: 'empresa_login_principal', full_name: fullName || `Login ${empresaNome}` } }
                });
                if (signUpError) {
                    if (signUpError.message.includes("User already registered")) {
                         throw new Error(`Email ${email} já registrado. Use outro ou delete o usuário no Supabase Auth.`);
                    } throw signUpError;
                }

                if (authData.user) { 
                    const { error: profileError } = await _supabaseClient.from('user_profiles').insert({
                        id: authData.user.id, email: email, empresa_id: empresaId, role: 'empresa_login_principal', full_name: fullName || `Login ${empresaNome}`
                    });
                    if (profileError) {
                        console.error("Login Auth criado, erro no perfil:", profileError);
                        throw new Error(`Login ${email} criado, mas falha ao salvar perfil: ${profileError.message}. Delete o usuário ${email} no Supabase Auth e tente de novo.`);
                    }
                } else if (!authData.user && authData.session === null && !(_supabaseClient.auth.settings?.mailer?.autoconfirm ?? true) ) { 
                } else if (!authData.user) {
                     throw new Error("Login da empresa não foi criado no Supabase Auth.");
                }
                
                let successMsg = `Login para ${empresaNome} (${email}) criado!\nSenha Gerada: ${password}\nInforme ao responsável.`;
                const mailerSettings = _supabaseClient.auth.settings?.mailer;
                if (mailerSettings && mailerSettings.autoconfirm === false) { // Checagem mais segura
                    successMsg += `\nO login pode precisar de confirmação por email (verifique config. Supabase).`;
                }
                
                passMsgEl.textContent = successMsg;
                passMsgEl.style.display = 'block';
            } catch (e) {
                console.error("Erro definir login empresa:", e); 
                passMsgEl.textContent = `Erro: ${e.message}`;
                passMsgEl.style.color = 'var(--danger-color)';
                passMsgEl.style.display = 'block';
            } finally { hideLoader(); }
        }
        
        async function showAdminCategoriasScreen() { 
            if (!currentUser || currentUser.role !== 'admin_master') { handleLogout(); return; }
            showLoader();
            adminSelectedEmpresaParaCategoriaId = null; 
            await populateEmpresasSelect('adminCategoriaEmpresaSelect', true, "-- Categoria Global --", ""); 
            const localAdminCategoriaEmpresaSelect = document.getElementById('adminCategoriaEmpresaSelect');
            
            if(localAdminCategoriaEmpresaSelect) {
                localAdminCategoriaEmpresaSelect.value = ""; 
                if(!localAdminCategoriaEmpresaSelect.onchange) { 
                    localAdminCategoriaEmpresaSelect.onchange = async () => {
                        adminSelectedEmpresaParaCategoriaId = localAdminCategoriaEmpresaSelect.value || null; 
                        await fetchAndRenderCategorias(adminSelectedEmpresaParaCategoriaId); 
                    };
                }
                if (localAdminCategoriaEmpresaSelect.onchange) localAdminCategoriaEmpresaSelect.onchange();
            } else {
                await fetchAndRenderCategorias(); 
            }
            hideLoader(); 
            showScreen('adminCategorias');
        }
        async function fetchAndRenderCategorias(filterEmpresaId = undefined) { /* ... (Mantida) ... */ }
        async function handleAdminAddCategoria() { /* ... (Mantida) ... */ }
        async function handleAdminDeleteCategoria(categoriaId, nomeCategoria) { /* ... (Mantida) ... */ }
        
        async function showEmpresaColaboradoresScreen() { /* ... (Mantida) ... */ }
        async function fetchAndRenderColaboradores(empresaId) { /* ... (Mantida) ... */ }
        async function handleAddColaborador() { /* ... (Mantida) ... */ }
        async function handleDeleteColaborador(colaboradorId, empresaId) { /* ... (Mantida) ... */ }

        function showChangePasswordScreen_Empresa() { /* ... (Mantida) ... */ }
        async function handleChangePassword() { /* ... (Mantida) ... */ }

        async function showHistoricoContagensScreen() { /* ... (Mantida) ... */ }
        async function fetchAndRenderHistoricoContagens(empresaId) { /* ... (Mantida) ... */ }
        function showDetalhesContagem(dadosContagem) { /* ... (Mantida) ... */ }
        function closeModalDetalhesContagem() { /* ... (Mantida) ... */ }
        function closeModalPreviewContagem() { /* ... (Mantida) ... */ }

        async function populateCategoriaSelect_ProdutoForm(empresaIdContexto = null) { /* ... (Mantida) ... */ }
        async function showProductManagementScreen_AdminGlobal() { /* ... (Mantida) ... */ }
        async function showProductManagementScreen_Empresa() { /* ... (Mantida) ... */ }
        async function fetchProductsFromSupabase(empresaIdFiltro = null) { /* ... (Mantida) ... */ }
        function renderProductManagementTable() { /* ... (Mantida) ... */ }
        async function handleAddProduct() { /* ... (Mantida) ... */ }
        async function handleRemoveProduct(idOuCodigo) { /* ... (Mantida) ... */ }
        async function handleXLSXImport() { /* ... (Mantida) ... */ }

        async function showInventoryCountScreen_AdminGlobal() { /* ... (Mantida) ... */ }
        async function showInventoryCountScreen_Empresa() { /* ... (Mantida) ... */ }
        function renderInventoryTableBasedOnSelection() { /* ... (Mantida) ... */ }
        async function loadColaboradoresParaContagem(empresaId, isGlobalAdminContext = false) { /* ... (Mantida) ... */ }
        
        // DEFINIÇÃO DE saveQuantities e loadQuantities
        function saveQuantities() { 
            localStorage.setItem('balancoQuantities_v2.8.7', JSON.stringify(quantidadesDigitadas)); 
            console.log("Quantidades salvas no localStorage:", quantidadesDigitadas);
        }
        function loadQuantities() {
            const stored = localStorage.getItem('balancoQuantities_v2.8.7');
            quantidadesDigitadas = stored ? JSON.parse(stored) : {};
            console.log("Quantidades carregadas do localStorage:", quantidadesDigitadas);
        }

        function populateCategoryFilter(selectElementId = 'filtroCategoria') { /* ... (Mantida) ... */ }
        function displayInventoryProducts(listaProdutos) { /* ... (Mantida) ... */ }
        function filterInventoryProducts() { /* ... (Mantida) ... */ }
        function clearAllQuantities() { /* ... (Mantida) ... */ }
        function showPreviewContagem() { /* ... (Mantida) ... */ }
        async function gerarArquivoTXT() { /* ... (Mantida) ... */ }
        
        window.onload = async () => { 
            console.log("window.onload v2.8.7 (DOM Ready) iniciado");
            initializeDOMSelectors(); 
            showLoader(); 
            console.log("Chamando loadQuantities() de window.onload...");
            loadQuantities(); // Chamada explícita e correta
            
            const loginBtn = document.getElementById('loginButton'); 
            if (loginBtn) {
                loginBtn.addEventListener('click', handleLogin);
                console.log("Event listener para handleLogin adicionado ao botão #loginButton.");
            } else {
                console.error("Botão de login com id='loginButton' NÃO encontrado no DOM!");
            }
            
            try {
                console.log("Carregando caches globais (empresas, categorias) no onload...");
                const empresasPromise = _supabaseClient.from('empresas').select('id, nome_empresa').order('nome_empresa');
                const categoriasPromise = _supabaseClient.from('categorias').select('*').order('nome_categoria');
                const [empresasRes, categoriasRes] = await Promise.all([empresasPromise, categoriasPromise]);

                if (empresasRes.error) console.error("Erro ao carregar empresas no cache (onload):", empresasRes.error);
                else empresasCache = empresasRes.data || [];

                if (categoriasRes.error) console.error("Erro ao carregar categorias no cache (onload):", categoriasRes.error);
                else categoriasCache = categoriasRes.data || [];
                console.log("Caches globais (empresas, categorias) carregados no onload.");

            } catch(e) {
                console.error("Erro crítico ao carregar dados iniciais (empresas/categorias) no onload:", e);
            }
            
            const localPesquisaProdutoInput = document.getElementById('pesquisaProduto');
            const localPesquisaCodigoInput = document.getElementById('pesquisaCodigo');
            const localFiltroCategoriaSelect = document.getElementById('filtroCategoria'); 
            if (localPesquisaProdutoInput) localPesquisaProdutoInput.addEventListener("input", filterInventoryProducts);
            if (localPesquisaCodigoInput) localPesquisaCodigoInput.addEventListener("input", filterInventoryProducts);
            if (localFiltroCategoriaSelect) localFiltroCategoriaSelect.addEventListener("change", filterInventoryProducts);
            
            try { 
                console.log("Tentando obter sessão Supabase no onload...");
                const { data: { session }, error: sessionError } = await _supabaseClient.auth.getSession();
                if (sessionError) { console.error("Erro ao obter sessão inicial Supabase (onload):", sessionError); throw sessionError; }

                if (session?.user) {
                    console.log("Sessão Supabase encontrada para user ID (onload):", session.user.id);
                    const user = session.user;
                    const { data: profile, error: profileError } = await _supabaseClient
                        .from('user_profiles')
                        .select('empresa_id, role, full_name, empresas ( nome_empresa )')
                        .eq('id', user.id)
                        .single();
                    
                    if (profileError && profileError.code === 'PGRST116') { 
                        console.warn("Sessão ativa, mas perfil não encontrado (onload). Deslogando.", user.id);
                        await _supabaseClient.auth.signOut(); showScreen('login');
                    } else if (profileError) { 
                        console.error("Erro ao buscar perfil para sessão ativa (onload):", profileError);
                        throw profileError; 
                    } else if (profile && profile.role === 'empresa_login_principal' && profile.empresa_id && profile.empresas) {
                        currentUser = { 
                            id: user.id, email: user.email, role: profile.role, 
                            empresa_id: profile.empresa_id,
                            empresa_nome: profile.empresas.nome_empresa || 'Empresa Associada',
                            full_name: profile.full_name || user.email
                        };
                        console.log("Sessão restaurada para Usuário de Empresa (onload):", currentUser);
                        await showEmpresaDashboardScreen();
                    } else { 
                        console.warn("Sessão Supabase ativa, mas perfil inválido ou não é 'empresa_login_principal' (onload). Deslogando. Perfil:", profile);
                        await _supabaseClient.auth.signOut(); showScreen('login'); 
                    }
                } else { 
                    console.log("Nenhuma sessão Supabase ativa encontrada (onload).");
                    showScreen('login'); 
                }
            } catch (e) {
                console.error("Erro crítico na inicialização ao tentar restaurar sessão/perfil (onload):", e);
                await _supabaseClient.auth.signOut().catch(err => { console.error("Erro no signOut de fallback (onload):", err); }); 
                currentUser = null; 
                showScreen('login');
            } finally {
                console.log("window.onload finalizado.");
                hideLoader(); 
            }
        };
    </script>
</body>
</html>