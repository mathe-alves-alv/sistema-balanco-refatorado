<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Balanço de Estoque - Multiempresa v2.1</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            /* Cores do Tema Escuro */
            --primary-color: #0d6efd; /* Azul Bootstrap um pouco mais moderno */
            --primary-color-darker: #0b5ed7;
            --secondary-color: #6c757d; /* Cinza Bootstrap */
            --secondary-color-darker: #5c636a;
            --success-color: #198754; /* Verde Bootstrap */
            --success-color-darker: #157347;
            --danger-color: #dc3545; /* Vermelho Bootstrap */
            --danger-color-darker: #bb2d3b;
            --warning-color: #ffc107; /* Amarelo Bootstrap */
            --warning-color-darker: #ffae00;
            --info-color: #0dcaf0; /* Ciano Bootstrap */
            --info-color-darker: #0baccc;

            --background-color: #212529; /* Cinza bem escuro (Bootstrap Dark BG) */
            --container-bg-color: #2c3034; /* Um pouco mais claro que o fundo */
            --header-bg-color: #343a40;  /* Cinza escuro (Bootstrap Dark Table Head) */
            --input-bg-color: #495057;   /* Cinza para inputs (Bootstrap Dark Forms) */
            --input-border-color: #6c757d; /* Borda dos inputs */
            
            --text-color: #f8f9fa; /* Branco (Bootstrap Dark Text) */
            --text-muted-color: #adb5bd; /* Cinza claro para texto secundário */
            --text-on-primary-color: #ffffff;
            --text-on-secondary-color: #ffffff;
            --text-on-success-color: #ffffff;
            --text-on-danger-color: #ffffff;
            --text-on-warning-color: #000000; /* Texto escuro para botões warning para contraste */
            
            --border-color: #495057; /* Cor das bordas mais escura */
            --hover-row-background: #343a40; 
            --border-radius: 0.375rem; /* Padrão Bootstrap */
            --box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            --box-shadow-lg: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }

        body {
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0; padding: 20px 0; /* Reduzido padding vertical */
            background-color: var(--background-color);
            color: var(--text-color); display: flex; flex-direction: column;
            align-items: center; min-height: 100vh; line-height: 1.6;
            font-size: 1rem; /* Tamanho de fonte base */
        }

        .container {
            width: 95%; /* Um pouco mais largo */
            max-width: 600px; /* Padrão para forms/dashboards simples */
            background-color: var(--container-bg-color); padding: 25px 30px; /* Ajustado padding */
            border-radius: var(--border-radius); box-shadow: var(--box-shadow-lg);
            margin-top: 20px; margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }
        .content-container { /* Para telas com tabelas e mais conteúdo */
             max-width: 1140px; /* Padrão Bootstrap .container-lg */
        }

        h1, h2, h3 {
            color: var(--text-color); text-align: center; margin-top: 0;
            margin-bottom: 1.5rem; font-weight: 500; /* Aumentado margin-bottom */
        }
        h1 { font-size: 2rem; }  /* Ajustado */
        h2 { font-size: 1.75rem; } /* Ajustado */
        h3 { font-size: 1.5rem; margin-bottom: 1rem; } /* Ajustado */

        .screen { display: none; } 
        .screen.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        button, .btn { /* Usar classe .btn para consistência */
            border: 1px solid transparent; 
            padding: 0.5rem 1rem; /* Ajustado padding */
            text-align: center; text-decoration: none; display: inline-block; 
            font-size: 1rem; font-weight: 400; line-height: 1.5;
            border-radius: var(--border-radius); cursor: pointer;
            transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            margin: 0.25rem; 
        }
        button:hover, .btn:hover { text-decoration: none; transform: translateY(-1px); box-shadow: var(--box-shadow); }
        button:active, .btn:active { transform: translateY(0); }
        button:focus-visible, .btn:focus-visible { outline: 2px solid var(--primary-color); outline-offset: 2px; }


        .btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); color: var(--text-on-primary-color); }
        .btn-primary:hover { background-color: var(--primary-color-darker); border-color: var(--primary-color-darker); }
        
        .btn-secondary { background-color: var(--secondary-color); border-color: var(--secondary-color); color: var(--text-on-secondary-color); }
        .btn-secondary:hover { background-color: var(--secondary-color-darker); border-color: var(--secondary-color-darker); }

        .btn-success { background-color: var(--success-color); border-color: var(--success-color); color: var(--text-on-success-color); }
        .btn-success:hover { background-color: var(--success-color-darker); border-color: var(--success-color-darker); }
        
        .btn-danger { background-color: var(--danger-color); border-color: var(--danger-color); color: var(--text-on-danger-color); }
        .btn-danger:hover { background-color: var(--danger-color-darker); border-color: var(--danger-color-darker); }

        .btn-warning { background-color: var(--warning-color); border-color: var(--warning-color); color: var(--text-on-warning-color); }
        .btn-warning:hover { background-color: var(--warning-color-darker); border-color: var(--warning-color-darker); }

        .dashboard-options { display: flex; flex-direction: column; align-items: stretch; gap: 1rem; padding: 1rem 0; }
        .dashboard-options .btn { padding: 0.75rem 1rem; font-size: 1.05rem; width: 100%; } /* Botões ocupam largura total */

        .card {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius); margin-bottom: 1.5rem; 
            box-shadow: none; /* Sombra mais sutil ou nenhuma, já que o fundo é escuro */
            background-color: var(--container-bg-color); /* Mantém o fundo do card */
        }
        .card-header {
            padding: 0.75rem 1.25rem; margin-bottom: 0; 
            background-color: rgba(0,0,0,0.03); /* Fundo sutil para header do card */
            border-bottom: 1px solid var(--border-color);
            border-top-left-radius: calc(var(--border-radius) - 1px);
            border-top-right-radius: calc(var(--border-radius) - 1px);
        }
        .card-header > * { margin: 0; font-size: 1.25rem; font-weight: 500; color: var(--text-color); text-align:left; } 
        .card-body { padding: 1.25rem; }
        
        table {
            width: 100%; border-collapse: collapse; margin-bottom: 1rem;
            background-color: transparent; /* Tabelas podem ter fundo transparente */
        }
        th, td {
            border: 1px solid var(--border-color); padding: 0.75rem; /* Ajustado padding */
            text-align: left; vertical-align: middle;
        }
        th {
            background-color: var(--header-bg-color); color: var(--text-color);
            font-weight: 500; border-bottom-width: 2px; 
        }
        tbody tr:nth-child(odd) { background-color: rgba(255,255,255,0.03); } /* Linhas alternadas sutis */
        tbody tr:hover { background-color: var(--hover-row-background); color: var(--text-color); }

        input[type="text"], input[type="number"], input[type="password"], input[type="email"], select, input[type="file"] {
            width: 100%; padding: 0.5rem 0.75rem; margin-bottom: 1rem; /* Ajustado padding e margin */
            border: 1px solid var(--input-border-color); border-radius: var(--border-radius);
            box-sizing: border-box; font-size: 1rem; line-height: 1.5;
            background-color: var(--input-bg-color); color: var(--text-color);
            background-clip: padding-box;
            transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
        }
        input[type="text"]::placeholder, input[type="number"]::placeholder, input[type="password"]::placeholder, input[type="email"]::placeholder {
            color: var(--text-muted-color); opacity: 1; /* Placeholders mais visíveis */
        }
        input[type="text"]:focus, input[type="number"]:focus, input[type="password"]:focus, input[type="email"]:focus, select:focus {
            border-color: var(--primary-color); outline: 0;
            box-shadow: 0 0 0 0.25rem rgba(var(--primary-color-rgb, 13, 110, 253), 0.25); /* Sombra de foco estilo Bootstrap */
        }
        /* Para o box-shadow acima, precisaremos de --primary-color-rgb. Vou definir no :root, ou usar um valor fixo. */
        /* Adicionando --primary-color-rgb ao :root */
        /* :root { --primary-color-rgb: 13,110,253; ... } */
        /* Usando valor fixo por enquanto para o box-shadow: */
        input[type="text"]:focus, input[type="number"]:focus, input[type="password"]:focus, input[type="email"]:focus, select:focus {
             box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); 
        }

        input[type="file"] { padding: 0.375rem 0.75rem; }
        select {
            appearance: none; 
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23f8f9fa' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 16px 12px;
        }

        .form-group { margin-bottom: 1rem; } 
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-muted-color); } 

        /* Seções e Ações com espaçamento mais consistente */
        .filter-controls, .product-management-form-fields, .xlsx-import-section, .actions-bar, .sub-form-section {
            margin-bottom: 1.5rem; padding: 1rem;
            background-color: rgba(0,0,0,0.03); /* Fundo sutil para agrupar */
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
        }
        .product-management-form-fields .form-group { margin-bottom: 0; } /* Remove margin extra dentro do flex */
        .filter-controls > div { flex: 1; min-width: 200px; }
        .filter-controls input, .filter-controls select { margin-bottom: 0; }
        .xlsx-import-section input[type="file"] { width: auto; margin-right: 0.5rem; }
        .actions-bar { text-align: center; padding: 1rem 0; }
        .actions-bar .btn { margin: 0 0.5rem; }

        #productManagementTable td:last-child, 
        #inventoryTable td:last-child,
        #adminEmpresasTable td:last-child { text-align: center; }
        #inventoryTable input[type="number"] { max-width: 80px; text-align: right; padding: 0.375rem 0.5rem; font-size: 0.9rem; }

        .back-button { margin-bottom: 1.5rem; display: inline-block; }
        .modal-overlay, .modal-content, .modal-actions, #passwordError, .loader, @keyframes spin { /* Mantidos como antes */ }
        .login-form { max-width: 400px; margin: 1.5rem auto; }
        .login-form .form-group { margin-bottom: 1rem; }
        .login-form button { width: 100%; padding: 0.75rem; font-size: 1.05em; }
        #loginErrorMessage { color: var(--danger-color); margin-top: 1rem; text-align: center; display: none; }
        .sub-form-section h4 { text-align: left; font-size: 1.1rem; color: var(--text-muted-color); margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem;}
        .table-actions button { margin: 0 2px; padding: 0.25rem 0.5rem; font-size: 0.85rem; } /* Botões menores para tabelas */

    </style>
</head>
<body>
    <div id="mainContainer" class="container"> 
        <div id="loadingIndicator" class="loader" style="display:none;"></div>

        <div id="screenLogin" class="screen active">
            <h1>Login no Sistema</h1>
            <div class="login-form card card-body"> <div class="form-group">
                    <label for="loginEmail">Email:</label>
                    <input type="email" id="loginEmail" placeholder="seuemail@exemplo.com">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Senha:</label>
                    <input type="password" id="loginPassword" placeholder="Sua senha">
                </div>
                <button class="btn btn-primary" onclick="handleLogin()">Entrar</button>
                <div id="loginErrorMessage"></div>
            </div>
        </div>

        <div id="screenAdminMasterDashboard" class="screen">
            <h2>Painel Admin Master</h2>
            <p style="text-align: center;">Bem-vindo, Admin Master!</p>
            <div class="dashboard-options">
                <button class="btn btn-primary" onclick="showAdminEmpresasScreen()">Gerenciar Empresas</button>
                <button class="btn btn-primary" onclick="showProductManagementScreen_AdminGlobal()">Gerenciar Produtos (Global)</button>
                <button class="btn btn-primary" onclick="showInventoryCountScreen_AdminGlobal()">Iniciar Contagem (Global)</button>
                <button class="btn btn-secondary" onclick="handleLogout()">Logout</button>
            </div>
        </div>

        <div id="screenEmpresaDashboard" class="screen">
            <h2 id="empresaDashboardTitle">Painel da Empresa</h2>
            <p style="text-align: center;">Bem-vindo, <span id="empresaUserName"></span>!</p>
            <div class="dashboard-options">
                <button class="btn btn-primary" onclick="showProductManagementScreen_Empresa()">Gerenciar Produtos da Empresa</button>
                <button class="btn btn-primary" onclick="showInventoryCountScreen_Empresa()">Iniciar Contagem da Empresa</button>
                <button class="btn btn-secondary" onclick="handleLogout()">Logout</button>
            </div>
        </div>
        
        <div id="screenAdminEmpresas" class="screen">
            <button class="btn btn-secondary back-button" onclick="showAdminMasterDashboardScreen()">&larr; Voltar ao Painel Admin</button>
            <h2>Gerenciar Empresas</h2>
            <div class="card">
                <div class="card-header"><h3>Adicionar Nova Empresa</h3></div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="adminNomeEmpresa">Nome da Empresa:</label>
                        <input type="text" id="adminNomeEmpresa" placeholder="Digite o nome da nova empresa">
                    </div>
                    <button class="btn btn-success" onclick="handleAdminAddEmpresa()">Adicionar Empresa</button>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><h3>Empresas Cadastradas</h3></div>
                <div class="card-body">
                    <table id="adminEmpresasTable">
                        <thead><tr><th>Nome da Empresa</th><th>Data Criação</th><th style="width: 250px;">Ações</th></tr></thead> <tbody id="adminEmpresasTableBody"></tbody>
                    </table>
                    <div id="adminAddUserToEmpresaSection" class="sub-form-section" style="display:none; margin-top: 1.5rem; padding-top: 1.5rem;">
                        <h4>Adicionar Usuário para <span id="selectedEmpresaNameForUser"></span></h4>
                        <input type="hidden" id="selectedEmpresaIdForUser">
                        <div class="form-group">
                            <label for="adminNewUserEmail">Email do Usuário:</label>
                            <input type="email" id="adminNewUserEmail" placeholder="email@dominio.com">
                        </div>
                        <div class="form-group">
                            <label for="adminNewUserPassword">Senha Inicial (mín. 6 caracteres):</label>
                            <input type="password" id="adminNewUserPassword" placeholder="Senha forte">
                        </div>
                        <button class="btn btn-success" onclick="handleAdminAddUserToEmpresa()">Criar Usuário para Empresa</button>
                        <button class="btn btn-secondary" onclick="cancelAddUserToEmpresa()">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="screenProductManagement" class="screen">
            <button class="btn btn-secondary back-button" id="productManagementBackButton">&larr; Voltar</button>
            <h2 id="productManagementTitle">Gerenciar Produtos</h2>
            <p id="productManagementContext" style="text-align:center; font-size:0.9em; color:var(--text-muted-color); margin-bottom: 1rem;"></p>
            
            <div class="card">
                <div class="card-header"><h3>Adicionar Novo Produto</h3></div>
                <div class="card-body">
                     <div class="product-management-form-fields">
                        <div class="form-group"><label for="prodCodigo">Código:</label><input type="text" id="prodCodigo"></div>
                        <div class="form-group"><label for="prodNome">Produto:</label><input type="text" id="prodNome"></div>
                        <div class="form-group"><label for="prodCategoria">Categoria:</label><input type="text" id="prodCategoria"></div>
                        <button class="btn btn-success" onclick="handleAddProduct()">Adicionar</button> </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><h3>Importar Produtos via XLSX</h3></div>
                <div class="card-body xlsx-import-section">
                    <input type="file" id="xlsxFile" accept=".xlsx, .xls"><button class="btn btn-info" onclick="handleXLSXImport()">Importar</button> <p>Colunas: 'codigo', 'produto', 'categoria'.</p>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><h3>Produtos Cadastrados</h3></div>
                <div class="card-body" style="padding:0;"><table id="productManagementTable"><thead><tr><th>Código</th><th>Produto</th><th>Categoria</th><th>Ação</th></tr></thead><tbody id="productManagementTableBody"></tbody></table></div>
            </div>
        </div>

        <div id="screenInventoryCount" class="screen">
            <button class="btn btn-secondary back-button" id="inventoryCountBackButton">&larr; Voltar</button>
            <h2 id="inventoryCountTitle">Balanço de Estoque</h2>
            <p id="inventoryCountContext" style="text-align:center; font-size:0.9em; color:var(--text-muted-color); margin-bottom: 1rem;"></p>

            <div class="actions-bar"><button class="btn btn-success" onclick="gerarArquivoTXT()">Gerar TXT</button><button class="btn btn-warning" onclick="clearAllQuantities()">Limpar Contagens</button></div>
            <div class="filter-controls card card-body"> <div><label for="pesquisaProduto">Produto:</label><input type="text" id="pesquisaProduto" placeholder="Nome do produto..."></div>
                <div><label for="pesquisaCodigo">Código:</label><input type="text" id="pesquisaCodigo" placeholder="Código..."></div>
                <div><label for="filtroCategoria">Categoria:</label><select id="filtroCategoria"><option value="">Todas</option></select></div>
            </div>
            <table><thead><tr><th>Código</th><th>Produto</th><th>Categoria</th><th>Quantidade</th></tr></thead><tbody id="inventoryTableBody"></tbody></table>
        </div>
    </div>
    <script>
        // --- CONFIGURAÇÃO SUPABASE ---
        const SUPABASE_URL = 'https://daeocsintrbdfqclvteg.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhZW9jc2ludHJiZGZxY2x2dGVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM0ODMxNDEsImV4cCI6MjA1OTA1OTE0MX0.BJ61kSxTDiEFway590hoTvVH4yu0FxLnjecqQsYdwK4';
        const { createClient } = supabase;
        const _supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- VARIÁVEIS GLOBAIS DE ESTADO DA APLICAÇÃO ---
        let produtosCache = []; 
        let quantidadesDigitadas = {}; 
        const ADMIN_MASTER_EMAIL = "matheus@mtech.com";
        const ADMIN_MASTER_PASSWORD = "260195@@";
        let currentUser = null; 

        // --- SELETORES DOM ---
        const mainContainer = document.getElementById('mainContainer');
        const screens = {
            login: document.getElementById('screenLogin'),
            adminMasterDashboard: document.getElementById('screenAdminMasterDashboard'),
            empresaDashboard: document.getElementById('screenEmpresaDashboard'),
            adminEmpresas: document.getElementById('screenAdminEmpresas'),
            productManagement: document.getElementById('screenProductManagement'),
            inventoryCount: document.getElementById('screenInventoryCount')
        };
        const loadingIndicator = document.getElementById('loadingIndicator');
        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');
        const loginErrorMessage = document.getElementById('loginErrorMessage');
        const adminNomeEmpresaInput = document.getElementById('adminNomeEmpresa');
        const adminEmpresasTableBody = document.getElementById('adminEmpresasTableBody');
        const addUserToEmpresaSection = document.getElementById('adminAddUserToEmpresaSection');
        const selectedEmpresaNameForUserSpan = document.getElementById('selectedEmpresaNameForUser');
        const selectedEmpresaIdForUserInput = document.getElementById('selectedEmpresaIdForUser');
        const adminNewUserEmailInput = document.getElementById('adminNewUserEmail');
        const adminNewUserPasswordInput = document.getElementById('adminNewUserPassword');
        const prodCodigoInput = document.getElementById('prodCodigo');
        const prodNomeInput = document.getElementById('prodNome');
        const prodCategoriaInput = document.getElementById('prodCategoria');
        const productManagementTableBody = document.getElementById('productManagementTableBody');
        const xlsxFileInput = document.getElementById('xlsxFile');
        const productManagementBackButton = document.getElementById('productManagementBackButton');
        const productManagementTitle = document.getElementById('productManagementTitle');
        const productManagementContext = document.getElementById('productManagementContext');
        const pesquisaProdutoInput = document.getElementById('pesquisaProduto');
        const pesquisaCodigoInput = document.getElementById('pesquisaCodigo');
        const filtroCategoriaSelect = document.getElementById('filtroCategoria');
        const inventoryTableBody = document.getElementById('inventoryTableBody');
        const inventoryCountBackButton = document.getElementById('inventoryCountBackButton');
        const inventoryCountTitle = document.getElementById('inventoryCountTitle');
        const inventoryCountContext = document.getElementById('inventoryCountContext');
        const empresaDashboardTitle = document.getElementById('empresaDashboardTitle');
        const empresaUserNameSpan = document.getElementById('empresaUserName');

        // --- FUNÇÕES UTILITÁRIAS DE UI ---
        function showLoader() { if (loadingIndicator) loadingIndicator.style.display = 'block'; }
        function hideLoader() { if (loadingIndicator) loadingIndicator.style.display = 'none'; }

        function showScreen(screenId, screenConfig = {}) {
            hideLoader();
            Object.values(screens).forEach(screen => screen && screen.classList.remove('active'));
            
            if (screens[screenId]) {
                screens[screenId].classList.add('active');
                if (['adminEmpresas', 'productManagement', 'inventoryCount'].includes(screenId)) {
                    mainContainer.classList.add('content-container');
                } else {
                    mainContainer.classList.remove('content-container');
                }

                // Configurações dinâmicas da tela
                if (screenId === 'productManagement') {
                    productManagementTitle.textContent = screenConfig.title || 'Gerenciar Produtos';
                    productManagementContext.textContent = screenConfig.context || '';
                    productManagementBackButton.onclick = screenConfig.backAction || (() => showScreen(currentUser?.role === 'admin_master' ? 'adminMasterDashboard' : 'empresaDashboard'));
                } else if (screenId === 'inventoryCount') {
                    inventoryCountTitle.textContent = screenConfig.title || 'Balanço de Estoque';
                    inventoryCountContext.textContent = screenConfig.context || '';
                    inventoryCountBackButton.onclick = screenConfig.backAction || (() => showScreen(currentUser?.role === 'admin_master' ? 'adminMasterDashboard' : 'empresaDashboard'));
                } else if (screenId === 'empresaDashboard' && currentUser) {
                    empresaDashboardTitle.textContent = `Painel: ${currentUser.empresa_nome || 'Minha Empresa'}`;
                    empresaUserNameSpan.textContent = currentUser.email;
                }
            } else {
                console.error("Tela não encontrada:", screenId);
                showScreen('login'); // Fallback
            }
            window.scrollTo(0,0); 
        }
        
        // --- LÓGICA DE LOGIN E LOGOUT ---
        async function handleLogin() {
            const email = loginEmailInput.value.trim();
            const password = loginPasswordInput.value.trim();
            loginErrorMessage.textContent = ""; loginErrorMessage.style.display = "none";

            if (!email || !password) {
                loginErrorMessage.textContent = "Preencha email e senha."; loginErrorMessage.style.display = "block"; return;
            }
            showLoader();
            if (email === ADMIN_MASTER_EMAIL && password === ADMIN_MASTER_PASSWORD) {
                currentUser = { email: ADMIN_MASTER_EMAIL, role: 'admin_master' };
                showAdminMasterDashboardScreen();
            } else {
                try {
                    const { data, error } = await _supabaseClient.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                    if (data.user && data.user.app_metadata?.role === 'empresa_user' && data.user.app_metadata?.empresa_id) {
                        currentUser = { 
                            id: data.user.id, email: data.user.email, role: 'empresa_user', 
                            empresa_id: data.user.app_metadata.empresa_id,
                            empresa_nome: data.user.app_metadata.empresa_nome || 'Empresa Associada'
                        };
                        await showEmpresaDashboardScreen();
                    } else {
                        throw new Error("Conta de usuário inválida ou sem permissões de empresa.");
                    }
                } catch (e) {
                    console.error("Erro no login (Supabase):", e);
                    loginErrorMessage.textContent = e.message || "Email ou senha inválidos."; 
                    loginErrorMessage.style.display = "block";
                    if (currentUser) await _supabaseClient.auth.signOut(); // Garante logout se algo deu errado no meio
                    currentUser = null;
                }
            }
            hideLoader();
        }

        async function handleLogout() {
            showLoader();
            if (currentUser && currentUser.role !== 'admin_master') {
                await _supabaseClient.auth.signOut();
            }
            currentUser = null;
            loginEmailInput.value = ""; loginPasswordInput.value = "";
            showScreen('login');
            hideLoader();
        }

        // --- TELAS DE PAINEL ---
        function showAdminMasterDashboardScreen() { showScreen('adminMasterDashboard'); }
        async function showEmpresaDashboardScreen() { 
             // A personalização do título e nome de usuário é feita em showScreen agora
            showScreen('empresaDashboard');
        }
        
        // --- GERENCIAMENTO DE EMPRESAS (ADMIN MASTER) ---
        async function showAdminEmpresasScreen() {
            if (!currentUser || currentUser.role !== 'admin_master') { handleLogout(); return; }
            showLoader();
            addUserToEmpresaSection.style.display = 'none';
            await fetchAndRenderEmpresas(); 
            showScreen('adminEmpresas'); 
        }

        async function fetchAndRenderEmpresas() {
            if (!adminEmpresasTableBody) return;
            adminEmpresasTableBody.innerHTML = '<tr><td colspan="3">Carregando...</td></tr>';
            try {
                const { data: empresas, error } = await _supabaseClient.from('empresas').select('*').order('nome_empresa');
                if (error) throw error;
                adminEmpresasTableBody.innerHTML = ""; 
                if (empresas && empresas.length > 0) {
                    empresas.forEach(empresa => {
                        const row = adminEmpresasTableBody.insertRow();
                        row.insertCell().textContent = empresa.nome_empresa;
                        row.insertCell().textContent = new Date(empresa.created_at).toLocaleDateString('pt-BR');
                        const actionsCell = row.insertCell();
                        const btnAddUser = document.createElement('button');
                        btnAddUser.textContent = 'Adicionar Usuário';
                        btnAddUser.className = 'btn btn-secondary table-actions'; // Estilo para botões em tabela
                        btnAddUser.onclick = () => showAddUserToEmpresaForm(empresa.id, empresa.nome_empresa);
                        actionsCell.appendChild(btnAddUser);
                        // TODO: Adicionar botões Editar/Excluir empresa
                    });
                } else {
                    adminEmpresasTableBody.innerHTML = '<tr><td colspan="3">Nenhuma empresa cadastrada.</td></tr>';
                }
            } catch (e) {
                console.error('Erro ao buscar empresas:', e);
                adminEmpresasTableBody.innerHTML = `<tr><td colspan="3" style="color:var(--danger-color);">Erro: ${e.message}</td></tr>`;
            }
        }

        async function handleAdminAddEmpresa() {
            const nomeEmpresa = adminNomeEmpresaInput.value.trim();
            if (!nomeEmpresa) { alert('Digite o nome da empresa.'); adminNomeEmpresaInput.focus(); return; }
            showLoader();
            try {
                const { data: existing } = await _supabaseClient.from('empresas').select('id').ilike('nome_empresa', nomeEmpresa).single();
                if (existing) { alert('Erro: Empresa já existe.'); hideLoader(); return; }
                const { error } = await _supabaseClient.from('empresas').insert([{ nome_empresa: nomeEmpresa }]);
                if (error) throw error;
                alert('Empresa adicionada!'); adminNomeEmpresaInput.value = ''; 
                await fetchAndRenderEmpresas(); 
            } catch (e) {
                console.error('Erro add empresa:', e); alert('Falha: ' + e.message);
            } finally { hideLoader(); }
        }

        function showAddUserToEmpresaForm(empresaId, nomeEmpresa) {
            selectedEmpresaIdForUserInput.value = empresaId;
            selectedEmpresaNameForUserSpan.textContent = nomeEmpresa;
            adminNewUserEmailInput.value = ""; adminNewUserPasswordInput.value = "";
            addUserToEmpresaSection.style.display = 'block'; adminNewUserEmailInput.focus();
        }
        function cancelAddUserToEmpresa() { // Nova função para cancelar
            addUserToEmpresaSection.style.display = 'none';
        }

        async function handleAdminAddUserToEmpresa() {
            const empresaId = selectedEmpresaIdForUserInput.value;
            const nomeEmpresa = selectedEmpresaNameForUserSpan.textContent;
            const email = adminNewUserEmailInput.value.trim();
            const password = adminNewUserPasswordInput.value.trim();

            if (!empresaId || !email || !password) { alert("Preencha email e senha."); return; }
            if (password.length < 6) { alert("Senha deve ter no mínimo 6 caracteres."); return; }

            showLoader();
            try {
                const { data: authData, error: signUpError } = await _supabaseClient.auth.signUp({
                    email, password,
                    options: { data: { empresa_id: empresaId, empresa_nome: nomeEmpresa, role: 'empresa_user' }}
                });
                if (signUpError) throw signUpError;
                if (authData.user) {
                    alert(`Usuário ${email} criado para ${nomeEmpresa}!`);
                } else if (authData && !authData.user && authData.session === null) {
                    alert(`Usuário ${email} registrado para ${nomeEmpresa}. Verifique o email para confirmação (se habilitado no Supabase).`);
                } else { throw new Error("Resposta inesperada ao criar usuário."); }
                adminNewUserEmailInput.value = ""; adminNewUserPasswordInput.value = "";
                addUserToEmpresaSection.style.display = 'none';
            } catch (e) {
                console.error("Erro criar usuário empresa:", e); alert(`Erro: ${e.message}`);
            } finally { hideLoader(); }
        }
        
        // --- GERENCIAMENTO DE PRODUTOS (CONTEXTUALIZADO) ---
        async function showProductManagementScreen_AdminGlobal() {
            if (!currentUser || currentUser.role !== 'admin_master') { handleLogout(); return; }
            await fetchProductsFromSupabase(); // Busca todos
            showScreen('productManagement', { title: 'Produtos (Admin Global)', context: 'Todos produtos do sistema.', backAction: showAdminMasterDashboardScreen });
        }
        async function showProductManagementScreen_Empresa() {
            if (!currentUser || !currentUser.empresa_id) { handleLogout(); return; }
            await fetchProductsFromSupabase(currentUser.empresa_id); 
            showScreen('productManagement', { title: `Produtos: ${currentUser.empresa_nome}`, context: 'Produtos da sua empresa.', backAction: showEmpresaDashboardScreen });
        }
        
        async function fetchProductsFromSupabase(empresaId = null) {
            showLoader();
            try {
                let query = _supabaseClient.from('produtos').select('*').order('produto');
                if (empresaId) {
                    query = query.eq('empresa_id', empresaId);
                } else if (currentUser?.role !== 'admin_master') {
                    produtosCache = []; hideLoader(); return; // Segurança: não admin só vê com empresaId
                }
                const { data, error } = await query;
                if (error) throw error;
                produtosCache = data || []; 
            } catch (e) {
                console.error('Erro buscar produtos:', e); alert('Falha: ' + e.message); produtosCache = [];
            } finally {
                renderProductManagementTable(); hideLoader(); 
            }
        }

        function renderProductManagementTable() {
            if (!productManagementTableBody) return;
            productManagementTableBody.innerHTML = ""; 
            if (produtosCache.length === 0) {
                productManagementTableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;padding:20px;">Nenhum produto.</td></tr>`;
                return;
            }
            [...produtosCache].sort((a,b) => String(a.codigo).localeCompare(String(b.codigo))).forEach(p => {
                const r = productManagementTableBody.insertRow();
                r.insertCell().textContent = p.codigo; r.insertCell().textContent = p.produto; r.insertCell().textContent = p.categoria;
                const ac = r.insertCell(); const btn = document.createElement('button');
                btn.textContent = "Remover"; btn.className = 'btn btn-danger table-actions';
                btn.onclick = () => handleRemoveProduct(p.id || p.codigo); ac.appendChild(btn);
            });
        }

        async function handleAddProduct() {
            const codigo = prodCodigoInput.value.trim(); const nome = prodNomeInput.value.trim();
            const categoria = prodCategoriaInput.value.trim();
            if (!codigo || !nome || !categoria) { alert("Preencha Código, Produto, Categoria."); return; }
            
            let empresaIdParaProduto = null;
            if (currentUser?.role === 'empresa_user') empresaIdParaProduto = currentUser.empresa_id;
            else if (currentUser?.role === 'admin_master') {
                // Admin: se empresa_id for NOT NULL no BD, esta inserção falhará sem um empresa_id.
                // Por agora, o admin adiciona produtos "sem empresa" (empresa_id = null).
                // No futuro, o admin master precisaria de um seletor de empresa aqui.
                if (!confirm("Admin: Adicionar produto sem empresa específica (global)? (Requer que empresa_id seja anulável no BD)")) { return; }
            } else { alert("Usuário não autorizado."); return; }

            showLoader();
            try {
                const { data, error } = await _supabaseClient.from('produtos')
                    .insert([{ codigo, produto: nome, categoria, empresa_id: empresaIdParaProduto }]).select(); 
                if (error) throw error;
                if (data && data[0]) produtosCache.push(data[0]);
                renderProductManagementTable(); 
                prodCodigoInput.value = ""; prodNomeInput.value = ""; prodCategoriaInput.value = "";
                prodCodigoInput.focus(); alert('Produto adicionado!');
            } catch (e) {
                console.error('Erro add produto:', e);
                if (e.message.includes('violates unique constraint') && e.message.includes('idx_produtos_empresa_id_codigo')) {
                    alert('Erro: Produto com este código já existe para esta empresa.');
                } else if (e.message.includes('null value in column "empresa_id" violates not-null constraint')) {
                    alert('Erro: Produto precisa ser associado a uma empresa.');
                } else { alert('Falha: ' + e.message); }
            } finally { hideLoader(); }
        }

        async function handleRemoveProduct(idOuCodigo) {
            const pIndex = produtosCache.findIndex(p => p.id === idOuCodigo || p.codigo === idOuCodigo);
            if (pIndex === -1) { alert("Produto não encontrado."); return; }
            const prod = produtosCache[pIndex];
            if (!confirm(`Remover "${prod.produto}"?`)) return;
            showLoader();
            try {
                let query = _supabaseClient.from('produtos').delete();
                if (prod.id) query = query.eq('id', prod.id); // Prioriza UUID se existir
                else { // Fallback para código, precisa de contexto da empresa se códigos não forem globalmente únicos
                    query = query.eq('codigo', prod.codigo);
                    if (prod.empresa_id) query = query.eq('empresa_id', prod.empresa_id);
                    else query = query.is('empresa_id', null); // Para produtos globais
                }
                const { error } = await query;
                if (error) throw error;
                produtosCache.splice(pIndex, 1);
                if (quantidadesDigitadas[prod.codigo + (prod.empresa_id ? '_' + prod.empresa_id : '')]) {
                    delete quantidadesDigitadas[prod.codigo + (prod.empresa_id ? '_' + prod.empresa_id : '')];
                    saveQuantities();
                }
                renderProductManagementTable(); alert('Produto removido!');
            } catch (e) {
                console.error('Erro remover produto:', e); alert('Falha: ' + e.message);
            } finally { hideLoader(); }
        }
        
        async function handleXLSXImport() {
            if (!xlsxFileInput?.files?.length) { alert("Selecione um arquivo XLSX."); return; }
            const file = xlsxFileInput.files[0];
            showLoader();
            const reader = new FileReader(); 
            reader.onload = async function(event) { 
                try {
                    const wb = XLSX.read(new Uint8Array(event.target.result), { type: 'array' }); 
                    const ws = wb.Sheets[wb.SheetNames[0]]; 
                    const jsonData = XLSX.utils.sheet_to_json(ws, { raw: false, defval:null });
                    if (jsonData.length === 0) { alert("XLSX vazio."); hideLoader(); return; }
                    
                    let empresaIdParaImport = null;
                    if (currentUser?.role === 'empresa_user') empresaIdParaImport = currentUser.empresa_id;
                    else if (currentUser?.role === 'admin_master') {
                        if (!confirm("Admin: Importar produtos sem empresa específica (global)? (Requer que empresa_id seja anulável no BD)")) { hideLoader(); return; }
                    } else { alert("Usuário não autorizado."); hideLoader(); return; }

                    const productsToInsert = jsonData.map(item => {
                        const codigo = item.codigo || item.Código; const produtoNome = item.produto || item.Produto; const categoria = item.categoria || item.Categoria;
                        if (codigo != null && produtoNome != null && categoria != null) {
                            return { codigo: String(codigo).trim(), produto: String(produtoNome).trim(), categoria: String(categoria).trim(), empresa_id: empresaIdParaImport };
                        } return null;
                    }).filter(Boolean);

                    if (productsToInsert.length === 0) { alert("Nenhum produto válido no XLSX."); hideLoader(); return; }
                    
                    // Para fazer upsert real com chave composta (empresa_id, codigo) seria complexo.
                    // Por agora, faremos insert. Se o índice unique (empresa_id, codigo) existir, ele impedirá duplicatas.
                    const { error } = await _supabaseClient.from('produtos').insert(productsToInsert);
                    if (error) throw error;
                    
                    await fetchProductsFromSupabase(empresaIdParaImport); 
                    alert(`${productsToInsert.length} produto(s) importado(s)!`);
                    if (xlsxFileInput) xlsxFileInput.value = ""; 
                } catch (e) {
                    console.error("Erro XLSX:", e); 
                    if (e.message.includes('violates unique constraint') && e.message.includes('idx_produtos_empresa_id_codigo')) {
                         alert('Erro: Um ou mais produtos no arquivo já existem com o mesmo código para esta empresa.');
                    } else if (e.message.includes('null value in column "empresa_id" violates not-null constraint')) {
                        alert('Erro: Os produtos importados precisam ser associados a uma empresa.');
                    } else { alert("Erro: " + e.message); }
                } finally { hideLoader(); }
            };
            reader.readAsArrayBuffer(file); 
        }

        // --- CONTAGEM DE ESTOQUE (CONTEXTUALIZADO) ---
        async function showInventoryCountScreen_AdminGlobal() {
            if (!currentUser || currentUser.role !== 'admin_master') { handleLogout(); return; }
            await fetchProductsFromSupabase(); 
            showScreen('inventoryCount', { title: 'Balanço (Admin Global)', context: 'Contagem sobre todos produtos.', backAction: showAdminMasterDashboardScreen });
            populateCategoryFilter(); filterInventoryProducts();
        }
        async function showInventoryCountScreen_Empresa() {
            if (!currentUser || !currentUser.empresa_id) { handleLogout(); return; }
            await fetchProductsFromSupabase(currentUser.empresa_id);
            showScreen('inventoryCount', { title: `Balanço: ${currentUser.empresa_nome}`, context: 'Contagem dos produtos da sua empresa.', backAction: showEmpresaDashboardScreen });
            populateCategoryFilter(); filterInventoryProducts();
        }
        // As funções auxiliares de contagem (populateCategoryFilter, displayInventoryProducts, etc.) usam 'produtosCache'
        // e a chave de 'quantidadesDigitadas' foi adaptada. O nome do arquivo TXT também.
        // (As implementações dessas funções foram ajustadas na seção anterior e mantidas aqui)
        function saveQuantities() { localStorage.setItem('balancoQuantities', JSON.stringify(quantidadesDigitadas)); }
        function loadQuantities() {
            const stored = localStorage.getItem('balancoQuantities');
            quantidadesDigitadas = stored ? JSON.parse(stored) : {};
        }
        
        // --- INICIALIZAÇÃO DA APLICAÇÃO ---
        window.onload = async () => { 
            showLoader(); 
            loadQuantities(); 
            
            const elLoginEmail = document.getElementById('loginEmail');
            const elLoginPassword = document.getElementById('loginPassword');
            if (elLoginEmail) elLoginEmail.addEventListener('keypress', e => { if (e.key === 'Enter' && elLoginPassword) elLoginPassword.focus(); });
            if (elLoginPassword) elLoginPassword.addEventListener('keypress', e => { if (e.key === 'Enter') handleLogin(); });
            
            const elPesquisaProduto = document.getElementById('pesquisaProduto');
            const elPesquisaCodigo = document.getElementById('pesquisaCodigo');
            const elFiltroCategoria = document.getElementById('filtroCategoria');
            if (elPesquisaProduto) elPesquisaProduto.addEventListener("input", filterInventoryProducts);
            if (elPesquisaCodigo) elPesquisaCodigo.addEventListener("input", filterInventoryProducts);
            if (elFiltroCategoria) elFiltroCategoria.addEventListener("change", filterInventoryProducts);
            
            // Verifica se há um usuário logado na sessão do Supabase
            const { data: { session } } = await _supabaseClient.auth.getSession();
            if (session?.user) {
                const user = session.user;
                if (user.app_metadata?.role === 'empresa_user' && user.app_metadata?.empresa_id) {
                    currentUser = { 
                        id: user.id, email: user.email, role: 'empresa_user', 
                        empresa_id: user.app_metadata.empresa_id,
                        empresa_nome: user.app_metadata.empresa_nome || 'Empresa Associada'
                    };
                    console.log("Sessão restaurada para Usuário de Empresa:", currentUser);
                    await showEmpresaDashboardScreen();
                } else {
                    // Usuário Supabase sem metadados corretos, ou é o admin master (que não usa sessão Supabase aqui)
                    // Para admin master, o login é sempre manual por enquanto.
                    // Se for um usuário Supabase inválido, desloga.
                    console.log("Sessão Supabase encontrada, mas usuário não é de empresa configurado. Deslogando.", user);
                    await _supabaseClient.auth.signOut();
                    showScreen('login');
                }
            } else {
                showScreen('login');
            }
            hideLoader(); 
        };
    </script>
</body>
</html>