<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Balanço de Estoque - v2.9.9 (Modificado v4 - Senha e TXT)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #007bff; 
            --primary-color-darker: #0069d9;
            --secondary-color: #6c757d; 
            --secondary-color-darker: #5a6268;
            --success-color: #198754; 
            --success-color-darker: #157347;
            --danger-color: #dc3545;  
            --danger-color-darker: #bb2d3b;
            --warning-color: #ffc107; 
            --warning-color-darker: #ffb300;
            --info-color: #0dcaf0;    
            --info-color-darker: #0aa9c6;
            --background-color: #f4f6f9;
            --container-bg-color: #ffffff;
            --card-bg-color: #ffffff;
            --header-bg-color: #f8f9fa;
            --input-bg-color: #ffffff;       
            --input-border-color: #ced4da;     
            --text-color: #212529;         
            --text-muted-color: #6c757d;     
            --text-on-primary-color: #ffffff;
            --text-on-secondary-color: #ffffff;
            --text-on-success-color: #ffffff;
            --text-on-danger-color: #ffffff;
            --text-on-warning-color: #000000;   
            --text-on-info-color: #000000;     
            --border-color: #dee2e6;         
            --hover-row-background: #e9ecef;
            --border-radius: 0.375rem; 
            --box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            --box-shadow-lg: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;margin:0;padding:20px 0;background-color:var(--background-color);color:var(--text-color);display:flex;flex-direction:column;align-items:center;min-height:100vh;line-height:1.5;font-size:1rem}
        .container{width:95%;max-width:600px;background-color:var(--container-bg-color);padding:25px 30px;border-radius:var(--border-radius);box-shadow:var(--box-shadow);margin-top:20px;margin-bottom:20px;border:1px solid var(--border-color)}
        .content-container{max-width:1140px}
        h1,h2,h3{color:var(--text-color);text-align:center;margin-top:0;margin-bottom:1.5rem;font-weight:500}
        h1{font-size:2rem}h2{font-size:1.75rem}h3{font-size:1.5rem;margin-bottom:1rem}
        .screen { display: none !important; opacity: 0 !important; visibility: hidden !important; min-height: 300px; } 
        .screen.active { display: block !important; opacity: 1 !important; visibility: visible !important; animation: fadeInView .4s ease-out; }
        @keyframes fadeInView{ from{opacity:0; transform: translateY(10px);} to{opacity:1; transform: translateY(0);} }
        button,.btn{border:1px solid transparent;padding:.5rem 1rem;text-align:center;text-decoration:none;display:inline-block;font-size:1rem;font-weight:400;line-height:1.5;border-radius:var(--border-radius);cursor:pointer;transition:color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;margin:.25rem}
        button:hover,.btn:hover{text-decoration:none;transform:translateY(-1px);box-shadow:var(--box-shadow-lg)}
        button:active,.btn:active{transform:translateY(0);}
        button:focus-visible,.btn:focus-visible{outline:2px solid var(--primary-color);outline-offset:2px}
        .btn-primary{background-color:var(--primary-color);border-color:var(--primary-color);color:var(--text-on-primary-color)}.btn-primary:hover{background-color:var(--primary-color-darker);border-color:var(--primary-color-darker)}
        .btn-secondary{background-color:var(--secondary-color);border-color:var(--secondary-color);color:var(--text-on-secondary-color)}.btn-secondary:hover{background-color:var(--secondary-color-darker);border-color:var(--secondary-color-darker)}
        .btn-success{background-color:var(--success-color);border-color:var(--success-color);color:var(--text-on-success-color)}.btn-success:hover{background-color:var(--success-color-darker);border-color:var(--success-color-darker)}
        .btn-danger{background-color:var(--danger-color);border-color:var(--danger-color);color:var(--text-on-danger-color)}.btn-danger:hover{background-color:var(--danger-color-darker);border-color:var(--danger-color-darker)}
        .btn-warning{background-color:var(--warning-color);border-color:var(--warning-color);color:var(--text-on-warning-color)}.btn-warning:hover{background-color:var(--warning-color-darker);border-color:var(--warning-color-darker)}
        .btn-info{background-color:var(--info-color);border-color:var(--info-color);color:var(--text-on-info-color);}.btn-info:hover{background-color:var(--info-color-darker);border-color:var(--info-color-darker);}
        .dashboard-options{display:flex;flex-direction:column;align-items:stretch;gap:1rem;padding:1rem 0}
        .dashboard-options .btn{padding:.75rem 1rem;font-size:1.05rem;width:100%}
        .card{border:1px solid var(--border-color);border-radius:var(--border-radius);margin-bottom:1.5rem;box-shadow:var(--box-shadow);background-color:var(--card-bg-color)}
        .card-header{padding:.75rem 1.25rem;margin-bottom:0;background-color:var(--header-bg-color);border-bottom:1px solid var(--border-color);border-top-left-radius:calc(var(--border-radius) - 1px);border-top-right-radius:calc(var(--border-radius) - 1px)}
        .card-header>*{margin:0;font-size:1.25rem;font-weight:500;color:var(--text-color);text-align:left}
        .card-body{padding:1.25rem}
        table{width:100%;border-collapse:collapse;margin-bottom:1rem;color:var(--text-color); }
        th,td{border:1px solid var(--border-color);padding:.75rem;text-align:left;vertical-align:middle}
        th{background-color:var(--header-bg-color);font-weight:500;border-bottom-width:2px} 
        tbody tr:nth-child(odd){background-color:var(--container-bg-color); } 
        tbody tr:nth-child(even){background-color: #f1f3f5; } 
        tbody tr:hover{background-color:var(--hover-row-background); }
        input[type=text],input[type=number],input[type=password],input[type=email],select,input[type=file]{width:100%;padding:.5rem .75rem;margin-bottom:1rem;border:1px solid var(--input-border-color);border-radius:var(--border-radius);box-sizing:border-box;font-size:1rem;line-height:1.5;background-color:var(--input-bg-color);color:var(--text-color);background-clip:padding-box;transition:border-color .15s ease-in-out,box-shadow .15s ease-in-out}
        input[type=text]::placeholder,input[type=number]::placeholder,input[type=password]::placeholder,input[type=email]::placeholder{color:var(--text-muted-color);opacity:1}
        input[type=text]:focus,input[type=number]:focus,input[type=password]:focus,input[type=email]:focus,select:focus{border-color:var(--primary-color);outline:0;box-shadow:0 0 0 .25rem rgba(13,110,253,.25)}
        input[type=file]{padding:.375rem .75rem}
        select{appearance:none;background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23212529' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");background-repeat:no-repeat;background-position:right .75rem center;background-size:16px 12px}
        .form-group{margin-bottom:1rem}
        .form-group label{display:block;margin-bottom:.5rem;font-weight:500;color:var(--text-color); }
        .filter-controls,.product-management-form-fields,.xlsx-import-section,.actions-bar,.sub-form-section{margin-bottom:1.5rem;padding:1rem;background-color:var(--card-bg-color);border:1px solid var(--border-color);border-radius:var(--border-radius)} 
        .product-management-form-fields .form-group{margin-bottom:0}
        .filter-controls>div{flex:1;min-width:200px}
        .filter-controls input,.filter-controls select{margin-bottom:0}
        .xlsx-import-section input[type=file]{width:auto;margin-right:.5rem}
        .actions-bar{text-align:center;padding:1rem 0; background-color: transparent; border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); }
        .actions-bar .btn{margin:0 .5rem}
        #productManagementTable td:last-child,#inventoryTable td:last-child,#adminEmpresasTable td:last-child, #colaboradoresTable td:last-child, #historicoContagensTable td:last-child, #adminCategoriasTable td:last-child {text-align:center} 
        #inventoryTable input[type=number]{max-width:80px;text-align:right;padding:.375rem .5rem;font-size:.9rem}
        .back-button{margin-bottom:1.5rem;display:inline-block}
        .modal-overlay { position: fixed !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; background-color: rgba(0,0,0,0.4) !important; display: flex !important; justify-content: center !important; align-items: center !important; z-index: 10000 !important; opacity: 0 !important; visibility: hidden !important; transition: opacity 0.2s ease, visibility 0.2s ease !important; }
        .modal-overlay.active { opacity: 1 !important; visibility: visible !important; }
        .modal-content { background-color: var(--container-bg-color); color: var(--text-color); padding: 20px 25px; border-radius: var(--border-radius); box-shadow: var(--box-shadow-lg); width: 90%; max-width: 500px; text-align: left; border: 1px solid var(--border-color); transform: translateY(-20px) scale(0.95); transition: transform 0.2s ease, opacity 0.2s ease; opacity: 0;}
        .modal-overlay.active .modal-content { transform: translateY(0) scale(1); opacity: 1;}
        .modal-content h4 { color: var(--text-color); margin-bottom: 1rem; font-size: 1.25rem; text-align: center;}
        .modal-content p { color: var(--text-muted-color); margin-bottom: 1rem; font-size: 0.95rem; } 
        .modal-actions { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem; }
        .login-form{max-width:400px;margin:1.5rem auto; padding: 2rem; background-color: var(--container-bg-color); border-radius: var(--border-radius); box-shadow: var(--box-shadow);}
        .login-form .form-group{margin-bottom:1rem}
        .login-form button{width:100%;padding:.75rem;font-size:1.05em}
        #loginErrorMessage{color:var(--danger-color);margin-top:1rem;text-align:center;display:none}
        .sub-form-section h4{text-align:left;font-size:1.1rem;color:var(--text-color);margin-bottom:1rem;border-bottom:1px solid var(--border-color);padding-bottom:.5rem}
        .table-actions button,.table-actions .btn{margin:0 2px;padding:.25rem .5rem;font-size:.85rem}
        .generated-password-display { margin-top: 10px; padding: 10px; background-color: #e9ecef; border: 1px dashed var(--border-color); border-radius: var(--border-radius); word-break: break-all; color: var(--text-color); font-family: monospace; text-align: center;}
        .password-change-form { max-width: 450px; margin: 1.5rem auto; }
        .form-inline-flex { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 1rem;}
        .form-inline-flex .form-group { flex: 1; margin-bottom: 0;}
        .form-inline-flex button { flex-shrink: 0; }
        #previewContagemTable { width: 100%; margin-top: 1rem; }
        #previewContagemTable th, #previewContagemTable td { font-size: 0.9rem; padding: 0.5rem; }
        .admin-context-selector { margin-bottom: 1.5rem; padding: 1rem; background-color: var(--header-bg-color); border-radius: var(--border-radius); }
        .admin-context-selector label { margin-right: 0.5rem; font-weight: 500;}
        .admin-context-selector select { display: inline-block; width: auto; min-width: 250px; margin-right: 10px; }
        .loader { border: 5px solid #e9ecef; border-top: 5px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        #adminManageLoginEmpresaContent { margin-top: 1rem; } /* Estilo adicionado */
        #adminManageLoginEmpresaContent p { margin-bottom: 0.5rem; }
        #adminManageLoginEmpresaContent .form-group { margin-top: 1rem; }
    </style>
</head>
<body>
    <div id="mainContainer" class="container"> 
        <div id="loadingIndicator" class="loader" style="display:none;"></div>

        <div id="screenLogin" class="screen active">
            <h1>Login no Sistema de Balanço</h1>
            <div class="login-form card card-body">
                <div class="form-group"><label for="loginEmail">Email:</label><input type="email" id="loginEmail" placeholder="seuemail@exemplo.com" autocomplete="email"></div>
                <div class="form-group"><label for="loginPassword">Senha:</label><input type="password" id="loginPassword" placeholder="Sua senha" autocomplete="current-password"></div>
                <button class="btn btn-primary" id="loginButton">Entrar</button> 
                <div id="loginErrorMessage"></div>
            </div>
        </div>

        <div id="screenAdminMasterDashboard" class="screen">
            <h2>Painel Admin Master</h2>
            <p style="text-align: center;">Bem-vindo, <span id="adminMasterNameDisplay">Admin Master</span>!</p>
            <div class="dashboard-options">
                <button class="btn btn-primary" id="btnAdminGerenciarEmpresas">Gerenciar Empresas & Seus Logins</button>
                <button class="btn btn-primary" id="btnAdminGerenciarCategorias">Gerenciar Categorias</button> 
                <button class="btn btn-primary" id="btnAdminGerenciarProdutos">Gerenciar Produtos</button>
                <button class="btn btn-primary" id="btnAdminContagemEstoque">Contagem de Estoque</button>
                <button class="btn btn-info" id="btnAdminHistoricoContagens">Histórico de Contagens (Admin)</button>
                <button class="btn btn-secondary" id="btnLogoutAdmin">Logout</button>
            </div>
        </div>

        <div id="screenEmpresaDashboard" class="screen">
            <h2 id="empresaDashboardTitle">Painel da Empresa</h2>
            <p style="text-align: center;">Logado como: <span id="empresaUserName"></span></p>
            <div class="dashboard-options">
                <button class="btn btn-primary" id="btnEmpresaGerenciarColaboradores">Gerenciar Colaboradores</button>
                <button class="btn btn-primary" id="btnEmpresaGerenciarProdutos">Gerenciar Produtos da Empresa</button>
                <button class="btn btn-primary" id="btnEmpresaContagemEstoque">Iniciar Contagem da Empresa</button>
                <button class="btn btn-info" id="btnEmpresaHistoricoContagens">Ver Histórico de Contagens</button>
                <button class="btn btn-info" id="btnEmpresaAlterarSenha">Alterar Senha da Empresa</button> 
                <button class="btn btn-secondary" id="btnLogoutEmpresa">Logout</button>
            </div>
        </div>
        
        <div id="screenAdminCategorias" class="screen">
            <button class="btn btn-secondary back-button" id="btnAdminCategoriasVoltar"> &larr; Painel Admin</button>
            <h2>Gerenciar Categorias de Produtos</h2>
            <div class="card">
                <div class="card-header"><h3>Adicionar Nova Categoria</h3></div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="adminCategoriaEmpresaSelect">Associar Categoria a:</label>
                        <select id="adminCategoriaEmpresaSelect">
                            <option value="">-- Categoria Global (para todas empresas) --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="adminNomeCategoria">Nome da Nova Categoria:</label>
                        <input type="text" id="adminNomeCategoria" placeholder="Ex: Bolos, Salgados, Bebidas">
                    </div>
                    <button class="btn btn-success" id="btnAdminAddCategoria">Adicionar Categoria</button>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><h3>Categorias Cadastradas</h3></div>
                <div class="card-body">
                    <table id="adminCategoriasTable">
                        <thead><tr><th>Nome da Categoria</th><th>Escopo (Empresa / Global)</th><th>Criação</th><th>Ações</th></tr></thead>
                        <tbody id="adminCategoriasTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="screenAdminEmpresas" class="screen">
             <button class="btn btn-secondary back-button" id="btnAdminEmpresasVoltar">&larr; Painel Admin</button>
            <h2>Gerenciar Empresas e Seus Logins Principais</h2>
            <div class="card"><div class="card-header"><h3>Adicionar Nova Empresa</h3></div><div class="card-body"><div class="form-group"><label for="adminNomeEmpresa">Nome da Empresa:</label><input type="text" id="adminNomeEmpresa" placeholder="Nome da nova empresa"></div><button class="btn btn-success" id="btnAdminAddEmpresa">Adicionar Empresa</button></div></div>
            <div class="card"><div class="card-header"><h3>Empresas Cadastradas</h3></div><div class="card-body"><table id="adminEmpresasTable"><thead><tr><th>Nome</th><th>Criação</th><th style="min-width: 280px;">Ações da Empresa</th></tr></thead><tbody id="adminEmpresasTableBody"></tbody></table></div></div>
            
            <div id="adminManageLoginEmpresaSection" class="card" style="display:none; margin-top: 2rem;">
                <div class="card-header"><h3 id="adminManageLoginEmpresaTitle">Gerenciar Login para Empresa</h3></div>
                <div class="card-body">
                    <input type="hidden" id="selectedEmpresaIdForLoginManage">
                    <input type="hidden" id="selectedEmpresaUserIdForLoginManage"> 
                    
                    <div id="adminManageLoginEmpresaContent">
                        {/* Conteúdo será populado pelo JavaScript: formulário de criação OU info do login existente + botão reset */}
                    </div>
                    <div id="manageLoginEmpresaMessage" class="generated-password-display" style="display:none; margin-top:1rem;"></div>
                </div>
                <button class="btn btn-secondary" id="btnCancelarManageLoginEmpresa" style="margin: 0 1.25rem 1.25rem;">Cancelar</button>
            </div>

        </div>
        
        <div id="screenEmpresaColaboradores" class="screen">
            <button class="btn btn-secondary back-button" id="colaboradoresBackButton">&larr; Voltar</button> 
            <h2>Gerenciar Colaboradores (<span id="colaboradoresEmpresaNome"></span>)</h2>
            <div class="card"><div class="card-header"><h3>Adicionar Novo Colaborador</h3></div><div class="card-body"><div class="form-inline-flex"><div class="form-group"><label for="colaboradorNome">Nome do Colaborador:</label><input type="text" id="colaboradorNome" placeholder="Nome completo"></div><button class="btn btn-success" id="btnAddColaborador">Adicionar</button></div></div></div>
            <div class="card"><div class="card-header"><h3>Colaboradores Cadastrados</h3></div><div class="card-body"><table id="colaboradoresTable"><thead><tr><th>Nome</th><th>Ativo</th><th>Criação</th><th style="min-width: 220px;">Ações</th></tr></thead><tbody id="colaboradoresTableBody"></tbody></table></div></div>
        </div>
        
        <div id="screenChangePassword" class="screen">
             <button class="btn btn-secondary back-button" id="changePasswordBackButton">&larr; Voltar ao Painel</button>
            <h2>Alterar Senha</h2>
            <div class="password-change-form card card-body">
                <p>Alterando senha para o login: <strong id="changingPasswordForUserDisplay"></strong></p>
                <div class="form-group" id="currentPasswordGroup" style="display:none;"><label for="currentPasswordInput">Senha Atual:</label><input type="password" id="currentPasswordInput"></div>
                <div class="form-group"><label for="newPasswordInput">Nova Senha (mín. 6 caracteres):</label><input type="password" id="newPasswordInput" placeholder="Digite a nova senha"></div>
                <div class="form-group"><label for="confirmNewPasswordInput">Confirmar Nova Senha:</label><input type="password" id="confirmNewPasswordInput" placeholder="Confirme a nova senha"></div>
                <button class="btn btn-primary" id="btnSalvarNovaSenha">Salvar Nova Senha</button>
                <div id="changePasswordMessage" style="margin-top:1rem; text-align:center;"></div>
            </div>
        </div>

        <div id="screenHistoricoContagens" class="screen">
            <button class="btn btn-secondary back-button" id="historicoBackButton">&larr; Voltar ao Painel</button> 
            <h2 id="historicoTitle">Histórico de Contagens (<span id="historicoEmpresaNomeSpan"></span>)</h2> 
            <div id="adminHistoricoEmpresaSelectorContainer" class="admin-context-selector" style="display:none;">
                <label for="adminHistoricoEmpresaSelect">Ver Histórico Para Empresa:</label>
                <select id="adminHistoricoEmpresaSelect"><option value="ALL_EMPRESAS">-- Todas as Empresas --</option></select>
            </div>
            <p id="historicoContext" style="text-align:center; font-size:0.9em; color:var(--text-muted-color); margin-bottom: 1rem;"></p>
            <div class="card"><div class="card-header"><h3>Registros de Contagem</h3></div><div class="card-body" style="padding:0;"><table id="historicoContagensTable"><thead><tr><th id="colEmpresaHistorico" style="display:none;">Empresa</th><th>Data</th><th>Colaborador</th><th>Itens Contados</th><th>Ações</th></tr></thead><tbody id="historicoContagensTableBody"></tbody></table></div></div>
        </div>

        <div id="screenProductManagement" class="screen">
            <button class="btn btn-secondary back-button" id="productManagementBackButton">&larr; Voltar</button>
            <h2 id="productManagementTitle">Gerenciar Produtos</h2>
            <div id="adminProdutoEmpresaSelectorContainer" class="admin-context-selector" style="display:none;">
                <label for="adminProdutoEmpresaSelect">Gerenciar Produtos Para Empresa:</label>
                <select id="adminProdutoEmpresaSelect"><option value="">-- Produtos Globais (Sem Empresa) --</option></select>
            </div>
            <p id="productManagementContext" style="text-align:center; font-size:0.9em; color:var(--text-muted-color); margin-bottom: 1rem;"></p>
            <div class="card"><div class="card-header"><h3>Adicionar Novo Produto</h3></div><div class="card-body">
                <div class="product-management-form-fields">
                    <div class="form-group"><label for="prodCodigo">Código:</label><input type="text" id="prodCodigo"></div>
                    <div class="form-group"><label for="prodNome">Produto:</label><input type="text" id="prodNome"></div>
                    <div class="form-group">
                        <label for="prodCategoriaSelect">Categoria:</label>
                        <select id="prodCategoriaSelect"><option value="">-- Sem Categoria --</option></select>
                    </div>
                    <button class="btn btn-success" id="btnAddProduct">Adicionar</button>
                </div>
            </div></div>
            <div class="card"><div class="card-header"><h3>Importar Produtos via XLSX</h3></div><div class="card-body xlsx-import-section"><input type="file" id="xlsxFile" accept=".xlsx, .xls"><button class="btn btn-info" id="btnImportXLSX">Importar</button><p>Colunas: 'codigo', 'produto', 'categoria'. Categoria vazia = Sem Categoria.</p></div></div>
            <div class="card"><div class="card-header"><h3>Produtos Cadastrados</h3></div><div class="card-body" style="padding:0;"><table id="productManagementTable"><thead><tr><th>Código</th><th>Produto</th><th>Categoria</th><th>Ação</th></tr></thead><tbody id="productManagementTableBody"></tbody></table></div></div>
        </div>

        <div id="screenInventoryCount" class="screen">
            <button class="btn btn-secondary back-button" id="inventoryCountBackButton">&larr; Voltar</button>
            <h2 id="inventoryCountTitle">Balanço de Estoque</h2>
            <div id="adminContagemEmpresaSelectorContainer" class="admin-context-selector" style="display:none;">
                <label for="adminContagemEmpresaSelect">Realizar Contagem Para Empresa:</label>
                <select id="adminContagemEmpresaSelect"><option value="">-- Contagem Global (Produtos Sem Empresa) --</option></select>
            </div>
            <p id="inventoryCountContext" style="text-align:center; font-size:0.9em; color:var(--text-muted-color); margin-bottom: 1rem;"></p>
            <div class="card card-body">
                <div class="form-group"> 
                    <label for="selectColaboradorContagem">Contagem realizada por:</label>
                    <select id="selectColaboradorContagem" style="margin-bottom: 1rem;"></select>
                </div>
                <div class="actions-bar" style="border:none; padding-bottom:0;">
                     <button class="btn btn-info" id="btnShowPreviewContagem">Ver Resumo</button> 
                     <button class="btn btn-success" id="btnGerarTXT">Gerar TXT & Salvar Histórico</button>
                     <button class="btn btn-warning" id="btnClearAllQuantities">Limpar Quantidades</button>
                </div>
            </div>
            <div class="filter-controls card card-body"><div><label for="pesquisaProduto">Produto:</label><input type="text" id="pesquisaProduto" placeholder="Nome..."></div><div><label for="pesquisaCodigo">Código:</label><input type="text" id="pesquisaCodigo" placeholder="Código..."></div><div><label for="filtroCategoria">Categoria:</label><select id="filtroCategoria"><option value="">Todas</option></select></div></div>
            <table><thead><tr><th>Código</th><th>Produto</th><th>Categoria</th><th>Quantidade</th></tr></thead><tbody id="inventoryTableBody"></tbody></table>
        </div>

        <div id="modalPreviewContagem" class="modal-overlay">
            <div class="modal-content" style="max-width: 700px; text-align:left;">
                <h4>Resumo da Contagem Atual</h4>
                <div id="previewContagemTableContainer" style="max-height: 400px; overflow-y:auto;">
                    <table id="previewContagemTable">
                        <thead><tr><th>Código</th><th>Produto</th><th>Categoria</th><th>Qtd. Digitada</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="modal-actions" style="margin-top: 1.5rem;">
                    <button class="btn btn-secondary" id="btnClosePreviewModal">Fechar</button>
                </div>
            </div>
        </div>
        <div id="modalDetalhesContagem" class="modal-overlay">
            <div class="modal-content" style="max-width: 600px; text-align:left;">
                <h4>Detalhes da Contagem</h4>
                <div id="detalhesContagemConteudo"></div>
                <div class="modal-actions" style="margin-top:1.5rem;">
                    <button class="btn btn-secondary" id="btnCloseDetalhesModal">Fechar</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        console.log("SCRIPT START - v2.9.9 MODIFICADO v4");
        // --- CONFIGURAÇÃO SUPABASE ---
        const SUPABASE_URL = 'https://daeocsintrbdfqclvteg.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhZW9jc2ludHJiZGZxY2x2dGVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM0ODMxNDEsImV4cCI6MjA1OTA1OTE0MX0.BJ61kSxTDiEFway590hoTvVH4yu0FxLnjecqQsYdwK4';
        const { createClient } = supabase;
        const _supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- VARIÁVEIS GLOBAIS ---
        let produtosCache = []; 
        let categoriasCache = []; 
        let empresasCache = []; 
        let colaboradoresCache = []; 
        let quantidadesDigitadas = {}; 
        const ADMIN_MASTER_EMAIL = "matheus@mtech.com"; 
        let currentUser = null; 
        let adminSelectedEmpresaId = null; 
        let adminSelectedEmpresaParaCategoriaId = null;

        // --- SELETORES DOM ---
        let mainContainer, screens = {}, loadingIndicator, loginEmailInput, loginPasswordInput, loginErrorMessage,
            adminMasterNameDisplay, adminNomeEmpresaInput, adminEmpresasTableBody, 
            adminManageLoginEmpresaSection, adminManageLoginEmpresaTitle, selectedEmpresaIdForLoginManage, 
            selectedEmpresaUserIdForLoginManage, // Adicionado
            adminManageLoginEmpresaContent, manageLoginEmpresaMessage,
            adminCategoriaEmpresaSelect, adminNomeCategoriaInput, adminCategoriasTableBody, 
            colaboradoresEmpresaNomeSpan, colaboradorNomeInput, colaboradoresTableBody, 
            currentPasswordInput, newPasswordInput, confirmNewPasswordInput, changePasswordMessage, 
            changePasswordBackButton, changingPasswordForUserDisplay, currentPasswordGroup,
            historicoEmpresaNomeSpan, historicoContagensTableBody, modalDetalhesContagem, detalhesContagemConteudo,
            productManagementBackButton, productManagementTitle, productManagementContext,
            adminProdutoEmpresaSelectorContainer, adminProdutoEmpresaSelect, prodCodigoInput, prodNomeInput,
            prodCategoriaSelect, productManagementTableBody, xlsxFileInput, inventoryCountBackButton,
            inventoryCountTitle, inventoryCountContext, adminContagemEmpresaSelectorContainer,
            adminContagemEmpresaSelect, selectColaboradorContagem, pesquisaProdutoInput, pesquisaCodigoInput,
            filtroCategoriaSelect, inventoryTableBody, modalPreviewContagem, previewContagemTableContainer,
            empresaDashboardTitle, empresaUserNameSpan,
            adminHistoricoEmpresaSelectorContainer, adminHistoricoEmpresaSelect, historicoBackButton, historicoTitle, historicoContext, colEmpresaHistorico;

        function initializeDOMSelectors() {
            console.log("initializeDOMSelectors v2.9.9 chamado");
            mainContainer = document.getElementById('mainContainer');
            screens = {
                login: document.getElementById('screenLogin'),
                adminMasterDashboard: document.getElementById('screenAdminMasterDashboard'),
                empresaDashboard: document.getElementById('screenEmpresaDashboard'),
                adminEmpresas: document.getElementById('screenAdminEmpresas'),
                adminCategorias: document.getElementById('screenAdminCategorias'), 
                empresaColaboradores: document.getElementById('screenEmpresaColaboradores'),
                changePassword: document.getElementById('screenChangePassword'), 
                historicoContagens: document.getElementById('screenHistoricoContagens'),
                productManagement: document.getElementById('screenProductManagement'),
                inventoryCount: document.getElementById('screenInventoryCount')
            };
            loadingIndicator = document.getElementById('loadingIndicator');
            loginEmailInput = document.getElementById('loginEmail');
            loginPasswordInput = document.getElementById('loginPassword');
            loginErrorMessage = document.getElementById('loginErrorMessage');
            
            function safeGetElementById(id, context = document) {
                const el = context.getElementById(id);
                if (!el) console.warn(`Elemento com ID '${id}' NÃO encontrado.`);
                return el;
            }

            Object.keys(screens).forEach(key => {
                if (!screens[key]) console.warn(`Elemento de tela screens.${key} (ID: ${key}) NÃO encontrado na atribuição inicial.`);
            });
            
            adminMasterNameDisplay = safeGetElementById('adminMasterNameDisplay');
            adminNomeEmpresaInput = safeGetElementById('adminNomeEmpresa');
            adminEmpresasTableBody = safeGetElementById('adminEmpresasTableBody');
            
            adminManageLoginEmpresaSection = safeGetElementById('adminManageLoginEmpresaSection');
            adminManageLoginEmpresaTitle = safeGetElementById('adminManageLoginEmpresaTitle');
            selectedEmpresaIdForLoginManage = safeGetElementById('selectedEmpresaIdForLoginManage'); // Este era o 'selectedEmpresaIdForLogin'
            selectedEmpresaUserIdForLoginManage = safeGetElementById('selectedEmpresaUserIdForLoginManage'); // Novo para guardar o user_id
            adminManageLoginEmpresaContent = safeGetElementById('adminManageLoginEmpresaContent');
            manageLoginEmpresaMessage = safeGetElementById('manageLoginEmpresaMessage');

            adminCategoriaEmpresaSelect = safeGetElementById('adminCategoriaEmpresaSelect');
            adminNomeCategoriaInput = safeGetElementById('adminNomeCategoria');
            adminCategoriasTableBody = safeGetElementById('adminCategoriasTableBody');
            colaboradoresEmpresaNomeSpan = safeGetElementById('colaboradoresEmpresaNome');
            colaboradorNomeInput = safeGetElementById('colaboradorNome');
            colaboradoresTableBody = safeGetElementById('colaboradoresTableBody');
            currentPasswordInput = safeGetElementById('currentPasswordInput');
            newPasswordInput = safeGetElementById('newPasswordInput');
            confirmNewPasswordInput = safeGetElementById('confirmNewPasswordInput');
            changePasswordMessage = safeGetElementById('changePasswordMessage');
            changePasswordBackButton = safeGetElementById('changePasswordBackButton');
            changingPasswordForUserDisplay = safeGetElementById('changingPasswordForUserDisplay');
            currentPasswordGroup = safeGetElementById('currentPasswordGroup');
            historicoEmpresaNomeSpan = safeGetElementById('historicoEmpresaNomeSpan'); 
            historicoContagensTableBody = safeGetElementById('historicoContagensTableBody');
            modalDetalhesContagem = safeGetElementById('modalDetalhesContagem');
            detalhesContagemConteudo = safeGetElementById('detalhesContagemConteudo');
            adminHistoricoEmpresaSelectorContainer = safeGetElementById('adminHistoricoEmpresaSelectorContainer');
            adminHistoricoEmpresaSelect = safeGetElementById('adminHistoricoEmpresaSelect');
            historicoBackButton = safeGetElementById('historicoBackButton'); 
            historicoTitle = safeGetElementById('historicoTitle'); 
            historicoContext = safeGetElementById('historicoContext'); 
            colEmpresaHistorico = safeGetElementById('colEmpresaHistorico'); 
            productManagementBackButton = safeGetElementById('productManagementBackButton');
            productManagementTitle = safeGetElementById('productManagementTitle');
            productManagementContext = safeGetElementById('productManagementContext');
            adminProdutoEmpresaSelectorContainer = safeGetElementById('adminProdutoEmpresaSelectorContainer');
            adminProdutoEmpresaSelect = safeGetElementById('adminProdutoEmpresaSelect');
            prodCodigoInput = safeGetElementById('prodCodigo');
            prodNomeInput = safeGetElementById('prodNome');
            prodCategoriaSelect = safeGetElementById('prodCategoriaSelect'); 
            productManagementTableBody = safeGetElementById('productManagementTableBody');
            xlsxFileInput = safeGetElementById('xlsxFile');
            inventoryCountBackButton = safeGetElementById('inventoryCountBackButton');
            inventoryCountTitle = safeGetElementById('inventoryCountTitle');
            inventoryCountContext = safeGetElementById('inventoryCountContext');
            adminContagemEmpresaSelectorContainer = safeGetElementById('adminContagemEmpresaSelectorContainer');
            adminContagemEmpresaSelect = safeGetElementById('adminContagemEmpresaSelect');
            selectColaboradorContagem = safeGetElementById('selectColaboradorContagem');
            pesquisaProdutoInput = safeGetElementById('pesquisaProduto');
            pesquisaCodigoInput = safeGetElementById('pesquisaCodigo');
            filtroCategoriaSelect = document.getElementById('filtroCategoria'); 
            inventoryTableBody = safeGetElementById('inventoryTableBody');
            modalPreviewContagem = safeGetElementById('modalPreviewContagem'); 
            previewContagemTableContainer = safeGetElementById('previewContagemTableContainer'); 
            empresaDashboardTitle = safeGetElementById('empresaDashboardTitle');
            empresaUserNameSpan = safeGetElementById('empresaUserName');
            console.log("DOM Selectors initialization complete.");
        }

        function saveQuantities() { try { localStorage.setItem('balancoQuantities_v2.9.9', JSON.stringify(quantidadesDigitadas)); } catch (e) { console.error("Erro ao salvar quantidades no localStorage:", e); }}
        function loadQuantities() { try { const stored = localStorage.getItem('balancoQuantities_v2.9.9'); quantidadesDigitadas = stored ? JSON.parse(stored) : {}; } catch (e) { console.error("Erro ao carregar quantidades:", e); quantidadesDigitadas = {}; }}
        function showLoader() { if (loadingIndicator) loadingIndicator.style.display = 'block'; }
        function hideLoader() { if (loadingIndicator) loadingIndicator.style.display = 'none'; }
        function generateNumericPassword(length = 6) { let pw = ''; for (let i = 0; i < length; i++) { pw += Math.floor(Math.random() * 10); } return pw; }
        async function populateEmpresasSelect(selectElementId, includeSpecialOption = false, specialOptionText = "-- Selecione --", specialOptionValue = "") { 
            const selectEmp = document.getElementById(selectElementId);
            if (!selectEmp) { console.warn(`Select de empresa ${selectElementId} não encontrado.`); return; }
            const currentValue = selectEmp.value; 
            selectEmp.innerHTML = ''; 
            if (includeSpecialOption) {
                const opt = document.createElement('option'); opt.value = specialOptionValue; opt.textContent = specialOptionText; selectEmp.appendChild(opt);
            }
            if (empresasCache.length === 0) {
                try {
                    const { data, error } = await _supabaseClient.from('empresas').select('id, nome_empresa').order('nome_empresa');
                    if (error) throw error; empresasCache = data || [];
                } catch (e) { console.error("Erro ao buscar empresas para select:", e); if(selectEmp) selectEmp.innerHTML = '<option value="">Erro ao carregar</option>'; return; }
            }
            empresasCache.forEach(emp => { const option = document.createElement('option'); option.value = emp.id; option.textContent = emp.nome_empresa; selectEmp.appendChild(option); });
            if (Array.from(selectEmp.options).some(opt => opt.value === currentValue)) { selectEmp.value = currentValue; } 
            else if (includeSpecialOption) { selectEmp.value = specialOptionValue; }
        }
        function showScreen(screenId, screenConfig = {}) {
            hideLoader(); 
            const mainCont = document.getElementById('mainContainer'); 
            const targetScreenElement = screens[screenId]; 
            Object.values(screens).forEach(sE => { if (sE && sE.classList) sE.classList.remove('active');});
            if (targetScreenElement && targetScreenElement.classList) {
                targetScreenElement.classList.add('active');
                if (mainCont) { mainCont.classList.toggle('content-container', ['adminEmpresas', 'adminCategorias', 'productManagement', 'inventoryCount', 'empresaColaboradores', 'historicoContagens'].includes(screenId));}
                ['adminProdutoEmpresaSelectorContainer', 'adminContagemEmpresaSelectorContainer', 'adminHistoricoEmpresaSelectorContainer', 'colEmpresaHistorico'].forEach(id => { const el = document.getElementById(id); if(el) el.style.display = 'none';});
                
                const { title, context, showEmpresaSelector, showEmpresaColumnInTable } = screenConfig;
                if (screenId === 'productManagement') {
                    if(document.getElementById('productManagementTitle')) document.getElementById('productManagementTitle').textContent = title || 'Gerenciar Produtos';
                    if(document.getElementById('productManagementContext') && context) document.getElementById('productManagementContext').textContent = context;
                    if (currentUser?.user_metadata?.user_role === 'admin_master' && showEmpresaSelector && document.getElementById('adminProdutoEmpresaSelectorContainer')) document.getElementById('adminProdutoEmpresaSelectorContainer').style.display = 'block';
                } else if (screenId === 'inventoryCount') {
                    if(document.getElementById('inventoryCountTitle')) document.getElementById('inventoryCountTitle').textContent = title || 'Balanço de Estoque';
                    if(document.getElementById('inventoryCountContext') && context) document.getElementById('inventoryCountContext').textContent = context;
                    if (currentUser?.user_metadata?.user_role === 'admin_master' && showEmpresaSelector && document.getElementById('adminContagemEmpresaSelectorContainer')) document.getElementById('adminContagemEmpresaSelectorContainer').style.display = 'block';
                } else if (screenId === 'historicoContagens') { 
                    if(document.getElementById('historicoTitle')) document.getElementById('historicoTitle').textContent = title || 'Histórico de Contagens';
                    if(document.getElementById('historicoContext') && context) document.getElementById('historicoContext').textContent = context;
                    if (currentUser?.user_metadata?.user_role === 'admin_master' && showEmpresaSelector && document.getElementById('adminHistoricoEmpresaSelectorContainer')) document.getElementById('adminHistoricoEmpresaSelectorContainer').style.display = 'block';
                    if (document.getElementById('colEmpresaHistorico')) document.getElementById('colEmpresaHistorico').style.display = (currentUser?.user_metadata?.user_role === 'admin_master' && showEmpresaColumnInTable) ? '' : 'none';
                } else if (screenId === 'empresaDashboard' && currentUser) {
                    if(document.getElementById('empresaDashboardTitle')) document.getElementById('empresaDashboardTitle').textContent = `Painel: ${currentUser.empresa_nome || 'Minha Empresa'}`;
                    if(document.getElementById('empresaUserName')) document.getElementById('empresaUserName').textContent = currentUser.full_name || currentUser.email;
                } else if (screenId === 'adminMasterDashboard' && currentUser && document.getElementById('adminMasterNameDisplay')) {
                     document.getElementById('adminMasterNameDisplay').textContent = currentUser.full_name || currentUser.email;  
                } else if (screenId === 'changePassword' && currentUser) {
                    if(document.getElementById('changingPasswordForUserDisplay')) document.getElementById('changingPasswordForUserDisplay').textContent = currentUser.email;
                    if(document.getElementById('currentPasswordGroup')) document.getElementById('currentPasswordGroup').style.display = (currentUser?.user_metadata?.user_role !== 'admin_master' && currentUser?.role !== 'admin_master') ? 'block' : 'none';
                }
            } else {
                console.error(`CRITICAL: Tela '${screenId}' não encontrada. Fallback para login.`);
                const loginSc = document.getElementById('screenLogin'); if (loginSc) loginSc.classList.add('active'); else document.body.innerHTML="Erro UI.";
            }
            window.scrollTo(0,0); 
        }
        function isMobileDevice() { return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent); }
        function triggerDownload(filename, textContent) { const blob = new Blob([textContent],{type:'text/plain;charset=utf-8'}); const link=document.createElement("a"); link.href=URL.createObjectURL(blob); link.download=filename; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(link.href); console.log(`Download ${filename} disparado.`); }

        // --- LÓGICA DE LOGIN E LOGOUT ---
        async function handleLogin() {
            console.log("handleLogin v2.9.9 MODIFICADO v4 chamado");
            if (!loginEmailInput || !loginPasswordInput || !loginErrorMessage) {
                console.error("handleLogin: Elementos do formulário de login não encontrados!");
                alert("Erro crítico no formulário de login. Tente recarregar."); hideLoader(); return;
            }
            const email = loginEmailInput.value.trim();
            const password = loginPasswordInput.value.trim();
            loginErrorMessage.textContent = ""; loginErrorMessage.style.display = "none";

            if (!email || !password) {
                loginErrorMessage.textContent = "Por favor, preencha email e senha.";
                loginErrorMessage.style.display = "block"; return;
            }
            showLoader();
            console.log("Tentando login Supabase para:", email);

            try {
                const { data: signInData, error: signInError } = await _supabaseClient.auth.signInWithPassword({ email, password });

                if (signInError) { console.error("Supabase signIn Error:", signInError); throw signInError; }
                if (!signInData || !signInData.user) { console.error("No user data from Supabase signIn."); throw new Error("Usuário não retornado. Verifique credenciais.");}
                
                console.log("Supabase signIn OK. User ID:", signInData.user.id, "Metadata:", signInData.user.user_metadata);

                const userRoleFromJWT = signInData.user.user_metadata?.user_role;
                const userFullNameFromJWT = signInData.user.user_metadata?.full_name || signInData.user.email;

                if (userRoleFromJWT === 'admin_master') {
                    currentUser = {
                        id: signInData.user.id, email: signInData.user.email, role: 'admin_master', 
                        user_metadata: signInData.user.user_metadata, full_name: userFullNameFromJWT
                    };
                    console.log("Admin Master Logado via Supabase Auth:", currentUser);
                    await Promise.all([ // Carrega selects em paralelo
                        populateEmpresasSelect('adminCategoriaEmpresaSelect', true, "-- Categoria Global --", ""),
                        populateEmpresasSelect('adminProdutoEmpresaSelect', true, "-- Produtos Globais (Sem Empresa) --", ""),
                        populateEmpresasSelect('adminContagemEmpresaSelect', true, "-- Contagem Global (Produtos Sem Empresa) --", ""),
                        populateEmpresasSelect('adminHistoricoEmpresaSelect', true, "-- Todas as Empresas --", "ALL_EMPRESAS")
                    ]);
                    showAdminMasterDashboardScreen();
                } else {
                    const { data: profile, error: profileError } = await _supabaseClient
                        .from('user_profiles').select('empresa_id, role, full_name, empresas (id, nome_empresa)')
                        .eq('id', signInData.user.id).single();

                    if (profileError && profileError.code !== 'PGRST116') { 
                        console.error("Erro ao buscar perfil:", profileError); await _supabaseClient.auth.signOut(); throw profileError;
                    }
                    if (!profile) { 
                        console.warn("Perfil não encontrado:", signInData.user.id); await _supabaseClient.auth.signOut();
                        throw new Error("Perfil do usuário não encontrado. Contate o suporte.");
                    }
                    if (profile.role === 'empresa_login_principal' && profile.empresa_id && profile.empresas) {
                        currentUser = {
                            id: signInData.user.id, email: signInData.user.email, role: profile.role, 
                            user_metadata: signInData.user.user_metadata, empresa_id: profile.empresa_id,
                            empresa_nome: profile.empresas.nome_empresa || 'Empresa Associada',
                            full_name: profile.full_name || signInData.user.email
                        };
                        console.log("Usuário de Empresa OK:", currentUser);
                        await showEmpresaDashboardScreen();
                    } else {
                        console.warn("Perfil inválido ou dados da empresa ausentes:", email, profile);
                        await _supabaseClient.auth.signOut();
                        throw new Error("Conta de empresa inválida/não configurada.");
                    }
                }
            } catch (e) {
                console.error("Catch em login:", e);
                loginErrorMessage.textContent = e.message.includes("Invalid login credentials") ? "Email ou senha inválidos."
                                              : (e.message.includes("Email not confirmed") ? "Email não confirmado."
                                              : (e.message || "Erro desconhecido."));
                loginErrorMessage.style.display = "block";
            } finally {
                hideLoader();
            }
        }

        async function handleLogout() { 
            console.log("handleLogout chamado"); showLoader();
            try {
                const { error } = await _supabaseClient.auth.signOut();
                if (error) { console.error("Erro no logout do Supabase:", error); }
                currentUser = null; adminSelectedEmpresaId = null; adminSelectedEmpresaParaCategoriaId = null;
                if(loginEmailInput) loginEmailInput.value = ""; if(loginPasswordInput) loginPasswordInput.value = "";
                produtosCache = []; categoriasCache = []; empresasCache = []; colaboradoresCache = [];
                quantidadesDigitadas = {}; localStorage.removeItem('balancoQuantities_v2.9.9'); 
                showScreen('login'); console.log("Usuário deslogado.");
            } catch (e) { console.error("Erro logout:", e); } finally { hideLoader(); }
        }
        function showAdminMasterDashboardScreen() { adminSelectedEmpresaId = null; adminSelectedEmpresaParaCategoriaId = null; showScreen('adminMasterDashboard'); }
        async function showEmpresaDashboardScreen() { adminSelectedEmpresaId = currentUser?.empresa_id; showScreen('empresaDashboard');}
        
        async function showAdminEmpresasScreen() { 
            if (!currentUser || currentUser?.user_metadata?.user_role !== 'admin_master') { handleLogout(); return; }
            showLoader();
            try {
                if (adminManageLoginEmpresaSection) adminManageLoginEmpresaSection.style.display = 'none';
                await fetchAndRenderEmpresas(); 
                showScreen('adminEmpresas'); 
            } catch (e) { console.error("Erro showAdminEmpresasScreen:", e); alert("Erro tela empresas."); hideLoader(); }
        }
        async function fetchAndRenderEmpresas() { 
            if (!adminEmpresasTableBody) {console.error("adminEmpresasTableBody não encontrado"); return;}
            adminEmpresasTableBody.innerHTML = '<tr><td colspan="3">Carregando...</td></tr>';
            try {
                const { data, error } = await _supabaseClient.from('empresas').select('id, nome_empresa, created_at').order('nome_empresa'); 
                if (error) throw error;
                empresasCache = data || []; tableBody = adminEmpresasTableBody; tableBody.innerHTML = ""; 
                if (empresasCache.length > 0) {
                    empresasCache.forEach(empresa => {
                        const row = tableBody.insertRow();
                        row.insertCell().textContent = empresa.nome_empresa;
                        row.insertCell().textContent = new Date(empresa.created_at).toLocaleDateString('pt-BR');
                        const actionsCell = row.insertCell();
                        const btnManageLogin = document.createElement('button'); 
                        btnManageLogin.textContent = 'Gerenciar Login'; 
                        btnManageLogin.className = 'btn btn-info table-actions';
                        btnManageLogin.onclick = () => handleShowManageLoginSection(empresa.id, empresa.nome_empresa); 
                        actionsCell.appendChild(btnManageLogin);
                        const btnManageColabs = document.createElement('button');
                        btnManageColabs.textContent = 'Colaboradores'; btnManageColabs.className = 'btn btn-secondary table-actions';
                        btnManageColabs.onclick = () => showEmpresaColaboradoresScreen(empresa.id, empresa.nome_empresa, true); 
                        actionsCell.appendChild(btnManageColabs);
                    });
                } else { tableBody.innerHTML = '<tr><td colspan="3">Nenhuma empresa.</td></tr>'; }
            } catch (e) { console.error("Erro listar empresas:", e); if(adminEmpresasTableBody) adminEmpresasTableBody.innerHTML = `<tr><td colspan="3" style="color:var(--danger-color);">Erro: ${e.message}</td></tr>`;}
        }
        async function handleAdminAddEmpresa() { 
            if(!adminNomeEmpresaInput) return; const nomeEmpresa = adminNomeEmpresaInput.value.trim();
            if (!nomeEmpresa) { alert('Digite o nome da empresa.'); return; }
            showLoader();
            try {
                const { data: existing } = await _supabaseClient.from('empresas').select('id').ilike('nome_empresa', nomeEmpresa).single();
                if (existing) { alert('Empresa já existe.'); hideLoader(); return; }
                const { data: novaEmpresa, error } = await _supabaseClient.from('empresas').insert([{ nome_empresa: nomeEmpresa }]).select().single();
                if (error) throw error;
                if (novaEmpresa && empresasCache) empresasCache.push(novaEmpresa); 
                alert('Empresa adicionada!'); adminNomeEmpresaInput.value = ''; 
                await fetchAndRenderEmpresas(); 
            } catch (e) { console.error("Erro add empresa:", e); alert('Falha: ' + e.message); } finally { hideLoader(); }
        }
        
        // ***** NOVA FUNÇÃO handleShowManageLoginSection *****
        async function handleShowManageLoginSection(empresaId, nomeEmpresa) {
            console.log("handleShowManageLoginSection para empresa:", nomeEmpresa, empresaId);
            if (!adminManageLoginEmpresaSection || !adminManageLoginEmpresaTitle || !selectedEmpresaIdForLoginManage || !adminManageLoginEmpresaContent || !manageLoginEmpresaMessage) {
                console.error("Elementos da UI para gerenciar login de empresa não foram encontrados."); return;
            }
            showLoader();
            adminManageLoginEmpresaTitle.textContent = `Gerenciar Login Principal para: ${nomeEmpresa}`;
            selectedEmpresaIdForLoginManage.value = empresaId; 
            adminManageLoginEmpresaContent.innerHTML = '<p>Verificando login existente...</p>';
            manageLoginEmpresaMessage.style.display = 'none'; manageLoginEmpresaMessage.textContent = '';
            adminManageLoginEmpresaSection.style.display = 'block';

            try {
                const { data: existingProfile, error: profileError } = await _supabaseClient
                    .from('user_profiles')
                    .select('id, email, full_name') // 'id' aqui é o user_id
                    .eq('empresa_id', empresaId)
                    .eq('role', 'empresa_login_principal')
                    .maybeSingle();

                if (profileError) throw profileError;

                if (existingProfile) {
                    if(selectedEmpresaUserIdForLoginManage) selectedEmpresaUserIdForLoginManage.value = existingProfile.id;
                    adminManageLoginEmpresaContent.innerHTML = `
                        <p>Login já definido para esta empresa:</p>
                        <p><strong>Email:</strong> ${existingProfile.email}</p>
                        <p><strong>Nome de Referência:</strong> ${existingProfile.full_name || 'Não definido'}</p>
                        <button class="btn btn-warning" id="btnExecuteResetSenhaEmpresa" style="margin-top:1rem;">Resetar Senha Deste Login</button>
                    `;
                    document.getElementById('btnExecuteResetSenhaEmpresa').onclick = () => callResetPasswordEdgeFunction(existingProfile.id, existingProfile.email, nomeEmpresa);
                } else {
                    if(selectedEmpresaUserIdForLoginManage) selectedEmpresaUserIdForLoginManage.value = '';
                    adminManageLoginEmpresaContent.innerHTML = `
                        <p>Nenhum login principal definido para esta empresa.</p>
                        <div class="form-group">
                            <label for="adminEmpresaLoginEmailNew">Email para Novo Login:</label>
                            <input type="email" id="adminEmpresaLoginEmailNew" placeholder="${nomeEmpresa.toLowerCase().replace(/\s+/g, '.').replace(/[^a-z0-9.-_]/gi, '')}@login.sistema">
                        </div>
                        <div class="form-group">
                            <label for="adminEmpresaLoginFullNameNew">Nome de Referência do Login:</label>
                            <input type="text" id="adminEmpresaLoginFullNameNew" placeholder="Login Principal ${nomeEmpresa}">
                        </div>
                        <button class="btn btn-success" id="btnExecutarCriarNovoLoginEmpresa">Criar Novo Login e Gerar Senha</button>
                    `;
                    const emailInputNew = document.getElementById('adminEmpresaLoginEmailNew');
                    const fullNameInputNew = document.getElementById('adminEmpresaLoginFullNameNew');
                    if(emailInputNew) emailInputNew.value = `${nomeEmpresa.toLowerCase().replace(/\s+/g, '.').replace(/[^a-z0-9.-_]/gi, '')}@login.sistema`;
                    if(fullNameInputNew) fullNameInputNew.value = `Login Principal ${nomeEmpresa}`;
                    document.getElementById('btnExecutarCriarNovoLoginEmpresa').onclick = () => handleAdminCreateOrUpdateEmpresaLogin();
                }
            } catch(e) {
                console.error("Erro em handleShowManageLoginSection:", e);
                adminManageLoginEmpresaContent.innerHTML = `<p style="color:var(--danger-color)">Erro ao verificar/gerenciar login: ${e.message}</p>`;
            } finally {
                hideLoader();
            }
        }
        
        function closeAdminManageLoginEmpresaSection() { 
            if(adminManageLoginEmpresaSection) adminManageLoginEmpresaSection.style.display = 'none';
        }

        // ***** MODIFICADA: handleAdminCreateOrUpdateEmpresaLogin (para focar na CRIAÇÃO, confiando no trigger) *****
        async function handleAdminCreateOrUpdateEmpresaLogin() { 
            console.log("handleAdminCreateOrUpdateEmpresaLogin (v4 - foco em CRIAÇÃO via trigger) chamada");
            const empresaId = document.getElementById('selectedEmpresaIdForLoginManage').value;
            const titleEl = document.getElementById('adminManageLoginEmpresaTitle');
            const titleText = titleEl ? titleEl.textContent : '';
            const match = titleText.match(/Gerenciar Login Principal para:\s*(.*)/);
            const empresaNome = match && match[1] ? match[1].trim() : 'Empresa Desconhecida';
            
            const emailEl = document.getElementById('adminEmpresaLoginEmailNew'); // Input para novo email
            const fullNameEl = document.getElementById('adminEmpresaLoginFullNameNew'); // Input para novo nome completo
            
            if (!emailEl || !fullNameEl || !manageLoginEmpresaMessage || !empresaId) { 
                alert("Erro de interface ou ID da empresa faltando. Recarregue."); return; 
            }

            const email = emailEl.value.trim();
            const fullName = fullNameEl.value.trim(); 

            if (!email) { alert("Email é obrigatório."); emailEl.focus(); return; }
            if (!fullName) { alert("Nome de referência é obrigatório."); fullNameEl.focus(); return; }

            const password = generateNumericPassword(6);
            showLoader();
            manageLoginEmpresaMessage.style.display = 'none'; manageLoginEmpresaMessage.textContent = '';

            try {
                // Garantir que não há sessão ativa que possa interferir com signUp de novo usuário
                await _supabaseClient.auth.signOut().catch(()=>{ console.warn("Nenhuma sessão para deslogar ou erro no signOut opcional antes de criar novo login.")}); 

                // Passo 1: Criar o usuário na auth.users
                // O trigger 'on_auth_user_created' (chamando 'handle_new_user') DEVE criar o perfil em 'user_profiles'
                const { data: authData, error: signUpError } = await _supabaseClient.auth.signUp({
                    email,
                    password,
                    options: {
                        data: { 
                            empresa_id: empresaId,
                            // empresa_nome: empresaNome, // Opcional, se handle_new_user usar
                            role: 'empresa_login_principal',
                            full_name: fullName
                        }
                    }
                });

                if (signUpError) {
                     if (signUpError.message.toLowerCase().includes("user already registered") || signUpError.message.toLowerCase().includes("already exists")) {
                         throw new Error(`Email ${email} já está registrado no Supabase Auth. Para definir uma nova senha para um login existente, use a opção "Resetar Senha". Se você tem certeza que quer usar este email para esta empresa e ele não deveria existir, delete o usuário da lista "Authentication" no painel do Supabase e tente novamente.`);
                    }
                    throw signUpError; // Outros erros do signUp
                }

                if (authData.user) {
                    console.log("Novo usuário criado na Auth:", authData.user.id, authData.user.email);
                    console.log("A criação do perfil em 'user_profiles' é de responsabilidade do trigger 'on_auth_user_created' -> 'handle_new_user()'.");

                    let successMsg = `Novo login para ${empresaNome} (${email}) criado com sucesso!`;
                    successMsg += `\nSenha Gerada: ${password}\nInforme ao responsável.`;
                    if (authData.user.email_confirmed_at === null && (authData.user.phone_confirmed_at === null || typeof authData.user.phone_confirmed_at === 'undefined')) {
                        successMsg += `\nNota: Se a confirmação de email estiver ATIVA no Supabase, o usuário ${email} precisará confirmar o email.`;
                    }
            
                    manageLoginEmpresaMessage.innerHTML = successMsg.replace(/\n/g, '<br>');
                    manageLoginEmpresaMessage.style.display = 'block';
                    manageLoginEmpresaMessage.style.color = 'var(--success-color)';
                    
                    // Após criar, atualiza a seção para mostrar que o login existe e oferece reset
                    await handleShowManageLoginSection(empresaId, empresaNome);

                } else {
                    console.warn("authData.user é null após signUp bem-sucedido (sem erro). authData:", authData);
                    throw new Error("Não foi possível obter os dados do usuário do Supabase Auth após o cadastro, embora não tenha havido erro no signUp.");
                }
            } catch (e) {
                console.error("Catch final em handleAdminCreateOrUpdateEmpresaLogin:", e);
                manageLoginEmpresaMessage.textContent = `Erro ao criar login: ${e.message}`;
                manageLoginEmpresaMessage.style.color = 'var(--danger-color)';
                manageLoginEmpresaMessage.style.display = 'block';
            } finally {
                hideLoader();
            }
        }

        // ***** NOVA FUNÇÃO callResetPasswordEdgeFunction *****
        async function callResetPasswordEdgeFunction(userId, userEmail, nomeEmpresa) {
            if (!userId || !userEmail) {
                alert("ID do usuário ou email não fornecido para resetar a senha.");
                return;
            }
            if (!confirm(`Tem certeza que deseja resetar a senha para o login ${userEmail} da empresa ${nomeEmpresa}? Uma nova senha numérica de 6 dígitos será gerada.`)) {
                return;
            }
            showLoader();
            if(manageLoginEmpresaMessage) { // Garante que o elemento existe
                manageLoginEmpresaMessage.style.display = 'none';
                manageLoginEmpresaMessage.textContent = '';
            }


            try {
                console.log(`Invocando Edge Function 'reset-empresa-password' para userId: ${userId}`);
                const { data, error } = await _supabaseClient.functions.invoke('reset-empresa-password', {
                    body: JSON.stringify({ target_user_id: userId }) // Garante que o body é uma string JSON
                });

                if (error) { // Erro na invocação da função (rede, permissão de chamada, etc.)
                    console.error("Erro ao invocar Edge Function 'reset-empresa-password':", error);
                    throw new Error(error.message || "Falha ao comunicar com a função de reset de senha.");
                }

                // 'data' aqui é o corpo da resposta da Edge Function
                if (data.error) { // Erro retornado pela lógica INTERNA da Edge Function
                    console.error("Erro retornado pela Edge Function:", data.error);
                    throw new Error(data.error);
                }
                
                console.log("Resposta da Edge Function:", data);
                let successMsg = data.message || `Senha para ${userEmail} resetada!`;
                if (data.newPassword) {
                    successMsg += `\nNova Senha Gerada: ${data.newPassword}\nInforme ao responsável.`;
                }
                if(manageLoginEmpresaMessage) {
                    manageLoginEmpresaMessage.innerHTML = successMsg.replace(/\n/g, '<br>');
                    manageLoginEmpresaMessage.style.display = 'block';
                    manageLoginEmpresaMessage.style.color = 'var(--success-color)';
                } else {
                    alert(successMsg.replace(/\n/g, '\n')); // Fallback se o elemento de mensagem não for encontrado
                }


            } catch (e) {
                console.error("Erro ao resetar senha via Edge Function:", e);
                if(manageLoginEmpresaMessage) {
                    manageLoginEmpresaMessage.textContent = `Erro ao resetar senha: ${e.message}`;
                    manageLoginEmpresaMessage.style.color = 'var(--danger-color)';
                    manageLoginEmpresaMessage.style.display = 'block';
                } else {
                    alert(`Erro ao resetar senha: ${e.message}`);
                }
            } finally {
                hideLoader();
            }
        }
        
        // --- FUNÇÃO GERAR ARQUIVO TXT MODIFICADA ---
        async function gerarArquivoTXT() {
            console.log("gerarArquivoTXT v2.9.9 (MODIFICADO v4) iniciada");
            showLoader();

            const colaboradorSelect = document.getElementById('selectColaboradorContagem');
            if (!colaboradorSelect) {
                alert("Erro: Seletor de colaborador não encontrado."); hideLoader(); return;
            }
            const colaboradorId = colaboradorSelect.value;
            const colaboradorNome = colaboradorSelect.options[colaboradorSelect.selectedIndex]?.text || "N/A";

            if (!colaboradorId) {
                alert("Por favor, selecione o colaborador que realizou a contagem."); hideLoader(); return;
            }

            const produtosContados = produtosCache.filter(p => quantidadesDigitadas[p.id] && parseFloat(quantidadesDigitadas[p.id]) > 0);

            if (produtosContados.length === 0) {
                alert("Nenhum produto com quantidade maior que zero para gerar o arquivo."); hideLoader(); return;
            }

            let conteudoTXT = "";
            produtosContados.forEach(produto => {
                const codigo = produto.codigo_produto || produto.id; 
                const quantidade = parseFloat(quantidadesDigitadas[produto.id]);
                conteudoTXT += `${codigo};${quantidade}\n`; // APENAS CÓDIGO E QUANTIDADE
            });

            const dataAtual = new Date();
            const nomeArquivo = `balanco_est_${dataAtual.getFullYear()}${String(dataAtual.getMonth() + 1).padStart(2, '0')}${String(dataAtual.getDate()).padStart(2, '0')}_${String(dataAtual.getHours()).padStart(2, '0')}${String(dataAtual.getMinutes()).padStart(2, '0')}.txt`;

            try {
                const empresaContextoId = (currentUser?.user_metadata?.user_role === 'admin_master' && adminSelectedEmpresaId) ? adminSelectedEmpresaId : (currentUser.empresa_id || null);

                const { error: histError } = await _supabaseClient.from('historico_contagens').insert({
                    empresa_id: empresaContextoId, colaborador_id: colaboradorId, colaborador_nome: colaboradorNome,
                    itens_contados: produtosContados.length,
                    dados_contagem: produtosContados.map(p => ({
                        produto_id: p.id, codigo: p.codigo_produto || p.id, nome: p.nome_produto, 
                        categoria: categoriasCache.find(c => c.id === p.categoria_id)?.nome_categoria || "Sem Categoria",
                        quantidade: parseFloat(quantidadesDigitadas[p.id])
                    }))
                });

                if (histError) { console.error("Erro ao salvar histórico:", histError); alert(`Erro histórico: ${histError.message}`); hideLoader(); return; }
                console.log("Histórico salvo.");

                if (isMobileDevice()) {
                    const blob = new Blob([conteudoTXT],{type:'text/plain;charset=utf-8'}); const file = new File([blob],nomeArquivo,{type:'text/plain;charset=utf-8'});
                    if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                        try {
                            await navigator.share({ files: [file], title: nomeArquivo, text: `Balanço: ${nomeArquivo}` });
                            alert('Compartilhe o arquivo!'); clearAllQuantities(); 
                        } catch (error) {
                            if (error.name !== 'AbortError') { console.error('Erro Web Share:', error); alert(`Falha compartilhar. Baixando.`); triggerDownload(nomeArquivo, conteudoTXT); clearAllQuantities(); }
                            else { alert('Compartilhamento cancelado.');}
                        }
                    } else { triggerDownload(nomeArquivo, conteudoTXT); alert(`Arquivo baixado. Share API (arquivos) não disponível.`); clearAllQuantities(); }
                } else { 
                    triggerDownload(nomeArquivo, conteudoTXT);
                    alert(`Arquivo "${nomeArquivo}" gerado, baixado e histórico salvo!`);
                    clearAllQuantities(); 
                }
            } catch (error) { console.error("Erro gerarTXT:", error); alert(`Erro contagem: ${error.message}`);
            } finally { hideLoader(); }
        }
        
        // --- INICIALIZAÇÃO e EVENT LISTENERS ---
        // (A função window.onload e a atribuição dos event listeners permanecem as mesmas da sua última versão completa)
        // Cole sua função window.onload e os addEventListener aqui. Certifique-se que os IDs dos botões
        // para a nova seção de gerenciamento de login (se você alterou os IDs) estejam corretos.
        // O botão na tabela de empresas que chama handleShowManageLoginSection é o mais importante de garantir.
        // E o btnCancelarManageLoginEmpresa.
        window.onload = async () => { 
            console.log("window.onload v2.9.9 (DOM Ready) MODIFICADO v4 iniciado");
            initializeDOMSelectors(); 
            showLoader(); 
            if (typeof loadQuantities === "function") loadQuantities(); 
            else console.error("CRITICAL: loadQuantities não definida!");
            
            document.getElementById('loginButton')?.addEventListener('click', handleLogin);
            document.getElementById('loginPassword')?.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); handleLogin(); }});

            document.getElementById('btnAdminGerenciarEmpresas')?.addEventListener('click', showAdminEmpresasScreen);
            document.getElementById('btnAdminGerenciarCategorias')?.addEventListener('click', showAdminCategoriasScreen);
            document.getElementById('btnAdminGerenciarProdutos')?.addEventListener('click', showProductManagementScreen_AdminGlobal);
            document.getElementById('btnAdminContagemEstoque')?.addEventListener('click', showInventoryCountScreen_AdminGlobal);
            document.getElementById('btnAdminHistoricoContagens')?.addEventListener('click', showHistoricoContagensScreen_Admin);
            document.getElementById('btnLogoutAdmin')?.addEventListener('click', handleLogout);

            document.getElementById('btnEmpresaGerenciarColaboradores')?.addEventListener('click', showEmpresaColaboradoresScreen);
            document.getElementById('btnEmpresaGerenciarProdutos')?.addEventListener('click', showProductManagementScreen_Empresa);
            document.getElementById('btnEmpresaContagemEstoque')?.addEventListener('click', showInventoryCountScreen_Empresa);
            document.getElementById('btnEmpresaHistoricoContagens')?.addEventListener('click', showHistoricoContagensScreen);
            document.getElementById('btnEmpresaAlterarSenha')?.addEventListener('click', showChangePasswordScreen_Empresa);
            document.getElementById('btnLogoutEmpresa')?.addEventListener('click', handleLogout);
            
            document.getElementById('btnAdminCategoriasVoltar')?.addEventListener('click', showAdminMasterDashboardScreen);
            document.getElementById('btnAdminAddCategoria')?.addEventListener('click', handleAdminAddCategoria);
            document.getElementById('btnAdminEmpresasVoltar')?.addEventListener('click', showAdminMasterDashboardScreen);
            document.getElementById('btnAdminAddEmpresa')?.addEventListener('click', handleAdminAddEmpresa);
            
            // Listener para o botão de cancelar na nova seção de gerenciamento de login
            document.getElementById('btnCancelarManageLoginEmpresa')?.addEventListener('click', closeAdminManageLoginEmpresaSection);


            document.getElementById('colaboradoresBackButton')?.addEventListener('click', () => { 
                if(currentUser?.user_metadata?.user_role === 'admin_master') showAdminEmpresasScreen(); else showEmpresaDashboardScreen(); 
            });
            document.getElementById('btnAddColaborador')?.addEventListener('click', handleAddColaborador);
            document.getElementById('btnSalvarNovaSenha')?.addEventListener('click', handleChangePassword);
            document.getElementById('btnAddProduct')?.addEventListener('click', handleAddProduct);
            document.getElementById('btnImportXLSX')?.addEventListener('click', handleXLSXImport);
            document.getElementById('btnShowPreviewContagem')?.addEventListener('click', showPreviewContagem);
            document.getElementById('btnGerarTXT')?.addEventListener('click', gerarArquivoTXT);
            document.getElementById('btnClearAllQuantities')?.addEventListener('click', clearAllQuantities);
            document.getElementById('btnClosePreviewModal')?.addEventListener('click', closeModalPreviewContagem);
            document.getElementById('btnCloseDetalhesModal')?.addEventListener('click', closeModalDetalhesContagem);

            if(document.getElementById('changePasswordBackButton')) {
                document.getElementById('changePasswordBackButton').addEventListener('click', () => {
                    if (currentUser?.user_metadata?.user_role === 'admin_master') { 
                        showAdminMasterDashboardScreen();
                    } else if (currentUser?.role === 'empresa_login_principal') { 
                        showEmpresaDashboardScreen();
                    } else {
                        showScreen('login'); 
                    }
                });
            }
            console.log("Event listeners principais adicionados.");
            
            try {
                console.log("Carregando caches globais (empresas, categorias) no onload...");
                const empresasPromise = _supabaseClient.from('empresas').select('id, nome_empresa').order('nome_empresa');
                const categoriasPromise = _supabaseClient.from('categorias').select('*').order('nome_categoria');
                
                const [empresasRes, categoriasRes] = await Promise.all([empresasPromise, categoriasPromise]);

                if (empresasRes.error) console.error("Erro ao carregar empresas no cache (onload):", empresasRes.error);
                else empresasCache = empresasRes.data || [];

                if (categoriasRes.error) console.error("Erro ao carregar categorias no cache (onload):", categoriasRes.error);
                else categoriasCache = categoriasRes.data || [];
                console.log("Caches globais (empresas, categorias) carregados no onload.");

            } catch(e) {
                console.error("Erro crítico ao carregar dados iniciais (empresas/categorias) no onload:", e);
            }
            
            const localPesquisaProdutoInput = document.getElementById('pesquisaProduto');
            const localPesquisaCodigoInput = document.getElementById('pesquisaCodigo');
            const localFiltroCategoriaSelect = document.getElementById('filtroCategoria'); 
            if (localPesquisaProdutoInput) localPesquisaProdutoInput.addEventListener("input", filterInventoryProducts);
            if (localPesquisaCodigoInput) localPesquisaCodigoInput.addEventListener("input", filterInventoryProducts);
            if (localFiltroCategoriaSelect) localFiltroCategoriaSelect.addEventListener("change", filterInventoryProducts);
            
            try { 
                console.log("Tentando obter sessão Supabase no onload...");
                const { data: { session }, error: sessionError } = await _supabaseClient.auth.getSession();
                if (sessionError) { console.error("Erro ao obter sessão inicial Supabase (onload):", sessionError); throw sessionError; }

                if (session?.user) {
                    console.log("Sessão Supabase encontrada para user ID (onload):", session.user.id);
                    const user = session.user;
                    
                    const userRoleFromJWT_onload = user.user_metadata?.user_role;
                    const userFullNameFromJWT_onload = user.user_metadata?.full_name || user.email;

                    if (userRoleFromJWT_onload === 'admin_master') {
                        currentUser = {
                            id: user.id, email: user.email, role: 'admin_master', 
                            user_metadata: user.user_metadata, full_name: userFullNameFromJWT_onload
                        };
                        console.log("Sessão restaurada para Admin Master (onload):", currentUser);
                        await Promise.all([
                            populateEmpresasSelect('adminCategoriaEmpresaSelect', true, "-- Categoria Global --", ""),
                            populateEmpresasSelect('adminProdutoEmpresaSelect', true, "-- Produtos Globais (Sem Empresa) --", ""),
                            populateEmpresasSelect('adminContagemEmpresaSelect', true, "-- Contagem Global (Produtos Sem Empresa) --", ""),
                            populateEmpresasSelect('adminHistoricoEmpresaSelect', true, "-- Todas as Empresas --", "ALL_EMPRESAS")
                        ]);
                        showAdminMasterDashboardScreen();
                    } else { 
                        const { data: profile, error: profileError } = await _supabaseClient
                            .from('user_profiles')
                            .select('empresa_id, role, full_name, empresas ( nome_empresa )')
                            .eq('id', user.id)
                            .single();
                        
                        if (profileError && profileError.code === 'PGRST116') { 
                            console.warn("Sessão ativa, mas perfil não encontrado em user_profiles (onload). Deslogando.", user.id);
                            await _supabaseClient.auth.signOut(); showScreen('login');
                        } else if (profileError) { 
                            console.error("Erro ao buscar perfil para sessão ativa (onload):", profileError);
                            throw profileError; 
                        } else if (profile && profile.role === 'empresa_login_principal' && profile.empresa_id && profile.empresas) {
                            currentUser = { 
                                id: user.id, email: user.email, role: profile.role, 
                                user_metadata: user.user_metadata, empresa_id: profile.empresa_id,
                                empresa_nome: profile.empresas.nome_empresa || 'Empresa Associada',
                                full_name: profile.full_name || user.email
                            };
                            console.log("Sessão restaurada para Usuário de Empresa (onload):", currentUser);
                            await showEmpresaDashboardScreen();
                        } else { 
                            console.warn("Sessão Supabase ativa, mas perfil inválido/incompleto ou não é 'empresa_login_principal' (onload). Deslogando. Perfil:", profile);
                            await _supabaseClient.auth.signOut(); showScreen('login'); 
                        }
                    }
                } else { 
                    console.log("Nenhuma sessão Supabase ativa encontrada (onload).");
                    showScreen('login'); 
                }
            } catch (e) {
                console.error("Erro crítico na inicialização ao tentar restaurar sessão/perfil (onload):", e);
                await _supabaseClient.auth.signOut().catch(err => { console.warn("Erro no signOut de fallback (onload):", err); }); 
                currentUser = null; 
                showScreen('login');
            } finally {
                console.log("window.onload finalizado.");
                hideLoader(); 
            }
        };
        console.log("SCRIPT END - v2.9.9 MODIFICADO v4");
    </script>
</body>
</html>