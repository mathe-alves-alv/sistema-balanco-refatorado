<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Balanço de Estoque - v2.9.9 (Corrigido v6 - Definições de Função)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            /* Tema Claro - Ajustado */
            --primary-color: #007bff; 
            --primary-color-darker: #0069d9;
            --secondary-color: #6c757d; 
            --secondary-color-darker: #5a6268;
            --success-color: #198754; 
            --success-color-darker: #157347;
            --danger-color: #dc3545;  
            --danger-color-darker: #bb2d3b;
            --warning-color: #ffc107; 
            --warning-color-darker: #ffb300;
            --info-color: #0dcaf0;    
            --info-color-darker: #0aa9c6;
            --background-color: #f4f6f9;
            --container-bg-color: #ffffff;
            --card-bg-color: #ffffff;
            --header-bg-color: #f8f9fa;
            --input-bg-color: #ffffff;      
            --input-border-color: #ced4da;     
            --text-color: #212529;        
            --text-muted-color: #6c757d;     
            --text-on-primary-color: #ffffff;
            --text-on-secondary-color: #ffffff;
            --text-on-success-color: #ffffff;
            --text-on-danger-color: #ffffff;
            --text-on-warning-color: #000000;   
            --text-on-info-color: #000000;     
            --border-color: #dee2e6;        
            --hover-row-background: #e9ecef;
            --border-radius: 0.375rem; 
            --box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            --box-shadow-lg: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;margin:0;padding:20px 0;background-color:var(--background-color);color:var(--text-color);display:flex;flex-direction:column;align-items:center;min-height:100vh;line-height:1.5;font-size:1rem}
        .container{width:95%;max-width:600px;background-color:var(--container-bg-color);padding:25px 30px;border-radius:var(--border-radius);box-shadow:var(--box-shadow);margin-top:20px;margin-bottom:20px;border:1px solid var(--border-color)}
        .content-container{max-width:1140px}
        h1,h2,h3{color:var(--text-color);text-align:center;margin-top:0;margin-bottom:1.5rem;font-weight:500}
        h1{font-size:2rem}h2{font-size:1.75rem}h3{font-size:1.5rem;margin-bottom:1rem}
        .screen { display: none !important; opacity: 0 !important; visibility: hidden !important; min-height: 300px; } 
        .screen.active { display: block !important; opacity: 1 !important; visibility: visible !important; animation: fadeInView .4s ease-out; }
        @keyframes fadeInView{ from{opacity:0; transform: translateY(10px);} to{opacity:1; transform: translateY(0);} }
        button,.btn{border:1px solid transparent;padding:.5rem 1rem;text-align:center;text-decoration:none;display:inline-block;font-size:1rem;font-weight:400;line-height:1.5;border-radius:var(--border-radius);cursor:pointer;transition:color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;margin:.25rem}
        button:hover,.btn:hover{text-decoration:none;transform:translateY(-1px);box-shadow:var(--box-shadow-lg)}
        button:active,.btn:active{transform:translateY(0);}
        button:focus-visible,.btn:focus-visible{outline:2px solid var(--primary-color);outline-offset:2px}
        .btn-primary{background-color:var(--primary-color);border-color:var(--primary-color);color:var(--text-on-primary-color)}.btn-primary:hover{background-color:var(--primary-color-darker);border-color:var(--primary-color-darker)}
        .btn-secondary{background-color:var(--secondary-color);border-color:var(--secondary-color);color:var(--text-on-secondary-color)}.btn-secondary:hover{background-color:var(--secondary-color-darker);border-color:var(--secondary-color-darker)}
        .btn-success{background-color:var(--success-color);border-color:var(--success-color);color:var(--text-on-success-color)}.btn-success:hover{background-color:var(--success-color-darker);border-color:var(--success-color-darker)}
        .btn-danger{background-color:var(--danger-color);border-color:var(--danger-color);color:var(--text-on-danger-color)}.btn-danger:hover{background-color:var(--danger-color-darker);border-color:var(--danger-color-darker)}
        .btn-warning{background-color:var(--warning-color);border-color:var(--warning-color);color:var(--text-on-warning-color)}.btn-warning:hover{background-color:var(--warning-color-darker);border-color:var(--warning-color-darker)}
        .btn-info{background-color:var(--info-color);border-color:var(--info-color);color:var(--text-on-info-color);}.btn-info:hover{background-color:var(--info-color-darker);border-color:var(--info-color-darker);}
        .dashboard-options{display:flex;flex-direction:column;align-items:stretch;gap:1rem;padding:1rem 0}
        .dashboard-options .btn{padding:.75rem 1rem;font-size:1.05rem;width:100%}
        .card{border:1px solid var(--border-color);border-radius:var(--border-radius);margin-bottom:1.5rem;box-shadow:var(--box-shadow);background-color:var(--card-bg-color)}
        .card-header{padding:.75rem 1.25rem;margin-bottom:0;background-color:var(--header-bg-color);border-bottom:1px solid var(--border-color);border-top-left-radius:calc(var(--border-radius) - 1px);border-top-right-radius:calc(var(--border-radius) - 1px)}
        .card-header>*{margin:0;font-size:1.25rem;font-weight:500;color:var(--text-color);text-align:left}
        .card-body{padding:1.25rem}
        table{width:100%;border-collapse:collapse;margin-bottom:1rem;color:var(--text-color); }
        th,td{border:1px solid var(--border-color);padding:.75rem;text-align:left;vertical-align:middle}
        th{background-color:var(--header-bg-color);font-weight:500;border-bottom-width:2px} 
        tbody tr:nth-child(odd){background-color:var(--container-bg-color); } 
        tbody tr:nth-child(even){background-color: #f1f3f5; } 
        tbody tr:hover{background-color:var(--hover-row-background); }
        input[type=text],input[type=number],input[type=password],input[type=email],select,input[type=file]{width:100%;padding:.5rem .75rem;margin-bottom:1rem;border:1px solid var(--input-border-color);border-radius:var(--border-radius);box-sizing:border-box;font-size:1rem;line-height:1.5;background-color:var(--input-bg-color);color:var(--text-color);background-clip:padding-box;transition:border-color .15s ease-in-out,box-shadow .15s ease-in-out}
        input[type=text]::placeholder,input[type=number]::placeholder,input[type=password]::placeholder,input[type=email]::placeholder{color:var(--text-muted-color);opacity:1}
        input[type=text]:focus,input[type=number]:focus,input[type=password]:focus,input[type=email]:focus,select:focus{border-color:var(--primary-color);outline:0;box-shadow:0 0 0 .25rem rgba(13,110,253,.25)}
        input[type=file]{padding:.375rem .75rem}
        select{appearance:none;background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23212529' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");background-repeat:no-repeat;background-position:right .75rem center;background-size:16px 12px}
        .form-group{margin-bottom:1rem}
        .form-group label{display:block;margin-bottom:.5rem;font-weight:500;color:var(--text-color); }
        .filter-controls,.product-management-form-fields,.xlsx-import-section,.actions-bar,.sub-form-section{margin-bottom:1.5rem;padding:1rem;background-color:var(--card-bg-color);border:1px solid var(--border-color);border-radius:var(--border-radius)} 
        .product-management-form-fields .form-group{margin-bottom:0}
        .filter-controls>div{flex:1;min-width:200px}
        .filter-controls input,.filter-controls select{margin-bottom:0}
        .xlsx-import-section input[type=file]{width:auto;margin-right:.5rem}
        .actions-bar{text-align:center;padding:1rem 0; background-color: transparent; border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); }
        .actions-bar .btn{margin:0 .5rem}
        #productManagementTable td:last-child,#inventoryTable td:last-child,#adminEmpresasTable td:last-child, #colaboradoresTable td:last-child, #historicoContagensTable td:last-child, #adminCategoriasTable td:last-child {text-align:center} 
        #inventoryTable input[type=number]{max-width:80px;text-align:right;padding:.375rem .5rem;font-size:.9rem}
        .back-button{margin-bottom:1.5rem;display:inline-block}
        .modal-overlay { position: fixed !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; background-color: rgba(0,0,0,0.4) !important; display: flex !important; justify-content: center !important; align-items: center !important; z-index: 10000 !important; opacity: 0 !important; visibility: hidden !important; transition: opacity 0.2s ease, visibility 0.2s ease !important; }
        .modal-overlay.active { opacity: 1 !important; visibility: visible !important; }
        .modal-content { background-color: var(--container-bg-color); color: var(--text-color); padding: 20px 25px; border-radius: var(--border-radius); box-shadow: var(--box-shadow-lg); width: 90%; max-width: 500px; text-align: left; border: 1px solid var(--border-color); transform: translateY(-20px) scale(0.95); transition: transform 0.2s ease, opacity 0.2s ease; opacity: 0;}
        .modal-overlay.active .modal-content { transform: translateY(0) scale(1); opacity: 1;}
        .modal-content h4 { color: var(--text-color); margin-bottom: 1rem; font-size: 1.25rem; text-align: center;}
        .modal-content p { color: var(--text-muted-color); margin-bottom: 1rem; font-size: 0.95rem; } 
        .modal-actions { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem; }
        .login-form{max-width:400px;margin:1.5rem auto; padding: 2rem; background-color: var(--container-bg-color); border-radius: var(--border-radius); box-shadow: var(--box-shadow);}
        .login-form .form-group{margin-bottom:1rem}
        .login-form button{width:100%;padding:.75rem;font-size:1.05em}
        #loginErrorMessage{color:var(--danger-color);margin-top:1rem;text-align:center;display:none}
        .sub-form-section h4{text-align:left;font-size:1.1rem;color:var(--text-color);margin-bottom:1rem;border-bottom:1px solid var(--border-color);padding-bottom:.5rem}
        .table-actions button,.table-actions .btn{margin:0 2px;padding:.25rem .5rem;font-size:.85rem}
        .generated-password-display { margin-top: 10px; padding: 10px; background-color: #e9ecef; border: 1px dashed var(--border-color); border-radius: var(--border-radius); word-break: break-all; color: var(--text-color); font-family: monospace; text-align: center;}
        .password-change-form { max-width: 450px; margin: 1.5rem auto; }
        .form-inline-flex { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 1rem;}
        .form-inline-flex .form-group { flex: 1; margin-bottom: 0;}
        .form-inline-flex button { flex-shrink: 0; }
        #previewContagemTable { width: 100%; margin-top: 1rem; }
        #previewContagemTable th, #previewContagemTable td { font-size: 0.9rem; padding: 0.5rem; }
        .admin-context-selector { margin-bottom: 1.5rem; padding: 1rem; background-color: var(--header-bg-color); border-radius: var(--border-radius); }
        .admin-context-selector label { margin-right: 0.5rem; font-weight: 500;}
        .admin-context-selector select { display: inline-block; width: auto; min-width: 250px; margin-right: 10px; }
        .loader { border: 5px solid #e9ecef; border-top: 5px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        #adminManageLoginEmpresaContent { margin-top: 1rem; } 
        #adminManageLoginEmpresaContent p { margin-bottom: 0.5rem; }
        #adminManageLoginEmpresaContent .form-group { margin-top: 1rem; }
    </style>
</head>
<body>
    <div id="mainContainer" class="container"> 
        <div id="loadingIndicator" class="loader" style="display:none;"></div>

        <div id="screenLogin" class="screen active">
            <h1>Login no Sistema de Balanço</h1>
            <div class="login-form card card-body">
                <div class="form-group"><label for="loginEmail">Email:</label><input type="email" id="loginEmail" placeholder="seuemail@exemplo.com" autocomplete="email"></div>
                <div class="form-group"><label for="loginPassword">Senha:</label><input type="password" id="loginPassword" placeholder="Sua senha" autocomplete="current-password"></div>
                <button class="btn btn-primary" id="loginButton">Entrar</button> 
                <div id="loginErrorMessage"></div>
            </div>
        </div>

        <div id="screenAdminMasterDashboard" class="screen">
            <h2>Painel Admin Master</h2>
            <p style="text-align: center;">Bem-vindo, <span id="adminMasterNameDisplay">Admin Master</span>!</p>
            <div class="dashboard-options">
                <button class="btn btn-primary" id="btnAdminGerenciarEmpresas">Gerenciar Empresas & Seus Logins</button>
                <button class="btn btn-primary" id="btnAdminGerenciarCategorias">Gerenciar Categorias</button> 
                <button class="btn btn-primary" id="btnAdminGerenciarProdutos">Gerenciar Produtos</button>
                <button class="btn btn-primary" id="btnAdminContagemEstoque">Contagem de Estoque</button>
                <button class="btn btn-info" id="btnAdminHistoricoContagens">Histórico de Contagens (Admin)</button>
                <button class="btn btn-secondary" id="btnLogoutAdmin">Logout</button>
            </div>
        </div>

        <div id="screenEmpresaDashboard" class="screen">
            <h2 id="empresaDashboardTitle">Painel da Empresa</h2>
            <p style="text-align: center;">Logado como: <span id="empresaUserName"></span></p>
            <div class="dashboard-options">
                <button class="btn btn-primary" id="btnEmpresaGerenciarColaboradores">Gerenciar Colaboradores</button>
                <button class="btn btn-primary" id="btnEmpresaGerenciarProdutos">Gerenciar Produtos da Empresa</button>
                <button class="btn btn-primary" id="btnEmpresaContagemEstoque">Iniciar Contagem da Empresa</button>
                <button class="btn btn-info" id="btnEmpresaHistoricoContagens">Ver Histórico de Contagens</button>
                <button class="btn btn-info" id="btnEmpresaAlterarSenha">Alterar Senha da Empresa</button> 
                <button class="btn btn-secondary" id="btnLogoutEmpresa">Logout</button>
            </div>
        </div>
        
        <div id="screenAdminCategorias" class="screen">
            <button class="btn btn-secondary back-button" id="btnAdminCategoriasVoltar"> &larr; Painel Admin</button>
            <h2>Gerenciar Categorias de Produtos</h2>
            <div class="card">
                <div class="card-header"><h3>Adicionar Nova Categoria</h3></div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="adminCategoriaEmpresaSelect">Associar Categoria a:</label>
                        <select id="adminCategoriaEmpresaSelect">
                            <option value="">-- Categoria Global (para todas empresas) --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="adminNomeCategoria">Nome da Nova Categoria:</label>
                        <input type="text" id="adminNomeCategoria" placeholder="Ex: Bolos, Salgados, Bebidas">
                    </div>
                    <button class="btn btn-success" id="btnAdminAddCategoria">Adicionar Categoria</button>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><h3>Categorias Cadastradas</h3></div>
                <div class="card-body">
                    <table id="adminCategoriasTable">
                        <thead><tr><th>Nome da Categoria</th><th>Escopo (Empresa / Global)</th><th>Criação</th><th>Ações</th></tr></thead>
                        <tbody id="adminCategoriasTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="screenAdminEmpresas" class="screen">
             <button class="btn btn-secondary back-button" id="btnAdminEmpresasVoltar">&larr; Painel Admin</button>
            <h2>Gerenciar Empresas e Seus Logins Principais</h2>
            <div class="card"><div class="card-header"><h3>Adicionar Nova Empresa</h3></div><div class="card-body"><div class="form-group"><label for="adminNomeEmpresa">Nome da Empresa:</label><input type="text" id="adminNomeEmpresa" placeholder="Nome da nova empresa"></div><button class="btn btn-success" id="btnAdminAddEmpresa">Adicionar Empresa</button></div></div>
            <div class="card"><div class="card-header"><h3>Empresas Cadastradas</h3></div><div class="card-body"><table id="adminEmpresasTable"><thead><tr><th>Nome</th><th>Criação</th><th style="min-width: 280px;">Ações da Empresa</th></tr></thead><tbody id="adminEmpresasTableBody"></tbody></table></div></div>
            
            <div id="adminManageLoginEmpresaSection" class="card" style="display:none; margin-top: 2rem;">
                <div class="card-header"><h3 id="adminManageLoginEmpresaTitle">Gerenciar Login para Empresa</h3></div>
                <div class="card-body">
                    <input type="hidden" id="selectedEmpresaIdForLoginManage">
                    <input type="hidden" id="selectedEmpresaUserIdForLoginManage"> 
                    <div id="adminManageLoginEmpresaContent">
                        {/* Conteúdo dinâmico aqui */}
                    </div>
                    <div id="manageLoginEmpresaMessage" class="generated-password-display" style="display:none; margin-top:1rem;"></div>
                </div>
                <button class="btn btn-secondary" id="btnCancelarManageLoginEmpresa" style="margin: 0 1.25rem 1.25rem;">Cancelar</button>
            </div>
        </div>
        
        <div id="screenEmpresaColaboradores" class="screen">
            <button class="btn btn-secondary back-button" id="colaboradoresBackButton">&larr; Voltar</button> 
            <h2>Gerenciar Colaboradores (<span id="colaboradoresEmpresaNome"></span>)</h2>
            <div class="card"><div class="card-header"><h3>Adicionar Novo Colaborador</h3></div><div class="card-body"><div class="form-inline-flex"><div class="form-group"><label for="colaboradorNome">Nome do Colaborador:</label><input type="text" id="colaboradorNome" placeholder="Nome completo"></div><button class="btn btn-success" id="btnAddColaborador">Adicionar</button></div></div></div>
            <div class="card"><div class="card-header"><h3>Colaboradores Cadastrados</h3></div><div class="card-body"><table id="colaboradoresTable"><thead><tr><th>Nome</th><th>Ativo</th><th>Criação</th><th style="min-width: 220px;">Ações</th></tr></thead><tbody id="colaboradoresTableBody"></tbody></table></div></div>
        </div>
        
        <div id="screenChangePassword" class="screen">
             <button class="btn btn-secondary back-button" id="changePasswordBackButton">&larr; Voltar ao Painel</button>
            <h2>Alterar Senha</h2>
            <div class="password-change-form card card-body">
                <p>Alterando senha para o login: <strong id="changingPasswordForUserDisplay"></strong></p>
                <div class="form-group" id="currentPasswordGroup" style="display:none;"><label for="currentPasswordInput">Senha Atual:</label><input type="password" id="currentPasswordInput"></div>
                <div class="form-group"><label for="newPasswordInput">Nova Senha (mín. 6 caracteres):</label><input type="password" id="newPasswordInput" placeholder="Digite a nova senha"></div>
                <div class="form-group"><label for="confirmNewPasswordInput">Confirmar Nova Senha:</label><input type="password" id="confirmNewPasswordInput" placeholder="Confirme a nova senha"></div>
                <button class="btn btn-primary" id="btnSalvarNovaSenha">Salvar Nova Senha</button>
                <div id="changePasswordMessage" style="margin-top:1rem; text-align:center;"></div>
            </div>
        </div>

        <div id="screenHistoricoContagens" class="screen">
            <button class="btn btn-secondary back-button" id="historicoBackButton">&larr; Voltar ao Painel</button> 
            <h2 id="historicoTitle">Histórico de Contagens (<span id="historicoEmpresaNomeSpan"></span>)</h2> 
            <div id="adminHistoricoEmpresaSelectorContainer" class="admin-context-selector" style="display:none;">
                <label for="adminHistoricoEmpresaSelect">Ver Histórico Para Empresa:</label>
                <select id="adminHistoricoEmpresaSelect"><option value="ALL_EMPRESAS">-- Todas as Empresas --</option></select>
            </div>
            <p id="historicoContext" style="text-align:center; font-size:0.9em; color:var(--text-muted-color); margin-bottom: 1rem;"></p>
            <div class="card"><div class="card-header"><h3>Registros de Contagem</h3></div><div class="card-body" style="padding:0;"><table id="historicoContagensTable"><thead><tr><th id="colEmpresaHistorico" style="display:none;">Empresa</th><th>Data</th><th>Colaborador</th><th>Itens Contados</th><th>Ações</th></tr></thead><tbody id="historicoContagensTableBody"></tbody></table></div></div>
        </div>

        <div id="screenProductManagement" class="screen">
            <button class="btn btn-secondary back-button" id="productManagementBackButton">&larr; Voltar</button>
            <h2 id="productManagementTitle">Gerenciar Produtos</h2>
            <div id="adminProdutoEmpresaSelectorContainer" class="admin-context-selector" style="display:none;">
                <label for="adminProdutoEmpresaSelect">Gerenciar Produtos Para Empresa:</label>
                <select id="adminProdutoEmpresaSelect"><option value="">-- Produtos Globais (Sem Empresa) --</option></select>
            </div>
            <p id="productManagementContext" style="text-align:center; font-size:0.9em; color:var(--text-muted-color); margin-bottom: 1rem;"></p>
            <div class="card"><div class="card-header"><h3>Adicionar Novo Produto</h3></div><div class="card-body">
                <div class="product-management-form-fields">
                    <div class="form-group"><label for="prodCodigo">Código:</label><input type="text" id="prodCodigo"></div>
                    <div class="form-group"><label for="prodNome">Produto:</label><input type="text" id="prodNome"></div>
                    <div class="form-group">
                        <label for="prodCategoriaSelect">Categoria:</label>
                        <select id="prodCategoriaSelect"><option value="">-- Sem Categoria --</option></select>
                    </div>
                    <button class="btn btn-success" id="btnAddProduct">Adicionar</button>
                </div>
            </div></div>
            <div class="card"><div class="card-header"><h3>Importar Produtos via XLSX</h3></div><div class="card-body xlsx-import-section"><input type="file" id="xlsxFile" accept=".xlsx, .xls"><button class="btn btn-info" id="btnImportXLSX">Importar</button><p>Colunas: 'codigo', 'produto', 'categoria'. Categoria vazia = Sem Categoria.</p></div></div>
            <div class="card"><div class="card-header"><h3>Produtos Cadastrados</h3></div><div class="card-body" style="padding:0;"><table id="productManagementTable"><thead><tr><th>Código</th><th>Produto</th><th>Categoria</th><th>Ação</th></tr></thead><tbody id="productManagementTableBody"></tbody></table></div></div>
        </div>

        <div id="screenInventoryCount" class="screen">
            <button class="btn btn-secondary back-button" id="inventoryCountBackButton">&larr; Voltar</button>
            <h2 id="inventoryCountTitle">Balanço de Estoque</h2>
            <div id="adminContagemEmpresaSelectorContainer" class="admin-context-selector" style="display:none;">
                <label for="adminContagemEmpresaSelect">Realizar Contagem Para Empresa:</label>
                <select id="adminContagemEmpresaSelect"><option value="">-- Contagem Global (Produtos Sem Empresa) --</option></select>
            </div>
            <p id="inventoryCountContext" style="text-align:center; font-size:0.9em; color:var(--text-muted-color); margin-bottom: 1rem;"></p>
            <div class="card card-body">
                <div class="form-group"> 
                    <label for="selectColaboradorContagem">Contagem realizada por:</label>
                    <select id="selectColaboradorContagem" style="margin-bottom: 1rem;"></select>
                </div>
                <div class="actions-bar" style="border:none; padding-bottom:0;">
                     <button class="btn btn-info" id="btnShowPreviewContagem">Ver Resumo</button> 
                     <button class="btn btn-success" id="btnGerarTXT">Gerar TXT & Salvar Histórico</button>
                     <button class="btn btn-warning" id="btnClearAllQuantities">Limpar Quantidades</button>
                </div>
            </div>
            <div class="filter-controls card card-body"><div><label for="pesquisaProduto">Produto:</label><input type="text" id="pesquisaProduto" placeholder="Nome..."></div><div><label for="pesquisaCodigo">Código:</label><input type="text" id="pesquisaCodigo" placeholder="Código..."></div><div><label for="filtroCategoria">Categoria:</label><select id="filtroCategoria"><option value="">Todas</option></select></div></div>
            <table><thead><tr><th>Código</th><th>Produto</th><th>Categoria</th><th>Quantidade</th></tr></thead><tbody id="inventoryTableBody"></tbody></table>
        </div>

        <div id="modalPreviewContagem" class="modal-overlay">
            <div class="modal-content" style="max-width: 700px; text-align:left;">
                <h4>Resumo da Contagem Atual</h4>
                <div id="previewContagemTableContainer" style="max-height: 400px; overflow-y:auto;">
                    <table id="previewContagemTable">
                        <thead><tr><th>Código</th><th>Produto</th><th>Categoria</th><th>Qtd. Digitada</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="modal-actions" style="margin-top: 1.5rem;">
                    <button class="btn btn-secondary" id="btnClosePreviewModal">Fechar</button>
                </div>
            </div>
        </div>
        <div id="modalDetalhesContagem" class="modal-overlay">
            <div class="modal-content" style="max-width: 600px; text-align:left;">
                <h4>Detalhes da Contagem</h4>
                <div id="detalhesContagemConteudo"></div>
                <div class="modal-actions" style="margin-top:1.5rem;">
                    <button class="btn btn-secondary" id="btnCloseDetalhesModal">Fechar</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Certifique-se de que todas as suas funções (handleLogin, showAdminEmpresasScreen, etc.) 
        // estão definidas aqui ANTES da função window.onload.
        // Colei as principais funções modificadas e as que você já tinha.
        // Verifique se alguma função que seus botões chamam está faltando.

        console.log("SCRIPT START - v2.9.9 MODIFICADO v6 - Definições de Função (Corrigido)");
        const SUPABASE_URL = 'https://daeocsintrbdfqclvteg.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhZW9jc2ludHJiZGZxY2x2dGVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM0ODMxNDEsImV4cCI6MjA1OTA1OTE0MX0.BJ61kSxTDiEFway590hoTvVH4yu0FxLnjecqQsYdwK4';
        const { createClient } = supabase;
        const _supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let produtosCache = [], categoriasCache = [], empresasCache = [], colaboradoresCache = [], quantidadesDigitadas = {}; 
        const ADMIN_MASTER_EMAIL = "matheus@mtech.com"; 
        let currentUser = null, adminSelectedEmpresaId = null, adminSelectedEmpresaParaCategoriaId = null;

        let mainContainer, screens = {}, loadingIndicator, loginEmailInput, loginPasswordInput, loginErrorMessage,
            adminMasterNameDisplay, adminNomeEmpresaInput, adminEmpresasTableBody, 
            adminManageLoginEmpresaSection, adminManageLoginEmpresaTitle, selectedEmpresaIdForLoginManage, 
            selectedEmpresaUserIdForLoginManage, adminManageLoginEmpresaContent, manageLoginEmpresaMessage,
            adminCategoriaEmpresaSelect, adminNomeCategoriaInput, adminCategoriasTableBody, 
            colaboradoresEmpresaNomeSpan, colaboradorNomeInput, colaboradoresTableBody, 
            currentPasswordInput, newPasswordInput, confirmNewPasswordInput, changePasswordMessage, 
            changePasswordBackButton, changingPasswordForUserDisplay, currentPasswordGroup,
            historicoEmpresaNomeSpan, historicoContagensTableBody, modalDetalhesContagem, detalhesContagemConteudo,
            productManagementBackButton, productManagementTitle, productManagementContext,
            adminProdutoEmpresaSelectorContainer, adminProdutoEmpresaSelect, prodCodigoInput, prodNomeInput,
            prodCategoriaSelect, productManagementTableBody, xlsxFileInput, inventoryCountBackButton,
            inventoryCountTitle, inventoryCountContext, adminContagemEmpresaSelectorContainer,
            adminContagemEmpresaSelect, selectColaboradorContagem, pesquisaProdutoInput, pesquisaCodigoInput,
            filtroCategoriaSelect, inventoryTableBody, modalPreviewContagem, previewContagemTableContainer,
            empresaDashboardTitle, empresaUserNameSpan,
            adminHistoricoEmpresaSelectorContainer, adminHistoricoEmpresaSelect, historicoBackButton, historicoTitle, historicoContext, colEmpresaHistorico;

        function initializeDOMSelectors() {
            console.log("initializeDOMSelectors v2.9.9 chamado");
            mainContainer = document.getElementById('mainContainer');
            screens = {
                login: document.getElementById('screenLogin'),
                adminMasterDashboard: document.getElementById('screenAdminMasterDashboard'),
                empresaDashboard: document.getElementById('screenEmpresaDashboard'),
                adminEmpresas: document.getElementById('screenAdminEmpresas'),
                adminCategorias: document.getElementById('screenAdminCategorias'), 
                empresaColaboradores: document.getElementById('screenEmpresaColaboradores'),
                changePassword: document.getElementById('screenChangePassword'), 
                historicoContagens: document.getElementById('screenHistoricoContagens'),
                productManagement: document.getElementById('screenProductManagement'),
                inventoryCount: document.getElementById('screenInventoryCount')
            };
            loadingIndicator = document.getElementById('loadingIndicator');
            loginEmailInput = document.getElementById('loginEmail');
            loginPasswordInput = document.getElementById('loginPassword');
            loginErrorMessage = document.getElementById('loginErrorMessage');
            
            function safeGetElementById(id, context = document) {
                const el = context.getElementById(id);
                if (!el) console.warn(`Elemento com ID '${id}' NÃO encontrado em initializeDOMSelectors.`);
                return el;
            }

            Object.keys(screens).forEach(key => {
                if (!screens[key]) console.warn(`Elemento de tela screens.${key} (ID de referência: ${key}) NÃO encontrado na atribuição inicial.`);
            });
            
            adminMasterNameDisplay = safeGetElementById('adminMasterNameDisplay');
            adminNomeEmpresaInput = safeGetElementById('adminNomeEmpresa');
            adminEmpresasTableBody = safeGetElementById('adminEmpresasTableBody');
            adminManageLoginEmpresaSection = safeGetElementById('adminManageLoginEmpresaSection');
            adminManageLoginEmpresaTitle = safeGetElementById('adminManageLoginEmpresaTitle');
            selectedEmpresaIdForLoginManage = safeGetElementById('selectedEmpresaIdForLoginManage'); 
            selectedEmpresaUserIdForLoginManage = safeGetElementById('selectedEmpresaUserIdForLoginManage'); 
            adminManageLoginEmpresaContent = safeGetElementById('adminManageLoginEmpresaContent');
            manageLoginEmpresaMessage = safeGetElementById('manageLoginEmpresaMessage');
            adminCategoriaEmpresaSelect = safeGetElementById('adminCategoriaEmpresaSelect');
            adminNomeCategoriaInput = safeGetElementById('adminNomeCategoria');
            adminCategoriasTableBody = safeGetElementById('adminCategoriasTableBody');
            colaboradoresEmpresaNomeSpan = safeGetElementById('colaboradoresEmpresaNome');
            colaboradorNomeInput = safeGetElementById('colaboradorNome');
            colaboradoresTableBody = safeGetElementById('colaboradoresTableBody');
            currentPasswordInput = safeGetElementById('currentPasswordInput');
            newPasswordInput = safeGetElementById('newPasswordInput');
            confirmNewPasswordInput = safeGetElementById('confirmNewPasswordInput');
            changePasswordMessage = safeGetElementById('changePasswordMessage');
            changePasswordBackButton = safeGetElementById('changePasswordBackButton');
            changingPasswordForUserDisplay = safeGetElementById('changingPasswordForUserDisplay');
            currentPasswordGroup = safeGetElementById('currentPasswordGroup');
            historicoEmpresaNomeSpan = safeGetElementById('historicoEmpresaNomeSpan'); 
            historicoContagensTableBody = safeGetElementById('historicoContagensTableBody');
            modalDetalhesContagem = safeGetElementById('modalDetalhesContagem');
            detalhesContagemConteudo = safeGetElementById('detalhesContagemConteudo');
            adminHistoricoEmpresaSelectorContainer = safeGetElementById('adminHistoricoEmpresaSelectorContainer');
            adminHistoricoEmpresaSelect = safeGetElementById('adminHistoricoEmpresaSelect');
            historicoBackButton = safeGetElementById('historicoBackButton'); 
            historicoTitle = safeGetElementById('historicoTitle'); 
            historicoContext = safeGetElementById('historicoContext'); 
            colEmpresaHistorico = safeGetElementById('colEmpresaHistorico'); 
            productManagementBackButton = safeGetElementById('productManagementBackButton');
            productManagementTitle = safeGetElementById('productManagementTitle');
            productManagementContext = safeGetElementById('productManagementContext');
            adminProdutoEmpresaSelectorContainer = safeGetElementById('adminProdutoEmpresaSelectorContainer');
            adminProdutoEmpresaSelect = safeGetElementById('adminProdutoEmpresaSelect');
            prodCodigoInput = safeGetElementById('prodCodigo');
            prodNomeInput = safeGetElementById('prodNome');
            prodCategoriaSelect = safeGetElementById('prodCategoriaSelect'); 
            productManagementTableBody = safeGetElementById('productManagementTableBody');
            xlsxFileInput = safeGetElementById('xlsxFile');
            inventoryCountBackButton = safeGetElementById('inventoryCountBackButton');
            inventoryCountTitle = safeGetElementById('inventoryCountTitle');
            inventoryCountContext = safeGetElementById('inventoryCountContext');
            adminContagemEmpresaSelectorContainer = safeGetElementById('adminContagemEmpresaSelectorContainer');
            adminContagemEmpresaSelect = safeGetElementById('adminContagemEmpresaSelect');
            selectColaboradorContagem = safeGetElementById('selectColaboradorContagem');
            pesquisaProdutoInput = safeGetElementById('pesquisaProduto');
            pesquisaCodigoInput = safeGetElementById('pesquisaCodigo');
            filtroCategoriaSelect = document.getElementById('filtroCategoria'); 
            inventoryTableBody = safeGetElementById('inventoryTableBody');
            modalPreviewContagem = safeGetElementById('modalPreviewContagem'); 
            previewContagemTableContainer = safeGetElementById('previewContagemTableContainer'); 
            empresaDashboardTitle = safeGetElementById('empresaDashboardTitle');
            empresaUserNameSpan = safeGetElementById('empresaUserName');
            console.log("DOM Selectors initialization complete.");
        }

        function saveQuantities() { try { localStorage.setItem('balancoQuantities_v2.9.9', JSON.stringify(quantidadesDigitadas)); } catch (e) { console.error("Erro ao salvar quantidades no localStorage:", e); }}
        function loadQuantities() { try { const stored = localStorage.getItem('balancoQuantities_v2.9.9'); quantidadesDigitadas = stored ? JSON.parse(stored) : {}; } catch (e) { console.error("Erro ao carregar quantidades:", e); quantidadesDigitadas = {}; }}
        function showLoader() { if (loadingIndicator) loadingIndicator.style.display = 'block'; }
        function hideLoader() { if (loadingIndicator) loadingIndicator.style.display = 'none'; }
        function generateNumericPassword(length = 6) { let pw = ''; for (let i = 0; i < length; i++) { pw += Math.floor(Math.random() * 10); } return pw; }
        
        async function populateEmpresasSelect(selectElementId, includeSpecialOption = false, specialOptionText = "-- Selecione --", specialOptionValue = "") { 
            const selectEmp = document.getElementById(selectElementId);
            if (!selectEmp) { console.warn(`Select de empresa ${selectElementId} não encontrado.`); return; }
            const currentValue = selectEmp.value; 
            selectEmp.innerHTML = ''; 
            if (includeSpecialOption) {
                const opt = document.createElement('option'); opt.value = specialOptionValue; opt.textContent = specialOptionText; selectEmp.appendChild(opt);
            }
            if (empresasCache.length === 0) {
                try {
                    const { data, error } = await _supabaseClient.from('empresas').select('id, nome_empresa').order('nome_empresa');
                    if (error) throw error; empresasCache = data || [];
                } catch (e) { console.error("Erro ao buscar empresas para select:", e); if(selectEmp) selectEmp.innerHTML = '<option value="">Erro ao carregar</option>'; return; }
            }
            empresasCache.forEach(emp => { const option = document.createElement('option'); option.value = emp.id; option.textContent = emp.nome_empresa; selectEmp.appendChild(option); });
            if (Array.from(selectEmp.options).some(opt => opt.value === currentValue)) { selectEmp.value = currentValue; } 
            else if (includeSpecialOption) { selectEmp.value = specialOptionValue; }
        }

        function showScreen(screenId, screenConfig = {}) {
            hideLoader(); 
            const mainCont = document.getElementById('mainContainer'); 
            const targetScreenElement = screens[screenId]; 
            Object.values(screens).forEach(sE => { if (sE && sE.classList) sE.classList.remove('active');});
            if (targetScreenElement && targetScreenElement.classList) {
                targetScreenElement.classList.add('active');
                if (mainCont) { mainCont.classList.toggle('content-container', ['adminEmpresas', 'adminCategorias', 'productManagement', 'inventoryCount', 'empresaColaboradores', 'historicoContagens'].includes(screenId));}
                ['adminProdutoEmpresaSelectorContainer', 'adminContagemEmpresaSelectorContainer', 'adminHistoricoEmpresaSelectorContainer', 'colEmpresaHistorico'].forEach(id => { const el = document.getElementById(id); if(el) el.style.display = 'none';});
                
                const { title, context, showEmpresaSelector, showEmpresaColumnInTable } = screenConfig;
                if (screenId === 'productManagement') {
                    if(document.getElementById('productManagementTitle')) document.getElementById('productManagementTitle').textContent = title || 'Gerenciar Produtos';
                    if(document.getElementById('productManagementContext') && context !== undefined) document.getElementById('productManagementContext').textContent = context;
                    else if (document.getElementById('productManagementContext')) document.getElementById('productManagementContext').textContent = ''; // Clear context if not provided
                    if (currentUser?.user_metadata?.user_role === 'admin_master' && showEmpresaSelector && document.getElementById('adminProdutoEmpresaSelectorContainer')) document.getElementById('adminProdutoEmpresaSelectorContainer').style.display = 'block';
                } else if (screenId === 'inventoryCount') {
                    if(document.getElementById('inventoryCountTitle')) document.getElementById('inventoryCountTitle').textContent = title || 'Balanço de Estoque';
                    if(document.getElementById('inventoryCountContext') && context !== undefined) document.getElementById('inventoryCountContext').textContent = context;
                    else if (document.getElementById('inventoryCountContext')) document.getElementById('inventoryCountContext').textContent = '';
                    if (currentUser?.user_metadata?.user_role === 'admin_master' && showEmpresaSelector && document.getElementById('adminContagemEmpresaSelectorContainer')) document.getElementById('adminContagemEmpresaSelectorContainer').style.display = 'block';
                } else if (screenId === 'historicoContagens') { 
                    if(document.getElementById('historicoTitle')) document.getElementById('historicoTitle').textContent = title || 'Histórico de Contagens';
                    if(document.getElementById('historicoEmpresaNomeSpan') && currentUser?.role === 'empresa_login_principal') document.getElementById('historicoEmpresaNomeSpan').textContent = currentUser.empresa_nome || '';
                    else if(document.getElementById('historicoEmpresaNomeSpan')) document.getElementById('historicoEmpresaNomeSpan').textContent = '';

                    if(document.getElementById('historicoContext') && context !== undefined) document.getElementById('historicoContext').textContent = context;
                    else if (document.getElementById('historicoContext')) document.getElementById('historicoContext').textContent = '';

                    if (currentUser?.user_metadata?.user_role === 'admin_master' && showEmpresaSelector && document.getElementById('adminHistoricoEmpresaSelectorContainer')) document.getElementById('adminHistoricoEmpresaSelectorContainer').style.display = 'block';
                    if (document.getElementById('colEmpresaHistorico')) document.getElementById('colEmpresaHistorico').style.display = (currentUser?.user_metadata?.user_role === 'admin_master' && showEmpresaColumnInTable) ? '' : 'none';
                } else if (screenId === 'empresaDashboard' && currentUser) {
                    if(document.getElementById('empresaDashboardTitle')) document.getElementById('empresaDashboardTitle').textContent = `Painel: ${currentUser.empresa_nome || 'Minha Empresa'}`;
                    if(document.getElementById('empresaUserName')) document.getElementById('empresaUserName').textContent = currentUser.full_name || currentUser.email;
                } else if (screenId === 'adminMasterDashboard' && currentUser && document.getElementById('adminMasterNameDisplay')) {
                     document.getElementById('adminMasterNameDisplay').textContent = currentUser.full_name || currentUser.email;  
                } else if (screenId === 'changePassword' && currentUser) {
                    if(document.getElementById('changingPasswordForUserDisplay')) document.getElementById('changingPasswordForUserDisplay').textContent = currentUser.email;
                    if(document.getElementById('currentPasswordGroup')) document.getElementById('currentPasswordGroup').style.display = (currentUser?.user_metadata?.user_role !== 'admin_master' && currentUser?.role !== 'admin_master') ? 'block' : 'none';
                }
            } else {
                console.error(`CRITICAL: Tela '${screenId}' não encontrada. Fallback para login.`);
                const loginSc = document.getElementById('screenLogin'); if (loginSc) loginSc.classList.add('active'); else if(document.body) document.body.innerHTML="Erro UI.";
            }
            window.scrollTo(0,0); 
        }
        function isMobileDevice() { return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent); }
        function triggerDownload(filename, textContent) { const blob = new Blob([textContent],{type:'text/plain;charset=utf-8'}); const link=document.createElement("a"); link.href=URL.createObjectURL(blob); link.download=filename; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(link.href); console.log(`Download ${filename} disparado.`); }

        async function handleLogin() {
            console.log("handleLogin v2.9.9 MODIFICADO v6 chamado");
            if (!loginEmailInput || !loginPasswordInput || !loginErrorMessage) {
                console.error("handleLogin: Elementos do formulário de login não encontrados!");
                alert("Erro crítico no formulário de login. Tente recarregar."); hideLoader(); return;
            }
            const email = loginEmailInput.value.trim();
            const password = loginPasswordInput.value.trim();
            loginErrorMessage.textContent = ""; loginErrorMessage.style.display = "none";

            if (!email || !password) {
                loginErrorMessage.textContent = "Por favor, preencha email e senha.";
                loginErrorMessage.style.display = "block"; return;
            }
            showLoader();
            console.log("Tentando login Supabase para:", email);

            try {
                const { data: signInData, error: signInError } = await _supabaseClient.auth.signInWithPassword({ email, password });

                if (signInError) { console.error("Supabase signIn Error:", signInError); throw signInError; }
                if (!signInData || !signInData.user) { console.error("No user data from Supabase signIn."); throw new Error("Usuário não retornado. Verifique credenciais.");}
                
                console.log("Supabase signIn OK. User ID:", signInData.user.id, "Metadata:", signInData.user.user_metadata);

                const userRoleFromJWT = signInData.user.user_metadata?.user_role;
                const userFullNameFromJWT = signInData.user.user_metadata?.full_name || signInData.user.email;

                if (userRoleFromJWT === 'admin_master') {
                    currentUser = {
                        id: signInData.user.id, email: signInData.user.email, role: 'admin_master', 
                        user_metadata: signInData.user.user_metadata, full_name: userFullNameFromJWT
                    };
                    console.log("Admin Master Logado via Supabase Auth:", currentUser);
                    await Promise.all([ 
                        populateEmpresasSelect('adminCategoriaEmpresaSelect', true, "-- Categoria Global --", ""),
                        populateEmpresasSelect('adminProdutoEmpresaSelect', true, "-- Produtos Globais (Sem Empresa) --", ""),
                        populateEmpresasSelect('adminContagemEmpresaSelect', true, "-- Contagem Global (Produtos Sem Empresa) --", ""),
                        populateEmpresasSelect('adminHistoricoEmpresaSelect', true, "-- Todas as Empresas --", "ALL_EMPRESAS")
                    ]);
                    showAdminMasterDashboardScreen();
                } else {
                    const { data: profile, error: profileError } = await _supabaseClient
                        .from('user_profiles').select('empresa_id, role, full_name, empresas (id, nome_empresa)')
                        .eq('id', signInData.user.id).single();

                    if (profileError && profileError.code !== 'PGRST116') { 
                        console.error("Erro ao buscar perfil:", profileError); await _supabaseClient.auth.signOut(); throw profileError;
                    }
                    if (!profile) { 
                        console.warn("Perfil não encontrado:", signInData.user.id); await _supabaseClient.auth.signOut();
                        throw new Error("Perfil do usuário não encontrado. Contate o suporte.");
                    }
                    if (profile.role === 'empresa_login_principal' && profile.empresa_id && profile.empresas) {
                        currentUser = {
                            id: signInData.user.id, email: signInData.user.email, role: profile.role, 
                            user_metadata: signInData.user.user_metadata, empresa_id: profile.empresa_id,
                            empresa_nome: profile.empresas.nome_empresa || 'Empresa Associada',
                            full_name: profile.full_name || signInData.user.email
                        };
                        console.log("Usuário de Empresa OK:", currentUser);
                        await showEmpresaDashboardScreen();
                    } else {
                        console.warn("Perfil inválido ou dados da empresa ausentes:", email, profile);
                        await _supabaseClient.auth.signOut();
                        throw new Error("Conta de empresa inválida/não configurada.");
                    }
                }
            } catch (e) {
                console.error("Catch em login:", e);
                loginErrorMessage.textContent = e.message.includes("Invalid login credentials") ? "Email ou senha inválidos."
                                                : (e.message.includes("Email not confirmed") ? "Email não confirmado." 
                                                : (e.message || "Erro desconhecido."));
                loginErrorMessage.style.display = "block";
            } finally {
                hideLoader();
            }
        }

        async function handleLogout() { 
            console.log("handleLogout chamado"); showLoader();
            try {
                const { error } = await _supabaseClient.auth.signOut();
                if (error) { console.error("Erro no logout do Supabase:", error); }
                currentUser = null; adminSelectedEmpresaId = null; adminSelectedEmpresaParaCategoriaId = null;
                if(loginEmailInput) loginEmailInput.value = ""; if(loginPasswordInput) loginPasswordInput.value = "";
                produtosCache = []; categoriasCache = []; empresasCache = []; colaboradoresCache = [];
                quantidadesDigitadas = {}; localStorage.removeItem('balancoQuantities_v2.9.9'); 
                showScreen('login'); console.log("Usuário deslogado.");
            } catch (e) { console.error("Erro logout:", e); } finally { hideLoader(); }
        }

        function showAdminMasterDashboardScreen() { adminSelectedEmpresaId = null; adminSelectedEmpresaParaCategoriaId = null; showScreen('adminMasterDashboard'); }
        async function showEmpresaDashboardScreen() { adminSelectedEmpresaId = currentUser?.empresa_id; showScreen('empresaDashboard');}
        
        async function showAdminEmpresasScreen() { 
            if (!currentUser || currentUser?.user_metadata?.user_role !== 'admin_master') { handleLogout(); return; }
            showLoader();
            try {
                if (adminManageLoginEmpresaSection) adminManageLoginEmpresaSection.style.display = 'none';
                await fetchAndRenderEmpresas(); 
                showScreen('adminEmpresas'); 
            } catch (e) { console.error("Erro showAdminEmpresasScreen:", e); alert("Erro tela empresas."); hideLoader(); }
        }

        async function fetchAndRenderEmpresas() { 
            if (!adminEmpresasTableBody) {console.error("adminEmpresasTableBody não encontrado"); return;}
            adminEmpresasTableBody.innerHTML = '<tr><td colspan="3">Carregando...</td></tr>';
            try {
                const { data, error } = await _supabaseClient.from('empresas').select('id, nome_empresa, created_at').order('nome_empresa'); 
                if (error) throw error;
                empresasCache = data || []; tableBody = adminEmpresasTableBody; tableBody.innerHTML = ""; 
                if (empresasCache.length > 0) {
                    empresasCache.forEach(empresa => {
                        const row = tableBody.insertRow();
                        row.insertCell().textContent = empresa.nome_empresa;
                        row.insertCell().textContent = new Date(empresa.created_at).toLocaleDateString('pt-BR');
                        const actionsCell = row.insertCell();
                        const btnManageLogin = document.createElement('button'); 
                        btnManageLogin.textContent = 'Gerenciar Login'; 
                        btnManageLogin.className = 'btn btn-info table-actions';
                        btnManageLogin.onclick = () => handleShowManageLoginSection(empresa.id, empresa.nome_empresa); 
                        actionsCell.appendChild(btnManageLogin);
                        const btnManageColabs = document.createElement('button');
                        btnManageColabs.textContent = 'Colaboradores'; btnManageColabs.className = 'btn btn-secondary table-actions';
                        btnManageColabs.onclick = () => showEmpresaColaboradoresScreen(empresa.id, empresa.nome_empresa, true); 
                        actionsCell.appendChild(btnManageColabs);
                    });
                } else { tableBody.innerHTML = '<tr><td colspan="3">Nenhuma empresa.</td></tr>'; }
            } catch (e) { console.error("Erro listar empresas:", e); if(adminEmpresasTableBody) adminEmpresasTableBody.innerHTML = `<tr><td colspan="3" style="color:var(--danger-color);">Erro: ${e.message}</td></tr>`;}
        }

        async function handleAdminAddEmpresa() { 
            if(!adminNomeEmpresaInput) return; const nomeEmpresa = adminNomeEmpresaInput.value.trim();
            if (!nomeEmpresa) { alert('Digite o nome da empresa.'); return; }
            showLoader();
            try {
                const { data: existing } = await _supabaseClient.from('empresas').select('id').ilike('nome_empresa', nomeEmpresa).single();
                if (existing) { alert('Empresa já existe.'); hideLoader(); return; }
                const { data: novaEmpresa, error } = await _supabaseClient.from('empresas').insert([{ nome_empresa: nomeEmpresa }]).select().single();
                if (error) throw error;
                if (novaEmpresa && empresasCache) empresasCache.push(novaEmpresa); 
                alert('Empresa adicionada!'); adminNomeEmpresaInput.value = ''; 
                await fetchAndRenderEmpresas(); 
            } catch (e) { console.error("Erro add empresa:", e); alert('Falha: ' + e.message); } finally { hideLoader(); }
        }
        
        async function handleShowManageLoginSection(empresaId, nomeEmpresa) {
            console.log("handleShowManageLoginSection para empresa:", nomeEmpresa, empresaId);
            if (!adminManageLoginEmpresaSection || !adminManageLoginEmpresaTitle || !selectedEmpresaIdForLoginManage || !adminManageLoginEmpresaContent || !manageLoginEmpresaMessage) {
                console.error("Elementos da UI para gerenciar login de empresa não foram encontrados."); return;
            }
            showLoader();
            adminManageLoginEmpresaTitle.textContent = `Gerenciar Login Principal para: ${nomeEmpresa}`;
            selectedEmpresaIdForLoginManage.value = empresaId; 
            adminManageLoginEmpresaContent.innerHTML = '<p>Verificando login existente...</p>';
            manageLoginEmpresaMessage.style.display = 'none'; manageLoginEmpresaMessage.textContent = '';
            adminManageLoginEmpresaSection.style.display = 'block';

            try {
                const { data: existingProfile, error: profileError } = await _supabaseClient
                    .from('user_profiles')
                    .select('id, email, full_name') 
                    .eq('empresa_id', empresaId)
                    .eq('role', 'empresa_login_principal')
                    .maybeSingle();

                if (profileError) throw profileError;

                const userIdHiddenInput = document.getElementById('selectedEmpresaUserIdForLoginManage');

                if (existingProfile) {
                    if(userIdHiddenInput) userIdHiddenInput.value = existingProfile.id;
                    adminManageLoginEmpresaContent.innerHTML = `
                        <p>Login já definido para esta empresa:</p>
                        <p><strong>Email:</strong> <span id="currentEmpresaLoginEmailDisplay">${existingProfile.email}</span></p>
                        <p><strong>Nome de Referência:</strong> ${existingProfile.full_name || 'Não definido'}</p>
                        <button class="btn btn-warning" id="btnExecuteResetSenhaEmpresa" style="margin-top:1rem;">Resetar Senha Deste Login</button>
                    `;
                    const btnReset = document.getElementById('btnExecuteResetSenhaEmpresa');
                    if(btnReset) btnReset.onclick = () => callResetPasswordEdgeFunction(existingProfile.id, existingProfile.email, nomeEmpresa);
                } else {
                    if(userIdHiddenInput) userIdHiddenInput.value = '';
                    adminManageLoginEmpresaContent.innerHTML = `
                        <p>Nenhum login principal definido para esta empresa.</p>
                        <div class="form-group">
                            <label for="adminEmpresaLoginEmailNew">Email para Novo Login:</label>
                            <input type="email" id="adminEmpresaLoginEmailNew" placeholder="${nomeEmpresa.toLowerCase().replace(/\s+/g, '.').replace(/[^a-z0-9.-_]/gi, '')}@login.sistema">
                        </div>
                        <div class="form-group">
                            <label for="adminEmpresaLoginFullNameNew">Nome de Referência do Login:</label>
                            <input type="text" id="adminEmpresaLoginFullNameNew" placeholder="Login Principal ${nomeEmpresa}">
                        </div>
                        <button class="btn btn-success" id="btnExecutarCriarNovoLoginEmpresa">Criar Novo Login e Gerar Senha</button>
                    `;
                    const emailInputNew = document.getElementById('adminEmpresaLoginEmailNew');
                    const fullNameInputNew = document.getElementById('adminEmpresaLoginFullNameNew');
                    if(emailInputNew) emailInputNew.value = `${nomeEmpresa.toLowerCase().replace(/\s+/g, '.').replace(/[^a-z0-9.-_]/gi, '')}@login.sistema`;
                    if(fullNameInputNew) fullNameInputNew.value = `Login Principal ${nomeEmpresa}`;
                    
                    const btnCreate = document.getElementById('btnExecutarCriarNovoLoginEmpresa');
                    if(btnCreate) btnCreate.onclick = () => handleAdminCreateOrUpdateEmpresaLogin();
                }
            } catch(e) {
                console.error("Erro em handleShowManageLoginSection:", e);
                adminManageLoginEmpresaContent.innerHTML = `<p style="color:var(--danger-color)">Erro ao verificar/gerenciar login: ${e.message}</p>`;
            } finally {
                hideLoader();
            }
        }
        
        function closeAdminManageLoginEmpresaSection() { 
            if(adminManageLoginEmpresaSection) adminManageLoginEmpresaSection.style.display = 'none';
        }

        async function handleAdminCreateOrUpdateEmpresaLogin() { 
            console.log("handleAdminCreateOrUpdateEmpresaLogin (v6 - confia no trigger) chamada");
            const empresaId = document.getElementById('selectedEmpresaIdForLoginManage').value;
            const titleEl = document.getElementById('adminManageLoginEmpresaTitle');
            const titleText = titleEl ? titleEl.textContent : '';
            const match = titleText.match(/Gerenciar Login Principal para:\s*(.*)/);
            const empresaNome = match && match[1] ? match[1].trim() : 'Empresa Desconhecida';
            
            const emailEl = document.getElementById('adminEmpresaLoginEmailNew');
            const fullNameEl = document.getElementById('adminEmpresaLoginFullNameNew');
            
            if (!emailEl || !fullNameEl || !manageLoginEmpresaMessage || !empresaId) { 
                alert("Erro de interface ou ID da empresa faltando. Recarregue."); return; 
            }

            const email = emailEl.value.trim();
            const fullName = fullNameEl.value.trim(); 

            if (!email) { alert("Email é obrigatório."); emailEl.focus(); return; }
            if (!fullName) { alert("Nome de referência é obrigatório."); fullNameEl.focus(); return; }

            const password = generateNumericPassword(6);
            showLoader();
            manageLoginEmpresaMessage.style.display = 'none'; manageLoginEmpresaMessage.textContent = '';

            try {
                await _supabaseClient.auth.signOut().catch(()=>{ console.warn("Nenhuma sessão para deslogar ou erro no signOut opcional.")}); 

                const { data: authData, error: signUpError } = await _supabaseClient.auth.signUp({
                    email, password,
                    options: { data: { empresa_id: empresaId, role: 'empresa_login_principal', full_name: fullName } }
                });

                if (signUpError) {
                     if (signUpError.message.toLowerCase().includes("user already registered") || signUpError.message.toLowerCase().includes("already exists")) {
                        throw new Error(`Email ${email} já está registrado no Supabase Auth. Para definir uma nova senha para um login existente, use a opção "Resetar Senha". Se você tem certeza que quer usar este email para esta empresa e ele não deveria existir, delete o usuário da lista "Authentication" no painel do Supabase e tente criar novamente.`);
                    }
                    throw signUpError;
                }

                if (authData.user) {
                    console.log("Novo usuário criado na Auth:", authData.user.id, authData.user.email);
                    console.log("A criação do perfil em 'user_profiles' é de responsabilidade do trigger 'on_auth_user_created' -> 'handle_new_user()'.");

                    let successMsg = `Novo login para ${empresaNome} (${email}) criado com sucesso!`;
                    successMsg += `\nSenha Gerada: ${password}\nInforme ao responsável.`;
                    if (authData.user.email_confirmed_at === null && (authData.user.phone_confirmed_at === null || typeof authData.user.phone_confirmed_at === 'undefined')) {
                        successMsg += `\nNota: Se a confirmação de email estiver ATIVA no Supabase, o usuário ${email} precisará confirmar o email.`;
                    }
                
                    manageLoginEmpresaMessage.innerHTML = successMsg.replace(/\n/g, '<br>');
                    manageLoginEmpresaMessage.style.display = 'block';
                    manageLoginEmpresaMessage.style.color = 'var(--success-color)';
                    
                    await handleShowManageLoginSection(empresaId, empresaNome);

                } else {
                    console.warn("authData.user é null após signUp. authData:", authData);
                    throw new Error("Não foi possível obter dados do usuário após cadastro (authData.user nulo).");
                }
            } catch (e) {
                console.error("Catch final em handleAdminCreateOrUpdateEmpresaLogin:", e);
                manageLoginEmpresaMessage.textContent = `Erro ao criar login: ${e.message}`;
                manageLoginEmpresaMessage.style.color = 'var(--danger-color)';
                manageLoginEmpresaMessage.style.display = 'block';
            } finally {
                hideLoader();
            }
        }

        async function callResetPasswordEdgeFunction(userId, userEmail, nomeEmpresa) {
            if (!userId || !userEmail) { alert("ID do usuário ou email não fornecido para resetar senha."); return; }
            if (!confirm(`Tem certeza que deseja resetar a senha para o login ${userEmail} da empresa ${nomeEmpresa}? Uma nova senha será gerada.`)) return;
            
            showLoader();
            if(manageLoginEmpresaMessage) { manageLoginEmpresaMessage.style.display = 'none'; manageLoginEmpresaMessage.textContent = ''; }

            try {
                console.log(`Invocando Edge Function 'reset-empresa-password' para userId: ${userId}`);
                const { data, error } = await _supabaseClient.functions.invoke('reset-empresa-password', {
                    body: JSON.stringify({ target_user_id: userId }) 
                });

                if (error) { throw new Error(error.message || "Falha ao chamar função de reset."); }
                if (data.error) { throw new Error(data.error); }
                
                console.log("Resposta da Edge Function:", data);
                let successMsg = data.message || `Senha para ${userEmail} resetada!`;
                if (data.newPassword) { successMsg += `\nNova Senha Gerada: ${data.newPassword}\nInforme ao responsável.`; }
                
                if(manageLoginEmpresaMessage) {
                    manageLoginEmpresaMessage.innerHTML = successMsg.replace(/\n/g, '<br>');
                    manageLoginEmpresaMessage.style.display = 'block';
                    manageLoginEmpresaMessage.style.color = 'var(--success-color)';
                } else { alert(successMsg.replace(/\n/g, '\n')); }
            } catch (e) {
                console.error("Erro ao resetar senha via Edge Function:", e);
                if(manageLoginEmpresaMessage) {
                    manageLoginEmpresaMessage.textContent = `Erro reset senha: ${e.message}`;
                    manageLoginEmpresaMessage.style.color = 'var(--danger-color)';
                    manageLoginEmpresaMessage.style.display = 'block';
                } else { alert(`Erro reset senha: ${e.message}`);}
            } finally { hideLoader(); }
        }
        
        async function gerarArquivoTXT() {
            console.log("gerarArquivoTXT v2.9.9 (MODIFICADO v6) iniciada");
            showLoader();
            const colaboradorSelect = document.getElementById('selectColaboradorContagem');
            if (!colaboradorSelect) { alert("Erro: Seletor de colaborador não encontrado."); hideLoader(); return; }
            const colaboradorId = colaboradorSelect.value;
            const colaboradorNome = colaboradorSelect.options[colaboradorSelect.selectedIndex]?.text || "N/A";
            if (!colaboradorId) { alert("Selecione o colaborador."); hideLoader(); return; }
            const produtosContados = produtosCache.filter(p => quantidadesDigitadas[p.id] && parseFloat(quantidadesDigitadas[p.id]) > 0);
            if (produtosContados.length === 0) { alert("Nenhum produto com quantidade > 0."); hideLoader(); return; }

            let conteudoTXT = "";
            produtosContados.forEach(produto => {
                const codigo = produto.codigo_produto || produto.id; 
                const quantidade = parseFloat(quantidadesDigitadas[produto.id]);
                conteudoTXT += `${codigo};${quantidade}\n`; 
            });

            const dataAtual = new Date();
            const nomeArquivo = `balanco_est_${dataAtual.getFullYear()}${String(dataAtual.getMonth() + 1).padStart(2, '0')}${String(dataAtual.getDate()).padStart(2, '0')}_${String(dataAtual.getHours()).padStart(2, '0')}${String(dataAtual.getMinutes()).padStart(2, '0')}.txt`;
            try {
                const empresaContextoId = (currentUser?.user_metadata?.user_role === 'admin_master' && adminSelectedEmpresaId) ? adminSelectedEmpresaId : (currentUser.empresa_id || null);
                const { error: histError } = await _supabaseClient.from('historico_contagens').insert({
                    empresa_id: empresaContextoId, colaborador_id: colaboradorId, colaborador_nome: colaboradorNome,
                    itens_contados: produtosContados.length,
                    dados_contagem: produtosContados.map(p => ({
                        produto_id: p.id, codigo: p.codigo_produto || p.id, nome: p.nome_produto, 
                        categoria: categoriasCache.find(c => c.id === p.categoria_id)?.nome_categoria || "Sem Categoria",
                        quantidade: parseFloat(quantidadesDigitadas[p.id])
                    }))
                });
                if (histError) { console.error("Erro ao salvar histórico:", histError); alert(`Erro histórico: ${histError.message}`); hideLoader(); return; }
                console.log("Histórico salvo.");
                if (isMobileDevice()) {
                    const blob = new Blob([conteudoTXT],{type:'text/plain;charset=utf-8'}); const file = new File([blob],nomeArquivo,{type:'text/plain;charset=utf-8'});
                    if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                        try { await navigator.share({ files: [file], title: nomeArquivo, text: `Balanço: ${nomeArquivo}` }); alert('Compartilhe o arquivo!'); clearAllQuantities(); }
                        catch (error) { if (error.name !== 'AbortError') { console.error('Erro Web Share:', error); alert(`Falha compartilhar. Baixando.`); triggerDownload(nomeArquivo, conteudoTXT); clearAllQuantities(); } else { alert('Compartilhamento cancelado.');}}
                    } else { triggerDownload(nomeArquivo, conteudoTXT); alert(`Arquivo baixado. Share API (arquivos) não disponível.`); clearAllQuantities(); }
                } else { triggerDownload(nomeArquivo, conteudoTXT); alert(`Arquivo "${nomeArquivo}" gerado, baixado e histórico salvo!`); clearAllQuantities(); }
            } catch (error) { console.error("Erro gerarTXT:", error); alert(`Erro contagem: ${error.message}`); } finally { hideLoader(); }
        }
        
        // --- DEFINIÇÕES DAS FUNÇÕES DE TELA (Implementadas ou Stubs) ---
        async function showAdminCategoriasScreen() {
            if (!currentUser || currentUser?.user_metadata?.user_role !== 'admin_master') { handleLogout(); return; }
            console.log("showAdminCategoriasScreen chamada");
            showLoader();
            try {
                adminSelectedEmpresaParaCategoriaId = null; // Reset or manage this based on selection
                const adminCatEmpSelect = document.getElementById('adminCategoriaEmpresaSelect');
                 await populateEmpresasSelect('adminCategoriaEmpresaSelect', true, "-- Categoria Global --", ""); // Ensure it's populated
                if (adminCatEmpSelect) {
                    adminCatEmpSelect.value = ""; // Default to global
                     if (!adminCatEmpSelect.onchangeAttached_cat) {
                        adminCatEmpSelect.addEventListener('change', async () => {
                            adminSelectedEmpresaParaCategoriaId = adminCatEmpSelect.value === "" ? null : adminCatEmpSelect.value;
                            await fetchAndRenderCategorias();
                        });
                        adminCatEmpSelect.onchangeAttached_cat = true;
                    }
                    adminCatEmpSelect.dispatchEvent(new Event('change')); // Trigger initial load
                } else {
                     await fetchAndRenderCategorias(); // Load global if select not found or no specific logic
                }
                showScreen('adminCategorias');
            } catch (e) {
                console.error("Erro em showAdminCategoriasScreen:", e);
                alert("Erro ao carregar tela de categorias.");
            } finally {
                hideLoader();
            }
        }

        async function fetchAndRenderCategorias() {
            if (!adminCategoriasTableBody) { console.error("adminCategoriasTableBody não encontrado"); return; }
            adminCategoriasTableBody.innerHTML = '<tr><td colspan="4">Carregando categorias...</td></tr>';
            showLoader();
            try {
                let query = _supabaseClient.from('categorias').select('id, nome_categoria, created_at, empresa_id, empresas (nome_empresa)');
                
                const selectedEmpresaIdForCat = document.getElementById('adminCategoriaEmpresaSelect')?.value;

                if (selectedEmpresaIdForCat && selectedEmpresaIdForCat !== "") {
                    query = query.eq('empresa_id', selectedEmpresaIdForCat);
                } else {
                    query = query.is('empresa_id', null); // Global categories
                }
                query = query.order('nome_categoria');

                const { data, error } = await query;
                if (error) throw error;

                categoriasCache = data || []; // Update local cache if needed, or use a dedicated one for this view
                adminCategoriasTableBody.innerHTML = "";
                if (data && data.length > 0) {
                    data.forEach(cat => {
                        const row = adminCategoriasTableBody.insertRow();
                        row.insertCell().textContent = cat.nome_categoria;
                        const escopoCell = row.insertCell();
                        escopoCell.textContent = cat.empresa_id ? (cat.empresas?.nome_empresa || `Empresa ID: ${cat.empresa_id}`) : "Global";
                        row.insertCell().textContent = new Date(cat.created_at).toLocaleDateString('pt-BR');
                        
                        const actionsCell = row.insertCell();
                        const btnDelete = document.createElement('button');
                        btnDelete.textContent = 'Excluir';
                        btnDelete.className = 'btn btn-danger table-actions';
                        btnDelete.onclick = () => handleAdminDeleteCategoria(cat.id, cat.nome_categoria);
                        actionsCell.appendChild(btnDelete);
                    });
                } else {
                    adminCategoriasTableBody.innerHTML = '<tr><td colspan="4">Nenhuma categoria encontrada para o filtro selecionado.</td></tr>';
                }
            } catch (e) {
                console.error("Erro ao buscar/renderizar categorias:", e);
                adminCategoriasTableBody.innerHTML = `<tr><td colspan="4" style="color:var(--danger-color);">Erro ao carregar: ${e.message}</td></tr>`;
            } finally {
                hideLoader();
            }
        }

        async function handleAdminAddCategoria() {
            if (!adminNomeCategoriaInput || !adminCategoriaEmpresaSelect) {
                 alert("Erro: Elementos do formulário de categoria não encontrados."); return;
            }
            const nomeCategoria = adminNomeCategoriaInput.value.trim();
            const empresaIdSelecionada = adminCategoriaEmpresaSelect.value === "" ? null : adminCategoriaEmpresaSelect.value;

            if (!nomeCategoria) { alert('Digite o nome da categoria.'); return; }
            showLoader();
            try {
                // Check for existing category with the same name and scope
                let checkQuery = _supabaseClient.from('categorias').select('id').eq('nome_categoria', nomeCategoria);
                if (empresaIdSelecionada) {
                    checkQuery = checkQuery.eq('empresa_id', empresaIdSelecionada);
                } else {
                    checkQuery = checkQuery.is('empresa_id', null);
                }
                const { data: existing, error: checkError } = await checkQuery.maybeSingle();
                if (checkError) throw checkError;
                if (existing) {
                    alert('Uma categoria com este nome já existe para este escopo (Global ou mesma Empresa).');
                    hideLoader(); return;
                }

                const { data, error } = await _supabaseClient.from('categorias')
                    .insert([{ nome_categoria: nomeCategoria, empresa_id: empresaIdSelecionada }])
                    .select();
                
                if (error) throw error;
                alert('Categoria adicionada com sucesso!');
                adminNomeCategoriaInput.value = '';
                await fetchAndRenderCategorias(); // Refresh table
            } catch (e) {
                console.error("Erro ao adicionar categoria:", e);
                alert('Falha ao adicionar categoria: ' + e.message);
            } finally {
                hideLoader();
            }
        }

        async function handleAdminDeleteCategoria(categoriaId, nomeCategoria) {
            if (!confirm(`Tem certeza que deseja excluir a categoria "${nomeCategoria}"? Esta ação não pode ser desfeita.`)) return;
            showLoader();
            try {
                // Check if any products are using this category
                const { data: productsUsingCategory, error: productCheckError } = await _supabaseClient
                    .from('produtos')
                    .select('id', { count: 'exact' })
                    .eq('categoria_id', categoriaId);

                if (productCheckError) throw productCheckError;

                if (productsUsingCategory && productsUsingCategory.length > 0) {
                     alert(`Não é possível excluir a categoria "${nomeCategoria}" pois ela está sendo utilizada por ${productsUsingCategory.length} produto(s). Remova ou altere a categoria desses produtos primeiro.`);
                     hideLoader();
                     return;
                }
                
                const { error } = await _supabaseClient.from('categorias').delete().eq('id', categoriaId);
                if (error) throw error;
                alert(`Categoria "${nomeCategoria}" excluída com sucesso!`);
                await fetchAndRenderCategorias(); // Refresh table
            } catch (e) {
                console.error("Erro ao excluir categoria:", e);
                alert('Falha ao excluir categoria: ' + e.message);
            } finally {
                hideLoader();
            }
        }
        
        async function showEmpresaColaboradoresScreen(empresaIdParaAdmin = null, nomeEmpresaParaAdmin = null, isAdminCalling = false) {
            let targetEmpresaId = currentUser?.empresa_id;
            let targetEmpresaNome = currentUser?.empresa_nome;

            if (isAdminCalling && currentUser?.user_metadata?.user_role === 'admin_master') {
                if (!empresaIdParaAdmin) {
                    alert("ID da empresa não fornecido para visualização do admin.");
                    showAdminEmpresasScreen(); // Go back if ID is missing
                    return;
                }
                targetEmpresaId = empresaIdParaAdmin;
                targetEmpresaNome = nomeEmpresaParaAdmin || `Empresa ID: ${empresaIdParaAdmin}`;
            } else if (!isAdminCalling && currentUser?.role !== 'empresa_login_principal') {
                handleLogout(); // Not an admin, not a empresa_login, something is wrong.
                return;
            }
            
            console.log(`showEmpresaColaboradoresScreen para Empresa ID: ${targetEmpresaId}, Nome: ${targetEmpresaNome}`);
            showLoader();
            try {
                if (colaboradoresEmpresaNomeSpan) colaboradoresEmpresaNomeSpan.textContent = targetEmpresaNome;
                else console.warn("colaboradoresEmpresaNomeSpan não encontrado");

                // Store the context for adding new collaborators
                if(colaboradorNomeInput) colaboradorNomeInput.dataset.empresaId = targetEmpresaId;

                await fetchAndRenderColaboradores(targetEmpresaId);
                showScreen('empresaColaboradores');
                
                // Adjust back button based on who is calling
                 const backBtn = document.getElementById('colaboradoresBackButton');
                 if(backBtn) {
                     if(backBtn.currentListener) backBtn.removeEventListener('click', backBtn.currentListener);
                     if (isAdminCalling) {
                        backBtn.currentListener = showAdminEmpresasScreen;
                     } else {
                        backBtn.currentListener = showEmpresaDashboardScreen;
                     }
                     backBtn.addEventListener('click', backBtn.currentListener);
                 }

            } catch (e) {
                console.error("Erro em showEmpresaColaboradoresScreen:", e);
                alert("Erro ao carregar tela de colaboradores.");
            } finally {
                hideLoader();
            }
        }

        async function fetchAndRenderColaboradores(empresaId) {
            if (!colaboradoresTableBody) { console.error("colaboradoresTableBody não encontrado"); return; }
            colaboradoresTableBody.innerHTML = '<tr><td colspan="4">Carregando colaboradores...</td></tr>';
            if (!empresaId) {
                 colaboradoresTableBody.innerHTML = '<tr><td colspan="4">ID da empresa não fornecido.</td></tr>';
                 return;
            }
            showLoader();
            try {
                const { data, error } = await _supabaseClient.from('colaboradores')
                    .select('id, nome_colaborador, created_at, ativo')
                    .eq('empresa_id', empresaId)
                    .order('nome_colaborador');
                
                if (error) throw error;
                
                colaboradoresCache = data || []; // Cache for this specific view
                colaboradoresTableBody.innerHTML = "";
                if (data && data.length > 0) {
                    data.forEach(colab => {
                        const row = colaboradoresTableBody.insertRow();
                        row.insertCell().textContent = colab.nome_colaborador;
                        row.insertCell().textContent = colab.ativo ? 'Sim' : 'Não';
                        row.insertCell().textContent = new Date(colab.created_at).toLocaleDateString('pt-BR');
                        
                        const actionsCell = row.insertCell();
                        const btnToggleAtivo = document.createElement('button');
                        btnToggleAtivo.textContent = colab.ativo ? 'Desativar' : 'Ativar';
                        btnToggleAtivo.className = `btn ${colab.ativo ? 'btn-warning' : 'btn-success'} table-actions`;
                        btnToggleAtivo.onclick = () => handleToggleAtivoColaborador(colab.id, !colab.ativo, empresaId);
                        actionsCell.appendChild(btnToggleAtivo);

                        const btnDelete = document.createElement('button');
                        btnDelete.textContent = 'Excluir';
                        btnDelete.className = 'btn btn-danger table-actions';
                        btnDelete.onclick = () => handleDeleteColaborador(colab.id, colab.nome_colaborador, empresaId);
                        actionsCell.appendChild(btnDelete);
                    });
                } else {
                    colaboradoresTableBody.innerHTML = '<tr><td colspan="4">Nenhum colaborador cadastrado para esta empresa.</td></tr>';
                }
            } catch (e) {
                console.error("Erro ao buscar/renderizar colaboradores:", e);
                colaboradoresTableBody.innerHTML = `<tr><td colspan="4" style="color:var(--danger-color);">Erro ao carregar: ${e.message}</td></tr>`;
            } finally {
                hideLoader();
            }
        }
        async function handleToggleAtivoColaborador(colaboradorId, novoEstadoAtivo, empresaId) {
            if (!confirm(`Tem certeza que deseja ${novoEstadoAtivo ? 'ATIVAR' : 'DESATIVAR'} este colaborador?`)) return;
            showLoader();
            try {
                const { error } = await _supabaseClient.from('colaboradores')
                    .update({ ativo: novoEstadoAtivo })
                    .eq('id', colaboradorId);
                if (error) throw error;
                alert(`Colaborador ${novoEstadoAtivo ? 'ativado' : 'desativado'} com sucesso!`);
                await fetchAndRenderColaboradores(empresaId); // Refresh table
            } catch (e) {
                console.error(`Erro ao ${novoEstadoAtivo ? 'ativar' : 'desativar'} colaborador:`, e);
                alert(`Falha: ${e.message}`);
            } finally {
                hideLoader();
            }
        }


        async function handleAddColaborador() {
            if (!colaboradorNomeInput) { alert("Erro: Campo nome do colaborador não encontrado."); return; }
            const nomeColaborador = colaboradorNomeInput.value.trim();
            const empresaId = colaboradorNomeInput.dataset.empresaId; // Get from data attribute

            if (!empresaId) { alert("Erro: ID da empresa não está definido para adicionar colaborador."); return;}
            if (!nomeColaborador) { alert('Digite o nome do colaborador.'); return; }
            
            showLoader();
            try {
                 const { data: existing, error: checkError } = await _supabaseClient
                    .from('colaboradores')
                    .select('id')
                    .eq('nome_colaborador', nomeColaborador)
                    .eq('empresa_id', empresaId)
                    .maybeSingle();

                if (checkError) throw checkError;
                if (existing) {
                    alert('Um colaborador com este nome já existe nesta empresa.');
                    hideLoader(); return;
                }

                const { error } = await _supabaseClient.from('colaboradores')
                    .insert([{ nome_colaborador: nomeColaborador, empresa_id: empresaId, ativo: true }]);
                if (error) throw error;
                alert('Colaborador adicionado com sucesso!');
                colaboradorNomeInput.value = '';
                await fetchAndRenderColaboradores(empresaId); // Refresh
            } catch (e) {
                console.error("Erro ao adicionar colaborador:", e);
                alert('Falha ao adicionar colaborador: ' + e.message);
            } finally {
                hideLoader();
            }
        }

        async function handleDeleteColaborador(colaboradorId, nomeColaborador, empresaId) {
            if (!confirm(`Tem certeza que deseja excluir o colaborador "${nomeColaborador}"? Contagens associadas a ele NÃO serão excluídas, mas o nome pode não ser exibido corretamente em históricos antigos se o registro do colaborador for removido.`)) return;
            showLoader();
            try {
                // Optional: Check if collaborator has any contagens. If so, warn or prevent.
                // For now, direct delete:
                const { error } = await _supabaseClient.from('colaboradores').delete().eq('id', colaboradorId);
                if (error) throw error;
                alert(`Colaborador "${nomeColaborador}" excluído com sucesso!`);
                await fetchAndRenderColaboradores(empresaId); // Refresh
            } catch (e) {
                console.error("Erro ao excluir colaborador:", e);
                alert('Falha ao excluir colaborador: ' + e.message);
            } finally {
                hideLoader();
            }
        }
        
        function showChangePasswordScreen_Empresa() {
            if (!currentUser || (currentUser.role !== 'empresa_login_principal' && currentUser.user_metadata?.user_role !== 'admin_master_changing_for_empresa')) { // Latter role is hypothetical if admin changes other user password
                handleLogout(); return;
            }
            console.log("showChangePasswordScreen_Empresa chamada");
            if (changePasswordMessage) changePasswordMessage.textContent = '';
            if (currentPasswordInput) currentPasswordInput.value = '';
            if (newPasswordInput) newPasswordInput.value = '';
            if (confirmNewPasswordInput) confirmNewPasswordInput.value = '';
            showScreen('changePassword');
        }

        async function handleChangePassword() {
            if (!newPasswordInput || !confirmNewPasswordInput || !changePasswordMessage || !currentPasswordInput) {
                alert("Erro: Campos de senha não encontrados."); return;
            }
            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmNewPasswordInput.value;
            const currentPwd = currentPasswordInput.value;

            changePasswordMessage.textContent = '';
            changePasswordMessage.style.color = 'var(--danger-color)';

            if (newPassword.length < 6) {
                changePasswordMessage.textContent = "Nova senha deve ter no mínimo 6 caracteres."; return;
            }
            if (newPassword !== confirmPassword) {
                changePasswordMessage.textContent = "As novas senhas não coincidem."; return;
            }

            // If not admin master, current password is required for Supabase user update
            if (currentUser.user_metadata?.user_role !== 'admin_master' && currentUser.role !== 'admin_master') { // Check both just in case
                 if (!currentPwd) {
                    changePasswordMessage.textContent = "Senha atual é obrigatória."; return;
                 }
                 // TODO: Supabase doesn't directly support verifying current password before setting a new one in client SDK.
                 // This usually requires a custom Edge Function if you want to verify the old password first.
                 // For simplicity, the `updateUser` will just try to set the new password.
                 // If the user is re-authenticating, Supabase handles this.
                 // If not, this might fail or succeed depending on session freshness.
                 // A robust solution would involve re-authentication or an Edge Function.
                 console.warn("Alteração de senha por não-admin: validação de senha atual não implementada diretamente aqui. Depende da sessão Supabase.");
            }


            showLoader();
            try {
                const { data, error } = await _supabaseClient.auth.updateUser({ password: newPassword });
                if (error) throw error;
                
                console.log("Senha alterada com sucesso para:", currentUser.email, data);
                changePasswordMessage.textContent = 'Senha alterada com sucesso!';
                changePasswordMessage.style.color = 'var(--success-color)';
                newPasswordInput.value = '';
                confirmNewPasswordInput.value = '';
                if(currentPasswordInput) currentPasswordInput.value = '';

                // Consider automatically logging out or redirecting after password change for security.
                // setTimeout(() => {
                //    if (currentUser.user_metadata?.user_role === 'admin_master') showAdminMasterDashboardScreen();
                //    else showEmpresaDashboardScreen();
                // }, 2000);

            } catch (e) {
                console.error("Erro ao alterar senha:", e);
                changePasswordMessage.textContent = 'Falha ao alterar senha: ' + e.message;
            } finally {
                hideLoader();
            }
        }

        async function showHistoricoContagensScreen() { // For Empresa User
            if (!currentUser || currentUser.role !== 'empresa_login_principal') { handleLogout(); return; }
            console.log("showHistoricoContagensScreen (Empresa) chamada");
            showLoader();
            try {
                const empresaNome = currentUser.empresa_nome || 'Sua Empresa';
                await fetchAndRenderHistoricoContagens(currentUser.empresa_id, false);
                showScreen('historicoContagens', {
                    title: `Histórico de Contagens (${empresaNome})`,
                    context: `Visualizando contagens para ${empresaNome}.`,
                    showEmpresaSelector: false,
                    showEmpresaColumnInTable: false
                });
            } catch (e) {
                console.error("Erro em showHistoricoContagensScreen (Empresa):", e);
                alert("Erro ao carregar histórico.");
            } finally {
                hideLoader();
            }
        }

        async function showHistoricoContagensScreen_Admin() {
            if (!currentUser || currentUser.user_metadata?.user_role !== 'admin_master') { handleLogout(); return; }
            console.log("showHistoricoContagensScreen_Admin chamada");
            showLoader();
            try {
                const adminHistEmpSelect = document.getElementById('adminHistoricoEmpresaSelect');
                await populateEmpresasSelect('adminHistoricoEmpresaSelect', true, "-- Todas as Empresas --", "ALL_EMPRESAS");
                
                if (adminHistEmpSelect) {
                    adminHistEmpSelect.value = "ALL_EMPRESAS"; // Default
                    if (!adminHistEmpSelect.onchangeAttached_hist) {
                        adminHistEmpSelect.addEventListener('change', async () => {
                            const selectedEmpresaId = adminHistEmpSelect.value === "ALL_EMPRESAS" ? null : adminHistEmpSelect.value;
                            const selectedEmpresa = empresasCache.find(e => e.id === selectedEmpresaId);
                            const contextText = selectedEmpresa ? `Empresa: ${selectedEmpresa.nome_empresa}` : "Todas as Empresas";
                             if(document.getElementById('historicoContext')) document.getElementById('historicoContext').textContent = contextText;
                            await fetchAndRenderHistoricoContagens(selectedEmpresaId, true);
                        });
                        adminHistEmpSelect.onchangeAttached_hist = true;
                    }
                    adminHistEmpSelect.dispatchEvent(new Event('change')); // Trigger initial load
                } else {
                    await fetchAndRenderHistoricoContagens(null, true); // Load all if select not found
                }

                showScreen('historicoContagens', {
                    title: 'Histórico de Contagens (Admin)',
                    context: 'Selecione uma empresa para filtrar o histórico ou veja todas.',
                    showEmpresaSelector: true,
                    showEmpresaColumnInTable: true
                });

            } catch (e) {
                console.error("Erro em showHistoricoContagensScreen_Admin:", e);
                alert("Erro ao carregar histórico do admin.");
            } finally {
                hideLoader();
            }
        }
        
        async function fetchAndRenderHistoricoContagens(empresaIdFiltro = null, isAdminView = false) {
            if (!historicoContagensTableBody) { console.error("historicoContagensTableBody não encontrado."); return; }
            historicoContagensTableBody.innerHTML = `<tr><td colspan="${isAdminView ? 5 : 4}">Carregando histórico...</td></tr>`;
            showLoader();
            try {
                let query = _supabaseClient.from('historico_contagens')
                                         .select('id, created_at, colaborador_nome, itens_contados, dados_contagem, empresa_id, empresas (nome_empresa)')
                                         .order('created_at', { ascending: false });

                if (empresaIdFiltro && empresaIdFiltro !== "ALL_EMPRESAS") {
                    query = query.eq('empresa_id', empresaIdFiltro);
                } else if (!isAdminView && currentUser && currentUser.empresa_id) { // Non-admin user, always filter by their own empresa_id
                    query = query.eq('empresa_id', currentUser.empresa_id);
                }
                // For Admin viewing "ALL_EMPRESAS", no empresa_id filter is applied here, fetching all.

                const { data, error } = await query;
                if (error) throw error;

                historicoContagensTableBody.innerHTML = "";
                if (data && data.length > 0) {
                    data.forEach(reg => {
                        const row = historicoContagensTableBody.insertRow();
                        if (isAdminView && document.getElementById('colEmpresaHistorico').style.display !== 'none') {
                             row.insertCell().textContent = reg.empresas?.nome_empresa || (reg.empresa_id ? `ID: ${reg.empresa_id}`: 'Global/N/A');
                        }
                        row.insertCell().textContent = new Date(reg.created_at).toLocaleString('pt-BR');
                        row.insertCell().textContent = reg.colaborador_nome || "N/A";
                        row.insertCell().textContent = reg.itens_contados;
                        
                        const actionsCell = row.insertCell();
                        const btnDetalhes = document.createElement('button');
                        btnDetalhes.textContent = 'Detalhes';
                        btnDetalhes.className = 'btn btn-info table-actions';
                        btnDetalhes.onclick = () => showDetalhesContagem(reg.dados_contagem, reg);
                        actionsCell.appendChild(btnDetalhes);
                    });
                } else {
                    historicoContagensTableBody.innerHTML = `<tr><td colspan="${isAdminView ? 5 : 4}">Nenhum registro de contagem encontrado.</td></tr>`;
                }
            } catch (e) {
                console.error("Erro ao buscar/renderizar histórico:", e);
                historicoContagensTableBody.innerHTML = `<tr><td colspan="${isAdminView ? 5 : 4}" style="color:var(--danger-color);">Erro: ${e.message}</td></tr>`;
            } finally {
                hideLoader();
            }
        }

        function showDetalhesContagem(dadosContagem, registroCompleto = null) {
            if (!modalDetalhesContagem || !detalhesContagemConteudo) { console.error("Modal de detalhes ou conteúdo não encontrados."); return;}
            
            let htmlConteudo = '';
            if (registroCompleto) {
                htmlConteudo += `<p><strong>Data:</strong> ${new Date(registroCompleto.created_at).toLocaleString('pt-BR')}</p>`;
                htmlConteudo += `<p><strong>Colaborador:</strong> ${registroCompleto.colaborador_nome || 'N/A'}</p>`;
                 if (registroCompleto.empresas) {
                    htmlConteudo += `<p><strong>Empresa:</strong> ${registroCompleto.empresas.nome_empresa}</p>`;
                } else if (registroCompleto.empresa_id) {
                     htmlConteudo += `<p><strong>Empresa ID:</strong> ${registroCompleto.empresa_id}</p>`;
                }
                 htmlConteudo += `<hr>`;
            }

            if (dadosContagem && dadosContagem.length > 0) {
                htmlConteudo += '<table style="width:100%; font-size:0.9em;"><thead><tr><th>Cód.</th><th>Produto</th><th>Qtd.</th></tr></thead><tbody>';
                dadosContagem.forEach(item => {
                    htmlConteudo += `<tr>
                        <td>${item.codigo || item.produto_id}</td>
                        <td>${item.nome || 'N/A'}</td>
                        <td style="text-align:right;">${item.quantidade}</td>
                    </tr>`;
                });
                htmlConteudo += '</tbody></table>';
            } else {
                htmlConteudo += '<p>Nenhum item detalhado nesta contagem.</p>';
            }
            detalhesContagemConteudo.innerHTML = htmlConteudo;
            modalDetalhesContagem.classList.add('active');
        }

        function closeModalDetalhesContagem() { if(modalDetalhesContagem) modalDetalhesContagem.classList.remove('active'); }
        function closeModalPreviewContagem() { if(modalPreviewContagem) modalPreviewContagem.classList.remove('active'); }
        
        async function populateCategoriaSelect_ProdutoForm(empresaIdContexto = null) {
            if (!prodCategoriaSelect) { console.warn("Select de categoria do produto (prodCategoriaSelect) não encontrado."); return; }
            const currentValue = prodCategoriaSelect.value;
            prodCategoriaSelect.innerHTML = '<option value="">-- Sem Categoria --</option>';
            showLoader();
            try {
                let query = _supabaseClient.from('categorias').select('id, nome_categoria').order('nome_categoria');
                
                // Admin context: if an empresaIdContexto is provided, fetch categories for that empresa AND global ones.
                // Empresa context: if empresaIdContexto (currentUser.empresa_id) is provided, fetch for that empresa AND global ones.
                // Global products (admin only, empresaIdContexto is null): fetch only global categories.
                
                let specificCategories = [];
                let globalCategories = [];

                if (empresaIdContexto) { // Fetch specific and global
                    const { data: specific, error: specificError } = await _supabaseClient.from('categorias')
                        .select('id, nome_categoria').eq('empresa_id', empresaIdContexto).order('nome_categoria');
                    if (specificError) throw specificError;
                    specificCategories = specific || [];
                }

                // Always fetch global categories unless we are in a non-admin context and there's NO empresaIdContexto (which shouldn't happen for empresa users)
                // For global products (admin, empresaIdContexto is null), this is the only fetch.
                // For specific company products (admin or empresa user), these are added to the company-specific ones.
                const { data: global, error: globalError } = await _supabaseClient.from('categorias')
                    .select('id, nome_categoria').is('empresa_id', null).order('nome_categoria');
                if (globalError) throw globalError;
                globalCategories = global || [];

                // Combine and deduplicate (though should be distinct by scope)
                const allCategorias = [];
                const addedIds = new Set();

                specificCategories.forEach(cat => {
                    if (!addedIds.has(cat.id)) {
                        allCategorias.push({...cat, display_name: `${cat.nome_categoria} (Empresa)`});
                        addedIds.add(cat.id);
                    }
                });
                 globalCategories.forEach(cat => {
                    if (!addedIds.has(cat.id)) {
                        allCategorias.push({...cat, display_name: `${cat.nome_categoria} (Global)`});
                        addedIds.add(cat.id);
                    }
                });
                
                // Sort combined list
                allCategorias.sort((a,b) => a.display_name.localeCompare(b.display_name));


                allCategorias.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.display_name;
                    prodCategoriaSelect.appendChild(option);
                });

                if (Array.from(prodCategoriaSelect.options).some(opt => opt.value === currentValue)) {
                    prodCategoriaSelect.value = currentValue;
                } else {
                    prodCategoriaSelect.value = ""; // Default to "Sem Categoria"
                }

            } catch (e) {
                console.error("Erro ao popular select de categorias para produtos:", e);
                prodCategoriaSelect.innerHTML = '<option value="">Erro ao carregar categorias</option>';
            } finally {
                hideLoader();
            }
        }
        
        async function showProductManagementScreen_AdminGlobal() { 
            if (!currentUser || currentUser?.user_metadata?.user_role !== 'admin_master') { handleLogout(); return; }
            console.log("showProductManagementScreen_AdminGlobal v2.9.9 (corrigido) chamada");
            showLoader();
            try {
                adminSelectedEmpresaId = null; 
                const adminProdEmpSelect = document.getElementById('adminProdutoEmpresaSelect');
                await populateEmpresasSelect('adminProdutoEmpresaSelect', true, "-- Produtos Globais (Sem Empresa) --", "");
                if (adminProdEmpSelect) {
                    adminProdEmpSelect.value = ""; 
                    if (!adminProdEmpSelect.onchangeAttached_prod) { 
                        adminProdEmpSelect.addEventListener('change', async () => {
                            adminSelectedEmpresaId = adminProdEmpSelect.value === "" ? null : adminProdEmpSelect.value;
                            const selectedEmpresa = empresasCache.find(e => e.id === adminSelectedEmpresaId);
                            const empresaNomeContext = selectedEmpresa ? selectedEmpresa.nome_empresa : "Produtos Globais";
                            if(document.getElementById('productManagementContext')) document.getElementById('productManagementContext').textContent = `Gerenciando para: ${empresaNomeContext}`;
                            await populateCategoriaSelect_ProdutoForm(adminSelectedEmpresaId); 
                            await fetchProductsFromSupabase(adminSelectedEmpresaId); 
                            renderProductManagementTable(); 
                        });
                        adminProdEmpSelect.onchangeAttached_prod = true;
                    }
                    adminProdEmpSelect.dispatchEvent(new Event('change')); 
                } else { 
                    await populateCategoriaSelect_ProdutoForm(null); await fetchProductsFromSupabase(null); renderProductManagementTable();
                }
                showScreen('productManagement', { title: 'Gerenciar Produtos (Admin)', context: 'Selecione uma empresa ou gerencie produtos globais.', showEmpresaSelector: true });
                // Back button logic is now handled in window.onload
            } catch (e) { console.error("Erro showProductManagementScreen_AdminGlobal:", e); alert("Erro tela produtos admin."); } 
            finally { hideLoader(); }
        }

        async function showProductManagementScreen_Empresa() {
            if (!currentUser || currentUser.role !== 'empresa_login_principal') { handleLogout(); return; }
            console.log("showProductManagementScreen_Empresa chamada");
            showLoader();
            try {
                adminSelectedEmpresaId = currentUser.empresa_id; // Empresa user always sees their own products
                await populateCategoriaSelect_ProdutoForm(adminSelectedEmpresaId);
                await fetchProductsFromSupabase(adminSelectedEmpresaId);
                renderProductManagementTable();
                showScreen('productManagement', {
                    title: `Gerenciar Produtos (${currentUser.empresa_nome || 'Sua Empresa'})`,
                    context: `Gerenciando produtos para ${currentUser.empresa_nome || 'sua empresa'}. Produtos globais também podem estar visíveis para contagem.`,
                    showEmpresaSelector: false // No selector for empresa user
                });
                 // Back button logic is now handled in window.onload
            } catch (e) {
                console.error("Erro em showProductManagementScreen_Empresa:", e);
                alert("Erro ao carregar tela de gerenciamento de produtos da empresa.");
            } finally {
                hideLoader();
            }
        }
        
        async function fetchProductsFromSupabase(empresaIdFiltro = null) {
            // This function now only fetches products. Rendering is separate.
            // For inventory, we need both global products AND products of the specific empresa.
            // For product management by empresa, only their products.
            // For product management by admin (global or specific), it depends on empresaIdFiltro.
            showLoader();
            try {
                let query = _supabaseClient.from('produtos').select('*, categorias(nome_categoria)');

                if (empresaIdFiltro) { // Admin managing specific company OR Empresa user managing their own
                    query = query.eq('empresa_id', empresaIdFiltro);
                } else if (currentUser?.user_metadata?.user_role === 'admin_master' && !empresaIdFiltro) { // Admin managing global products
                    query = query.is('empresa_id', null);
                } else if (currentUser?.role === 'empresa_login_principal' && !empresaIdFiltro) { // Should not happen, empresa_id should be set
                     console.warn("fetchProductsFromSupabase: Empresa user com empresaIdFiltro nulo. Usando currentUser.empresa_id");
                     query = query.eq('empresa_id', currentUser.empresa_id);
                }
                // If it's for inventory count, this logic might need adjustment to include global products.
                // This function is primarily for the "Product Management" screen.

                query = query.order('nome_produto');
                const { data, error } = await query;

                if (error) throw error;
                produtosCache = data || []; // This cache is for the current view of product management.
                console.log(`Produtos carregados para empresa ID ${empresaIdFiltro || 'Global'}:`, produtosCache.length);
            } catch (e) {
                console.error("Erro ao buscar produtos:", e);
                produtosCache = []; // Clear cache on error
                alert(`Erro ao carregar produtos: ${e.message}`);
            } finally {
                hideLoader();
            }
        }

        function renderProductManagementTable() {
            if (!productManagementTableBody) { console.error("productManagementTableBody não encontrado"); return; }
            productManagementTableBody.innerHTML = ""; // Clear existing rows

            if (produtosCache.length === 0) {
                productManagementTableBody.innerHTML = '<tr><td colspan="4">Nenhum produto cadastrado para o filtro atual.</td></tr>';
                return;
            }

            produtosCache.forEach(produto => {
                const row = productManagementTableBody.insertRow();
                row.insertCell().textContent = produto.codigo_produto;
                row.insertCell().textContent = produto.nome_produto;
                row.insertCell().textContent = produto.categorias ? produto.categorias.nome_categoria : (produto.categoria_id ? 'Categoria não encontrada' : 'Sem Categoria');
                
                const actionsCell = row.insertCell();
                const btnRemove = document.createElement('button');
                btnRemove.textContent = 'Remover';
                btnRemove.className = 'btn btn-danger table-actions';
                btnRemove.onclick = () => handleRemoveProduct(produto.id, produto.nome_produto);
                actionsCell.appendChild(btnRemove);
                // TODO: Add Edit button if needed
            });
        }

        async function handleAddProduct() {
            if (!prodCodigoInput || !prodNomeInput || !prodCategoriaSelect) {
                alert("Erro: Campos do formulário de produto não encontrados."); return;
            }
            const codigo = prodCodigoInput.value.trim();
            const nome = prodNomeInput.value.trim();
            const categoriaId = prodCategoriaSelect.value === "" ? null : prodCategoriaSelect.value;
            
            // Determine empresa_id for the new product
            // If admin is on "Global Products", empresa_id is null.
            // If admin selected a company from dropdown, adminSelectedEmpresaId is set.
            // If empresa user, currentUser.empresa_id is used.
            let empresaParaProdutoId = null;
            if (currentUser?.user_metadata?.user_role === 'admin_master') {
                empresaParaProdutoId = adminSelectedEmpresaId; // This will be null for global, or an ID if admin selected a company
            } else if (currentUser?.role === 'empresa_login_principal') {
                empresaParaProdutoId = currentUser.empresa_id;
            }


            if (!codigo) { alert("Código do produto é obrigatório."); prodCodigoInput.focus(); return; }
            if (!nome) { alert("Nome do produto é obrigatório."); prodNomeInput.focus(); return; }

            showLoader();
            try {
                // Check for existing product with same code for the same company scope or global
                let checkQuery = _supabaseClient.from('produtos').select('id').eq('codigo_produto', codigo);
                if (empresaParaProdutoId) {
                    checkQuery = checkQuery.eq('empresa_id', empresaParaProdutoId);
                } else {
                    checkQuery = checkQuery.is('empresa_id', null); // Check global scope
                }
                const { data: existing, error: checkError } = await checkQuery.maybeSingle();
                if (checkError) throw checkError;
                if (existing) {
                    alert(`Um produto com o código "${codigo}" já existe para ${empresaParaProdutoId ? 'esta empresa' : 'o escopo global'}.`);
                    hideLoader(); return;
                }


                const { data, error } = await _supabaseClient.from('produtos').insert([
                    { 
                        codigo_produto: codigo, 
                        nome_produto: nome, 
                        categoria_id: categoriaId,
                        empresa_id: empresaParaProdutoId // This correctly sets null for global products by admin
                    }
                ]).select().single();

                if (error) throw error;
                alert(`Produto "${nome}" adicionado com sucesso!`);
                prodCodigoInput.value = '';
                prodNomeInput.value = '';
                prodCategoriaSelect.value = '';
                
                // Refresh product list for the current view
                await fetchProductsFromSupabase(empresaParaProdutoId); 
                renderProductManagementTable();

            } catch (e) {
                console.error("Erro ao adicionar produto:", e);
                alert('Falha ao adicionar produto: ' + e.message);
            } finally {
                hideLoader();
            }
        }

        async function handleRemoveProduct(produtoId, nomeProduto) {
            if (!confirm(`Tem certeza que deseja remover o produto "${nomeProduto}"? Esta ação não pode ser desfeita.`)) return;
            showLoader();
            try {
                const { error } = await _supabaseClient.from('produtos').delete().eq('id', produtoId);
                if (error) throw error;
                alert(`Produto "${nomeProduto}" removido com sucesso!`);
                
                // Determine current context for refreshing
                 let currentEmpresaContextId = null;
                if (currentUser?.user_metadata?.user_role === 'admin_master') {
                    currentEmpresaContextId = adminSelectedEmpresaId; 
                } else if (currentUser?.role === 'empresa_login_principal') {
                    currentEmpresaContextId = currentUser.empresa_id;
                }
                await fetchProductsFromSupabase(currentEmpresaContextId);
                renderProductManagementTable();

            } catch (e) {
                console.error("Erro ao remover produto:", e);
                alert('Falha ao remover produto: ' + e.message);
            } finally {
                hideLoader();
            }
        }

        async function handleXLSXImport() {
            if (!xlsxFileInput || !xlsxFileInput.files || xlsxFileInput.files.length === 0) {
                alert("Por favor, selecione um arquivo XLSX."); return;
            }
            const file = xlsxFileInput.files[0];
            const reader = new FileReader();

            reader.onload = async (e) => {
                showLoader();
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (jsonData.length < 2) { // Header + at least one data row
                        alert("Planilha vazia ou sem cabeçalho. Colunas esperadas: 'codigo', 'produto', 'categoria'.");
                        hideLoader(); return;
                    }
                    
                    const header = jsonData[0].map(h => String(h).toLowerCase().trim());
                    const codigoIndex = header.indexOf('codigo');
                    const produtoIndex = header.indexOf('produto');
                    const categoriaIndex = header.indexOf('categoria');

                    if (codigoIndex === -1 || produtoIndex === -1) {
                        alert("Cabeçalho inválido. Colunas 'codigo' e 'produto' são obrigatórias. 'categoria' é opcional.");
                        hideLoader(); return;
                    }
                    
                    // Determine empresa_id for imported products
                    let empresaParaImportacaoId = null;
                    if (currentUser?.user_metadata?.user_role === 'admin_master') {
                        empresaParaImportacaoId = adminSelectedEmpresaId; // From the dropdown on admin product screen
                    } else if (currentUser?.role === 'empresa_login_principal') {
                        empresaParaImportacaoId = currentUser.empresa_id;
                    }

                    // Fetch categories for mapping names to IDs
                    let allCategoriesForContext = [];
                    let catQuery = _supabaseClient.from('categorias').select('id, nome_categoria, empresa_id');
                    if (empresaParaImportacaoId) { // For specific company, get their categories + global
                        const {data: compCat, error: compErr} = await _supabaseClient.from('categorias').select('id, nome_categoria, empresa_id').eq('empresa_id', empresaParaImportacaoId);
                        if(compErr) throw compErr;
                        allCategoriesForContext = allCategoriesForContext.concat(compCat || []);
                    }
                    const {data: globalCat, error: globErr} = await _supabaseClient.from('categorias').select('id, nome_categoria, empresa_id').is('empresa_id', null);
                    if(globErr) throw globErr;
                    allCategoriesForContext = allCategoriesForContext.concat(globalCat || []);
                    
                    const categoriaMap = new Map(); // nome_lower_case -> id
                    allCategoriesForContext.forEach(cat => {
                        categoriaMap.set(String(cat.nome_categoria).toLowerCase().trim(), cat.id);
                    });


                    const produtosParaInserir = [];
                    let produtosIgnoradosCount = 0;
                    let produtosAtualizadosCount = 0; // Placeholder if update logic is added

                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        const codigo = row[codigoIndex] ? String(row[codigoIndex]).trim() : null;
                        const nomeProduto = row[produtoIndex] ? String(row[produtoIndex]).trim() : null;
                        const nomeCategoria = (categoriaIndex !== -1 && row[categoriaIndex]) ? String(row[categoriaIndex]).trim() : null;

                        if (!codigo || !nomeProduto) {
                            console.warn(`Linha ${i+1} ignorada: código ou nome do produto ausente.`);
                            produtosIgnoradosCount++;
                            continue;
                        }
                        
                        let categoriaIdParaProduto = null;
                        if (nomeCategoria) {
                            categoriaIdParaProduto = categoriaMap.get(nomeCategoria.toLowerCase());
                            if (!categoriaIdParaProduto) {
                                console.warn(`Categoria "${nomeCategoria}" não encontrada para o produto "${nomeProduto}". Será salvo sem categoria.`);
                            }
                        }
                        
                        // Check if product with this code already exists for the target scope
                        let checkExistingQuery = _supabaseClient.from('produtos').select('id').eq('codigo_produto', codigo);
                        if(empresaParaImportacaoId) {
                            checkExistingQuery = checkExistingQuery.eq('empresa_id', empresaParaImportacaoId);
                        } else {
                            checkExistingQuery = checkExistingQuery.is('empresa_id', null);
                        }
                        const {data: existingProd, error: checkProdError} = await checkExistingQuery.maybeSingle();
                        if(checkProdError) throw checkProdError;

                        if(existingProd) {
                            console.warn(`Produto com código "${codigo}" já existe. Linha ${i+1} ignorada.`);
                             // Optionally, implement update logic here
                            produtosIgnoradosCount++;
                            continue;
                        }

                        produtosParaInserir.push({
                            codigo_produto: codigo,
                            nome_produto: nomeProduto,
                            categoria_id: categoriaIdParaProduto,
                            empresa_id: empresaParaImportacaoId
                        });
                    }

                    if (produtosParaInserir.length > 0) {
                        const { error: insertError, count } = await _supabaseClient.from('produtos').insert(produtosParaInserir).select({count: 'exact'});
                        if (insertError) throw insertError;
                        alert(`${count || 0} produtos importados com sucesso! ${produtosIgnoradosCount > 0 ? `${produtosIgnoradosCount} produtos foram ignorados (já existentes ou dados inválidos).` : ''}`);
                    } else {
                        alert(`Nenhum produto novo para importar. ${produtosIgnoradosCount > 0 ? `${produtosIgnoradosCount} produtos foram ignorados (já existentes ou dados inválidos).` : ''}`);
                    }

                    await fetchProductsFromSupabase(empresaParaImportacaoId);
                    renderProductManagementTable();

                } catch (e) {
                    console.error("Erro ao importar XLSX:", e);
                    alert("Falha ao importar XLSX: " + e.message);
                } finally {
                    xlsxFileInput.value = ''; // Clear file input
                    hideLoader();
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        async function showInventoryCountScreen_AdminGlobal() {
            if (!currentUser || currentUser?.user_metadata?.user_role !== 'admin_master') { handleLogout(); return; }
            console.log("showInventoryCountScreen_AdminGlobal chamada");
            showLoader();
            try {
                adminSelectedEmpresaId = null; // Default to global context for admin count
                const adminCountEmpSelect = document.getElementById('adminContagemEmpresaSelect');
                await populateEmpresasSelect('adminContagemEmpresaSelect', true, "-- Contagem Global (Produtos Sem Empresa) --", "");
                
                if (adminCountEmpSelect) {
                    adminCountEmpSelect.value = ""; // Default
                    if (!adminCountEmpSelect.onchangeAttached_count) {
                        adminCountEmpSelect.addEventListener('change', async () => {
                            adminSelectedEmpresaId = adminCountEmpSelect.value === "" ? null : adminCountEmpSelect.value;
                            const selectedEmpresa = empresasCache.find(e => e.id === adminSelectedEmpresaId);
                            const empresaNomeContext = selectedEmpresa ? selectedEmpresa.nome_empresa : "Contagem Global";
                            if(document.getElementById('inventoryCountContext')) document.getElementById('inventoryCountContext').textContent = `Realizando contagem para: ${empresaNomeContext}`;
                            
                            await loadColaboradoresParaContagem(adminSelectedEmpresaId, true); // Admin is doing the count, but might log against an employee of that company or a global placeholder
                            await loadProductsForInventory(adminSelectedEmpresaId); // Load products relevant to this context
                            populateCategoryFilter(); // Populate category filter based on loaded products
                            displayInventoryProducts(produtosCache); // Display them
                        });
                        adminCountEmpSelect.onchangeAttached_count = true;
                    }
                    adminCountEmpSelect.dispatchEvent(new Event('change')); // Trigger initial load for global
                } else { // Fallback if select not found
                    await loadColaboradoresParaContagem(null, true);
                    await loadProductsForInventory(null);
                    populateCategoryFilter();
                    displayInventoryProducts(produtosCache);
                }

                showScreen('inventoryCount', { title: 'Balanço de Estoque (Admin)', context: 'Selecione uma empresa ou realize uma contagem global.', showEmpresaSelector: true });
            } catch (e) {
                console.error("Erro em showInventoryCountScreen_AdminGlobal:", e);
                alert("Erro ao carregar tela de contagem do admin.");
            } finally {
                hideLoader();
            }
        }
        
        async function showInventoryCountScreen_Empresa() {
            if (!currentUser || currentUser.role !== 'empresa_login_principal') { handleLogout(); return; }
            console.log("showInventoryCountScreen_Empresa chamada");
            showLoader();
            try {
                adminSelectedEmpresaId = currentUser.empresa_id; // Empresa user always uses their own empresa_id
                const empresaNomeContext = currentUser.empresa_nome || 'Sua Empresa';
                if(document.getElementById('inventoryCountContext')) document.getElementById('inventoryCountContext').textContent = `Realizando contagem para: ${empresaNomeContext}`;

                await loadColaboradoresParaContagem(adminSelectedEmpresaId, false);
                await loadProductsForInventory(adminSelectedEmpresaId);
                populateCategoryFilter();
                displayInventoryProducts(produtosCache);

                showScreen('inventoryCount', { title: `Balanço de Estoque (${empresaNomeContext})`, context: `Contagem para ${empresaNomeContext}`, showEmpresaSelector: false });
            } catch (e) {
                console.error("Erro em showInventoryCountScreen_Empresa:", e);
                alert("Erro ao carregar tela de contagem da empresa.");
            } finally {
                hideLoader();
            }
        }

        async function loadProductsForInventory(empresaIdContexto = null) {
            // For inventory, we need products specific to the empresaIdContexto AND global products.
            showLoader();
            try {
                let companyProducts = [];
                let globalProducts = [];

                // Fetch company-specific products if empresaIdContexto is provided
                if (empresaIdContexto) {
                    const { data: cProds, error: cErr } = await _supabaseClient.from('produtos')
                        .select('*, categorias(nome_categoria)')
                        .eq('empresa_id', empresaIdContexto)
                        .order('nome_produto');
                    if (cErr) throw cErr;
                    companyProducts = cProds || [];
                }

                // Always fetch global products (empresa_id IS NULL)
                const { data: gProds, error: gErr } = await _supabaseClient.from('produtos')
                    .select('*, categorias(nome_categoria)')
                    .is('empresa_id', null)
                    .order('nome_produto');
                if (gErr) throw gErr;
                globalProducts = gProds || [];
                
                // Combine and ensure no duplicates if a global product was somehow also listed under a company with same ID (unlikely with good data hygiene)
                const combinedProducts = [];
                const productIds = new Set();

                companyProducts.forEach(p => {
                    if(!productIds.has(p.id)){
                        combinedProducts.push(p);
                        productIds.add(p.id);
                    }
                });
                globalProducts.forEach(p => {
                     if(!productIds.has(p.id)){
                        combinedProducts.push(p);
                        productIds.add(p.id);
                    }
                });
                
                // Sort the final list (optional, could sort by company then name, or just name)
                combinedProducts.sort((a,b) => (a.nome_produto || "").localeCompare(b.nome_produto || ""));

                produtosCache = combinedProducts; // This cache is for the current inventory screen
                console.log(`Produtos carregados para contagem (Contexto Empresa ID: ${empresaIdContexto || 'Global'}): ${produtosCache.length}`);

            } catch (e) {
                console.error("Erro ao buscar produtos para contagem:", e);
                produtosCache = [];
                alert(`Erro ao carregar produtos para contagem: ${e.message}`);
            } finally {
                hideLoader();
            }
        }

        async function loadColaboradoresParaContagem(empresaId, isAdminContextGlobalCount = false) {
            // isAdminContextGlobalCount: true if admin is doing a "global" count (not tied to specific company products)
            // In this case, there are no specific "company employees" to list, maybe a generic "Admin" option.
            // If admin is doing a count FOR a specific company (adminSelectedEmpresaId is set), list that company's employees.
            // If empresa user, list their own company's employees.
            if (!selectColaboradorContagem) { console.warn("Select de colaborador para contagem não encontrado."); return; }
            selectColaboradorContagem.innerHTML = '<option value="">-- Selecione Colaborador --</option>';
            showLoader();

            try {
                let colaboradoresParaSelect = [];
                if (isAdminContextGlobalCount && !empresaId) { // Admin doing a truly global count (no company selected)
                     colaboradoresParaSelect.push({id: currentUser.id, nome_colaborador: `${currentUser.full_name || currentUser.email} (Admin Global)`});
                } else if (empresaId) { // Admin counting for a specific company OR Empresa user counting for their own
                    const { data, error } = await _supabaseClient.from('colaboradores')
                        .select('id, nome_colaborador')
                        .eq('empresa_id', empresaId)
                        .eq('ativo', true) // Only active collaborators
                        .order('nome_colaborador');
                    if (error) throw error;
                    colaboradoresParaSelect = data || [];
                    // If admin is counting for a specific company, also add admin as an option?
                    if (currentUser?.user_metadata?.user_role === 'admin_master' && empresaId) {
                         colaboradoresParaSelect.unshift({id: `admin_${currentUser.id}`, nome_colaborador: `${currentUser.full_name || currentUser.email} (Admin)`});
                    }
                }
                // If non-admin (empresa_login_principal) and no collaborators found, this will be empty + "Selecione"

                if (colaboradoresParaSelect.length > 0) {
                    colaboradoresParaSelect.forEach(colab => {
                        const option = document.createElement('option');
                        option.value = colab.id; // Could be user_id for admin, or colaborador_id
                        option.textContent = colab.nome_colaborador;
                        selectColaboradorContagem.appendChild(option);
                    });
                } else if (!isAdminContextGlobalCount || empresaId) { // Warn if no collaborators for a specific company context
                    selectColaboradorContagem.innerHTML = '<option value="">Nenhum colaborador ativo encontrado</option>';
                }

            } catch (e) {
                console.error("Erro ao carregar colaboradores para contagem:", e);
                selectColaboradorContagem.innerHTML = '<option value="">Erro ao carregar</option>';
            } finally {
                hideLoader();
            }
        }
        
        function populateCategoryFilter(selectElementId = 'filtroCategoria') {
            const filterSelect = document.getElementById(selectElementId);
            if (!filterSelect) { console.warn(`Select de filtro de categoria '${selectElementId}' não encontrado.`); return; }
            
            const currentFilterValue = filterSelect.value;
            filterSelect.innerHTML = '<option value="">Todas</option>';
            
            const uniqueCategories = new Map();
            produtosCache.forEach(produto => { // Use produtosCache from the inventory screen
                if (produto.categoria_id && produto.categorias?.nome_categoria) {
                    if (!uniqueCategories.has(produto.categoria_id)) {
                        uniqueCategories.set(produto.categoria_id, produto.categorias.nome_categoria);
                    }
                }
            });
            // Add "Sem Categoria" if any products lack one
            if (produtosCache.some(p => !p.categoria_id)) {
                 if (!uniqueCategories.has("NO_CATEGORY_ID")) { // Use a special key
                    uniqueCategories.set("NO_CATEGORY_ID", "Sem Categoria");
                 }
            }


            const sortedCategories = Array.from(uniqueCategories.entries())
                .map(([id, name]) => ({ id, name }))
                .sort((a, b) => a.name.localeCompare(b.name));

            sortedCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id === "NO_CATEGORY_ID" ? "SEM_CATEGORIA_FILTER" : cat.id; // Use specific value for "Sem Categoria" filter
                option.textContent = cat.name;
                filterSelect.appendChild(option);
            });
            
            if (Array.from(filterSelect.options).some(opt => opt.value === currentFilterValue)) {
                 filterSelect.value = currentFilterValue;
            } else {
                 filterSelect.value = ""; // Default to "Todas"
            }
        }

        function displayInventoryProducts(listaProdutos) {
            if (!inventoryTableBody) { console.error("inventoryTableBody não encontrado"); return; }
            inventoryTableBody.innerHTML = ""; // Clear
            loadQuantities(); // Ensure latest quantities from localStorage are used

            if (!listaProdutos || listaProdutos.length === 0) {
                inventoryTableBody.innerHTML = '<tr><td colspan="4">Nenhum produto para exibir. Verifique os filtros ou cadastre produtos.</td></tr>';
                return;
            }

            listaProdutos.forEach(produto => {
                const row = inventoryTableBody.insertRow();
                row.insertCell().textContent = produto.codigo_produto;
                row.insertCell().textContent = produto.nome_produto;
                row.insertCell().textContent = produto.categorias ? produto.categorias.nome_categoria : 'Sem Categoria';
                
                const qtdCell = row.insertCell();
                const qtdInput = document.createElement('input');
                qtdInput.type = 'number';
                qtdInput.min = '0';
                qtdInput.dataset.produtoId = produto.id;
                qtdInput.value = quantidadesDigitadas[produto.id] || '';
                qtdInput.addEventListener('change', (e) => {
                    const val = e.target.value;
                    if (val === '' || parseFloat(val) < 0) {
                         delete quantidadesDigitadas[produto.id];
                    } else {
                        quantidadesDigitadas[produto.id] = parseFloat(val);
                    }
                    saveQuantities();
                });
                 qtdInput.addEventListener('focus', (e) => e.target.select()); // Select all text on focus
                qtdCell.appendChild(qtdInput);
            });
        }

        function filterInventoryProducts() {
            const termoProduto = pesquisaProdutoInput.value.toLowerCase();
            const termoCodigo = pesquisaCodigoInput.value.toLowerCase();
            const categoriaIdFiltro = filtroCategoriaSelect.value;

            const produtosFiltrados = produtosCache.filter(produto => {
                const matchProduto = !termoProduto || produto.nome_produto.toLowerCase().includes(termoProduto);
                const matchCodigo = !termoCodigo || produto.codigo_produto.toLowerCase().includes(termoCodigo);
                
                let matchCategoria = true;
                if (categoriaIdFiltro) {
                     if (categoriaIdFiltro === "SEM_CATEGORIA_FILTER") {
                        matchCategoria = !produto.categoria_id;
                     } else {
                        matchCategoria = produto.categoria_id === categoriaIdFiltro;
                     }
                }
                return matchProduto && matchCodigo && matchCategoria;
            });
            displayInventoryProducts(produtosFiltrados);
        }
        
        function clearAllQuantities() {
            if (confirm("Tem certeza que deseja limpar todas as quantidades digitadas nesta tela?")) {
                quantidadesDigitadas = {};
                saveQuantities();
                // Re-filter or re-display to clear inputs visually
                const inputs = inventoryTableBody.querySelectorAll('input[type=number]');
                inputs.forEach(input => input.value = '');
                console.log("Quantidades limpas.");
            }
        }

        function showPreviewContagem() {
            if (!modalPreviewContagem || !previewContagemTableContainer) {
                console.error("Modal de preview ou container da tabela não encontrados."); return;
            }
            const tableBody = previewContagemTableContainer.querySelector('#previewContagemTable tbody');
            if (!tableBody) { console.error("Corpo da tabela de preview não encontrado."); return; }

            tableBody.innerHTML = ''; // Clear previous
            const produtosContados = produtosCache.filter(p => quantidadesDigitadas[p.id] && parseFloat(quantidadesDigitadas[p.id]) > 0);

            if (produtosContados.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4">Nenhum item com quantidade maior que zero para exibir.</td></tr>';
            } else {
                produtosContados.sort((a,b) => (a.nome_produto || "").localeCompare(b.nome_produto || "")).forEach(produto => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = produto.codigo_produto;
                    row.insertCell().textContent = produto.nome_produto;
                    row.insertCell().textContent = produto.categorias ? produto.categorias.nome_categoria : 'Sem Categoria';
                    const qtdCell = row.insertCell();
                    qtdCell.style.textAlign = 'right';
                    qtdCell.textContent = quantidadesDigitadas[produto.id];
                });
            }
            modalPreviewContagem.classList.add('active');
        }

        // --- INICIALIZAÇÃO ---
        window.onload = async () => { 
            console.log("window.onload v2.9.9 (DOM Ready) MODIFICADO v6 (Corrigido) iniciado");
            initializeDOMSelectors(); 
            showLoader(); 
            if (typeof loadQuantities === "function") loadQuantities(); 
            else console.error("CRITICAL: loadQuantities não está definida!");
            
            // Listeners de Login e Logout
            document.getElementById('loginButton')?.addEventListener('click', handleLogin);
            document.getElementById('loginPassword')?.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); handleLogin(); }});
            document.getElementById('btnLogoutAdmin')?.addEventListener('click', handleLogout);
            document.getElementById('btnLogoutEmpresa')?.addEventListener('click', handleLogout);

            // Listeners Painel Admin Master
            document.getElementById('btnAdminGerenciarEmpresas')?.addEventListener('click', showAdminEmpresasScreen);
            document.getElementById('btnAdminGerenciarCategorias')?.addEventListener('click', showAdminCategoriasScreen); 
            document.getElementById('btnAdminGerenciarProdutos')?.addEventListener('click', showProductManagementScreen_AdminGlobal);
            document.getElementById('btnAdminContagemEstoque')?.addEventListener('click', showInventoryCountScreen_AdminGlobal);
            document.getElementById('btnAdminHistoricoContagens')?.addEventListener('click', showHistoricoContagensScreen_Admin);
            
            // Listeners Painel Empresa
            document.getElementById('btnEmpresaGerenciarColaboradores')?.addEventListener('click', () => showEmpresaColaboradoresScreen(null, null, false)); // Explicitly isAdminCalling = false
            document.getElementById('btnEmpresaGerenciarProdutos')?.addEventListener('click', showProductManagementScreen_Empresa);
            document.getElementById('btnEmpresaContagemEstoque')?.addEventListener('click', showInventoryCountScreen_Empresa);
            document.getElementById('btnEmpresaHistoricoContagens')?.addEventListener('click', showHistoricoContagensScreen);
            document.getElementById('btnEmpresaAlterarSenha')?.addEventListener('click', showChangePasswordScreen_Empresa);
            
            // Listeners Ações e Voltar das Telas
            document.getElementById('btnAdminCategoriasVoltar')?.addEventListener('click', showAdminMasterDashboardScreen);
            document.getElementById('btnAdminAddCategoria')?.addEventListener('click', handleAdminAddCategoria);
            document.getElementById('btnAdminEmpresasVoltar')?.addEventListener('click', showAdminMasterDashboardScreen);
            document.getElementById('btnAdminAddEmpresa')?.addEventListener('click', handleAdminAddEmpresa);
            document.getElementById('btnCancelarManageLoginEmpresa')?.addEventListener('click', closeAdminManageLoginEmpresaSection); 

            // Colaboradores back button handled dynamically in showEmpresaColaboradoresScreen

            document.getElementById('btnAddColaborador')?.addEventListener('click', handleAddColaborador);
            document.getElementById('btnSalvarNovaSenha')?.addEventListener('click', handleChangePassword);
            document.getElementById('btnAddProduct')?.addEventListener('click', handleAddProduct);
            document.getElementById('btnImportXLSX')?.addEventListener('click', handleXLSXImport);
            document.getElementById('btnShowPreviewContagem')?.addEventListener('click', showPreviewContagem);
            document.getElementById('btnGerarTXT')?.addEventListener('click', gerarArquivoTXT);
            document.getElementById('btnClearAllQuantities')?.addEventListener('click', clearAllQuantities);
            document.getElementById('btnClosePreviewModal')?.addEventListener('click', closeModalPreviewContagem);
            document.getElementById('btnCloseDetalhesModal')?.addEventListener('click', closeModalDetalhesContagem);

            const changePassBackBtn = document.getElementById('changePasswordBackButton');
            if(changePassBackBtn) {
                changePassBackBtn.addEventListener('click', () => {
                    if (currentUser?.user_metadata?.user_role === 'admin_master') showAdminMasterDashboardScreen();
                    else if (currentUser?.role === 'empresa_login_principal') showEmpresaDashboardScreen();
                    else showScreen('login'); 
                });
            }
            const prodMgmtBackBtn = document.getElementById('productManagementBackButton');
            if(prodMgmtBackBtn) { 
                 prodMgmtBackBtn.addEventListener('click', () => {
                    if (currentUser?.user_metadata?.user_role === 'admin_master') showAdminMasterDashboardScreen();
                    else if (currentUser?.role === 'empresa_login_principal') showEmpresaDashboardScreen();
                    else showScreen('login');
                 });
            }
            const invCountBackBtn = document.getElementById('inventoryCountBackButton');
            if(invCountBackBtn) { 
                 invCountBackBtn.addEventListener('click', () => {
                    if (currentUser?.user_metadata?.user_role === 'admin_master') showAdminMasterDashboardScreen();
                    else if (currentUser?.role === 'empresa_login_principal') showEmpresaDashboardScreen();
                    else showScreen('login');
                 });
            }
            const histBackBtn = document.getElementById('historicoBackButton');
             if(histBackBtn) { 
                 histBackBtn.addEventListener('click', () => {
                    if (currentUser?.user_metadata?.user_role === 'admin_master') showAdminMasterDashboardScreen();
                    else if (currentUser?.role === 'empresa_login_principal') showEmpresaDashboardScreen();
                    else showScreen('login');
                 });
            }

            console.log("Event listeners principais adicionados.");
            
            try {
                console.log("Carregando caches globais (empresas, categorias) no onload...");
                const empresasPromise = _supabaseClient.from('empresas').select('id, nome_empresa').order('nome_empresa');
                // Categorias are often context-dependent (global + specific company), so less critical to pre-cache all without context here.
                // However, product/inventory screens might benefit from a full cache if performance allows.
                // For now, just empresas.
                
                const [empresasRes] = await Promise.all([empresasPromise]);

                if (empresasRes.error) console.error("Erro ao carregar empresas no cache (onload):", empresasRes.error);
                else empresasCache = empresasRes.data || [];

                console.log("Cache de empresas carregado no onload.");

            } catch(e) {
                console.error("Erro crítico ao carregar dados iniciais (empresas) no onload:", e);
            }
            
            const localPesquisaProdutoInput = document.getElementById('pesquisaProduto');
            const localPesquisaCodigoInput = document.getElementById('pesquisaCodigo');
            const localFiltroCategoriaSelect = document.getElementById('filtroCategoria'); 
            if (localPesquisaProdutoInput) localPesquisaProdutoInput.addEventListener("input", filterInventoryProducts);
            if (localPesquisaCodigoInput) localPesquisaCodigoInput.addEventListener("input", filterInventoryProducts);
            if (localFiltroCategoriaSelect) localFiltroCategoriaSelect.addEventListener("change", filterInventoryProducts);
            
            try { 
                console.log("Tentando obter sessão Supabase no onload...");
                const { data: { session }, error: sessionError } = await _supabaseClient.auth.getSession();
                if (sessionError) { console.error("Erro ao obter sessão inicial Supabase (onload):", sessionError); throw sessionError; }

                if (session?.user) {
                    console.log("Sessão Supabase encontrada para user ID (onload):", session.user.id);
                    const user = session.user;
                    
                    const userRoleFromJWT_onload = user.user_metadata?.user_role;
                    const userFullNameFromJWT_onload = user.user_metadata?.full_name || user.email;

                    if (userRoleFromJWT_onload === 'admin_master') {
                        currentUser = {
                            id: user.id, email: user.email, role: 'admin_master', 
                            user_metadata: user.user_metadata, full_name: userFullNameFromJWT_onload
                        };
                        console.log("Sessão restaurada para Admin Master (onload):", currentUser);
                        await Promise.all([
                            populateEmpresasSelect('adminCategoriaEmpresaSelect', true, "-- Categoria Global --", ""),
                            populateEmpresasSelect('adminProdutoEmpresaSelect', true, "-- Produtos Globais (Sem Empresa) --", ""),
                            populateEmpresasSelect('adminContagemEmpresaSelect', true, "-- Contagem Global (Produtos Sem Empresa) --", ""),
                            populateEmpresasSelect('adminHistoricoEmpresaSelect', true, "-- Todas as Empresas --", "ALL_EMPRESAS")
                        ]);
                        showAdminMasterDashboardScreen();
                    } else { 
                        const { data: profile, error: profileError } = await _supabaseClient
                            .from('user_profiles')
                            .select('empresa_id, role, full_name, empresas ( nome_empresa )')
                            .eq('id', user.id)
                            .single();
                        
                        if (profileError && profileError.code === 'PGRST116') { 
                            console.warn("Sessão ativa, mas perfil não encontrado em user_profiles (onload). Deslogando.", user.id);
                            await _supabaseClient.auth.signOut(); showScreen('login');
                        } else if (profileError) { 
                            console.error("Erro ao buscar perfil para sessão ativa (onload):", profileError);
                            throw profileError; 
                        } else if (profile && profile.role === 'empresa_login_principal' && profile.empresa_id && profile.empresas) {
                            currentUser = { 
                                id: user.id, email: user.email, role: profile.role, 
                                user_metadata: user.user_metadata, empresa_id: profile.empresa_id,
                                empresa_nome: profile.empresas.nome_empresa || 'Empresa Associada',
                                full_name: profile.full_name || user.email
                            };
                            console.log("Sessão restaurada para Usuário de Empresa (onload):", currentUser);
                            await showEmpresaDashboardScreen();
                        } else { 
                            console.warn("Sessão Supabase ativa, mas perfil inválido/incompleto ou não é 'empresa_login_principal' (onload). Deslogando. Perfil:", profile);
                            await _supabaseClient.auth.signOut(); showScreen('login'); 
                        }
                    }
                } else { 
                    console.log("Nenhuma sessão Supabase ativa encontrada (onload).");
                    showScreen('login'); 
                }
            } catch (e) {
                console.error("Erro crítico na inicialização ao tentar restaurar sessão/perfil (onload):", e);
                await _supabaseClient.auth.signOut().catch(err => { console.warn("Erro no signOut de fallback (onload):", err); }); 
                currentUser = null; 
                showScreen('login');
            } finally {
                console.log("window.onload finalizado.");
                hideLoader(); 
            }
        };
        console.log("SCRIPT END - v2.9.9 MODIFICADO v6 - Definições de Função (Corrigido)");
    </script>
</body>
</html>